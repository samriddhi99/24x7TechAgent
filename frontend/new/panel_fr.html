<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panneau de configuration | Votre assistant vocal IA 24/7</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ajv@6.12.6/dist/ajv.min.js"></script>
  <style>
    .panel-header { 
      text-align: left; 
      padding: 48px 0 28px;
    }
    .panel-header h1 {
      font-size: 2rem;
      margin: 0 0 8px;
    }
    .panel-header p {
      color: var(--muted);
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .tab-debug {
      margin-top:8px;
      font-size:0.85rem;
      color:var(--muted);
    }
    .tab-btn {
      padding: 12px 18px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      transition: color .2s ease;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab-btn:hover {
      color: var(--fg);
    }
    .tab-btn.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 28px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--fg);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--fg);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color .2s ease;
    }

    /* Ensure checkboxes/radios inside form groups don't stretch to full width */
    .form-group input[type="checkbox"],
    .form-group input[type="radio"] {
      width: auto;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
      height: 18px;
      padding: 0;
      background: transparent;
      border: none;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(91, 140, 255, 0.1);
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
    }

    .checkbox-group {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }
    .slider-group input[type="range"] {
      flex: 1;
      cursor: pointer;
    }
    .slider-value {
      min-width: 50px;
      text-align: right;
      color: var(--brand);
      font-weight: 600;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--fg);
      margin: 24px 0 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .save-btn {
      background: linear-gradient(135deg, var(--brand), #7aa2ff);
      color: #0b0d12;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease;
      box-shadow: 0 10px 24px rgba(91, 140, 255, .25);
    }
    .save-btn:hover {
      transform: translateY(-1px);
    }
    .save-btn:active {
      transform: translateY(0);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .info-box {
      background: rgba(91, 140, 255, 0.1);
      border-left: 3px solid var(--brand);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .section-card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 14px;
      margin-bottom: 24px;
    }
    .section-card .section-header{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin-bottom:10px;
    }
    .section-card .section-header h2{ margin:0; flex:0 0 auto; }
    .helper-text {
      font-style: italic;
      font-size: 0.92rem;
      color: var(--muted);
      margin-top: 6px;
    }
    .disabled-section {
      opacity: 0.6;
      filter: grayscale(40%);
    }
    .toggle-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
      color: var(--fg);
      cursor: pointer;
      font-weight: 600;
      min-width: 48px;
      line-height:1;
    }
    .toggle-btn .dot {
      width: 14px; height: 14px; border-radius: 50%; background: #222; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2);
      transition: transform .18s ease, background .18s ease;
      flex: 0 0 14px;
    }
    .toggle-btn.on { background: linear-gradient(90deg, var(--brand), #7aa2ff); color: #071022; border-color: rgba(122,162,255,0.6); }
    .toggle-btn.on .dot { background: #fff; transform: translateX(6px); }
    .toggle-btn .label { font-size:0.9rem; }
    /* Developer-only controls are hidden for business users by default */
    .dev-only { display: none !important; }
    .dev-warning { background: #fff3cd; border: 1px solid #ffeeba; padding:12px; border-radius:8px; color:#856404; }
    /* Capability categories (accordion) */
    .cap-category-header { text-align:left; color:var(--fg); background:transparent; border:none; padding:0; display:flex; align-items:center; gap:8px; }
    .cap-category-header strong { color:var(--fg); font-size:1rem; font-weight:700; text-align:left; }
    .cap-category-header .muted { color:var(--muted); font-weight:400; font-size:0.95rem; margin-left:8px; }
    .cap-category-header.open { border-color: var(--brand); box-shadow: 0 6px 18px rgba(91,140,255,0.08); }
    .cap-category-content { padding: 8px 0 0 0; }
    .cap-category .cond-area { margin-left: 8px; }
  </style>
</head>
<body>
  <header class="container panel-header">
    <h1>Configuration de l'agent IA</h1>
    <p>Personnalisez votre assistant technique 24/7 pour r√©pondre aux besoins de votre entreprise</p>
        <div style="display:flex; gap:12px; align-items:center; margin-top:16px;">
            <a class="btn" href="index.html">‚Üê Retour</a>
          <button id="export_config_btn" class="btn" type="button">Exporter les param√®tres (JSON)</button>
        <label for="lang_select" style="margin-left:12px; display:inline-flex; align-items:center; gap:8px;">Langue
          <select id="lang_select" style="padding:8px; border-radius:8px; margin-left:6px;">
            <option value="en">Anglais</option>
            <option value="fr" selected>Fran√ßais</option>
        </select>
      </label>
      <button id="import_config_btn" class="btn dev-only" type="button">Importer les param√®tres (JSON)</button>
      <input type="file" id="import_config_file" accept="application/json" class="dev-only" style="display:none" />
      <input type="file" id="template_import_file" accept=".json,.txt" style="display:none" onchange="handleTemplateFile(event)" />
      <input type="file" id="document_import_file" accept=".txt,.md" style="display:none" onchange="handleDocumentFile(event)" />
      <input type="file" id="calendar_import_file" accept=".ics" style="display:none" onchange="handleCalendarFile(event)" />
      <input type="file" id="invoice_template_import_file" accept=".json,.txt,.md" style="display:none" onchange="handleInvoiceTemplateFile(event)" />
    </div>
    <!-- DEVELOPERS / Advanced Controls -->
    <div id="developers" class="tab-content">
      <div class="section-card">
        <div class="dev-warning"><strong>Param√®tres d√©veloppeur (Avanc√©)</strong><div style="margin-top:6px;">Ces contr√¥les sont destin√©s aux d√©veloppeurs et aux √©quipes techniques. Les propri√©taires d'entreprise ne doivent pas modifier ces options sans en comprendre l'impact. Sauvegardez votre configuration avant d'appliquer des modifications.</div></div>
        <div style="display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;">
          <button class="btn" type="button" onclick="openImportFile()">Importer les param√®tres (JSON)</button>
          <button class="btn" type="button" onclick="showImportPreviewPanel()">Afficher l'aper√ßu d'importation</button>
          <button class="btn" type="button" onclick="openBackupsTab()">G√©rer les sauvegardes</button>
          <button class="btn" type="button" onclick="openTrainingQueueTab()">Ouvrir la file d'entra√Ænement</button>
          <button class="btn" type="button" onclick="revealPaymentApiKey()">Afficher la cl√© API de paiement</button>
          <button class="btn" type="button" onclick="showSSMLRaw()">Afficher SSML brut</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
          <div class="section-card" style="padding:12px;">
            <h3 style="margin-top:0;">API Keys</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input id="new_api_name" placeholder="Nom de la cl√© (ex. : service-app)" style="flex:1; padding:8px;" /><button class="btn" onclick="createApiKey()">G√©n√©rer une cl√©</button></div>
            <div id="api_keys_list" style="max-height:220px; overflow:auto;"></div>
          </div>

          <div class="section-card" style="padding:12px;">
            <h3 style="margin-top:0;">Webhooks</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input id="new_webhook_url" placeholder="https://example.com/webhook" style="flex:1; padding:8px;" /><select id="new_webhook_method"><option>POST</option><option>PUT</option><option>PATCH</option></select><button class="btn" onclick="addWebhook()">Ajouter</button></div>
            <div id="webhooks_list" style="max-height:220px; overflow:auto;"></div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
          <div class="section-card">
            <h3 style="margin-top:0;">Extraits SDK</h3>
            <div id="sdk_snippets" style="font-family:monospace; font-size:0.95rem; max-height:220px; overflow:auto; padding:8px; background:var(--panel); border-radius:6px;"></div>
          </div>
          <div class="section-card">
            <h3 style="margin-top:0;">Journaux d√©veloppeur & Test</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><button class="btn" onclick="testApiEndpoint()">Tester le point de terminaison API</button><button class="btn" onclick="downloadDevLogs()">T√©l√©charger les journaux</button><button class="btn" onclick="clearDevLogs()" style="background:#d9534f;">Effacer les journaux</button></div>
            <div id="dev_logs" style="max-height:220px; overflow:auto; font-family:monospace; background:var(--panel); padding:8px; border-radius:6px;"></div>
          </div>
        </div>
        <div id="dev_output" style="margin-top:12px; font-family:monospace; white-space:pre-wrap; color:var(--muted);"></div>
      </div>
    </div>
  </header>
  <div class="container" style="margin-top:12px;">
      <div id="import_preview" class="section-card dev-only" style="display:none;">
      <h3 style="margin-top:0;">Aper√ßu d'importation</h3>
      <div id="import_changes" style="max-height:280px; overflow:auto; font-family:monospace; font-size:0.95rem;"></div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button id="apply_import_btn" class="save-btn">Appliquer l'importation</button>
        <button id="cancel_import_btn" class="btn">Annuler</button>
      </div>
    </div>

    <!-- MODEL / TRAINING TAB -->
    <div id="model" class="tab-content dev-only">
      <div class="info-box">üß† Contr√¥lez l'utilisation des interactions pour l'entra√Ænement du mod√®le, la file de revue et la gestion des √©chantillons.</div>
      <div class="section-card">
        <div style="display:flex; align-items:center; gap:12px;">
          <button class="toggle-btn" data-checkbox="training_enabled" role="switch" aria-checked="false"><span class="dot"></span><span class="label">D√©sactiv√©</span></button>
          <input type="checkbox" id="training_enabled" name="training.enabled" style="display:none" />
          <div style="flex:1;"><strong>Inclure les interactions anonymis√©es dans l'entra√Ænement</strong><div class="helper-text">Lorsqu'il est activ√©, certaines conversations peuvent √™tre envoy√©es dans votre file d'entra√Ænement (la d√©mo utilise localStorage).</div></div>
        </div>
        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <button class="btn" type="button" onclick="enqueueSampleFromRecent()">Ajouter un √©chantillon r√©cent</button>
          <button class="btn" type="button" onclick="renderTrainingQueue()">Ouvrir la file de revue</button>
        </div>
        <div id="training_queue" style="margin-top:12px; display:none;"></div>
      </div>
    </div>

    <!-- TEMPLATES & SNIPPETS TAB -->
    <div id="templates" class="tab-content">
      <div class="info-box">‚úâÔ∏è Mod√®les de message et extraits r√©utilisables avec aper√ßu et variables.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1;">
            <label><strong>Mod√®les</strong></label>
            <div id="templates_list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
            <div style="margin-top:8px;"><button class="btn" type="button" onclick="addTemplateModifieror()">Ajouter un mod√®le</button></div>
          </div>
          <div style="flex:1;">
            <label><strong>Aper√ßu en direct</strong></label>
            <div style="margin-top:8px;">
              <div style="display:flex; gap:8px; align-items:center;"><label style="min-width:80px;">Mod√®le</label><select id="preview_template" onchange="updateTemplatePreview()"></select></div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:8px;"><label style="min-width:80px;">Variables (JSON)</label><input id="preview_vars" placeholder='{"customer_name":"Jane"}' style="flex:1; padding:8px;" /></div>
              <div id="template_preview" style="margin-top:12px; white-space:pre-wrap; font-family:monospace; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCESSIBILITY / LOCALIZATION TAB -->
    <div id="accessibility" class="tab-content dev-only">
      <div class="info-box">‚ôø Accessibilit√© et localisation : s√©lection de la voix TTS, SSML, traductions et aper√ßu RTL.</div>
      <div class="section-card">
        <div class="form-row">
          <div class="form-group"><label for="tts_voice">Voix TTS</label>
            <select id="tts_voice" name="accessibility.tts_voice"><option value="default">Par d√©faut</option><option value="female_en">Femme - en-US</option><option value="male_en">Homme - en-US</option><option value="multilang">Multi-langue</option></select></div>
          <div class="form-group"><label for="tts_speed">Vitesse TTS</label><input id="tts_speed" name="accessibility.tts_speed" type="range" min="0.5" max="2" step="0.1" value="1" /></div>
        </div>
        <div class="form-group"><label for="ssml_snippet">Extrait SSML</label><textarea id="ssml_snippet" name="accessibility.ssml" placeholder="<speak>Hello <break time=\"200ms\"/> world</speak>"></textarea>
          <div style="margin-top:8px;"><button class="btn" type="button" onclick="previewSSML()">Aper√ßu SSML (d√©mo)</button></div>
        </div>
        <div class="section-title">Traductions</div>
        <div class="helper-text">G√©rer les cha√Ænes de traduction pour les messages UI. √âditeur cl√©-valeur ci-dessous.</div>
        <div id="translations_list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;"><button class="btn" type="button" onclick="addTranslationRow()">Ajouter une cha√Æne</button><button class="btn" type="button" onclick="toggleRTLPreview()">Basculer aper√ßu RTL</button></div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="tabs">
      <button class="tab-btn" data-tab="presets">Pr√©r√©glages & Profil</button>
      <button class="tab-btn active" data-tab="personality">Marque & Personnalit√©</button>
      <button class="tab-btn" data-tab="capabilities">Fonctionnalit√©s & Garanties</button>
      <button class="tab-btn" data-tab="telephony">T√©l√©phonie & CRM</button>
      <button class="tab-btn" data-tab="transcription">Transcription & Transcrits</button>
      <button class="tab-btn" data-tab="diagnostics">Diagnostics & Outils</button>
      <button class="tab-btn" data-tab="playbooks">Playbooks (Runbooks)</button>
      <button class="tab-btn" data-tab="network">Statut R√©seau & Pannes</button>
      <button class="tab-btn" data-tab="ticketing">Tickets & SLA</button>
      <button class="tab-btn" data-tab="knowledge">Connaissances & Mod√®les</button>
      <button class="tab-btn" data-tab="appointments">Rendez-vous & R√©servations</button>
      <button class="tab-btn" data-tab="quotes">Devis & Paiements</button>
      <button class="tab-btn" data-tab="analytics">Stockage, Insights & Analytique</button>
      <button class="tab-btn" data-tab="escalation">Escalade & Astreinte</button>
      <button class="tab-btn" data-tab="privacy">Confidentialit√© & Conformit√©</button>
      <button class="tab-btn" data-tab="developers">D√©veloppeurs & Avanc√©</button>
    </div>

    <!-- PERSONALITY TAB -->
    <!-- PRESETS TAB (UI only) -->
    <div id="presets" class="tab-content">
      <div class="info-box">üéØ Appliquez des pr√©r√©glages sectoriels pour configurer rapidement l'agent selon les types d'entreprises courants.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Pr√©r√©glages</h2>
        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
          <div class="card">
            <strong>Telecom Frontline</strong>
            <div class="muted">Assistant d'accueil/IVR : identification de l'appelant, d√©pannage de base, routage vers les files et recherches de compte simples.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="telecom_frontline">Appliquer</button></div>
          </div>
          <div class="card">
            <strong>Telecom NOC</strong>
            <div class="muted">Orient√© NOC : diagnostics automatis√©s, d√©tection de pannes, playbooks r√©seau et escalade vers les √©quipes sur le terrain.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="telecom_noc">Appliquer</button></div>
          </div>
          <div class="card">
            <strong>IT Helpdesk / MSP</strong>
            <div class="muted">Support informatique g√©r√© : reprovisionnement d'appareils, v√©rifications VPN, cr√©ation de tickets, dispatch de techniciens et workflows SLA.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="it_msp">Appliquer</button></div>
          </div>
          <div class="card">
            <strong>SaaS Support</strong>
            <div class="muted">Support centr√© application : recherche de compte, assistance facturation/abonnement, d√©pannage guid√© et escalade vers les √©quipes produit.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="saas_support">Appliquer</button></div>
          </div>
        </div>
        <div class="helper-text" style="margin-top:12px;">Ces boutons sont uniquement une interface utilisateur pour l'instant.</div>
        <div class="helper-text">Astuce : Appliquez un pr√©r√©glage pour obtenir des valeurs par d√©faut adapt√©es √† votre secteur, puis v√©rifiez les param√®tres (confidentialit√©, devis, horaires) avant d'enregistrer.</div>
      </div>
    </div>
    <div id="personality" class="tab-content active">
      <div class="info-box">
        üí° D√©finissez la fa√ßon dont votre agent IA communique avec les clients. Ces param√®tres affectent le ton, la r√©activit√© et le style de communication.
      </div>

      <form id="personalityForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Style de communication</h2>

          <div class="form-group">
            <label>Nom de l'agent</label>
            <input type="text" id="agentName" value="TechBot" placeholder="ex. : TechBot, Alex, Agent de support">
            <div class="helper-text">Utilisez un nom convivial et reconnaissable que les clients retiendront ‚Äî utile pour les transferts vers le personnel humain.</div>
          </div>

          <div class="form-group">
            <label>Avatar de l'agent <small class="muted">(optionnel)</small></label>
            <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
              <button class="btn" type="button" onclick="openImportFile()">Importer les param√®tres (JSON)</button>
              <img id="avatar_preview" alt="Aper√ßu de l'avatar" src="" style="width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid var(--border); display:inline-block; background:var(--panel);" />
            </div>
            <div class="helper-text">T√©l√©chargez une image repr√©sentant l'agent (affich√©e aux clients).</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Type de personnalit√©</label>
              <select id="personalityType">
                <option value="professional">Professionnel & Formel</option>
                <option value="friendly">Amical & Accessible</option>
                <option value="technical">Technique & D√©taill√©</option>
                <option value="concise">Concise & Direct</option>
              </select>
              <div class="helper-text">Choisissez le style qui correspond √† votre marque ‚Äî convivial pour le commerce de d√©tail, technique pour les entreprises ax√©es sur le support.</div>
            </div>
            <div class="form-group">
              <label>Vitesse de r√©ponse</label>
              <select id="responseSpeed">
                <option value="instant">Instant (&lt; 1 seconde)</option>
                <option value="normal">Normal (1-2 secondes)</option>
                <option value="thoughtful">R√©fl√©chi (2-3 secondes)</option>
              </select>
              <div class="helper-text">Les r√©ponses plus rapides semblent plus r√©actives ; les r√©ponses plus lentes permettent des r√©ponses plus longues et plus pr√©cises. Choisissez selon le type d'appel.</div>
            </div>
          </div>

          <div class="form-group">
            <label>Message d'accueil personnalis√©</label>
            <input type="text" id="customGreeting" value="Merci d'appeler. Comment puis-je vous aider aujourd'hui ?" placeholder="Votre message d'accueil personnalis√©">
            <div class="helper-text">Les salutations courtes r√©duisent la friction ‚Äî incluez le nom de l'entreprise si cela aide √† la reconnaissance de l'appelant.</div>
          </div>

          <div class="form-group">
            <label>Formule de fin personnalis√©e</label>
            <input type="text" id="customSignOff" value="Merci de nous avoir contact√©s. Bonne journ√©e !" placeholder="Votre message de cl√¥ture">
            <div class="helper-text">Une cl√¥ture chaleureuse et coh√©rente instaure la confiance et signale la fin de la conversation aux clients.</div>
          </div>

          <div class="section-title">Param√®tres de langue</div>

          <div class="form-group">
            <label>Langue principale</label>
            <select id="primaryLangue">
              <option value="en">Anglais</option>
              <option value="es">Espagnol</option>
              <option value="fr">Fran√ßais</option>
              <option value="de">Allemand</option>
              <option value="it">Italien</option>
              <option value="pt">Portugais</option>
              <option value="ja">Japonais</option>
              <option value="zh">Chinois</option>
            </select>
          </div>

          <div class="form-group">
            <label>Langues prises en charge (support multilingue)</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="lang_en" checked>
                <label for="lang_en">Anglais</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_es">
                <label for="lang_es">Espagnol</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_fr">
                <label for="lang_fr">French</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_de">
                <label for="lang_de">Allemand</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="savePersonality()">Enregistrer les param√®tres de personnalit√©</button>
        </div>
      </form>
    </div>

    <!-- CAPABILITIES TAB -->
    <div id="capabilities" class="tab-content">
      <div class="info-box">
        üîß Configurez les actions que votre agent IA peut effectuer automatiquement. Les t√¢ches complexes peuvent √™tre escalad√©es vers des techniciens humains.
      </div>

      <form id="capabilitiesForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Capacit√©s du service</h2>

          <div class="helper-text">D√©finissez le niveau de confirmation pour chaque action : <strong>Aucune confirmation requise</strong>, <strong>Peut n√©cessiter</strong> ou <strong>Requise</strong>.</div>

          <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <label style="min-width:120px; font-weight:600;">R√©glage rapide</label>
            <select id="bulkSetLevel" style="max-width:260px;">
              <option value="">-- D√©finir la s√©lection --</option>
              <option value="no_need">Aucune confirmation requise</option>
              <option value="may_require">Peut n√©cessiter une confirmation</option>
              <option value="required">Toujours demander confirmation</option>
            </select>
            <button type="button" class="btn" id="bulkAppliquerBtn">Appliquer √† tous</button>
          </div>

          <div class="section-title" style="margin-top:16px;">Actions & Niveaux de confirmation</div>

          <div class="helper-text" style="margin-top:8px;">
            Chaque action ci-dessous peut √™tre r√©gl√©e sur l'un des trois niveaux de confirmation :
            <strong>Aucune confirmation requise</strong> (t√¢ches s√ªres, lecture seule ou √† faible impact),
            <strong>Peut n√©cessiter</strong> (l'agent proposera l'action mais pourra demander une confirmation), et
            <strong>Requise</strong> (demander toujours l'avis d'un humain en premier).
          </div>

          <div class="section-card" style="margin-top:12px; padding:10px; background:var(--panel); border:1px solid var(--border);">
            <strong>Guide des conditions</strong>
            <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">
              - <strong>high_priority_account</strong> : client marqu√© par votre CRM comme VIP ou soumis √† un SLA plus strict.
              <br>- <strong>outage_detected</strong> : panne g√©n√©ralis√©e ou plusieurs clients affect√©s.
              <br>- <strong>after_hours</strong> : action demand√©e en dehors des heures d'ouverture normales.
              <br>- <strong>field_dispatch_required</strong> : probl√®me n√©cessitant probablement l'intervention d'un technicien sur site.
              <br>- <strong>monetary_impact</strong> : l'action modifiera la facturation, appliquera des cr√©dits ou des remboursements.
              <br>- <strong>new_device</strong> : l'utilisateur enregistre ou utilise un appareil nouveau/non reconnu.
              <br>- <strong>unusual_location</strong> : l'appelant semble dans un emplacement inhabituel (risque de fraude).
              <br>- <strong>legal_identity_change</strong> : modifications impliquant l'identit√© ou la propri√©t√©.
              <br>- <strong>security_incident</strong> : actions li√©es √† des failles de s√©curit√© ou comptes compromis.
                <br>- <strong>staging_passed</strong> : les tests automatis√©s et la validation staging sont pass√©s.
                <br>- <strong>backup_taken</strong> : une sauvegarde r√©cente existe pour la r√©cup√©ration.
                <br>- <strong>client_approval</strong> : une approbation explicite du client a √©t√© enregistr√©e pour ce changement.
                <br>- <strong>production_environment</strong> : cette action affecte les syst√®mes de production (risque √©lev√©).
                <br>- <strong>domain_verification</strong> : √©tape de v√©rification de la propri√©t√© du domaine compl√©t√©e.
                <br>- <strong>contract_signed</strong> : le contrat client ou SOW est sign√© et archiv√©.
                <br>- <strong>payment_verified</strong> : paiement ou d√©p√¥t client v√©rifi√©.
                <br>- <strong>production_issue</strong> : incident ou panne de production en cours.
            </div>
            <div style="margin-top:8px; font-size:0.9rem;" class="helper-text">Astuce : utilisez le r√©glage global ¬´ Escalader automatiquement si incertain ¬ª pour d√©finir un seuil d'escalade automatique.</div>
          </div>

          <div id="capabilities_actions_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>

          <div class="section-title">D√©clencheurs d'escalade</div>

          <div class="form-group">
            <label>Escalader automatiquement apr√®s (minutes de conversation)</label>
            <div class="slider-group">
              <input type="range" id="escalationTimeout" min="1" max="15" value="5" style="width: 200px;">
              <span class="slider-value"><span id="escalationTimeoutVal">5</span> min</span>
            </div>
            <div class="helper-text">Si la conversation dure plus longtemps sans r√©solution, envisagez d'escalader vers un technicien humain.</div>
          </div>

          <div class="form-group">
            <label>Seuil de satisfaction client pour l'escalade</label>
            <div class="slider-group">
              <input type="range" id="satisfactionThreshold" min="1" max="10" value="5" style="width: 200px;">
              <span class="slider-value"><span id="satisfactionThresholdVal">5</span>/10</span>
            </div>
            <div class="helper-text">D√©finissez le score minimal de satisfaction avant que le syst√®me n'escalade automatiquement.</div>
          </div>
          
          <div class="section-title">Garde-fous globaux</div>
          <div class="form-group">
            <label><input type="checkbox" id="safeguards_enabled" /> Demander avant les actions risqu√©es (bascule ma√Ætre)</label>
            <div class="helper-text">Activez une protection principale qui demande une confirmation pour les actions d√©passant les limites configur√©es.</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="max_monetary_impact">Impact mon√©taire max sans approbation (‚Ç¨)</label>
              <input id="max_monetary_impact" type="number" min="0" value="0" />
            </div>
            <div class="form-group">
              <label for="actions_whitelist">Liste blanche d'actions (autoris√©es sans approbation)</label>
              <select id="actions_whitelist" multiple style="height:120px;"></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Escalader automatiquement si incertain (seuil)</label>
              <div class="slider-group"><input type="range" id="auto_escalate" min="0" max="100" value="60" /><span class="slider-value"><span id="auto_escalate_val">60</span>%</span></div>
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="audit_log_enabled" /> Journal d'audit activ√©</label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveCapabilities()">Enregistrer les capacit√©s du service</button>
        </div>
      </form>
    </div>

    <!-- QUOTES TAB -->
    <div id="quotes" class="tab-content">
            <div class="info-box">
        üí∂ Configurez la cr√©ation et la validation des devis par l'IA. Mod√®les, TVA, devise et r√®gles d'approbation.
      </div>

      <form id="quotesForm">
        <div class="section-card">
          <div class="section-header">
            <h2 style="margin:0;">Param√®tres des devis</h2>
            <div style="display:flex; align-items:center; gap:12px;">
              <button type="button" class="toggle-btn" data-checkbox="quotes_enabled" role="switch" aria-checked="false">
                <span class="dot"></span>
                <span class="label">D√©sactiv√©</span>
              </button>
              <input type="checkbox" id="quotes_enabled" name="quotes.enabled" style="display:none" />
            </div>
          </div>
          <div class="helper-text">Activez si votre entreprise propose des estimations simples ou des devis formels ‚Äî configurez les mod√®les et les r√®gles d'approbation.</div>

          <div class="form-row">
            <div class="form-group">
              <label for="quotes_currency">Devise par d√©faut</label>
              <select id="quotes_currency" name="quotes.currency">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
            <div class="form-group">
              <label for="quotes_vat">VAT (%)</label>
              <input id="quotes_vat" name="quotes.vat" type="number" min="0" max="100" value="20" />
            </div>
          </div>

          <div class="form-group">
            <label for="quotes_valid_days">Validit√© par d√©faut (jours)</label>
            <input id="quotes_valid_days" name="quotes.valid_days" type="number" min="0" value="30" />
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="quotes_require_human" name="quotes.require_human" /> Exiger une approbation humaine pour les devis sup√©rieurs √†</label>
            <input id="quotes_human_threshold" name="quotes.human_threshold" type="number" min="0" value="1000" style="margin-left:8px; width:140px;" /> <span class="muted">(montant dans la devise par d√©faut)</span>
            <div class="helper-text">Activez pour exiger une validation manuelle au-dessus du seuil sp√©cifi√©.</div>
          </div>

          <div class="form-group">
            <label for="quotes_template_subject">Mod√®le d'objet d'email</label>
            <input id="quotes_template_subject" name="quotes.email_subject" placeholder="Devis pour {{customer_name}} - {{quote_id}}" />
          </div>
          <div class="form-group">
            <label for="quotes_template_body">Mod√®le de corps d'email</label>
            <textarea id="quotes_template_body" name="quotes.email_body" placeholder="Bonjour {{customer_name}},\nVeuillez trouver votre devis en pi√®ce jointe. Total : {{total}} {{currency}}"></textarea>
          </div>

          <div class="form-group">
            <label>Invoice Templates</label>
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <button class="btn" type="button" onclick="connectInvoicePlatform(true)">Enregistrer la plateforme (d√©mo)</button>
              <button class="btn" type="button" onclick="disconnectInvoicePlatform()">D√©connecter</button>
              <div id="invoice_platform_status_pay" style="color:var(--muted); margin-left:8px;">Non enregistr√©</div>
            </div>
            <div id="invoice_templates_list" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>

          <div class="form-group" style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
            <label><strong>Invoice Platform (Compliance)</strong></label>
            <div class="helper-text">Certaines juridictions exigent que les factures soient d√©clar√©es sur une plateforme certifi√©e. Choisissez votre plateforme et enregistrez une connexion (d√©mo front-end uniquement).</div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <select id="invoice_platform_select" style="min-width:200px">
                <option value="none">Aucune</option>
                <option value="chorus_pro">Chorus Pro</option>
                <option value="sage">Sage</option>
                <option value="dgi">DGI / Plateforme locale</option>
                <option value="custom">Autre (personnalis√©)</option>
              </select>
              <input id="invoice_platform_merchant" placeholder="Identifiant marchand / compte" style="padding:8px;" />
              <input id="invoice_platform_api" placeholder="Cl√© API / Jeton" style="padding:8px;" />
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
              <button class="btn" type="button" onclick="connectInvoicePlatform()">Enregistrer la plateforme de facturation (d√©mo)</button>
              <button class="btn" type="button" onclick="disconnectInvoicePlatform()">D√©connecter</button>
              <div id="invoice_platform_status" style="color:var(--muted); margin-left:8px;">Non enregistr√©</div>
            </div>
          </div>

          <div class="form-group">
            <label for="quotes_validation_rules">Validation rules (JSON)</label>
            <textarea id="quotes_validation_rules" name="quotes.validation_rules" placeholder='[{"field":"price","min":0}]' style="min-height:80px;"></textarea>
            <div class="helper-text">R√®gles JSON simples facultatives pour valider les devis g√©n√©r√©s avant envoi.</div>
          </div>

        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveQuotes()">Enregistrer les param√®tres de devis</button>
          <button type="button" class="btn" onclick="previewQuote()">Aper√ßu du devis</button>
          <button type="button" class="btn" onclick="exportInvoiceSample()">Exporter facture (JSON)</button>
          <button type="button" class="btn" onclick="openInvoiceHistory()">Historique des factures</button>
        </div>
      </form>
    </div>

    <!-- KNOWLEDGE / FAQ TAB -->
    <div id="knowledge" class="tab-content">
      <div class="info-box">‚ùì G√©rer les questions fr√©quemment pos√©es (FAQ). Consultez les questions r√©centes des utilisateurs et ajoutez de courtes r√©ponses pour l'agent.</div>

      <form id="knowledgeForm">
        <div class="section-card">
          <h2 style="margin-top:0;">FAQ</h2>

            <div class="muted">FAQ existantes (modifiez les r√©ponses ou ajoutez-en de nouvelles)</div>
            <div class="helper-text">Transformez les questions fr√©quentes en FAQ concises pour r√©duire les appels r√©p√©titifs et acc√©l√©rer les r√©solutions.</div>
            <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Guide rapide¬†: utilisez les FAQ et mod√®les pour capturer les r√©ponses et extraits courants. Gardez les r√©ponses courtes et utilisez des variables comme <code>{{customer_name}}</code> pour personnaliser les messages. Convertissez les questions r√©centes en FAQ pour enrichir rapidement votre base de connaissances.</div>
          <div id="faqs_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
          <div style="margin-top:8px;"><button type="button" id="knowledge_add" class="btn">Ajouter FAQ</button></div>

          <div class="section-title" style="margin-top:18px;">Questions r√©centes</div>
          <div id="recent_questions" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
          <div class="helper-text">Voici les questions r√©centes d√©tect√©es lors de l'utilisation¬†; cliquez sur ¬´¬†Ajouter r√©ponse¬†¬ª pour les convertir en FAQ. Utilisez le bouton ¬´¬†Ajouter un mod√®le¬†¬ª ci-dessous pour cr√©er des extraits de r√©ponse r√©utilisables pour e‚Äëmail/SMS.</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn" type="button" onclick="addTemplateModifieror()">Ajouter un mod√®le</button>
            <button class="btn" type="button" onclick="importTemplates()">Importer des mod√®les</button>
            <button class="btn" type="button" onclick="exportTemplates()">Exporter des mod√®les</button>
          </div>

          <div style="margin-top:16px; border-top:1px dashed var(--border); padding-top:12px;">
            <h3 style="margin:0 0 6px;">Company Documents</h3>
            <div class="helper-text">T√©l√©versez des fichiers texte ou Markdown d√©crivant votre entreprise, services, SLAs ou pages produit. Les documents t√©l√©vers√©s sont stock√©s localement (navigateur) et peuvent servir √† cr√©er des mod√®les ou FAQ. Vous pouvez supprimer les documents √† tout moment.</div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
              <button class="btn" type="button" onclick="importDocument()">T√©l√©verser un document d'entreprise</button>
              <button class="btn" type="button" onclick="renderDocumentLibrary()">Ouvrir la biblioth√®que de documents</button>
            </div>
            <div id="uploaded_docs_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveKnowledge()">Enregistrer la FAQ</button>
        </div>
      </form>
    </div>

        <!-- APPOINTMENTS TAB -->
        <div id="appointments" class="tab-content">
          <div class="info-box">üìÖ Configurez le comportement de r√©servation : calendriers, dur√©es et protections contre les doubles r√©servations.</div>
          <form id="appointmentsForm">
            <div class="section-card">
              <div class="section-header">
                <h2 style="margin:0;">Rendez-vous</h2>
                <div style="display:flex; align-items:center; gap:12px;">
                  <button type="button" class="toggle-btn" data-checkbox="appts_enabled" role="switch" aria-checked="false">
                    <span class="dot"></span>
                    <span class="label">D√©sactiv√©</span>
                  </button>
                  <input type="checkbox" id="appts_enabled" name="appointments.enabled" style="display:none" />
                </div>
              </div>
              <div class="helper-text">Activez pour permettre aux clients de r√©server des cr√©neaux ; connectez votre fournisseur de calendrier pour la disponibilit√© en temps r√©el.</div>
              <div class="form-row">
                <div class="form-group"><label for="appts_provider">Fournisseur</label>
                  <select id="appts_provider" name="appointments.provider"><option value="google">Google Calendar</option><option value="outlook">Outlook</option><option value="none">Aucune</option></select>
                  <div class="helper-text">Choisissez votre fournisseur de calendrier ‚Äî la connexion permet la disponibilit√© en direct et √©vite les doubles r√©servations.</div>
                </div>
                <div class="form-group"><label for="appts_calendar">ID du calendrier</label><input id="appts_calendar" name="appointments.calendar_id" placeholder="principal" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label for="appts_duration">Dur√©e par d√©faut (min)</label><input id="appts_duration" name="appointments.duration_min" type="number" min="5" value="30"/></div>
                <div class="form-group"><label for="appts_buffer">Intervalle (min)</label><input id="appts_buffer" name="appointments.buffer_min" type="number" min="0" value="10"/></div>
              </div>
              <div class="form-group"><label for="appts_reminder">Rappel (min avant)</label><input id="appts_reminder" name="appointments.reminder_min" type="number" min="0" value="60"/></div>
              <div class="form-group"><label><input type="checkbox" name="appointments.prevent_double_booking" /> Emp√™cher les doubles r√©servations</label></div>
              <div class="form-group"><label for="appts_confirm">Message de confirmation</label><textarea id="appts_confirm" name="appointments.confirm_message" placeholder="Merci {{customer_name}}, votre r√©servation est confirm√©e pour le {{date}} √† {{time}}."></textarea></div>
            </div>
            <div style="margin-top:16px; border-top:1px dashed var(--border); padding-top:12px;">
              <h3 style="margin:0 0 6px;">Calendar Connections</h3>
              <div class="helper-text">Connectez ou t√©l√©versez des calendriers pour que l'agent puisse v√©rifier la disponibilit√© et √©viter les doubles r√©servations. Pour la d√©mo, vous pouvez t√©l√©verser un fichier .ics qui sera stock√© localement.</div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <button class="btn" type="button" onclick="importCalendar()">T√©l√©verser un calendrier .ics</button>
                <button class="btn" type="button" onclick="renderCalendarLibrary()">Ouvrir la biblioth√®que de calendriers</button>
                <button class="btn" type="button" onclick="testCalendarConnection()">Tester la connexion</button>
              </div>
              <div id="uploaded_calendars_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>
            <div class="form-actions"><button type="button" class="save-btn" onclick="saveAppointments()">Enregistrer les rendez-vous</button></div>
          </form>
        </div>

        <!-- RESERVATION TAB -->
        <div id="reservation" class="tab-content">
          <div class="info-box">üçΩÔ∏è Param√®tres de r√©servation pour restaurants et lieux : tailles de groupe, acomptes et pr√©f√©rences de table.</div>
          <form id="reservationForm">
            <div class="section-card">
              <div class="section-header">
                <h2 style="margin:0;">Param√®tres de r√©servation</h2>
                <div style="display:flex; align-items:center; gap:12px;">
                  <button type="button" class="toggle-btn" data-checkbox="resv_enabled" role="switch" aria-checked="false">
                    <span class="dot"></span>
                    <span class="label">D√©sactiv√©</span>
                  </button>
                  <input type="checkbox" id="resv_enabled" name="reservation.enabled" style="display:none" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label for="resv_party_default">Taille de groupe par d√©faut</label><input id="resv_party_default" name="reservation.party_default" type="number" min="1" value="2"/></div>
                <div class="form-group"><label for="resv_table_pref">Pr√©f√©rence de table</label><input id="resv_table_pref" name="reservation.table_pref" placeholder="Fen√™tre / Banquette / N'importe"/></div>
              </div>
              <div class="form-group"><label><input type="checkbox" id="resv_deposit" name="reservation.deposit_required" /> Exiger un acompte</label> <input id="resv_deposit_amount" name="reservation.deposit_amount" type="number" min="0" value="0" style="margin-left:8px; width:120px;"/></div>
              <div class="helper-text">Les acomptes r√©duisent les absences et prot√®gent les revenus ‚Äî gardez-les modestes et communiquez clairement la politique aux clients.</div>
              <div class="form-group"><label for="resv_booking_url">URL de r√©servation en ligne</label><input id="resv_booking_url" name="reservation.booking_url" type="url" placeholder="https://example.com/book"/></div>
              <div class="form-group"><label for="resv_cancel_policy">Politique d'annulation</label><textarea id="resv_cancel_policy" name="reservation.cancellation_policy" placeholder="Annulation autoris√©e jusqu'√† 24 heures avant..."></textarea></div>
            </div>
            <div class="form-actions"><button type="button" class="save-btn" onclick="saveReservation()">Enregistrer les param√®tres de r√©servation</button></div>
          </form>
        </div>

        <!-- TECHNICAL ASSISTANCE TAB removed temporarily -->
    <!-- DATA & PRIVACY TAB -->
    <div id="privacy" class="tab-content">
      <div class="info-box">üîí Donn√©es & Confidentialit√© (RGPD/GDPR) ‚Äî contr√¥les pour le consentement, la r√©tention, la gestion des donn√©es personnelles et les exportations de donn√©es.</div>

      <form id="privacyForm">
        <div class="section-card">
          <h2 style="margin-top:0;">Contr√¥les de confidentialit√©</h2>

          <div class="form-group">
            <label><input type="checkbox" id="privacy_consent_enabled" name="privacy.consent.enabled" /> Afficher l'invite de consentement aux utilisateurs</label>
          </div>

          <div class="form-group">
            <label for="privacy_consent_text">Texte de l'invite de consentement</label>
            <input id="privacy_consent_text" name="privacy.consent.text" placeholder="Nous utilisons ces informations pour am√©liorer le service. Consentez-vous ?" />
            <div class="helper-text">Gardez le texte de consentement court et pr√©cis. Il est affich√© aux utilisateurs finaux.</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="privacy_retention_days">R√©tention (jours)</label>
              <input id="privacy_retention_days" name="privacy.retention_days" type="number" min="0" value="0" />
              <div class="muted">0 = ne pas conserver les transcriptions de conversation</div>
            </div>
            <div class="form-group">
              <label>R√©daction des donn√©es personnelles (PII)</label>
              <div><label><input type="checkbox" id="privacy_pii_redact" name="privacy.pii_redaction" /> Enable automated PII redaction for transcripts</label></div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_email" /> Masquer les e‚Äëmails</label>
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_phone" /> Masquer les num√©ros de t√©l√©phone</label>
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_names" /> Masquer les noms des clients</label>
              </div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;"><button class="btn" type="button" onclick="runPiiRedactionPreview()">Aper√ßu de la r√©daction</button><button class="btn" type="button" onclick="purgeExpiredData()" style="background:#d9534f;">Purger les donn√©es expir√©es</button></div>
              <div class="helper-text">La r√©daction masque les noms, e‚Äëmails et num√©ros de t√©l√©phone pour r√©duire les risques li√©s √† la vie priv√©e ‚Äî cela peut limiter les d√©tails utiles au d√©pannage dans les transcriptions.</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="privacy_data_residency">Localisation des donn√©es</label>
              <select id="privacy_data_residency" name="privacy.data_residency">
                <option value="eu">Union europ√©enne (UE)</option>
                <option value="us">√âtats-Unis (US)</option>
                <option value="other">Autre</option>
              </select>
            </div>
            <div class="form-group">
              <label for="privacy_dpa_url">DPA / Privacy policy URL</label>
              <input id="privacy_dpa_url" name="privacy.dpa_url" placeholder="https://example.com/privacy" />
            </div>
          </div>

          <div class="section-title" style="margin-top:12px;">Account Data Actions</div>
          <div class="form-row" style="align-items:center; gap:12px;">
            <button type="button" id="export_my_data" class="save-btn">Exporter mes donn√©es</button>
            <button type="button" id="delete_my_data" class="save-btn" style="background:#d9534f;">Supprimer mes donn√©es</button>
            <button type="button" id="export_audit_log" class="btn">Exporter le journal d'audit</button>
            <button type="button" id="simulate_consent" class="btn">Simuler la banni√®re de consentement</button>
            <div class="muted">Les exports produisent un ZIP/JSON contenant les FAQ, instantan√©s et d√©tails de profil. La suppression n'enl√®ve que les donn√©es de d√©monstration stock√©es localement.</div>
            <div class="helper-text">Astuce : pour la conformit√© RGPD, d√©finissez de courtes dur√©es de conservation et proposez des options d'export/suppression de donn√©es aux utilisateurs. Consultez votre conseiller juridique pour les d√©ploiements en production.</div>
          </div>
        </div>

        <div id="snaps_section" class="section-card" style="margin-top:12px;">
          <div class="section-header">
            <h3 style="margin:0;">Stockage & Instantan√©s de conversation</h3>
            <div style="display:flex; align-items:center; gap:12px;">
              <button type="button" class="toggle-btn" data-checkbox="snaps_store_enabled" role="switch" aria-checked="false">
                <span class="dot"></span>
                <span class="label">D√©sactiv√©</span>
              </button>
              <input type="checkbox" id="snaps_store_enabled" name="storage.store_snaps" style="display:none" />
            </div>
          </div>
          <div class="helper-text" style="margin-top:6px;">Ne conservez que les extraits n√©cessaires. Faites attention aux donn√©es personnelles et aux r√®gles de r√©tention ; envisagez de ne stocker que les intentions lorsque c'est possible.</div>

          <div class="form-row">
            <div class="form-group">
              <label for="snaps_last_n">Conserver les N derni√®res questions client</label>
              <input id="snaps_last_n" name="storage.snaps_last_n" type="number" min="0" value="10" />
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="snaps_unresolved" name="storage.snaps_unresolved" /> Conserver les questions non r√©solues</label>
            </div>
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="snaps_intents_only" name="storage.snaps_intents_only" /> Stocker uniquement les intentions (pas de transcriptions compl√®tes)</label>
          </div>

          <div style="margin-top:8px; display:flex; gap:12px; align-items:center;">
            <button type="button" id="snaps_export_btn" class="btn">Exporter les instantan√©s de conversation</button>
            <div id="snaps_preview" style="flex:1; max-height:120px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
          </div>
        </div>

        <div class="form-actions"><button type="button" class="save-btn" onclick="savePrivacy()">Enregistrer la confidentialit√© des donn√©es</button></div>
      </form>
    </div>

        <!-- ESCALATION TAB -->
    <div id="escalation" class="tab-content">
      <div class="info-box">
        üë§ Configurez comment et quand les appels sont escalad√©s vers des techniciens humains, et configurez votre √©quipe de support.
      </div>

      <form id="escalationForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Param√®tres d'escalade</h2>

          <div class="section-title">√âquipe de support</div>

          <div class="form-group">
            <label>Adresse e‚Äëmail de l'√©quipe de support</label>
            <input type="email" id="teamEmail" value="support@company.com" placeholder="equipe@exemple.com">
          </div>

          <div class="form-group">
            <label>File d'escalade</label>
            <select id="escalationQueue">
              <option value="priority">File prioritaire (imm√©diate)</option>
              <option value="standard">File standard (5-10 min)</option>
              <option value="scheduled">Rappel programm√© (prochain disponible)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="oncall_calendar">URL du calendrier d'astreinte</label>
            <input id="oncall_calendar" placeholder="https://calendar.example.com/oncall" />
            <div class="helper-text">Optionnel : fournissez un calendrier d'astreinte pour que les escalades puissent √™tre rout√©es vers les techniciens de garde.</div>
          </div>

          <div class="form-group">
            <label>Files de comp√©tences</label>
            <div class="helper-text">Comp√©tences s√©par√©es par des virgules (ex. : Fiber,xDSL,WiFi,VoIP). Le routage fera correspondre les comp√©tences aux profils des techniciens.</div>
            <input id="skill_queues" placeholder="Fiber,xDSL,WiFi,VoIP" />
          </div>

          <div class="section-title">Objectifs SLA</div>
          <div class="form-row">
            <div class="form-group"><label for="sla_p1">P1 : R√©ponse (min)</label><input id="sla_p1" type="number" min="0" value="15" /></div>
            <div class="form-group"><label for="sla_p1_res">P1 : R√©solution (heures)</label><input id="sla_p1_res" type="number" min="0" value="2" /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="sla_p2">P2 : R√©ponse (min)</label><input id="sla_p2" type="number" min="0" value="60" /></div>
            <div class="form-group"><label for="sla_p2_res">P2 : R√©solution (heures)</label><input id="sla_p2_res" type="number" min="0" value="8" /></div>
          </div>

          <div class="section-title">Motifs d'escalade</div>

          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="esc_unknown_issue" checked>
              <label for="esc_unknown_issue">Probl√®me inconnu</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_customer_request" checked>
              <label for="esc_customer_request">Demande client</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_complex_billing" checked>
              <label for="esc_complex_billing">Probl√®me de facturation complexe</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_special_case" checked>
              <label for="esc_special_case">Cas sp√©cial / Exception</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_angry_customer">
              <label for="esc_angry_customer">D√©tection client frustr√©</label>
            </div>
          </div>

          <div class="section-title">Heures d'ouverture</div>

          <div class="form-row">
            <div class="form-group">
              <label>Heures de support (D√©but)</label>
              <input type="time" id="supportHourStart" value="09:00">
            </div>
            <div class="form-group">
              <label>Heures de support (Fin)</label>
              <input type="time" id="supportHourEnd" value="17:00">
            </div>
          </div>

          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="weekend_support">
              <label for="weekend_support">Support disponible le week-end</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="holidays_support">
              <label for="holidays_support">Support disponible les jours f√©ri√©s</label>
            </div>
          </div>

          <div class="form-group">
            <label>R√©ponse automatique hors heures</label>
            <textarea id="afterHoursMessage" placeholder="Nous sommes actuellement ferm√©s. Votre appel sera mis en file et trait√© pendant les heures d'ouverture...">Nous sommes actuellement ferm√©s. Votre appel sera mis en file et trait√© pendant les heures d'ouverture. Veuillez laisser un message.</textarea>
          </div>

          <div class="section-title">Liste d'astreinte</div>
          <div style="display:flex; gap:12px; align-items:center;">
            <button type="button" class="btn" id="add_oncall_btn">Ajouter une entr√©e d'astreinte</button>
            <button type="button" class="btn" id="test_escalation_btn">Tester l'alerte</button>
            <div class="helper-text" style="margin-left:8px;">Liez les calendriers t√©l√©vers√©s aux entr√©es d'astreinte, ou ajoutez des contacts manuellement. Les alertes sont simul√©es c√¥t√© client.</div>
          </div>
          <div id="oncall_roster_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto;"></div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveEscalation()">Enregistrer les param√®tres d'escalade</button>
        </div>
      </form>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
      <div class="info-box">
        üìä Voir analytics and questions asked by customers to improve your AI agent.
      </div>

      <div class="section-card">
        <h2 style="margin-top: 0;">Call Analytics</h2>

        <div class="form-row">
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Total Calls</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">1,247</h3>
          </div>
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Resolved by AI</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">78%</h3>
          </div>
        </div>

        <div class="form-row" style="margin-top: 16px;">
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Escalated to Humans</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">22%</h3>
          </div>
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Avg. Resolution Time</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">2m 34s</h3>
          </div>
        </div>

        <div class="section-title">Top Customer Questions</div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border);">
              <th style="text-align: left; padding: 12px; color: var(--fg); font-weight: 600;">Question</th>
              <th style="text-align: center; padding: 12px; color: var(--fg); font-weight: 600;">Count</th>
              <th style="text-align: center; padding: 12px; color: var(--fg); font-weight: 600;">Resolution Rate</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">How do I reset my password?</td>
              <td style="text-align: center; color: var(--muted);">245</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">95%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">Why is my service down?</td>
              <td style="text-align: center; color: var(--muted);">189</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">78%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">How do I upgrade my plan?</td>
              <td style="text-align: center; color: var(--muted);">156</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">92%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">What is my current bill?</td>
              <td style="text-align: center; color: var(--muted);">134</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">98%</td>
            </tr>
            <tr>
              <td style="padding: 12px; color: var(--fg);">How do I cancel my service?</td>
              <td style="text-align: center; color: var(--muted);">98</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">35%</td>
            </tr>
          </tbody>
        </table>

        <div class="section-title">Export Data</div>

        <div style="display: flex; gap: 12px; margin-top: 16px;">
          <button type="button" class="save-btn" onclick="exportAnalytics('csv')">Exporter en CSV</button>
          <button type="button" class="save-btn" onclick="exportAnalytics('pdf')">Exporter en PDF</button>
        </div>

        <div class="section-title">Intent Trends (Custom Range)</div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
          <label style="min-width:80px;">From</label><input type="date" id="intents_from" />
          <label style="min-width:50px;">To</label><input type="date" id="intents_to" />
          <button class="btn" type="button" onclick="loadIntentTrends()">Load</button>
          <button class="btn" type="button" onclick="exportIntentCSV()">Exporter les intentions (CSV)</button>
        </div>
        <div id="intent_trends_preview" style="margin-top:12px; max-height:180px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>

        <div class="section-title">Storage & Analytics</div>
        <div class="section-card">
          <h3 style="margin-top:0;">Local Storage & Telemetry</h3>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn" type="button" onclick="renderStorageAnalytics()">Refresh Storage Voir</button>
            <button class="btn" type="button" onclick="exportAllLocalStorage()">Exporter tout le stockage</button>
            <button class="btn" type="button" onclick="document.getElementById('import_storage_file').click()">Import Storage JSON</button>
            <input id="import_storage_file" type="file" accept="application/json" style="display:none" onchange="handleImportLocalStorageFile(event)" />
            <label style="display:flex; align-items:center; gap:8px; margin-left:8px;"><input type="checkbox" id="telemetry_opt_in" /> Enable telemetry (anonymized events)</label>
          </div>
          <div class="helper-text" style="margin-top:8px;">Inspect localStorage keys used by this demo and export/import data. Telemetry collects anonymized event counts for UX testing only.</div>
          <div style="margin-top:12px; display:flex; gap:12px;">
            <div style="flex:1; min-width:260px;">
              <strong>Storage Keys</strong>
              <div id="storage_keys_list" style="margin-top:8px; max-height:240px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
            <div style="flex:1; min-width:260px;">
              <strong>Analytics Events</strong>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;"><button class="btn" onclick="generateSampleEvent()">G√©n√©rer un √©v√©nement exemple</button><button class="btn" onclick="clearAnalyticsEvents()">Effacer les √©v√©nements</button></div>
              <div id="analytics_events_list" style="margin-top:8px; max-height:240px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <label style="min-width:160px;">R√©tention des donn√©es (jours)</label>
            <input id="storage_retention_days" type="number" min="1" value="90" style="width:80px;" />
            <button class="btn" onclick="purgeStorageOlderThan()">Purger les anciennes donn√©es</button>
            <button class="btn" onclick="clearAllD√©moStorage()" style="background:#d9534f;">Effacer le stockage de d√©monstration</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TRANSCRIPTS / CONVERSATIONS TAB -->
    <div id="transcripts" class="tab-content">
      <div class="info-box">üóÇÔ∏è G√©rer les transcriptions de conversation : recherche, aper√ßu de la r√©daction, export s√©lectif, signalement et purge.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:center;">
          <input id="transcript_search" placeholder="Rechercher des transcriptions ou le nom du client" style="flex:1; padding:8px;" />
          <button class="btn" type="button" onclick="renderConversations()">Rechercher</button>
          <button class="btn" type="button" onclick="exportSelectedConversations()">Exporter la s√©lection</button>
          <button class="btn" type="button" onclick="purgeAllConversations()" style="background:#d9534f;">Tout purger</button>
        </div>
        <div class="helper-text">S√©lectionnez des conversations pour pr√©visualiser la r√©daction ou exporter. La purge supprime les transcriptions stock√©es localement (d√©mo uniquement).</div>
        <div id="conversations_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-height:300px; overflow:auto;"></div>
      </div>
      <div class="section-card" style="margin-top:12px;">
        <h3 style="margin-top:0;">Aper√ßu de la r√©daction</h3>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="min-width:120px;">Masquer les e‚Äëmails</label><input type="checkbox" id="redact_email" checked />
          <label style="min-width:120px;">Masquer les num√©ros</label><input type="checkbox" id="redact_phone" checked />
          <label style="min-width:120px;">Masquer les noms</label><input type="checkbox" id="redact_names" />
        </div>
        <div id="redaction_preview" style="margin-top:12px; white-space:pre-wrap; font-family:monospace; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
      </div>
    </div>

    <!-- TELEPHONY & CRM TAB -->
    <div id="telephony" class="tab-content">
      <div class="info-box">üìû T√©l√©phonie & CRM integration ‚Äî identify callers automatically and surface account info.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">T√©l√©phonie & CRM</h2>
        <div style="margin-bottom:12px;">
          <div class="helper-text">Guide rapide : Connectez une URL de recherche CRM (utilisez le placeholder <code>{{caller}}</code>), activez les champs √† afficher en screen-pop et d√©finissez le comportement de secours pour les appelants inconnus.</div>
          <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">
            <strong>Astuce :</strong> Gardez votre jeton d'authentification CRM s√©curis√©. En production, pr√©f√©rez un proxy c√¥t√© serveur plut√¥t que d'int√©grer les jetons dans l'interface cliente.
          </div>
        </div>
          <div class="form-group"><label for="crm_lookup_url">URL de recherche CRM</label>
          <input id="crm_lookup_url" placeholder="https://crm.example.com/lookup?phone={{caller}}" />
          <div class="helper-text">URL √† appeler avec l'ID appelant ; utilisez le placeholder {{caller}}. Ajoutez le jeton d'authentification ci-dessous.</div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="crm_auth_token">CRM Auth Token</label><input id="crm_auth_token" placeholder="Bearer xxxxx" /></div>
          <div class="form-group"><label for="crm_match_strategy">Customer Match Strategy</label>
            <select id="crm_match_strategy"><option value="phone">T√©l√©phone</option><option value="account">ID de compte</option><option value="contract">N¬∞ de contrat</option></select></div>
        </div>
        <div class="form-group"><label>Screen-pop fields</label>
          <div class="checkbox-group" style="margin-top:8px;">
            <label class="checkbox-item"><input type="checkbox" id="crm_show_plan" /> Forfait</label>
            <label class="checkbox-item"><input type="checkbox" id="crm_show_device" /> Appareil</label>
            <label class="checkbox-item"><input type="checkbox" id="crm_show_outage" /> Derni√®re panne</label>
          </div>
        </div>
        <div class="form-group"><label>Comportement en cas d'absence de correspondance</label>
          <select id="crm_failover"><option value="ask">Demander le compte √† l'appelant</option><option value="create_lead">Cr√©er un lead</option><option value="proceed_guest">Continuer en tant qu'invit√©</option></select>
        </div>
        <div class="form-row" style="margin-top:12px;">
            <div class="form-group"><label><input type="checkbox" id="tele_auto_open_ticket" /> Ouvrir automatiquement un ticket √† l'appel entrant</label>
            <div class="helper-text">Lorsque activ√©, les appels entrants cr√©eront un ticket brouillon (modifiable avant envoi).</div>
          </div>
          <div class="form-group"><label for="tele_default_queue">Default support queue</label><input id="tele_default_queue" placeholder="e.g., general-support" /></div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="form-group"><label for="tele_caller_risk">Caller risk threshold (%)</label><input id="tele_caller_risk" type="number" min="0" max="100" value="50" /></div>
          <div class="form-group"><label for="tele_phone_hook">Phone webhook (optional)</label><input id="tele_phone_hook" placeholder="https://hook.example.com/inbound" /></div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveTelephony()">Enregistrer les param√®tres de t√©l√©phonie</button></div>
    </div>

    <!-- LIVE TRANSCRIPTION / ASR TAB -->
    <div id="transcription" class="tab-content">
      <div class="info-box">üéôÔ∏è Configurez la transcription en temps r√©el, le moteur ASR et les r√®gles de confidentialit√©.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Transcription en direct</h2>
        <div style="margin-bottom:12px;">
          <div class="helper-text">Guide rapide : Choisissez un moteur ASR (cloud ou local), s√©lectionnez la langue pour une meilleure pr√©cision et d√©cidez si vous avez besoin de streaming en direct ou de transcription par lot. Configurez la diarisation pour s√©parer les intervenants et activez la r√©daction PII si vous stockez des transcriptions.</div>
          <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Lors des tests : commencez par un petit √©chantillon audio, ajustez le <strong>seuil de confiance</strong> pour contr√¥ler les textes consid√©r√©s comme incertains, et utilisez la <strong>conservation des transcrits</strong> avec pr√©caution pour √©quilibrer d√©pannage et confidentialit√©.</div>
        </div>
        <div class="form-row">
            <div class="form-group"><label for="asr_engine">Moteur ASR</label>
            <select id="asr_engine"><option value="openai">OpenAI</option><option value="whisper_local">Whisper (local)</option><option value="google_stream">Google Streaming</option></select>
            <div class="helper-text">S√©lectionnez le fournisseur de reconnaissance vocale. Les services cloud offrent souvent une meilleure pr√©cision ; les options locales conservent l'audio en interne pour la confidentialit√©.</div>
          </div>
          <div class="form-group"><label for="asr_language">Langue</label><input id="asr_language" placeholder="en-US" />
            <div class="helper-text">D√©finissez la langue/dialecte principal utilis√© lors des appels (ex. : <code>en-US</code>, <code>es-ES</code>) pour am√©liorer la reconnaissance.</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label><input type="checkbox" id="asr_streaming" /> Streaming (faible latence)</label>
            <div class="helper-text">Activez pour des sous-titres en temps r√©el ou une assistance en appel. Le streaming peut augmenter les co√ªts et la complexit√©.</div>
          </div>
          <div class="form-group"><label for="asr_confidence">Seuil de confiance (%)</label><input id="asr_confidence" type="number" min="0" max="100" value="70" />
            <div class="helper-text">D√©finissez le score de confiance minimal en-de√ß√† duquel le syst√®me doit signaler le texte comme incertain (utile pour les r√®gles d'auto-escalade).</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label><input type="checkbox" id="asr_diarization" /> Diarisation (appelant/agent)</label>
            <div class="helper-text">Lorsqu'activ√©e, les transcriptions indiqueront quel intervenant a prononc√© chaque ligne ‚Äî utile pour la formation des agents et des notes de ticket pr√©cises.</div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="asr_profanity_filter" /> Filtre de grossi√®ret√©s</label>
            <div class="helper-text">Masquez ou supprimez les grossi√®ret√©s des transcrits stock√©s et des vues publiques.</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="transcript_retention">Conserver les transcrits (jours)</label><input id="transcript_retention" type="number" min="0" value="30" />
            <div class="helper-text">D√©finissez la dur√©e de conservation selon votre politique de confidentialit√© ‚Äî 0 = ne pas conserver les transcrits.</div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="transcript_pii_redact" /> R√©diger les PII lors de l'enregistrement</label>
            <div class="helper-text">Supprimez ou masquez les noms, e‚Äëmails et num√©ros de t√©l√©phone lors de l'enregistrement afin de r√©duire les risques li√©s √† la confidentialit√© (peut enlever des d√©tails utiles au d√©pannage).</div>
          </div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveTranscription()">Enregistrer les param√®tres de transcription</button></div>
    </div>

    <!-- DIAGNOSTICS & TOOLS TAB -->
    <div id="diagnostics" class="tab-content">
      <div class="info-box">üõ†Ô∏è Configure remote diagnostic tools and safety limits for automatic actions.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Diagnostics & Outils</h2>
        <div class="helper-text">Guide rapide diagnostics : Ajoutez de petites d√©finitions d'outils HTTP/SSH que l'agent peut appeler pour effectuer des v√©rifications (ping, red√©marrage, collecte de journaux). Prot√©gez les points de terminaison et d√©finissez des d√©lais/limites conservateurs pour les ex√©cutions automatiques.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Astuce : pour les op√©rations √† distance qui modifient l'√©tat d'un appareil (red√©marrage, mise √† jour du firmware), d√©finissez la confirmation d'action sur <strong>Requise</strong> dans les capacit√©s et activez la journalisation d'audit.</div>
        <div id="tools_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <div style="flex:1;">
            <button class="btn" type="button" onclick="addToolModifieror()">Ajouter un outil</button>
            <button class="btn" type="button" onclick="importTools()">Importer des outils (JSON)</button>
          </div>
          <div style="min-width:320px; color:var(--muted); font-size:0.95rem;">Chaque outil peut avoir une URL, une m√©thode (GET/POST), un d√©lai et une limite de s√©curit√©. Testez les outils en environnement de staging avant de les activer en production.</div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveDiagnostics()">Enregistrer les param√®tres de diagnostics</button></div>
    </div>

    <!-- PLAYBOOKS TAB -->
    <div id="playbooks" class="tab-content">
      <div class="info-box">üìö Incident playbooks (runbooks) for common telecom/IT problems.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Playbooks Library</h2>
        <div class="helper-text">Les playbooks (runbooks) sont des proc√©dures √©tape par √©tape que votre agent peut ex√©cuter lorsque des conditions sp√©cifiques sont remplies ‚Äî par exemple : "If outage_detected ‚Üí run diagnostics ‚Üí notify NOC ‚Üí open ticket".</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Guide rapide : Gardez les playbooks courts et explicites. Chaque playbook doit inclure : une condition de d√©clenchement claire, un ensemble d'√©tapes automatis√©es d√©fini et une √©tape d'escalade vers un humain ou l'astreinte si la r√©solution automatis√©e √©choue.</div>
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <div>
            <button class="btn" onclick="addPlaybook()">Ajouter un playbook</button>
            <button class="btn" onclick="importPlaybooks()">Importer des runbooks</button>
          </div>
          <div style="margin-left:12px; color:var(--muted); font-size:0.95rem;">Astuce : testez les playbooks en staging et ajoutez des √©tapes de journalisation pour que les actions soient audit√©es. Marquez les √©tapes destructrices (red√©marrages, modifications de config) pour exiger une confirmation humaine.</div>
        </div>
        <div id="playbooks_list" style="margin-top:12px; max-height:220px; overflow:auto;">
          <div class="card" style="padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--panel);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div>
                <strong>Exemple : Playbook panne NOC</strong>
                <div style="color:var(--muted); font-size:0.95rem; margin-top:6px;">D√©clencheur : <code>outage_detected</code></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn" type="button" onclick="(window.clonePlaybook||(()=>alert('Clone not implemented')))('noc_outage')">Dupliquer</button>
                <button class="btn" type="button" onclick="(window.testPlaybook||(()=>alert('Tester not implemented')))('noc_outage')">Tester</button>
              </div>
            </div>
            <ol style="margin-top:10px; padding-left:20px;">
              <li>Ex√©cuter des tests de ping et de d√©bit pour v√©rifier la connectivit√©.</li>
              <li>Si les tests montrent une panne g√©n√©ralis√©e, avertir l'√©quipe NOC et ouvrir un ticket via le fournisseur de ticketing configur√©.</li>
              <li>Tenter un red√©marrage √† distance de l'appareil uniquement si c'est s√ªr ; cette √©tape est signal√©e comme n√©cessitant une confirmation humaine.</li>
            </ol>
            <div style="margin-top:8px;" class="helper-text">Cet exemple s√ªr montre une s√©quence de diagnostic en lecture seule ; les √©tapes destructrices sont explicitement signal√©es et doivent n√©cessiter une confirmation avant ex√©cution.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NETWORK STATUS TAB -->
    <div id="network" class="tab-content">
      <div class="info-box">üì° Int√©gration du statut r√©seau et contr√¥les du mode panne.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Network Status</h2>
        <div class="helper-text">Guide rapide r√©seau : Connectez une API de statut pour permettre au syst√®me de d√©tecter automatiquement les pannes. Utilisez le commutateur de d√©tection automatique pour activer le mode panne et configurez un mod√®le de message de diffusion clair pour les annonces.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Astuce : Pr√©f√©rez un point d'acc√®s API en lecture seule et testez les r√®gles de d√©tection en staging avant d'activer le mode panne automatique.</div>
        <div class="form-group" style="margin-top:10px;"><label for="status_api">URL de l'API de statut (lecture seule)</label><input id="status_api" placeholder="https://status.example.com/api" />
          <div class="helper-text">Point de terminaison renvoyant l'√©tat des syst√®mes/services (ex. JSON avec l'√©tat des composants). Le panneau consid√®re cela comme lecture seule ‚Äî pr√©f√©rez un proxy c√¥t√© serveur en production.</div>
        </div>
        <div class="form-group"><label><input type="checkbox" id="auto_outage_detect" /> D√©tection automatique des pannes</label>
          <div class="helper-text">Lorsque activ√©, le syst√®me passera en mode panne √† partir de l'API de statut ou des r√®gles configur√©es et appliquera les comportements li√©s aux pannes (ex. : mod√®les de r√©ponse diff√©rents, routage vers le NOC).</div>
        </div>
        <div class="form-group"><label for="outage_broadcast">Outage broadcast script</label><textarea id="outage_broadcast" placeholder="Broadcast message template"></textarea>
          <div class="helper-text">Un court mod√®le de message utilis√© pour les diffusions (appels, messages IVR ou SMS). Incluez des placeholders comme <code>{{service}}</code> et <code>{{eta}}</code> pour du contenu dynamique.</div>
        </div>
      </div>
    </div>

    <!-- TICKETING & SLA TAB -->
    <div id="ticketing" class="tab-content">
      <div class="info-box">üé´ Configure ticketing integration, auto-create rules and SLA targets.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Ticketing & SLA</h2>
        <div class="helper-text">Guide rapide ticketing : Connectez votre fournisseur de ticketing pour cr√©er et router automatiquement les tickets. D√©finissez des r√®gles de cr√©ation automatique claires et des objectifs SLA raisonnables pour que le syst√®me sache quand escalader vers des humains.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Astuce : commencez par des r√®gles de cr√©ation conservatrices (ex. : faible confiance OU outage_detected) et ajustez apr√®s observation des faux positifs.</div>
        <div class="form-row" style="margin-top:10px;"><div class="form-group"><label for="ticketing_provider">Fournisseur</label>
            <select id="ticketing_provider"><option value="zendesk">Zendesk</option><option value="jira">JIRA</option><option value="servicenow">ServiceNow</option><option value="none">None</option></select>
            <div class="helper-text">Choisissez le syst√®me de ticketing √† int√©grer. En production, configurez les identifiants API dans un stockage serveur s√©curis√©.</div>
          </div>
          <div class="form-group" style="flex:1;"><label for="ticket_create_rule">Auto-create rule</label>
            <input id="ticket_create_rule" placeholder="when: confidence &lt; 50% OR outage_detected" />
            <div class="helper-text">A simple rule language: use conditions like <code>confidence &lt; 50%</code> or <code>outage_detected</code> to trigger ticket creation automatically.</div>

            <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <select id="rb_condition" style="min-width:180px;">
                <option value="outage_detected">outage_detected</option>
                <option value="confidence">confidence</option>
                <option value="satisfaction">satisfaction</option>
                <option value="high_priority_account">high_priority_account</option>
                <option value="customer_tier">customer_tier</option>
                <option value="failed_checks">failed_checks</option>
              </select>
              <select id="rb_operator" style="width:80px;">
                <option value="=">=</option>
                <option value=">">&gt;</option>
                <option value="<">&lt;</option>
                <option value="contains">contains</option>
              </select>
              <input id="rb_value" placeholder="value (optional)" style="min-width:120px; padding:8px;" />
              <button class="btn" type="button" onclick="addRuleCondition()">Ajouter une condition</button>
              <button class="btn" type="button" onclick="insertRuleTemplate()">Ins√©rer un exemple de mod√®le</button>
            </div>
          </div></div>
        <div class="form-row" style="margin-top:8px;"><div class="form-group"><label for="sla_response">SLA : R√©ponse (min)</label><input id="sla_response" type="number" min="0" value="30" />
            <div class="helper-text">Temps maximal pour la premi√®re r√©ponse (en minutes) afin de respecter vos engagements SLA.</div>
          </div>
          <div class="form-group"><label for="sla_resolution">SLA : R√©solution (heures)</label><input id="sla_resolution" type="number" min="0" value="4" />
            <div class="helper-text">D√©lai cible pour r√©soudre les incidents (en heures). Utilisez des objectifs r√©alistes pour √©viter les promesses excessives.</div>
          </div></div>
      </div>
    </div>

    <!-- STORAGE & INSIGHTS TAB -->
    <div id="storage" class="tab-content">
      <div class="info-box">üíæ Stockage et insights : choisissez quoi conserver et pendant combien de temps.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Storage & Insights</h2>
        <div class="helper-text">Guide rapide stockage : D√©cidez des transcrits, insights et r√©sum√©s de questions √† conserver pour les rapports et l'entra√Ænement. Gardez des dur√©es courtes pour les donn√©es sensibles et plus longues pour l'analytique lorsque c'est autoris√©.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Astuce : utilisez de courtes dur√©es de conservation pour les √©l√©ments contenant des PII et exportez des r√©sum√©s pour l'analytique √† long terme plut√¥t que des transcrits bruts.</div>
        <div class="form-group" style="margin-top:12px;"><label><input type="checkbox" id="store_top_questions" /> Store top questions</label>
          <div class="helper-text">Enable to collect and persist the most common user questions for training and FAQ generation.</div>
        </div>
        <div class="form-group"><label for="insights_retention">Insights retention (days)</label><input id="insights_retention" type="number" min="0" value="30" />
          <div class="helper-text">How many days to keep aggregated insights and trend data. Shorter retention reduces privacy risk and storage cost.</div>
        </div>
        <div style="margin-top:8px; display:flex; gap:12px; align-items:center;"><button class="btn" onclick="exportInsightsCSV()">Exporter les insights (CSV)</button>
          <div style="color:var(--muted); font-size:0.95rem;">Export current analytic summaries for offline review or to import into BI tools.</div>
        </div>
      </div>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="payments" class="tab-content dev-only">
      <div class="info-box">üí≥ Configure payment provider, deposit capture, and view refunds/logs.</div>
      <form id="paymentsForm">
        <div class="section-card">
          <h2 style="margin-top:0;">Payment Fournisseur</h2>
          <div class="form-row">
            <div class="form-group"><label for="payment_provider">Fournisseur</label>
              <select id="payment_provider" name="payments.provider"><option value="stripe">Stripe</option><option value="paypal">PayPal</option><option value="none">None</option></select></div>
            <div class="form-group"><label for="payment_mode">Mode</label>
              <select id="payment_mode" name="payments.mode"><option value="test">Tester</option><option value="live">Live</option></select></div>
          </div>
          <div class="form-group"><label for="payment_api_key">API Key / Client ID</label><input id="payment_api_key" name="payments.api_key" placeholder="sk_test_..." /></div>
          <div class="section-title">Payment Gestionnaire (PSP)</div>
          <div class="helper-text">Connectez-vous √† votre gestionnaire de paiement local ou PSP pour g√©rer les mandats, paiements et la conformit√© juridique. Il s'agit d'une d√©mo c√¥t√© client ; en production, une int√©gration serveur s√©curis√©e est requise.</div>
          <div class="form-row">
            <div class="form-group"><label for="payment_manager">Gestionnaire</label>
              <select id="payment_manager" name="payments.manager"><option value="none">None</option><option value="stripe">Stripe</option><option value="paypal">PayPal</option><option value="mangopay">MangoPay</option><option value="hipay">HiPay</option></select></div>
            <div class="form-group"><label for="payment_manager_merchant">Merchant / Client ID</label><input id="payment_manager_merchant" name="payments.manager_merchant" placeholder="merchant_..." /></div>
          </div>
          <div class="form-group"><label for="payment_manager_secret">Secret / API Key</label><input id="payment_manager_secret" name="payments.manager_secret" placeholder="(store securely; local demo only)" /></div>
          <div style="display:flex; gap:8px; align-items:center;"><button class="btn" type="button" onclick="connectPaymentGestionnaire()">Connect Payment Gestionnaire</button><button class="btn" type="button" onclick="disconnectPaymentGestionnaire()">D√©connecter</button><div id="payment_manager_status" style="color:var(--muted); margin-left:8px;">Non connect√©</div></div>

          <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
            <h3 style="margin:0 0 6px;">Invoice Platform (Compliance)</h3>
            <div class="helper-text">Optionally register a certified invoice platform here. This front-end demo stores connection details locally; in production this must be done via secure server-side integration and OAuth.</div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <select id="invoice_platform_select_pay" style="min-width:220px">
                <option value="none">None</option>
                <option value="chorus_pro">Chorus Pro</option>
                <option value="sage">Sage</option>
                <option value="dgi">DGI / Local Platform</option>
                <option value="custom">Other (Custom)</option>
              </select>
              <input id="invoice_platform_merchant_pay" placeholder="Merchant / Account ID" style="padding:8px;" />
              <input id="invoice_platform_api_pay" placeholder="API Key / Token" style="padding:8px;" />
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
              <button class="btn" type="button" onclick="connectInvoicePlatform(true)">Register Platform (demo)</button>
              <button class="btn" type="button" onclick="disconnectInvoicePlatform()">D√©connecter</button>
              <div id="invoice_platform_status_pay" style="color:var(--muted); margin-left:8px;">Not registered</div>
            </div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="deposit_capture" name="payments.deposit_capture" /> Capturer l'acompte lors de la r√©servation/du devis</label></div>
          <div class="form-row"><div class="form-group"><label for="deposit_amount_default">Montant d'acompte par d√©faut</label><input id="deposit_amount_default" name="payments.deposit_default" type="number" min="0" value="0"/></div>
            <div class="form-group"><label for="refunds_log_link">Journal des remboursements (d√©mo)</label><input id="refunds_log_link" name="payments.refunds_log" placeholder="(lien ou notes)" /></div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="save-btn" onclick="savePaymentSettings()">Enregistrer les param√®tres de paiement</button>
          <button type="button" class="btn" onclick="testPaymentConnector()">Tester le paiement (d√©mo)</button>
          <button type="button" class="btn" onclick="exportPaymentConfig()">Exporter les paiements (JSON)</button>
        </div>
      </form>
    </div>

    <!-- BACKUPS / VERSIONING TAB -->
    <div id="backups" class="tab-content dev-only">
      <div class="info-box">üíæ Versioned exports and restores. Create backups, schedule a demo backup, compare and restore versions.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:center;">
          <button class="save-btn" type="button" onclick="createBackup()">Cr√©er une sauvegarde maintenant</button>
          <button class="btn" type="button" onclick="downloadLatestBackup()">T√©l√©charger le plus r√©cent</button>
          <button class="btn" type="button" onclick="scheduleD√©moBackup()">Programmer une sauvegarde de d√©mo</button>
        </div>
        <div class="helper-text">Les sauvegardes sont stock√©es dans `localStorage` sous la cl√© `backups` pour les besoins de la d√©mo. N'utilisez la planification que pour des d√©monstrations locales.</div>
        <div style="margin-top:12px; max-height:240px; overflow:auto;" id="backups_list"></div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <h4>Assistant vocal IA</h4>
        <p>Conversations naturelles. Aide instantan√©e. Toujours disponible.</p>
      </div>
      <div>
        <h4>Liens rapides</h4>
        <ul>
          <li><a href="index.html">Accueil</a></li>
          <li><a href="record.html">D√©mo</a></li>
          <li><a href="#">Documentation</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <ul>
          <li><a href="mailto:support@company.com">support@company.com</a></li>
          <li><a href="#">+1 (555) 123-4567</a></li>
          <li><a href="#">Suivre sur X</a></li>
        </ul>
      </div>
    </div>
    <div class="container footer-bottom">
      <small>¬© <span id="year"></span> Votre entreprise. Tous droits r√©serv√©s.</small>
    </div>
  </footer>

  <script>
    // Tab switching (defensive) with debug logging
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        console.log('Tab clicked:', tabName);
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(tabName);
        if (!target) {
          console.warn('Tab target not found:', tabName);
          return;
        }
        console.log('Activating target element:', target, 'height=', target.clientHeight);
        target.classList.add('active');
        btn.classList.add('active');
      });
    });

    // --- Simple i18n (English / French) ---
    const I18N = {
      en: {
        headerTitle: 'AI Agent Configuration',
        headerSubtitle: 'Customize your 24/7 technical support assistant to match your business needs',
        export_btn: 'Export Settings (JSON)',
        tabs: {
          presets: 'Presets & Profile',
          personality: 'Branding & Personality',
          capabilities: 'Capabilities & Safeguards',
          telephony: 'Telephony & CRM',
          transcription: 'Transcription & Transcripts',
          diagnostics: 'Diagnostics & Tools',
          playbooks: 'Playbooks (Runbooks)',
          network: 'Network Status & Outage',
          ticketing: 'Ticketing & SLA',
          knowledge: 'Knowledge & Templates',
          appointments: 'Appointments & Reservations',
          quotes: 'Quotes & Payments',
          analytics: 'Storage, Insights & Analytics',
          escalation: 'Escalation & On-Call',
          privacy: 'Privacy & Compliance',
          developers: 'Developers & Advanced',
          payments: 'Payments'
        }
      },
      fr: {
        headerTitle: 'Configuration de l\'agent IA',
        headerSubtitle: 'Personnalisez votre assistant technique 24/7 pour r√©pondre aux besoins de votre entreprise',
        export_btn: 'Exporter les param√®tres (JSON)',
        tabs: {
          presets: 'Pr√©r√©glages & Profil',
          personality: 'Marque & Personnalit√©',
          capabilities: 'Fonctionnalit√©s & Garanties',
          telephony: 'T√©l√©phonie & CRM',
          transcription: 'Transcription & Transcrits',
          diagnostics: 'Diagnostics & Outils',
          playbooks: 'Playbooks (Runbooks)',
          network: 'Statut R√©seau & Pannes',
          ticketing: 'Ticketing & SLA',
          knowledge: 'Connaissances & Mod√®les',
          appointments: 'Rendez-vous & R√©servations',
          quotes: 'Devis & Paiements',
          analytics: 'Stockage, Insights & Analytique',
          escalation: 'Escalade & Astreinte',
          privacy: 'Confidentialit√© & Conformit√©',
          developers: 'D√©veloppeurs & Avanc√©',
          payments: 'Paiements'
        }
      }
    };

    // Merge a more comprehensive French translation map (generated from pending export)
    // Store deferred translations if `DICT` is not yet declared; they'll be merged later.
    window.__DEFERRED_TRANSLATIONS = Object.assign(window.__DEFERRED_TRANSLATIONS || {}, {
      "1 items": "1 √©l√©ment",
      "2 items": "2 √©l√©ments",
      "3 items": "3 √©l√©ments",
      "4 items": "4 √©l√©ments",
      "5 items": "5 √©l√©ments",
      "Total Calls": "Appels totaux",
      "Resolved by AI": "R√©solu par l'IA",
      "Escalated to Humans": "Escalad√© vers des humains",
      "Avg. Resolution Time": "Temps moyen de r√©solution",
      "No confirmation needed": "Pas de confirmation n√©cessaire",
      "Always require confirmation": "Toujours exiger une confirmation",
      "May require confirmation": "Peut n√©cessiter une confirmation",
      "No need": "Pas besoin",
      "Required": "Requis",
      "May require": "Peut n√©cessiter",
      "Presets": "Pr√©r√©glages",
      "Personality Type": "Type de personnalit√©",
      "Response Speed": "Vitesse de r√©ponse",
      "Custom Greeting": "Message d'accueil personnalis√©",
      "Custom Sign-off": "Formule de fin personnalis√©e",
      "Primary Language": "Langue principale",
      "Supported Languages (Multi-language support)": "Langues prises en charge (support multilingue)",
      "Templates": "Mod√®les",
      "Live Preview": "Aper√ßu en direct",
      "Template": "Mod√®le",
      "Templates & Snippets": "Mod√®les & Extraits",
      "Invoice Templates": "Mod√®les de facture",
      "Invoice History": "Historique des factures",
      "Export Invoice (JSON)": "Exporter la facture (JSON)",
      "Export Invoice Templates": "Exporter les mod√®les de facture",
      "Export Templates": "Exporter les mod√®les",
      "Import Templates": "Importer des mod√®les",
      "Import Invoice Template": "Importer un mod√®le de facture",
      "Upload Company Doc": "T√©l√©verser un document d'entreprise",
      "Open Document Library": "Ouvrir la biblioth√®que de documents",
      "Upload .ics Calendar": "T√©l√©verser un calendrier .ics",
      "Open Calendar Library": "Ouvrir la biblioth√®que de calendriers",
      "On-Call Roster": "Astreinte",
      "Support Team": "√âquipe de support",
      "Support Team Email Ajouterress": "Adresse e-mail de l'√©quipe de support",
      "Escalation Queue": "File d'escalade",
      "Escalation Settings": "Param√®tres d'escalade",
      "SLA Targets": "Objectifs SLA",
      "SLA: Response (min)": "SLA : R√©ponse (min)",
      "SLA: Resolution (hrs)": "SLA : R√©solution (heures)",
      "Ticketing & SLA": "Ticketing & SLA",
      "Auto-create Support Ticket": "Cr√©er automatiquement un ticket de support",
      "Auto-assign Ticket Priority": "Attribuer automatiquement la priorit√© du ticket",
      "Auto-close Ticket (resolved)": "Cl√¥turer automatiquement le ticket (r√©solu)",
      "Create / Send Invoice": "Cr√©er / Envoyer la facture",
      "Issue Refund / Credit": "√âmettre un remboursement / avoir",
      "Quotes & Payments": "Devis & Paiements",
      "Payment Provider": "Fournisseur de paiement",
      "Payment Manager (PSP)": "Gestionnaire de paiement (PSP)",
      "Connect Payment Manager": "Connecter le gestionnaire de paiement",
      "Disconnect": "D√©connecter",
      "Not connected": "Non connect√©",
      "Connected:": "Connect√© :",
      "Deposit capture on booking/quote": "Capture d'acompte lors de la r√©servation/du devis",
      "Default currency": "Devise par d√©faut",
      "VAT (%)": "TVA (%)",
      "Default validity (days)": "Validit√© par d√©faut (jours)",
      "Quotes & Payments": "Devis & Paiements",
      "Export Payments (JSON)": "Exporter les paiements (JSON)",
      "Payments": "Paiements",
      "Payment Manager (PSP)": "Gestionnaire de paiement (PSP)",
      "Invoice Platform (Compliance)": "Plateforme de facturation (Conformit√©)",
      "Register Invoice Platform (demo)": "Enregistrer la plateforme de facturation (d√©mo)",
      "Invoice Platform (Compliance)": "Plateforme de facturation (Conformit√©)",
      "Storage & Insights": "Stockage & Insights",
      "Storage & Analytics": "Stockage & Analytique",
      "Storage Keys": "Cl√©s de stockage",
      "Analytics Events": "√âv√©nements analytiques",
      "Generate Sample Event": "G√©n√©rer un √©v√©nement exemple",
      "Clear Events": "Effacer les √©v√©nements",
      "Export All Storage": "Exporter tout le stockage",
      "Import Storage JSON": "Importer JSON de stockage",
      "Purge Older Data": "Purger les anciennes donn√©es",
      "Clear Demo Storage": "Effacer le stockage de d√©monstration",
      "Privacy Controls": "Contr√¥les de confidentialit√©",
      "Show consent prompt to users": "Afficher l'invite de consentement aux utilisateurs",
      "Consent prompt text": "Texte de l'invite de consentement",
      "Retention (days)": "R√©tention (jours)",
      "PII Redaction": "R√©duction des PII",
      "Mask emails": "Masquer les e-mails",
      "Mask phones": "Masquer les num√©ros de t√©l√©phone",
      "Mask names": "Masquer les noms",
      "Purge Expired Data": "Purger les donn√©es expir√©es",
      "Export Audit Log": "Exporter le journal d'audit",
      "Simulate Consent Banner": "Simuler la banni√®re de consentement",
      "Transcription & Transcripts": "Transcription & Transcrits",
      "ASR Engine": "Moteur ASR",
      "Language": "Langue",
      "Streaming (low-latency)": "Streaming (faible latence)",
      "Confidence threshold (%)": "Seuil de confiance (%)",
      "Diarization (caller/agent)": "Diarisation (appelant/agent)",
      "Store transcripts (days)": "Conserver les transcrits (jours)",
      "Redact PII on store": "Redacter les PII lors de l'enregistrement",
      "Diagnostics & Tools": "Diagnostics & Outils",
      "Ping / Connectivity Test": "Test de ping / connectivit√©",
      "Speed Test": "Test de d√©bit",
      "Traceroute / Route Analysis": "Traceroute / Analyse de routage",
      "Run NOC Playbook (automated checks)": "Ex√©cuter le playbook NOC (v√©rifications automatis√©es)",
      "Device Reboot": "Red√©marrage de l'appareil",
      "Firmware Update": "Mise √† jour du firmware",
      "Playbooks (Runbooks)": "Playbooks (Runbooks)",
      "Runbook": "Runbook",
      "Add Playbook": "Ajouter un playbook",
      "Test Playbook": "Tester le playbook",
      "Backups & Data": "Sauvegardes & Donn√©es",
      "Create Backup Now": "Cr√©er une sauvegarde maintenant",
      "Download Latest": "T√©l√©charger le plus r√©cent",
      "Manage Backups": "G√©rer les sauvegardes",
      "Developers & Advanced": "D√©veloppeurs & Avanc√©",
      "Developer Settings (Advanced)": "Param√®tres d√©veloppeur (Avanc√©)",
      "API Keys": "Cl√©s API",
      "Generate Key": "G√©n√©rer une cl√©",
      "Webhooks": "Webhooks",
      "Test": "Tester",
      "Test API Endpoint": "Tester le point de terminaison API",
      "Developer Logs & Test": "Journaux d√©veloppeur & Test",
      "Download Logs": "T√©l√©charger les journaux",
      "Clear Logs": "Effacer les journaux",
      "Export Missing Translations": "Exporter les traductions manquantes",
      "Import Settings (JSON)": "Importer les param√®tres (JSON)",
      "Import Preview": "Aper√ßu d'importation",
      "Apply Import": "Appliquer l'import",
      "Apply": "Appliquer"
    });

    function applyTranslations(lang){
      const map = I18N[lang] || I18N.en;
      const h = document.querySelector('.panel-header h1'); if(h) h.textContent = map.headerTitle;
      const p = document.querySelector('.panel-header p'); if(p) p.textContent = map.headerSubtitle;
      const exportBtn = document.getElementById('export_config_btn'); if(exportBtn) exportBtn.textContent = map.export_btn;
      // translate tabs by data-tab
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        const name = btn.getAttribute('data-tab');
        if(name && map.tabs && map.tabs[name]) btn.textContent = map.tabs[name];
      });
      // sync select value
      const sel = document.getElementById('lang_select'); if(sel) sel.value = lang;
    }

    function setLanguage(lang){ console.log('setLanguage called', lang); try{ localStorage.setItem('ui_lang', lang); }catch(e){} try{ document.documentElement.lang = lang; }catch(e){}
      // apply programmatic translations and walk the DOM to replace remaining strings
      try{ applyTranslations(lang); translateAll(lang); }catch(e){ console.warn('translation apply failed', e); }
      // notify other listeners in-page
      try{ window.dispatchEvent(new CustomEvent('languageChanged', { detail: { lang } })); }catch(e){}
      if(typeof appendDevLog==='function') appendDevLog('UI language set to '+lang);
    }

    function loadLanguage(){ const saved = localStorage.getItem('ui_lang'); const auto = (!saved && navigator.language && navigator.language.toLowerCase().startsWith('fr')) ? 'fr' : (saved || 'en'); try{ document.documentElement.lang = auto; }catch(e){} applyTranslations(auto); }

    // wire language selector (attach after DOM ready to be robust)
    function attachLangSelector(){
      const langSelEl = document.getElementById('lang_select');
      console.log('attachLangSelector running, found=', !!langSelEl);
      if(langSelEl){
        langSelEl.addEventListener('change', (e)=> {
          const val = e.target.value;
          console.log('lang_select change ->', val);
          try{ localStorage.setItem('ui_lang', val); }catch(e){}
          try{ document.documentElement.lang = val; }catch(e){}
          const isFr = val === 'fr';
          const current = window.location.pathname.split('/').pop();
          if(isFr && current !== 'panel_fr.html'){ window.location.href = 'panel_fr.html'; return; }
          if(!isFr && current !== 'panel.html'){ window.location.href = 'panel.html'; return; }
          try{ setLanguage(val); }catch(e){}
        });
      }
    }
    document.addEventListener('DOMContentLoaded', attachLangSelector);

    // --- Generic translator helpers ---
    // dictionary-style translations (flat mapping for larger text replacements)
    const DICT = {
      // English -> French mappings (auto-filled for the panel)
      'Back to Home': 'Retour',
      'Export Settings (JSON)': 'Exporter les param√®tres (JSON)',
      'Import Settings (JSON)': 'Importer les param√®tres (JSON)',
      'Show Import Preview': "Afficher l'aper√ßu d'import",
      'Manage Backups': 'G√©rer les sauvegardes',
      'Open Training Queue': "Ouvrir la file d'entra√Ænement",
      'Reveal Payment API Key': "Afficher la cl√© API de paiement",
      'Show SSML Raw': 'Afficher SSML brut',
      '\u2713 Personality settings saved successfully!': '\u2713 Param√®tres de personnalit√© enregistr√©s avec succ√®s !',
      '\u2713 Capabilities saved successfully!': '\u2713 Param√®tres de fonctionnalit√©s enregistr√©s !',
      '\u2713 Telephony settings saved successfully!': '\u2713 Param√®tres de t√©l√©phonie enregistr√©s !',
      '\u2713 Escalation settings saved successfully!': '\u2713 Param√®tres d\'escalade enregistr√©s !',
      '\u2713 Data & Privacy settings saved': '\u2713 Param√®tres de confidentialit√© enregistr√©s',
      'No webhooks configured.': 'Aucun webhook configur√©.',
      'No invoice templates available.': "Aucun mod√®le de facture disponible.",
      'No on-call entries. Add technicians or link calendars to route escalations.': 'Aucune entr√©e d\'astreinte. Ajoutez des techniciens ou liez des calendriers pour router les escalades.',
      'No dev logs yet.': "Pas encore de journaux d√©veloppeur.",
      'Simulated API test complete ‚Äî see developer logs.': "Test d'API simul√© termin√© ‚Äî voir les journaux d√©veloppeur.",
      'No invoices yet. Export one to populate history.': "Aucune facture pour le moment. Exportez-en une pour remplir l'historique.",
      'No storage keys found.': "Aucune cl√© de stockage trouv√©e.",
      'No analytics events recorded yet.': "Aucun √©v√©nement analytique enregistr√© pour l'instant.",
      'No conversations available for preview': "Aucune conversation disponible pour l'aper√ßu",
      'This is a simulated alert (demo only).': "Ceci est une alerte simul√©e (d√©mo uniquement).",
      'Close': 'Fermer',
      'Cancel': 'Annuler',
      'Save': 'Enregistrer',
      'Remove': 'Supprimer',
      'Edit': 'Modifier',
      'Add': 'Ajouter',
      'View': 'Voir',
      'Download': 'T√©l√©charger',
      'Copy': 'Copier',

      // Common helper texts and labels
      'Include anonymized interactions in training': "Inclure les interactions anonymis√©es dans l'entra√Ænement",
      'When enabled, selected conversations may be sent to your training queue (demo uses localStorage).': "Lorsqu'activ√©, certaines conversations peuvent √™tre envoy√©es dans votre file d'entra√Ænement (d√©mo utilise localStorage).",
      'Manage translation strings for UI messages. Key-value editor below.': "G√©rer les cha√Ænes de traduction pour les messages UI. √âditeur cl√©-valeur ci-dessous.",
      'These buttons are UI-only for now. Applying presets will be implemented later.': "Ces boutons sont uniquement UI pour l'instant. L'application des pr√©r√©glages sera impl√©ment√©e plus tard.",
      'Tip: Apply a preset to get sensible defaults for your industry, then review settings (privacy, quotes, hours) before saving.': "Astuce : Appliquez un pr√©r√©glage pour obtenir des valeurs par d√©faut adapt√©es √† votre secteur, puis v√©rifiez les param√®tres (confidentialit√©, devis, horaires) avant d'enregistrer.",
      'Use a friendly, recognizable name customers will remember ‚Äî helpful for handoffs to human staff.': "Utilisez un nom convivial et reconnaissable que les clients retiendront ‚Äî utile pour les transferts vers le personnel humain.",
      'Upload an image to represent the agent (shown to customers).': "T√©l√©chargez une image repr√©sentant l'agent (affich√©e aux clients).",
      'Choose the style that matches your brand ‚Äî friendly for retail, technical for support-heavy businesses.': "Choisissez le style qui correspond √† votre marque ‚Äî convivial pour le commerce de d√©tail, technique pour les entreprises ax√©es sur le support.",
      'Faster replies feel more responsive; slower replies allow longer, more accurate answers. Pick based on call type.': "Les r√©ponses plus rapides semblent plus r√©actives ; les r√©ponses plus lentes permettent des r√©ponses plus longues et plus pr√©cises. Choisissez selon le type d'appel.",
      'Short greetings reduce friction ‚Äî include business name if helpful for caller recognition.': "Les salutations courtes r√©duisent la friction ‚Äî incluez le nom de l'entreprise si cela aide √† la reconnaissance de l'appelant.",
      'A warm, consistent sign-off builds trust and signals the conversation end to customers.': "Une cl√¥ture chaleureuse et coh√©rente instaure la confiance et signale la fin de la conversation aux clients.",
      'Set the confirmation level for each action: <strong>No need</strong>, <strong>May require</strong>, or <strong>Required</strong>.': "D√©finissez le niveau de confirmation pour chaque action : <strong>Pas n√©cessaire</strong>, <strong>Peut n√©cessiter</strong> ou <strong>Requis</strong>.",
      'Tip: use the global "Auto-escalate if unsure" slider to hand off uncertain cases instead of tagging individual actions with confidence rules.': "Astuce : utilisez le curseur global 'Auto-escalade si incertain' pour transf√©rer les cas incertains au lieu d'√©tiqueter chaque action avec des r√®gles de confiance.",
      'If conversations run this long without resolution, consider escalating to a human (reduce customer frustration).': "Si les conversations durent aussi longtemps sans r√©solution, envisagez d'escalader vers un humain (r√©duire la frustration du client).",
      'Set the minimum satisfaction score before the system escalates ‚Äî lower values escalate sooner.': "D√©finissez le score de satisfaction minimal avant que le syst√®me n'escalade ‚Äî des valeurs inf√©rieures entra√Ænent une escalation plus t√¥t.",
      'Enable a master safeguard that prompts for confirmation on actions that exceed configured limits.': "Activez une protection ma√Ætresse qui demande une confirmation pour les actions d√©passant les limites configur√©es.",
      'Enable if your business provides simple price estimates or formal quotes ‚Äî integrates with email templates below.': "Activez si votre entreprise fournit des estimations simples ou des devis formels ‚Äî s'int√®gre aux mod√®les d'e-mail ci-dessous.",
      'When enabled, quotes above the threshold will be flagged for human review to prevent large or risky automatic approvals.': "Lorsqu'activ√©, les devis au-del√† du seuil seront signal√©s pour examen humain afin d'√©viter des approbations automatiques importantes ou risqu√©es.",
      'Some jurisdictions require invoices be reported to a certified platform. Choose your platform and register a connection (front-end demo only).': "Certaines juridictions exigent que les factures soient d√©clar√©es sur une plateforme certifi√©e. Choisissez votre plateforme et enregistrez une connexion (d√©mo front-end uniquement).",
      'Optional simple JSON rules to validate generated quotes before sending.': "R√®gles JSON simples facultatives pour valider les devis g√©n√©r√©s avant envoi.",

      // More UI labels and small phrases
      'Presets & Profile': 'Pr√©r√©glages & Profil',
      'Branding & Personality': 'Marque & Personnalit√©',
      'Capabilities & Safeguards': 'Fonctionnalit√©s & Garanties',
      'Telephony & CRM': 'T√©l√©phonie & CRM',
      'Transcription & Transcripts': 'Transcription & Transcrits',
      'Diagnostics & Tools': 'Diagnostics & Outils',
      'Playbooks (Runbooks)': 'Playbooks (Runbooks)',
      'Network Status & Outage': 'Statut R√©seau & Pannes',
      'Ticketing & SLA': 'Ticketing & SLA',
      'Knowledge & Templates': 'Connaissances & Mod√®les',
      'Appointments & Reservations': 'Rendez-vous & R√©servations',
      'Quotes & Payments': 'Devis & Paiements',
      'Storage, Insights & Analytics': 'Stockage, Insights & Analytique',
      'Escalation & On-Call': 'Escalade & Astreinte',
      'Privacy & Compliance': 'Confidentialit√© & Conformit√©',
      'Developers & Advanced': 'D√©veloppeurs & Avanc√©',

      // generic small words
      'Tip:': 'Astuce :',
      'Demo': 'D√©mo',
      'Not connected': 'Non connect√©',
      'Connected:': 'Connect√© :',
      'Register Invoice Platform (demo)': "Enregistrer la plateforme de facturation (d√©mo)",
      'Disconnect': 'D√©connecter',
      'Invoice History': 'Historique des factures',
      'Line Items': 'Lignes de facture',
      'Add Line Item': 'Ajouter un √©l√©ment',
      'Save Items': 'Enregistrer les √©l√©ments',

      // fallbacks for common UI phrases
      'No storage keys found.': 'Aucune cl√© de stockage trouv√©e.',
      'No analytics events recorded yet.': "Aucun √©v√©nement analytique enregistr√© pour l'instant.",
      'No webhooks configured.': 'Aucun webhook configur√©.'
    };

    // If there were deferred translations collected earlier, merge them now
    if (window.__DEFERRED_TRANSLATIONS) {
      try { Object.assign(DICT, window.__DEFERRED_TRANSLATIONS); } catch (e) { console.warn('Failed to merge deferred translations', e); }
    }

    function translateString(s, lang){
      if(!s || typeof s !== 'string') return s;
      // try exact matches first
      if(lang === 'fr'){
        if(DICT[s]) return DICT[s];
      }
      // fallback: replace known substrings when translating to French
      if(lang === 'fr'){
        let out = s;
        Object.keys(DICT).forEach(k => { out = out.split(k).join(DICT[k]); });
        return out;
      }
      return s;
    }

    function translateNodeText(node, lang){
      if(!node || !node.nodeType) return;
      if(node.nodeType === Node.TEXT_NODE){
        const txt = node.nodeValue.trim();
        if(!txt) return;
        const translated = translateString(node.nodeValue, lang);
        if(translated !== node.nodeValue) node.nodeValue = translated;
      } else if(node.nodeType === Node.ELEMENT_NODE){
        // translate attributes: placeholder, title, alt, value for buttons/inputs
        ['placeholder','title','alt','value','aria-label'].forEach(attr => {
          if(node.hasAttribute && node.hasAttribute(attr)){
            const v = node.getAttribute(attr);
            const tv = translateString(v, lang);
            if(tv !== v) node.setAttribute(attr, tv);
          }
        });
        // translate visible element text nodes
        node.childNodes.forEach(child => translateNodeText(child, lang));
      }
    }

    function translateAll(lang){
      // translate document title if present in map
      const docTitle = document.title || '';
      if(lang === 'fr' && DICT[docTitle]) document.title = DICT[docTitle];
      // walk body
      translateNodeText(document.body, lang);
      // also translate static elements we programmatically set via applyTranslations
      applyTranslations(lang);
    }

    // Collect all visible text inside section cards and build a translation map (english -> french or empty)
    function collectSectionText(){
      const set = new Set();
      // target area selectors: section-card, info-box, tab-content
      const roots = Array.from(document.querySelectorAll('.section-card, .info-box, .tab-content'));
      roots.forEach(root=>{
        // get visible text nodes under root
        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while(node = walker.nextNode()){
          const txt = node.nodeValue && node.nodeValue.trim();
          if(txt && txt.length>0 && !/^\s*$/.test(txt)) set.add(txt);
        }
      });
      return Array.from(set).sort();
    }

    function buildTranslationPayload(lang){
      const keys = collectSectionText();
      const payload = {};
      keys.forEach(k=>{
        // if we already have a DICT translation use it
        if(lang==='fr' && DICT[k]) payload[k] = DICT[k];
        else payload[k] = '';
      });
      return payload;
    }

    function exportMissingTranslations(){
      const lang = 'fr';
      const map = buildTranslationPayload(lang);
      // count missing
      let missing = 0; Object.keys(map).forEach(k=>{ if(!map[k]) missing++; });
      const blob = new Blob([JSON.stringify(map, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `translations_${lang}_pending.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      alert('Exported translations file. Missing translations: '+missing+' (fill them and re-import or paste them into DICT).');
    }

    // allow importing a completed translations JSON directly into DICT at runtime
    function importTranslationsFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(){ try{ const parsed = JSON.parse(String(reader.result||'')); if(typeof parsed !== 'object') return alert('Invalid translations file'); // merge into DICT
          Object.keys(parsed).forEach(k=>{ if(parsed[k]) DICT[k] = parsed[k]; });
          const lang = localStorage.getItem('ui_lang')||'en'; translateAll(lang); alert('Imported translations and applied to page.'); }catch(e){ alert('Import error: '+e.message); } };
      reader.readAsText(file);
    }

    // helper to trigger import via hidden file input (developer use)
    function openTranslationsImport(){ let f = document.getElementById('translations_import_file'); if(!f){ f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.id='translations_import_file'; f.style.display='none'; f.addEventListener('change', (e)=>{ const file = e.target.files && e.target.files[0]; if(file) importTranslationsFile(file); }); document.body.appendChild(f); } f.value=''; f.click(); }

    // override alert/confirm to try translating messages when possible
    (function(){
      const _alert = window.alert; const _confirm = window.confirm;
      window.alert = function(msg){ try{ const lang = localStorage.getItem('ui_lang') || 'en'; const tmsg = translateString(String(msg), lang); return _alert(tmsg); }catch(e){ return _alert(msg); } };
      window.confirm = function(msg){ try{ const lang = localStorage.getItem('ui_lang') || 'en'; const tmsg = translateString(String(msg), lang); return _confirm(tmsg); }catch(e){ return _confirm(msg); } };
    })();

    // ensure language loaded and applied after DOM ready
    document.addEventListener('DOMContentLoaded', function(){ try{ loadLanguage(); const lang = localStorage.getItem('ui_lang') || (navigator.language && navigator.language.toLowerCase().startsWith('fr') ? 'fr' : 'en'); translateAll(lang); }catch(e){ console.warn('i18n init failed', e); } });


    // hydrate telephony settings into fields
    try {
      const tele = JSON.parse(localStorage.getItem('telephony_settings') || '{}');
      if (tele) {
        if (document.getElementById('crm_lookup_url')) document.getElementById('crm_lookup_url').value = tele.crm_lookup_url || '';
        if (document.getElementById('crm_auth_token')) document.getElementById('crm_auth_token').value = tele.crm_auth_token || '';
    function testPaymentConnector(){
      const prov = document.getElementById('payment_provider')?.value || 'none';
      const mode = document.getElementById('payment_mode')?.value || 'test';
      const key = document.getElementById('payment_api_key')?.value || '';
      if(prov==='none') return alert('No payment provider selected');
      if(!key) return alert('API key / client id is not set ‚Äî add it before testing (demo)');
      // Demo: simulate a small charge attempt
      setTimeout(()=>{
        alert(`‚úì Test ${prov} connection successful (mode=${mode}). Demo charge $1.00 would be authorized.`);
      }, 600);
    }
    function exportPaymentConfig(){
      const obj = { provider: document.getElementById('payment_provider')?.value || '', mode: document.getElementById('payment_mode')?.value || '', api_key: document.getElementById('payment_api_key')?.value || '', deposit_capture: !!document.getElementById('deposit_capture')?.checked, deposit_default: Number(document.getElementById('deposit_amount_default')?.value || 0) };
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payments-config.json'; document.body.appendChild(a); a.click(); a.remove();
    }

    // Payment Manager connect/disconnect (demo-only)
    function connectPaymentManager(){
      const mgr = document.getElementById('payment_manager')?.value || 'none';
      const merchant = document.getElementById('payment_manager_merchant')?.value || '';
      const secret = document.getElementById('payment_manager_secret')?.value || '';
      if(mgr==='none') return alert('S√©lectionnez un gestionnaire de paiement');
      if(!merchant || !secret) return alert('Fournissez l\'identifiant marchand/client et le secret pour la connexion (d√©mo)');
      // simulate OAuth flow and persist an entry in localStorage
      const token = 'pm-'+Date.now();
      localStorage.setItem('payment_manager_connected', JSON.stringify({manager: mgr, merchant, token, connected_at: new Date().toISOString()}));
      renderPaymentManagerStatus();
      alert('Connect√© √† ' + mgr + ' (d√©mo)');
    }

    function disconnectPaymentManager(){ if(!confirm('D√©connecter le gestionnaire de paiement ?')) return; localStorage.removeItem('payment_manager_connected'); renderPaymentManagerStatus(); alert('D√©connect√© (d√©mo)'); }

    function renderPaymentManagerStatus(){ const s = localStorage.getItem('payment_manager_connected'); const el = document.getElementById('payment_manager_status'); if(!el) return; if(!s){ el.textContent = 'Non connect√©'; el.style.color = 'var(--muted)'; } else { try{ const obj = JSON.parse(s); el.textContent = `Connect√© : ${obj.manager} (${new Date(obj.connected_at).toLocaleString()})`; el.style.color = 'var(--brand)'; }catch(e){ el.textContent = 'Connect√©'; } } }

    // ensure payment manager status is rendered on load
    renderPaymentManagerStatus();
    
    // Invoice Platform connect/disconnect (front-end demo)
    function connectInvoicePlatform(fromPayments){
      const select = (fromPayments ? document.getElementById('invoice_platform_select_pay') : document.getElementById('invoice_platform_select'));
      const merchant = (fromPayments ? document.getElementById('invoice_platform_merchant_pay') : document.getElementById('invoice_platform_merchant'))?.value || '';
      const api = (fromPayments ? document.getElementById('invoice_platform_api_pay') : document.getElementById('invoice_platform_api'))?.value || '';
      if(!select) return alert('S√©lecteur de plateforme de facturation introuvable');
      const platform = select.value || 'none';
      if(platform==='none') return alert('S√©lectionnez une plateforme de facturation √† enregistrer');
      if(!merchant || !api) return alert('Fournissez l\'identifiant marchand/compte et le jeton API pour l\'enregistrement (d√©mo)');
      const cfg = { platform, merchant, api, registered_at: new Date().toISOString() };
      localStorage.setItem('invoice_platform_config', JSON.stringify(cfg));
      renderInvoicePlatformStatus();
      alert('Plateforme de facturation enregistr√©e (d√©mo) : ' + platform);
    }

    function disconnectInvoicePlatform(){ if(!confirm('D√©connecter la plateforme de facturation ?')) return; localStorage.removeItem('invoice_platform_config'); renderInvoicePlatformStatus(); alert('Plateforme de facturation d√©connect√©e'); }

    function renderInvoicePlatformStatus(){ const raw = localStorage.getItem('invoice_platform_config'); const s = raw ? JSON.parse(raw) : null; const el = document.getElementById('invoice_platform_status'); const el2 = document.getElementById('invoice_platform_status_pay'); if(el) el.textContent = s ? `Enregistr√©e : ${s.platform} (${new Date(s.registered_at).toLocaleString()})` : 'Non enregistr√©e'; if(el2) el2.textContent = s ? `Enregistr√©e : ${s.platform} (${new Date(s.registered_at).toLocaleString()})` : 'Non enregistr√©e'; if(el) el.style.color = s ? 'var(--brand)' : 'var(--muted)'; if(el2) el2.style.color = s ? 'var(--brand)' : 'var(--muted)'; }

    // render invoice platform status at load
    renderInvoicePlatformStatus();
        if (document.getElementById('crm_match_strategy')) document.getElementById('crm_match_strategy').value = tele.crm_match_strategy || 'phone';
        if (document.getElementById('crm_show_plan')) document.getElementById('crm_show_plan').checked = !!tele.crm_show_plan;
        if (document.getElementById('crm_show_device')) document.getElementById('crm_show_device').checked = !!tele.crm_show_device;
        if (document.getElementById('crm_show_outage')) document.getElementById('crm_show_outage').checked = !!tele.crm_show_outage;
        if (document.getElementById('crm_failover')) document.getElementById('crm_failover').value = tele.crm_failover || 'ask';
        if (document.getElementById('tele_auto_open_ticket')) document.getElementById('tele_auto_open_ticket').checked = !!tele.tele_auto_open_ticket;
        if (document.getElementById('tele_default_queue')) document.getElementById('tele_default_queue').value = tele.tele_default_queue || '';
        if (document.getElementById('tele_caller_risk')) document.getElementById('tele_caller_risk').value = tele.tele_caller_risk || 50;
        if (document.getElementById('tele_phone_hook')) document.getElementById('tele_phone_hook').value = tele.tele_phone_hook || '';
      }
    } catch (e) { console.warn('Failed to hydrate telephony_settings', e); }


    // Slider value updates
    document.getElementById('escalationTimeout').addEventListener('input', (e) => {
      document.getElementById('escalationTimeoutVal').textContent = e.target.value;
    });
    document.getElementById('satisfactionThreshold').addEventListener('input', (e) => {
      document.getElementById('satisfactionThresholdVal').textContent = e.target.value;
    });

    // Save functions (demo purposes)
    function savePersonality() {
      alert('‚úì Personality settings saved successfully!');
    }

    // Capabilities: Telecom & IT focused actions list with conservative defaults
    // Notes for business owners:
    //  - Conditions are lightweight tags used to suggest when extra caution is warranted.
    //  - "high_priority_account": accounts flagged by your CRM as VIP/priority (billing or SLA importance).
    //  - Confidence/uncertainty is handled globally by the "Auto-escalate if unsure" slider ‚Äî no need for a separate "low_confidence" tag here.
    const CAPABILITY_ACTIONS = [
      { id: 'account_lookup', label: 'Account Lookup (CRM)', defaultLevel: 'no_need', conditions:[], category:'Accounts & Identity' },
      { id: 'caller_identification', label: 'Caller Identification / Screen-pop', defaultLevel: 'no_need', conditions:[], category:'Accounts & Identity' },
      { id: 'password_reset', label: 'Password / PIN Reset', defaultLevel: 'may_require', conditions:['new_device','unusual_location','high_priority_account'], category:'Accounts & Identity' },
      { id: 'sensitive_info_display', label: 'Show Sensitive Account Info (PII)', defaultLevel: 'may_require', conditions:['high_priority_account'], category:'Accounts & Identity' },

      { id: 'ping_test', label: 'Ping / Connectivity Test', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'speed_test', label: 'Speed Test', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'trace_route', label: 'Traceroute / Route Analysis', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'run_noc_playbook', label: 'Run NOC Playbook (automated checks)', defaultLevel: 'may_require', conditions:['outage_detected'], category:'Diagnostics & Network' },

      { id: 'device_reboot', label: 'Remote Device Reboot', defaultLevel: 'may_require', conditions:['after_hours','high_priority_account'], category:'Remote Device Management' },
      { id: 'firmware_update', label: 'Push Firmware Update', defaultLevel: 'required', conditions:['field_dispatch_required','monetary_impact'], category:'Remote Device Management' },
      { id: 'provision_device', label: 'Provision / Reprovision Device', defaultLevel: 'may_require', conditions:['customer_request','high_priority_account'], category:'Provisioning & Orders' },

      { id: 'create_ticket', label: 'Auto-create Support Ticket', defaultLevel: 'no_need', conditions:['outage_detected'], category:'Ticketing & Escalation' },
      { id: 'assign_priority', label: 'Auto-assign Ticket Priority', defaultLevel: 'may_require', conditions:['outage_detected','high_priority_account'], category:'Ticketing & Escalation' },
      { id: 'close_ticket', label: 'Auto-close Ticket (resolved)', defaultLevel: 'may_require', conditions:[], category:'Ticketing & Escalation' },

      { id: 'issue_refund', label: 'Issue Refund / Credit', defaultLevel: 'required', conditions:['monetary_impact','high_priority_account'], category:'Billing & Payments' },
      { id: 'adjust_invoice', label: 'Adjust Billing / Invoice', defaultLevel: 'required', conditions:['monetary_impact','legal_identity_change'], category:'Billing & Payments' },

      { id: 'schedule_field_visit', label: 'Schedule Field Technician', defaultLevel: 'may_require', conditions:['field_dispatch_required','after_hours'], category:'Field Operations & Dispatch' },
      { id: 'dispatch_urgent', label: 'Dispatch Urgent Field Team', defaultLevel: 'required', conditions:['outage_detected','high_priority_account'], category:'Field Operations & Dispatch' },

      { id: 'change_service_plan', label: 'Change Service Plan / Upgrade', defaultLevel: 'required', conditions:['monetary_impact','customer_request'], category:'Configuration & Service Control' },
      { id: 'enable_feature', label: 'Enable/Disable Service Feature', defaultLevel: 'may_require', conditions:['customer_request'], category:'Configuration & Service Control' },

      { id: 'add_user', label: 'Create / Add User Account', defaultLevel: 'may_require', conditions:['new_device','legal_identity_change'], category:'Admin & Security' },
      { id: 'revoke_access', label: 'Revoke Access / Disable Account', defaultLevel: 'required', conditions:['security_incident'], category:'Admin & Security' },

      { id: 'outbound_sms', label: 'Send Outbound SMS / Notifications', defaultLevel: 'no_need', conditions:['after_hours'], category:'Customer Communications' },
      { id: 'send_confirmation_email', label: 'Send Confirmation Email', defaultLevel: 'no_need', conditions:[], category:'Customer Communications' }
      ,
      // Freelancer / Web Developer focused actions (organized)
      // Category: Deployment & Release
      { id: 'deploy_production', label: 'Deploy to Production', defaultLevel: 'required', conditions:['staging_passed','client_approval','production_environment'], category:'Deployment & Release' },
      { id: 'run_db_migration', label: 'Run Database Migration', defaultLevel: 'required', conditions:['staging_passed','backup_taken','client_approval'], category:'Deployment & Release' },
      { id: 'rollback_deploy', label: 'Rollback Production Deploy', defaultLevel: 'required', conditions:['production_issue','high_priority_client'], category:'Deployment & Release' },
      { id: 'restart_server', label: 'Restart Application / Server', defaultLevel: 'may_require', conditions:['after_hours','production_environment'], category:'Deployment & Release' },
      { id: 'run_tests_and_deploy', label: 'Run Tests & Deploy (CI)', defaultLevel: 'may_require', conditions:['staging_passed'], category:'Deployment & Release' },

      // Category: DNS & Domains
      { id: 'modify_dns', label: 'Modify DNS Records', defaultLevel: 'required', conditions:['domain_verification','client_approval'], category:'DNS & Domains' },
      { id: 'install_ssl', label: 'Install / Renew SSL Certificate', defaultLevel: 'may_require', conditions:['domain_verification'], category:'DNS & Domains' },

      // Category: Access & Security
      { id: 'grant_repo_access', label: 'Grant Repo / SSH Access', defaultLevel: 'required', conditions:['identity_verification','client_approval'], category:'Access & Security' },
      { id: 'revoke_repo_access', label: 'Revoke Repo / SSH Access', defaultLevel: 'required', conditions:['security_incident'], category:'Access & Security' },
      { id: 'share_remote_link', label: 'Share Remote Access Link', defaultLevel: 'may_require', conditions:['client_approval','security_incident'], category:'Access & Security' },

      // Category: Provisioning & Hosting
      { id: 'provision_instance', label: 'Provision Hosting / VM', defaultLevel: 'may_require', conditions:['payment_verified','client_approval'], category:'Provisioning & Hosting' },
      { id: 'decommission_instance', label: 'Decommission Hosting / VM', defaultLevel: 'required', conditions:['client_approval','backup_taken'], category:'Provisioning & Hosting' },

      // Category: Backups & Data
      { id: 'take_backup', label: 'Take Backup / Snapshot', defaultLevel: 'no_need', conditions:['production_environment'], category:'Backups & Data' },
      { id: 'run_data_export', label: 'Run Data Export', defaultLevel: 'may_require', conditions:['contract_signed','payment_verified'], category:'Backups & Data' },

      // Category: Billing & Contracts (freelancer-focused)
      { id: 'create_invoice', label: 'Create / Send Invoice', defaultLevel: 'may_require', conditions:['payment_verified'], category:'Billing & Contracts' },
      { id: 'issue_refund_freelancer', label: 'Issue Refund (Freelancer)', defaultLevel: 'required', conditions:['monetary_impact','client_approval'], category:'Billing & Contracts' },
      { id: 'update_contract', label: 'Create / Update Client Contract', defaultLevel: 'required', conditions:['client_approval','legal_identity_change'], category:'Billing & Contracts' },

      // Category: Client Communication & Scheduling
      { id: 'schedule_meeting', label: 'Schedule Client Meeting', defaultLevel: 'no_need', conditions:[], category:'Client Communication' },
      { id: 'send_progress_report', label: 'Send Progress Report / Status', defaultLevel: 'no_need', conditions:[], category:'Client Communication' }
    ];

    // Small initializer: populate whitelist options, hydrate saved per-action levels, and trigger renderer
    function initCapabilitiesHelpers() {
      const whitelist = document.getElementById('actions_whitelist');
      if (whitelist) {
        whitelist.innerHTML = '';
        CAPABILITY_ACTIONS.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.label;
          whitelist.appendChild(opt);
        });
      }

      // hydrate previously saved per-action levels from localStorage
      try {
        const saved = JSON.parse(localStorage.getItem('capabilities_settings') || '{}');
        if (saved && saved.actions) {
          CAPABILITY_ACTIONS.forEach(a => {
            if (saved.actions[a.id] && saved.actions[a.id].level) {
              a.defaultLevel = saved.actions[a.id].level;
            }
          });
        }
      } catch (e) {
        console.warn('Failed to parse capabilities_settings', e);
      }

      if (typeof renderCapabilitiesActions === 'function') {
        try { renderCapabilitiesActions(); } catch (e) { console.warn('renderCapabilitiesActions failed', e); }
      }
    }

    document.addEventListener('DOMContentLoaded', initCapabilitiesHelpers);

    document.addEventListener('DOMContentLoaded', function(){
      // initialize storage analytics UI
      try{ renderStorageAnalytics(); }catch(e){}
      const tb = document.getElementById('telemetry_opt_in'); if(tb){ tb.addEventListener('change', function(){ const s = loadStorageAnalyticsSettings(); s.telemetry_opt_in = !!tb.checked; saveStorageAnalyticsSettings(s); }); }
      try{ renderOncallRoster(); }catch(e){}
      // wire buttons in Escalation tab
      const addBtn = document.getElementById('add_oncall_btn'); if(addBtn) addBtn.addEventListener('click', addOncallEntry);
      const testBtn = document.getElementById('test_escalation_btn'); if(testBtn) testBtn.addEventListener('click', testEscalationAlert);
      try{ loadEscalationSettings(); }catch(e){}
    });

    function renderCapabilitiesActions() {
      const container = document.getElementById('capabilities_actions_list');
      if (!container) return;
      const saved = loadCapabilities();
      container.innerHTML = '';

      // group actions by category
      const categories = {};
      CAPABILITY_ACTIONS.forEach(a => {
        const cat = a.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(a);
      });

      // helper to create a category accordion
      Object.keys(categories).forEach(catName => {
        const catWrap = document.createElement('div');
        catWrap.className = 'cap-category';
        catWrap.style.marginBottom = '12px';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'cap-category-header';
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.style.width = '100%';
        header.style.padding = '10px 12px';
        header.style.border = '1px solid var(--border)';
        header.style.borderRadius = '8px';
        header.style.background = 'var(--card)';
        header.style.cursor = 'pointer';
        header.innerHTML = `<strong style="text-align:left">${catName}</strong><span class="muted">${categories[catName].length} items</span>`;

        const content = document.createElement('div');
        content.className = 'cap-category-content';
        content.style.display = 'none';
        content.style.marginTop = '8px';

        header.addEventListener('click', () => {
          const open = content.style.display === 'block';
          content.style.display = open ? 'none' : 'block';
          header.classList.toggle('open', !open);
        });

        // render actions inside this category
        categories[catName].forEach(act => {
          const rowWrap = document.createElement('div');
          rowWrap.style.display = 'flex';
          rowWrap.style.flexDirection = 'column';
          rowWrap.style.gap = '8px';
          rowWrap.style.padding = '8px 0';
          rowWrap.style.borderBottom = '1px dashed rgba(0,0,0,0.03)';

          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '12px';

          const label = document.createElement('div');
          label.style.flex = '1';
          label.textContent = act.label;

          const select = document.createElement('select');
          select.style.minWidth = '220px';
          select.dataset.actionId = act.id;
          select.id = `cap_${act.id}`;
          const opts = [
            {v:'no_need', t:'No confirmation needed'},
            {v:'may_require', t:'May require confirmation'},
            {v:'required', t:'Always require confirmation'}
          ];
          opts.forEach(o=>{ const option=document.createElement('option'); option.value=o.v; option.textContent=o.t; select.appendChild(option); });
          let sv = 'no_need';
          if (saved && saved.actions && saved.actions[act.id]) {
            const asv = saved.actions[act.id];
            if (typeof asv === 'string') sv = asv;
            else if (asv && typeof asv === 'object' && asv.level) sv = asv.level;
            else sv = asv;
          } else {
            sv = act.defaultLevel || 'no_need';
          }
          select.value = sv;

          row.appendChild(label);
          row.appendChild(select);

          // condition area (hidden by default) - keep data attrs used by save
          const condArea = document.createElement('div');
          condArea.className = 'cond-area';
          condArea.dataset.actionId = act.id;
          condArea.style.display = (select.value === 'may_require') ? 'block' : 'none';
          condArea.style.padding = '8px 12px';
          condArea.style.border = '1px dashed var(--border)';
          condArea.style.borderRadius = '8px';
          condArea.style.background = 'rgba(0,0,0,0.01)';

          function renderConditions() {
            condArea.innerHTML = '';
            const savedForAction = (saved && saved.conditions && saved.conditions[act.id]) ? saved.conditions[act.id] : {};
            act.conditions && act.conditions.forEach(cond => {
              const ctrl = renderConditionControl(cond, savedForAction[cond], act.id);
              if (ctrl) condArea.appendChild(ctrl);
            });
          }
          renderConditions();

          // show/hide conditions when selection changes; also open category when may_require
          select.addEventListener('change', ()=>{
            condArea.style.display = (select.value === 'may_require') ? 'block' : 'none';
            if (select.value === 'may_require') {
              content.style.display = 'block';
              header.classList.add('open');
            }
          });

          rowWrap.appendChild(row);
          rowWrap.appendChild(condArea);
          content.appendChild(rowWrap);
        });

        catWrap.appendChild(header);
        catWrap.appendChild(content);
        container.appendChild(catWrap);
      });

      // wire bulk apply to set values and also open/close categories as needed
      const bulkBtn = document.getElementById('bulkApplyBtn');
      const bulkSel = document.getElementById('bulkSetLevel');
      if (bulkBtn && bulkSel) {
        bulkBtn.onclick = () => {
          const v = bulkSel.value;
          if (!v) return alert('Select a level to apply');
          // set all selects and dispatch change so condition areas update
          container.querySelectorAll('select').forEach(s => {
            s.value = v;
            s.dispatchEvent(new Event('change', { bubbles: true }));
          });

          // open categories that contain any 'may_require' selections, close others
          container.querySelectorAll('.cap-category').forEach(cat => {
            const content = cat.querySelector('.cap-category-content');
            const hasMay = Array.from(cat.querySelectorAll('select')).some(s => s.value === 'may_require');
            if (hasMay) { content.style.display = 'block'; cat.querySelector('.cap-category-header').classList.add('open'); }
            else { content.style.display = 'none'; cat.querySelector('.cap-category-header').classList.remove('open'); }
          });
        };
      }

      // hydrate escalation sliders if present
      if (saved && saved.escalation) {
        const t = document.getElementById('escalationTimeout');
        const s = document.getElementById('satisfactionThreshold');
        if (t) { t.value = saved.escalation.timeout || t.value; document.getElementById('escalationTimeoutVal').textContent = t.value; }
        if (s) { s.value = saved.escalation.satisfaction || s.value; document.getElementById('satisfactionThresholdVal').textContent = s.value; }
        // load new escalation fields: on-call calendar, skill queues, SLA targets
        const oncall = document.getElementById('oncall_calendar');
        if (oncall && saved.escalation.oncall_calendar) oncall.value = saved.escalation.oncall_calendar;
        const skills = document.getElementById('skill_queues');
        if (skills && Array.isArray(saved.escalation.skill_queues)) skills.value = saved.escalation.skill_queues.join(',');
        // SLA targets
        if (saved.escalation.sla) {
          const s1 = document.getElementById('sla_p1'); if (s1 && saved.escalation.sla.p1) s1.value = saved.escalation.sla.p1.response_min || s1.value;
          const s1r = document.getElementById('sla_p1_res'); if (s1r && saved.escalation.sla.p1) s1r.value = saved.escalation.sla.p1.resolution_hours || s1r.value;
          const s2 = document.getElementById('sla_p2'); if (s2 && saved.escalation.sla.p2) s2.value = saved.escalation.sla.p2.response_min || s2.value;
          const s2r = document.getElementById('sla_p2_res'); if (s2r && saved.escalation.sla.p2) s2r.value = saved.escalation.sla.p2.resolution_hours || s2r.value;
        }
      }
      // hydrate global safeguards
      if (saved && saved.safeguards) {
        document.getElementById('safeguards_enabled').checked = !!saved.safeguards.enabled;
        document.getElementById('max_monetary_impact').value = saved.safeguards.max_monetary_impact || 0;
        document.getElementById('auto_escalate').value = saved.safeguards.auto_escalate || 60;
        document.getElementById('auto_escalate_val').textContent = document.getElementById('auto_escalate').value;
        document.getElementById('audit_log_enabled').checked = !!saved.safeguards.audit_log_enabled;
        // whitelist selections
        const wl = saved.safeguards.actions_whitelist || [];
        const sel = document.getElementById('actions_whitelist');
        if (sel) { Array.from(sel.options).forEach(o=> o.selected = wl.includes(o.value)); }
      }
    }

    // Populate actions whitelist options
    function populateActionsWhitelist() {
      const sel = document.getElementById('actions_whitelist');
      if (!sel) return;
      sel.innerHTML = '';
      CAPABILITY_ACTIONS.forEach(a=>{
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.label; sel.appendChild(opt);
      });
    }

    // Render control for a single condition knob
    function renderConditionControl(condKey, savedValue, actionId) {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '8px';
      row.style.marginBottom = '8px';

      const label = document.createElement('label');
      label.style.minWidth = '220px'; label.style.fontWeight = '600';
      // map condKey to friendly label and input type
      switch(condKey) {
        case 'new_device': label.textContent = 'Condition: New Device?'; break;
        case 'unusual_location': label.textContent = 'Condition: Unusual Location?'; break;
        case 'daily_limit': label.textContent = 'Condition: Daily Reset Limit (count)'; break;
        case 'customer_tier': label.textContent = 'Condition: Customer Tier (min)'; break;
        case 'send_otp': label.textContent = 'Send OTP on change'; break;
        case 'billing_impact': label.textContent = 'Affects billing/shipping?'; break;
        case 'block_po_box': label.textContent = 'Block P.O. boxes?'; break;
        case 'identity_verification': label.textContent = 'Require identity verification'; break;
        case 'human_approval': label.textContent = 'Require human approval'; break;
        case 'flag_low_rating': label.textContent = 'Flag ratings ‚â§'; break;
        case 'low_sentiment': label.textContent = 'Trigger on low sentiment'; break;
        case 'policy_conflict': label.textContent = 'Trigger on policy conflicts'; break;
        case 'misunderstandings': label.textContent = 'Trigger on repeated misunderstandings'; break;
        case 'price_limit': label.textContent = '‚Ç¨ Limit'; break;
        case 'discount_limit': label.textContent = '% Limit'; break;
        case 'unlisted_items': label.textContent = 'Unlisted items present'; break;
        case 'new_customer': label.textContent = 'New customer?'; break;
        case 'custom_terms': label.textContent = 'Custom terms present'; break;
        case 'tax_edits': label.textContent = 'Tax edits present'; break;
        case 'percent_limit': label.textContent = '% Limit'; break;
        case 'value_limit': label.textContent = 'Value (‚Ç¨) Limit'; break;
        case 'campaign_dates': label.textContent = 'Outside campaign dates'; break;
        case 'require_3ds': label.textContent = 'Require 3DS/OTP'; break;
        case 'cap_limit': label.textContent = 'Capture cap (‚Ç¨)'; break;
        case 'approved_quote': label.textContent = 'Only for approved quotes/invoices'; break;
        case 'paid_orders_only': label.textContent = 'Only for paid orders'; break;
        case 'double_book': label.textContent = 'Avoid double-book'; break;
        case 'buffers': label.textContent = 'Enforce buffers (min)'; break;
        case 'outside_hours_hold': label.textContent = 'Outside hours ‚Üí hold for approval'; break;
        case 'lock_window': label.textContent = 'Inside lock window (minutes)'; break;
        case 'vip_customer': label.textContent = 'VIP customer?'; break;
        case 'explicit_consent': label.textContent = 'Require explicit consent'; break;
        case 'business_hours': label.textContent = 'Business hours only'; break;
        case 'skill_match': label.textContent = 'Skill match required'; break;
        case 'overtime': label.textContent = 'Overtime hours'; break;
        case 'travel_time': label.textContent = 'Travel time (min)'; break;
        case 'price_change_limit': label.textContent = 'Price change > (‚Ç¨)'; break;
        case 'commitment_change': label.textContent = 'Commitment term change'; break;
        case 'confirmation_shown': label.textContent = 'Show confirmation + retention'; break;
        case 'retention_script': label.textContent = 'Run retention script'; break;
        case 'amount_limit': label.textContent = 'Amount > (‚Ç¨)'; break;
        case 'refunds_count_window': label.textContent = 'Refunds > N in 30 days'; break;
        case 'payment_age': label.textContent = 'Payment older than (days)'; break;
        case 'order_value_limit': label.textContent = 'Order value > (‚Ç¨)'; break;
        case 'stock_substitution': label.textContent = 'Out-of-stock substitutions'; break;
        case 'prepayment_required': label.textContent = 'Pre-payment required'; break;
        case 'fulfillment_cutoff': label.textContent = 'After fulfillment cutoff'; break;
        case 'change_value_limit': label.textContent = 'Change > (‚Ç¨) Limit'; break;
        case 'after_prep_start': label.textContent = 'After prep/ship start'; break;
        case 'cancellation_fee': label.textContent = 'Restocking / cancellation fee present'; break;
        case 'address_risk': label.textContent = 'Address risk score'; break;
        case 'calendar_rules': label.textContent = 'Slot must pass calendar rules'; break;
        case 'opt_in_required': label.textContent = 'Customer opt-in required'; break;
        case 'fee_limit': label.textContent = 'Fee > (‚Ç¨) Limit'; break;
        case 'vip_exempt': label.textContent = 'VIP exempt'; break;
        case 'double_opt_in': label.textContent = 'Require double opt-in'; break;
        case 'log_consent': label.textContent = 'Log consent text'; break;
        case 'template_approved': label.textContent = 'Template approved?'; break;
        case 'send_window': label.textContent = 'Allowed send window'; break;
        case 'confidence_threshold': label.textContent = 'Confidence threshold (%)'; break;
        case 'user_consent': label.textContent = 'User consent required'; break;
        case 'redact_pii': label.textContent = 'Redact PII?'; break;
        case 'retention_limit': label.textContent = 'Retention ‚â§ (days)'; break;
        case 'staging_passed': label.textContent = 'Staging tests passed'; break;
        case 'backup_taken': label.textContent = 'Backup / Snapshot taken'; break;
        case 'client_approval': label.textContent = 'Client approval recorded'; break;
        case 'production_environment': label.textContent = 'Affects production environment'; break;
        case 'domain_verification': label.textContent = 'Domain verified'; break;
        case 'contract_signed': label.textContent = 'Contract / SOW signed'; break;
        case 'payment_verified': label.textContent = 'Payment verified'; break;
        case 'production_issue': label.textContent = 'Production incident present'; break;
        default: label.textContent = condKey; break;
      }

      // decide input type
      const key = `${actionId}::${condKey}`;
      if (/(limit|amount|value|price|cap|fee|percent|threshold|minutes|days|time|travel_time)$/i.test(condKey) || condKey==='retention_limit') {
        const inp = document.createElement('input'); inp.type='number'; inp.value = (savedValue!==undefined?savedValue:''); inp.style.min='0'; inp.style.width='160px'; inp.dataset.condKey = condKey; inp.dataset.actionId = actionId;
        row.appendChild(label); row.appendChild(inp); return row;
      }
      if (/^(business_hours|require_3ds|send_otp|block_po_box|identity_verification|human_approval|new_customer|vip_customer|paid_orders_only|unlisted_items|stock_substitution|template_approved|redact_pii|staging_passed|backup_taken|client_approval|production_environment|domain_verification|contract_signed|payment_verified|production_issue)$/i.test(condKey)) {
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!savedValue; cb.dataset.condKey = condKey; cb.dataset.actionId = actionId; row.appendChild(label); row.appendChild(cb); return row;
      }
      if (condKey==='customer_tier' || condKey==='address_risk') {
        const sel = document.createElement('select'); sel.dataset.condKey = condKey; sel.dataset.actionId = actionId; ['any','low','medium','high','vip'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); if (savedValue) sel.value = savedValue; row.appendChild(label); row.appendChild(sel); return row;
      }
      if (condKey==='send_window') {
        const inp = document.createElement('input'); inp.type='text'; inp.placeholder='09:00-20:00'; inp.value = savedValue||''; inp.dataset.condKey = condKey; inp.dataset.actionId = actionId; row.appendChild(label); row.appendChild(inp); return row;
      }
      // default: checkbox
      const cbDefault = document.createElement('input'); cbDefault.type='checkbox'; cbDefault.checked = !!savedValue; cbDefault.dataset.condKey = condKey; cbDefault.dataset.actionId = actionId; row.appendChild(label); row.appendChild(cbDefault); return row;
    }

    function loadCapabilities() {
      try { const raw = localStorage.getItem('capabilities_settings'); return raw ? JSON.parse(raw) : null; } catch(e) { return null; }
    }

    function saveCapabilities() {
      try {
        const container = document.getElementById('capabilities_actions_list');
        if (!container) return alert('Capabilities UI not ready');
        const actions = {};
        container.querySelectorAll('select').forEach(s => { actions[s.dataset.actionId] = { level: s.value }; });
        // collect per-action condition knobs
        const conditions = {};
        container.querySelectorAll('[data-action-id]').forEach(el => {
          const aid = el.dataset.actionId;
          const ckey = el.dataset.condKey;
          if (!ckey || !aid) return;
          conditions[aid] = conditions[aid] || {};
          if (el.type === 'checkbox') conditions[aid][ckey] = !!el.checked;
          else if (el.tagName === 'SELECT') conditions[aid][ckey] = el.value;
          else conditions[aid][ckey] = el.value;
        });
        // keep escalation settings
        const escalation = { timeout: Number(document.getElementById('escalationTimeout')?.value || 5), satisfaction: Number(document.getElementById('satisfactionThreshold')?.value || 5) };
        // global safeguards
        const safeguards = {
          enabled: !!document.getElementById('safeguards_enabled')?.checked,
          max_monetary_impact: Number(document.getElementById('max_monetary_impact')?.value || 0),
          actions_whitelist: Array.from(document.getElementById('actions_whitelist')?.selectedOptions || []).map(o=>o.value),
          auto_escalate: Number(document.getElementById('auto_escalate')?.value || 60),
          audit_log_enabled: !!document.getElementById('audit_log_enabled')?.checked
        };

        const obj = { actions, conditions, escalation, safeguards, updated: new Date().toISOString() };
        localStorage.setItem('capabilities_settings', JSON.stringify(obj));
        document.getElementById('dev_output').textContent = 'Capabilities saved to localStorage';
        alert('‚úì Capabilities saved successfully!');
      } catch (e) { console.error(e); alert('Error saving capabilities'); }
    }

    // Save Telephony & CRM settings
    function saveTelephony() {
      try {
        const obj = {
          crm_lookup_url: (document.getElementById('crm_lookup_url')?.value || '').trim(),
          crm_auth_token: (document.getElementById('crm_auth_token')?.value || '').trim(),
          crm_match_strategy: (document.getElementById('crm_match_strategy')?.value || 'phone'),
          crm_show_plan: !!document.getElementById('crm_show_plan')?.checked,
          crm_show_device: !!document.getElementById('crm_show_device')?.checked,
          crm_show_outage: !!document.getElementById('crm_show_outage')?.checked,
          crm_failover: (document.getElementById('crm_failover')?.value || 'ask'),
          tele_auto_open_ticket: !!document.getElementById('tele_auto_open_ticket')?.checked,
          tele_default_queue: (document.getElementById('tele_default_queue')?.value || '').trim(),
          tele_caller_risk: Number(document.getElementById('tele_caller_risk')?.value || 50),
          tele_phone_hook: (document.getElementById('tele_phone_hook')?.value || '').trim(),
          updated: new Date().toISOString()
        };
        localStorage.setItem('telephony_settings', JSON.stringify(obj));
        document.getElementById('dev_output').textContent = 'Telephony settings saved to localStorage';
        alert('‚úì Telephony settings saved successfully!');
      } catch (e) { console.error(e); alert('Error saving telephony settings'); }
    }

    function saveEscalation() {
      const caps = loadCapabilities() || { actions: {} };
      const timeout = Number(document.getElementById('escalationTimeout')?.value || 5);
      const satisfaction = Number(document.getElementById('satisfactionThreshold')?.value || 5);
      const oncall_calendar = (document.getElementById('oncall_calendar')?.value || '').trim();
      const skillQueuesRaw = (document.getElementById('skill_queues')?.value || '').trim();
      const skill_queues = skillQueuesRaw ? skillQueuesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      const sla = {
        p1: { response_min: Number(document.getElementById('sla_p1')?.value || 15), resolution_hours: Number(document.getElementById('sla_p1_res')?.value || 2) },
        p2: { response_min: Number(document.getElementById('sla_p2')?.value || 60), resolution_hours: Number(document.getElementById('sla_p2_res')?.value || 8) }
      };

      caps.escalation = { timeout, satisfaction, oncall_calendar, skill_queues, sla };
      localStorage.setItem('capabilities_settings', JSON.stringify(caps));

      // Also save richer escalation settings for the Escalation tab
      try{
        const esc = {
          team_email: (document.getElementById('teamEmail')?.value || '').trim(),
          escalation_queue: (document.getElementById('escalationQueue')?.value || '').trim(),
          oncall_calendar: oncall_calendar,
          skill_queues: skill_queues,
          sla: sla,
          support_hours: { start: document.getElementById('supportHourStart')?.value || '', end: document.getElementById('supportHourEnd')?.value || '' },
          weekend_support: !!document.getElementById('weekend_support')?.checked,
          holidays_support: !!document.getElementById('holidays_support')?.checked,
          after_hours_message: document.getElementById('afterHoursMessage')?.value || '' ,
          escalation_reasons: {
            unknown_issue: !!document.getElementById('esc_unknown_issue')?.checked,
            customer_request: !!document.getElementById('esc_customer_request')?.checked,
            complex_billing: !!document.getElementById('esc_complex_billing')?.checked,
            special_case: !!document.getElementById('esc_special_case')?.checked,
            frustrated: !!document.getElementById('esc_angry_customer')?.checked
          },
          updated: new Date().toISOString()
        };
        // store roster separately if present
        try{ const rosterRaw = localStorage.getItem('escalation_roster'); if(rosterRaw) esc.roster = JSON.parse(rosterRaw); }catch(e){}
        localStorage.setItem('escalation_settings', JSON.stringify(esc));
      }catch(e){ console.warn('Failed to save escalation_settings', e); }

      document.getElementById('dev_output').textContent = 'Escalation settings saved to localStorage';
      alert('‚úì Escalation settings saved successfully!');
    }

    // Escalation Roster helpers
    function loadEscalationRoster(){ try{ const raw = localStorage.getItem('escalation_roster'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function saveEscalationRoster(arr){ try{ localStorage.setItem('escalation_roster', JSON.stringify(arr)); }catch(e){ console.warn('save roster failed', e); } }

    function renderOncallRoster(){ const el = document.getElementById('oncall_roster_list'); if(!el) return; const arr = loadEscalationRoster(); el.innerHTML=''; if(arr.length===0){ el.innerHTML = '<div class="helper-text">Aucune entr√©e d\'astreinte. Ajoutez des techniciens ou liez des calendriers pour acheminer les escalades.</div>'; return; }
      arr.forEach((r,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(r.name||'Unnamed')}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(r.method||'')} ¬∑ ${escapeHtml(r.contact||'')}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Modifier'; edit.addEventListener('click', ()=> openOncallEditor(r,i)); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Supprimer'; rem.addEventListener('click', ()=>{ if(!confirm('Supprimer l\'entr√©e d\'astreinte pour '+r.name+' ?')) return; const a = loadEscalationRoster(); a.splice(i,1); saveEscalationRoster(a); renderOncallRoster(); }); controls.appendChild(edit); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); el.appendChild(row); }); }

    function openOncallEditor(existing, index){ // small modal editor
      return new Promise((resolve,reject)=>{
        let modal = document.getElementById('oncall_editor'); if(!modal){ modal = document.createElement('div'); modal.id='oncall_editor'; modal.style.position='fixed'; modal.style.left='20%'; modal.style.right='20%'; modal.style.top='12%'; modal.style.bottom='12%'; modal.style.background='var(--card)'; modal.style.zIndex=10001; modal.style.overflow='auto'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.color='var(--fg)'; modal.style.border='1px solid var(--border)'; document.body.appendChild(modal); }
        modal.innerHTML=''; const title = document.createElement('h3'); title.textContent = existing ? 'Modifier une entr√©e d\'astreinte' : 'Ajouter une entr√©e d\'astreinte'; modal.appendChild(title);
        const form = document.createElement('div'); form.style.display='grid'; form.style.gridTemplateColumns='1fr 1fr'; form.style.gap='8px';
        const name = document.createElement('input'); name.placeholder='Nom'; name.value = existing?.name||''; const contact = document.createElement('input'); contact.placeholder='Contact (email ou t√©l√©phone)'; contact.value = existing?.contact||'';
        const method = document.createElement('select'); method.innerHTML = '<option value="email">E-mail</option><option value="phone">T√©l√©phone</option><option value="pager">Pager/SMS</option>'; method.value = existing?.method||'email'; const calendarSel = document.createElement('select'); calendarSel.innerHTML = '<option value="">-- pas de calendrier --</option>';
        // populate with uploaded calendars if available
        try{ const calRaw = localStorage.getItem('uploaded_calendars'); const cals = calRaw?JSON.parse(calRaw):[]; (cals||[]).forEach(c=>{ const o = document.createElement('option'); o.value = c.id || c.name; o.textContent = c.name || c.id; calendarSel.appendChild(o); }); }catch(e){}
        calendarSel.value = existing?.calendar||'';
        const start = document.createElement('input'); start.type='date'; start.value = existing?.start||''; const end = document.createElement('input'); end.type='date'; end.value = existing?.end||'';
        form.appendChild(name); form.appendChild(contact); form.appendChild(method); form.appendChild(calendarSel); form.appendChild(start); form.appendChild(end);
        modal.appendChild(form);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='12px'; const save = document.createElement('button'); save.className='save-btn'; save.textContent='Enregistrer'; save.addEventListener('click', ()=>{
          const obj = { name: name.value.trim(), contact: contact.value.trim(), method: method.value, calendar: calendarSel.value, start: start.value||null, end: end.value||null };
          let arr = loadEscalationRoster(); if(Number.isInteger(index) && index>=0) arr[index] = obj; else arr.push(obj); saveEscalationRoster(arr); modal.remove(); renderOncallRoster(); resolve(obj);
        }); const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Annuler'; cancel.addEventListener('click', ()=>{ modal.remove(); reject(new Error('cancel')); }); actions.appendChild(save); actions.appendChild(cancel); modal.appendChild(actions);
      });
    }

    function addOncallEntry(){ openOncallEditor(null).catch(()=>{}); }

    // Test paging/alert (simulated)
    function testEscalationAlert(){ const roster = loadEscalationRoster(); if(!roster || roster.length===0) return alert('Aucune entr√©e d\'astreinte √† tester. Ajoutez au moins un technicien.'); const idx = 0; const target = roster[idx]; // choose first for demo
      const msg = `Test alert to ${target.name} (${target.contact}) via ${target.method}`;
      showModal('Test Alert', `<div style="padding:12px;"><p>${escapeHtml(msg)}</p><p style="color:var(--muted)">Ceci est une alerte simul√©e (d√©mo uniquement).</p><button class=\"btn\" onclick=\"document.getElementById('template_snippets_panel').remove()\">Fermer</button></div>`);
    }

    function loadEscalationSettings(){
      try{
        const raw = localStorage.getItem('escalation_settings'); if(!raw) return;
        const esc = JSON.parse(raw);
        if(esc.team_email) document.getElementById('teamEmail').value = esc.team_email;
        if(esc.escalation_queue) document.getElementById('escalationQueue').value = esc.escalation_queue;
        if(esc.oncall_calendar) document.getElementById('oncall_calendar').value = esc.oncall_calendar;
        if(esc.skill_queues) document.getElementById('skill_queues').value = (esc.skill_queues || []).join(',');
        if(esc.sla){ document.getElementById('sla_p1').value = esc.sla.p1?.response_min || 15; document.getElementById('sla_p1_res').value = esc.sla.p1?.resolution_hours || 2; document.getElementById('sla_p2').value = esc.sla.p2?.response_min || 60; document.getElementById('sla_p2_res').value = esc.sla.p2?.resolution_hours || 8; }
        if(esc.support_hours){ document.getElementById('supportHourStart').value = esc.support_hours.start || '09:00'; document.getElementById('supportHourEnd').value = esc.support_hours.end || '17:00'; }
        document.getElementById('weekend_support').checked = !!esc.weekend_support; document.getElementById('holidays_support').checked = !!esc.holidays_support;
        if(esc.after_hours_message) document.getElementById('afterHoursMessage').value = esc.after_hours_message;
        if(esc.escalation_reasons){ document.getElementById('esc_unknown_issue').checked = !!esc.escalation_reasons.unknown_issue; document.getElementById('esc_customer_request').checked = !!esc.escalation_reasons.customer_request; document.getElementById('esc_complex_billing').checked = !!esc.escalation_reasons.complex_billing; document.getElementById('esc_special_case').checked = !!esc.escalation_reasons.special_case; document.getElementById('esc_angry_customer').checked = !!esc.escalation_reasons.frustrated; }
        // if roster included, ensure it's saved to escalation_roster
        if(esc.roster && Array.isArray(esc.roster)){
          saveEscalationRoster(esc.roster);
        }
      }catch(e){ console.warn('Failed to load escalation_settings', e); }
    }
    function exportAnalytics(format) {
      alert(`‚úì Analytics exported as ${format.toUpperCase()}!`);
    }

    /* --- Storage & Analytics helpers --- */
    function loadStorageAnalyticsSettings(){ try{ const raw = localStorage.getItem('storage_analytics_settings'); return raw?JSON.parse(raw):{telemetry_opt_in:false, retention_days:90}; }catch(e){return {telemetry_opt_in:false, retention_days:90};} }
    function saveStorageAnalyticsSettings(s){ localStorage.setItem('storage_analytics_settings', JSON.stringify(s)); }

    function renderStorageAnalytics(){
      const out = document.getElementById('storage_keys_list'); if(!out) return;
      out.innerHTML = '';
      // list keys and approximate sizes
      const rows = [];
      for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); try{ const v = localStorage.getItem(k)||''; rows.push({key:k, size: new Blob([v]).size}); }catch(e){} }
      rows.sort((a,b)=>b.size-a.size);
      if(rows.length===0) { out.innerHTML = '<div class="helper-text">No storage keys found.</div>'; } else {
        rows.forEach(r=>{
          const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='8px'; el.style.padding='6px'; el.style.borderBottom='1px solid var(--border)';
          const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(r.key)}</strong><div style="color:var(--muted); font-size:0.9rem;">${r.size} bytes</div>`;
          const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
          const view = document.createElement('button'); view.className='btn'; view.textContent='Voir'; view.addEventListener('click', ()=>{ const val = localStorage.getItem(r.key)||''; showModal('Cl√© : '+r.key, '<pre style="white-space:pre-wrap; max-height:320px; overflow:auto;">'+escapeHtml(val)+'</pre>'); });
          const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Exporter'; dl.addEventListener('click', ()=>{ const v = localStorage.getItem(r.key)||''; const blob = new Blob([v], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `${r.key}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); });
          const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Supprimer'; rem.addEventListener('click', ()=>{ if(!confirm('Supprimer la cl√© localStorage '+r.key+' ?')) return; localStorage.removeItem(r.key); renderStorageAnalytics(); });
          controls.appendChild(view); controls.appendChild(dl); controls.appendChild(rem);
          el.appendChild(left); el.appendChild(controls); out.appendChild(el);
        });
      }
      renderAnalyticsEventsList();
      // telemetry checkbox
      const s = loadStorageAnalyticsSettings(); const tb = document.getElementById('telemetry_opt_in'); if(tb) tb.checked = !!s.telemetry_opt_in; const rd = document.getElementById('storage_retention_days'); if(rd) rd.value = s.retention_days||90;
    }

    function exportAllLocalStorage(){
      const obj = {};
      for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); try{ obj[k]=JSON.parse(localStorage.getItem(k)); }catch(e){ obj[k]=localStorage.getItem(k); } }
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'localstorage-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }

    function handleImportLocalStorageFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(){ try{ const parsed = JSON.parse(String(reader.result||'')); if(typeof parsed !== 'object'){ return alert('Imported JSON should be an object of key:value pairs'); } Object.keys(parsed).forEach(k=>{ try{ localStorage.setItem(k, typeof parsed[k] === 'string' ? parsed[k] : JSON.stringify(parsed[k])); }catch(err){} }); alert('Imported '+Object.keys(parsed).length+' keys into localStorage (demo only)'); renderStorageAnalytics(); }catch(err){ alert('Import error: '+err.message); } }; reader.readAsText(file);
    }

    function purgeStorageOlderThan(){ const days = Number(document.getElementById('storage_retention_days')?.value || 90); if(!confirm('Purge demo data older than '+days+' days? This affects demo keys that include a timestamp.')) return; const cutoff = Date.now() - (days*24*60*60*1000);
      // heuristic: many demo keys store objects with created_at or timestamps; try to parse and remove those older than cutoff
      let removed = 0; for(let i=localStorage.length-1;i>=0;i--){ const k=localStorage.key(i); try{ const v = localStorage.getItem(k); if(!v) continue; let parsed; try{ parsed = JSON.parse(v); }catch(e){ parsed = null; }
        let t = null; if(parsed && parsed.created_at) t = Date.parse(parsed.created_at); else if(parsed && parsed.updated) t = Date.parse(parsed.updated); else {
          // try numeric timestamp inside string
          const m = v.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/); if(m) t = Date.parse(m[0]);
        }
        if(t && !isNaN(t) && t < cutoff){ localStorage.removeItem(k); removed++; }
      }catch(e){} }
      alert('Purge complete. Removed '+removed+' keys (heuristic)'); renderStorageAnalytics();
    }

    function showModal(title, html){ let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); } panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn); const t = document.createElement('h3'); t.textContent = title; t.style.marginTop='0'; panel.appendChild(t); const wrapper = document.createElement('div'); wrapper.style.marginTop='8px'; wrapper.innerHTML = html; panel.appendChild(wrapper); }

    function generateSampleEvent(){ const s = loadStorageAnalyticsSettings(); if(!s.telemetry_opt_in){ if(!confirm('Telemetry is currently disabled. Enable it to generate anonymized events?')) return; s.telemetry_opt_in = true; saveStorageAnalyticsSettings(s); }
      const arrRaw = localStorage.getItem('analytics_events'); let arr = []; try{ arr = arrRaw?JSON.parse(arrRaw):[]; }catch(e){ arr = []; }
      arr.push({ id: 'evt-'+Date.now(), type:'sample.event', created_at: new Date().toISOString(), meta:{demo:true} }); localStorage.setItem('analytics_events', JSON.stringify(arr)); renderAnalyticsEventsList(); }

    function renderAnalyticsEventsList(){ const el = document.getElementById('analytics_events_list'); if(!el) return; const raw = localStorage.getItem('analytics_events'); let arr = []; try{ arr = raw?JSON.parse(raw):[]; }catch(e){ arr = []; }
      el.innerHTML = ''; if(arr.length===0){ el.innerHTML = '<div class="helper-text">Aucun √©v√©nement d\'analyse enregistr√© pour le moment.</div>'; return; }
      arr.slice(-100).reverse().forEach(a=>{ const row = document.createElement('div'); row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)'; row.innerHTML = `<div style="font-weight:600">${escapeHtml(a.type||'event')}</div><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(a.created_at||'')}</div><div style="margin-top:6px;">${escapeHtml(JSON.stringify(a.meta||{}))}</div>`; el.appendChild(row); });
    }

    function clearAnalyticsEvents(){ if(!confirm('Clear stored analytics events?')) return; localStorage.removeItem('analytics_events'); renderAnalyticsEventsList(); }

    function clearAllDemoStorage(){ if(!confirm('Clear all localStorage used by this demo? This cannot be undone.')) return; // remove keys that look demo-related
      const preserve = []; const removed = []; for(let i=localStorage.length-1;i>=0;i--){ const k = localStorage.key(i); if(k && (k.startsWith('capabilities')||k.startsWith('telephony')||k.startsWith('templates')||k.startsWith('knowledge')||k.startsWith('invoices')||k.startsWith('analytics')||k.startsWith('uploaded_')||k==='storage_analytics_settings')){ localStorage.removeItem(k); removed.push(k); } }
      alert('Removed '+removed.length+' demo keys.'); renderStorageAnalytics(); }

    function saveQuotes() {
      // simple demo save handler for quotes settings
      const form = document.getElementById('quotesForm');
      if (!form) return alert('Quotes form not found');
      // for now just notify ‚Äî could serialize like others
      alert('‚úì Param√®tres des devis enregistr√©s avec succ√®s !');
    }

    function previewQuote(){
      // Use modal item editor instead of prompt for better UX
      const cur = {};
      cur.currency = document.getElementById('quotes_currency')?.value || 'USD';
      cur.vat = Number(document.getElementById('quotes_vat')?.value || 0);
      cur.valid_days = Number(document.getElementById('quotes_valid_days')?.value || 30);
      cur.subject = document.getElementById('quotes_template_subject')?.value || 'Quote';
      cur.body = document.getElementById('quotes_template_body')?.value || '';
      // get items from modal editor
      openLineItemEditor([]).then(items=>{
        if(!items || items.length===0) items = [{desc:'Service (demo)', amount:100}];
        const subtotal = items.reduce((s,i)=>s + (i.amount||0), 0);
        const vatAmount = Math.round((subtotal * (cur.vat/100))*100)/100;
        const total = Math.round((subtotal + vatAmount)*100)/100;
        // render overlay preview
        let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'Quote Preview'; title.style.marginTop='0'; panel.appendChild(title);
        const subj = document.createElement('div'); subj.innerHTML = '<strong>Subject:</strong> ' + escapeHtml(cur.subject); subj.style.marginTop='8px'; panel.appendChild(subj);
        const bodyEl = document.createElement('div'); bodyEl.style.marginTop='8px'; bodyEl.innerHTML = '<strong>Message:</strong><div style="white-space:pre-wrap; border:1px solid var(--border); padding:8px; border-radius:6px; margin-top:6px; background:var(--panel);">' + escapeHtml(cur.body) + '</div>'; panel.appendChild(bodyEl);
        const list = document.createElement('div'); list.style.marginTop='12px'; list.innerHTML = '<strong>Items</strong>';
        const ul = document.createElement('div'); ul.style.marginTop='6px'; items.forEach(it=>{ const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.padding='6px 0'; r.innerHTML = '<div>'+escapeHtml(it.desc)+'</div><div>'+escapeHtml((it.amount||0).toFixed(2))+' '+escapeHtml(cur.currency)+'</div>'; ul.appendChild(r); }); list.appendChild(ul); panel.appendChild(list);
        const sums = document.createElement('div'); sums.style.marginTop='12px'; sums.innerHTML = `<div style="display:flex; justify-content:space-between"><div>Subtotal</div><div>${subtotal.toFixed(2)} ${escapeHtml(cur.currency)}</div></div><div style="display:flex; justify-content:space-between"><div>VAT (${cur.vat}%)</div><div>${vatAmount.toFixed(2)} ${escapeHtml(cur.currency)}</div></div><div style="display:flex; justify-content:space-between; font-weight:700; margin-top:6px"><div>Total</div><div>${total.toFixed(2)} ${escapeHtml(cur.currency)}</div></div>`;
        panel.appendChild(sums);
      }).catch(()=>{ /* user cancelled */ });
    }

    function exportInvoiceSample(){
      // Use modal editor to build items; then save invoice to history and download
      openLineItemEditor([]).then(items=>{
        const subtotal = items.reduce((s,i)=>s + (i.amount||0), 0);
        const invoice = { id: 'inv-'+Date.now(), created_at: new Date().toISOString(), currency: document.getElementById('quotes_currency')?.value || 'USD', vat: Number(document.getElementById('quotes_vat')?.value || 0), valid_days: Number(document.getElementById('quotes_valid_days')?.value || 30), subject: document.getElementById('quotes_template_subject')?.value || '', body: document.getElementById('quotes_template_body')?.value || '', items: items.length?items:[{desc:'Demo service', amount:100}], subtotal };
        invoice.vat_amount = Math.round((invoice.subtotal * (invoice.vat/100))*100)/100; invoice.total = Math.round((invoice.subtotal + invoice.vat_amount)*100)/100;
        // save to history
        try{ const histRaw = localStorage.getItem('invoices'); const hist = histRaw?JSON.parse(histRaw):[]; hist.unshift(invoice); localStorage.setItem('invoices', JSON.stringify(hist)); }catch(e){}
        // download
        const blob = new Blob([JSON.stringify(invoice, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoice-${invoice.id}.json`; document.body.appendChild(a); a.click(); a.remove();
        // refresh history UI if open
        renderInvoiceHistoryList();
      }).catch(()=>{});
    }

    /* --- Invoice Templates management (simple client-side) --- */
    function loadInvoiceTemplates(){ try{ const raw = localStorage.getItem('invoice_templates'); return raw?JSON.parse(raw):[]; }catch(e){return[];} }
    function saveInvoiceTemplates(arr){ localStorage.setItem('invoice_templates', JSON.stringify(arr)); }

    function importInvoiceTemplate(){ const f = document.getElementById('invoice_template_import_file'); if(!f) return alert('Invoice import input not available'); f.value=''; f.click(); }

    function handleInvoiceTemplateFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const name = file.name || 'invoice-template'; const reader = new FileReader(); reader.onload = function(){ const txt = String(reader.result||''); if(!txt.trim()) return alert('Empty file'); if(name.toLowerCase().endsWith('.json')){ try{ const parsed = JSON.parse(txt); if(Array.isArray(parsed)){ const cur = loadInvoiceTemplates(); saveInvoiceTemplates(cur.concat(parsed)); renderInvoiceTemplatesList(); alert('Imported '+parsed.length+' invoice templates'); } else { // try to accept object
            const cur = loadInvoiceTemplates(); cur.push(parsed); saveInvoiceTemplates(cur); renderInvoiceTemplatesList(); alert('Imported invoice template'); }
          }catch(err){ alert('JSON parse error: '+err.message); } }
        else { // treat as text/markdown: split paragraphs as potential templates
          const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean); if(parts.length===0) return alert('No template text found'); const cur = loadInvoiceTemplates(); parts.forEach((p,i)=> cur.push({name: name + (parts.length>1? ' - part '+(i+1):''), body: p})); saveInvoiceTemplates(cur); renderInvoiceTemplatesList(); alert('Imported '+parts.length+' invoice snippets'); }
    }; reader.readAsText(file); }

    function renderInvoiceTemplatesList(){ const el = document.getElementById('invoice_templates_list'); if(!el) return; const arr = loadInvoiceTemplates(); el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">Aucun mod√®le de facture disponible.</div>'; return; } arr.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='6px'; row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(t.name||('Template '+(i+1)))}</strong><div style="color:var(--muted)">${escapeHtml(((t.body||'').slice(0,140))) + ((t.body||'').length>140?'...':'')}</div></div>`; const view = document.createElement('button'); view.className='btn'; view.textContent='Voir'; view.addEventListener('click', ()=>{ let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); } panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn); const title = document.createElement('h3'); title.textContent = t.name || 'Mod√®le de facture'; title.style.marginTop='0'; panel.appendChild(title); const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.background='rgba(255,255,255,0.02)'; pre.style.padding='12px'; pre.style.borderRadius='8px'; pre.textContent = t.body || ''; panel.appendChild(pre); }); const rem = document.createElement('button'); rem.className='btn'; rem.textContent='Supprimer'; rem.style.background='#d9534f'; rem.addEventListener('click', ()=>{ const arr2 = loadInvoiceTemplates(); arr2.splice(i,1); saveInvoiceTemplates(arr2); renderInvoiceTemplatesList(); }); row.appendChild(view); row.appendChild(rem); el.appendChild(row); }); }

    function exportInvoiceTemplates(){ const arr = loadInvoiceTemplates(); const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoice-templates.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); }

    // --- Line Item Editor Modal ---
    function openLineItemEditor(initialItems){
      return new Promise((resolve, reject)=>{
        let modal = document.getElementById('line_item_editor');
        if(!modal){ modal = document.createElement('div'); modal.id='line_item_editor'; modal.style.position='fixed'; modal.style.left='20%'; modal.style.right='20%'; modal.style.top='10%'; modal.style.bottom='10%'; modal.style.background='var(--card)'; modal.style.zIndex=10000; modal.style.overflow='auto'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.color='var(--fg)'; modal.style.border='1px solid var(--border)'; document.body.appendChild(modal); }
        modal.innerHTML='';
        const title = document.createElement('h3'); title.textContent='Line Items'; modal.appendChild(title);
        const list = document.createElement('div'); list.id='line_items_container'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px'; list.style.marginTop='8px'; modal.appendChild(list);
        const addRow = (it)=>{
          const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; const desc = document.createElement('input'); desc.type='text'; desc.placeholder='Description'; desc.value = it.desc || ''; desc.style.flex='1'; const amt = document.createElement('input'); amt.type='number'; amt.step='0.01'; amt.min='0'; amt.value = (it.amount!=null?it.amount:''); amt.style.width='120px'; const del = document.createElement('button'); del.className='btn'; del.textContent='Supprimer'; del.style.background='#d9534f'; del.addEventListener('click', ()=>{ row.remove(); }); row.appendChild(desc); row.appendChild(amt); row.appendChild(del); list.appendChild(row); };
        (initialItems||[]).forEach(i=> addRow(i));
        const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Ajouter un article'; addBtn.addEventListener('click', ()=> addRow({desc:'', amount:0})); modal.appendChild(addBtn);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='12px'; const save = document.createElement('button'); save.className='save-btn'; save.textContent='Enregistrer les articles'; save.addEventListener('click', ()=>{
          const rows = Array.from(list.children); const items = rows.map(r=>{ const d = r.querySelector('input[type="text"]')?.value||''; const a = Number(r.querySelector('input[type="number"]')?.value||0); return {desc:d.trim(), amount: Math.round(a*100)/100}; }).filter(x=>x.desc);
          modal.remove(); resolve(items);
        }); const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.addEventListener('click', ()=>{ modal.remove(); reject(new Error('cancel')); }); actions.appendChild(save); actions.appendChild(cancel); modal.appendChild(actions);
      });
    }

    // --- Invoice History (local-only) ---
    function loadInvoiceHistory(){ try{ const raw = localStorage.getItem('invoices'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function renderInvoiceHistoryList(){ const el = document.getElementById('invoice_history_list'); if(!el) return; const arr = loadInvoiceHistory(); el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">Aucune facture pour le moment. Exportez-en une pour remplir l\'historique.</div>'; return; } arr.forEach((inv,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(inv.id)}</strong><div style="color:var(--muted); font-size:0.9rem;">${new Date(inv.created_at).toLocaleString()} ‚Äî ${escapeHtml((inv.total||0).toFixed?inv.total.toFixed(2):String(inv.total))} ${escapeHtml(inv.currency||'')}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const dl = document.createElement('button'); dl.className='btn'; dl.textContent='T√©l√©charger'; dl.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(inv, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${inv.id}.json`; document.body.appendChild(a); a.click(); a.remove(); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Supprimer'; rem.addEventListener('click', ()=>{ if(!confirm('Supprimer la facture '+inv.id+' de l\'historique ?')) return; const a2 = loadInvoiceHistory(); a2.splice(i,1); localStorage.setItem('invoices', JSON.stringify(a2)); renderInvoiceHistoryList(); }); controls.appendChild(dl); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); el.appendChild(row); }); }
    function openInvoiceHistory(){ // show modal with invoice history
      let panel = document.getElementById('invoice_history_panel');
      if(!panel){ panel = document.createElement('div'); panel.id='invoice_history_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
       panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent='Invoice History'; title.style.marginTop='0'; panel.appendChild(title);
      const container = document.createElement('div'); container.id='invoice_history_list'; container.style.marginTop='12px'; panel.appendChild(container);
      renderInvoiceHistoryList();
    }

    function saveAppointments() {
      const f = document.getElementById('appointmentsForm');
      if (!f) return alert('Formulaire de rendez-vous introuvable');
      alert('‚úì Param√®tres de rendez-vous enregistr√©s avec succ√®s !');
    }

    function saveReservation() {
      const f = document.getElementById('reservationForm');
      if (!f) return alert('Formulaire de r√©servation introuvable');
      alert('‚úì Param√®tres de r√©servation enregistr√©s avec succ√®s !');
    }

    // Rule builder helpers for Ticketing auto-create rules
    function insertRuleTemplate(){
      const el = document.getElementById('ticket_create_rule');
      if(!el) return alert('Rule input not found');
      el.value = 'when: confidence < 50% OR outage_detected';
      el.focus();
    }

    function addRuleCondition(){
      const cond = document.getElementById('rb_condition')?.value;
      const op = document.getElementById('rb_operator')?.value;
      const val = (document.getElementById('rb_value')?.value || '').trim();
      const input = document.getElementById('ticket_create_rule');
      if(!cond || !input) return alert('Builder or rule input not found');

      let fragment = '';
      // boolean conditions don't need operator/value
      const booleanConds = ['outage_detected','high_priority_account','failed_checks'];
      if(booleanConds.includes(cond)){
        fragment = cond;
      } else {
        // require value for numeric/qualitative conditions
        if(!val){ return alert('Please provide a value for this condition'); }
        fragment = `${cond} ${op} ${val}`;
      }

      // build into rule input
      let cur = (input.value || '').trim();
      if(!cur){
        input.value = `when: ${fragment}`;
      } else {
        // if cur already starts with "when:", append with AND
        if(/^when:/i.test(cur)) input.value = cur + ' AND ' + fragment;
        else input.value = cur + ' AND ' + fragment;
      }
      input.focus();
      // clear value field for convenience
      const rv = document.getElementById('rb_value'); if(rv) rv.value = '';
    }

    // Knowledge (FAQ) handlers
    function renderFaqRow(q='', a=''){
      const container = document.getElementById('faqs_list');
      if (!container) return;
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 1fr auto';
      row.style.gap = '8px';
      row.innerHTML = `
        <input class="faq-q" placeholder="Question" value="${escapeHtml(q)}" />
        <textarea class="faq-a" placeholder="Short answer">${escapeHtml(a)}</textarea>
        <div style="display:flex; flex-direction:column; gap:8px;"><button type="button" class="btn remove-faq">Remove</button></div>
      `;
      container.appendChild(row);
      row.querySelector('.remove-faq').addEventListener('click', ()=>row.remove());
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function loadKnowledge(){
      // Load saved FAQs and recent questions (demo: from localStorage)
      const faqsRaw = localStorage.getItem('knowledge_faqs');
      const recentRaw = localStorage.getItem('recent_questions');
      const container = document.getElementById('faqs_list');
      if (container) container.innerHTML='';
      try{
        const faqs = faqsRaw ? JSON.parse(faqsRaw) : [];
        (faqs||[]).forEach(item=> renderFaqRow(item.question || '', item.answer || ''));
      }catch(e){ console.warn('Could not parse saved faqs', e); }

      // Sample recent questions if none are present
      let recent = [];
      try{ recent = recentRaw ? JSON.parse(recentRaw) : []; }catch(e){ recent = []; }
      if (!recent || recent.length===0){
        recent = [
          {q:'How can I change my password?', id:1},
          {q:'What are your opening hours on weekends?', id:2},
          {q:'Do you offer maintenance contracts?', id:3}
        ];
      }
      const recentEl = document.getElementById('recent_questions');
      if (recentEl) recentEl.innerHTML = '';
      recent.forEach(r=>{
        const el = document.createElement('div');
        el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='12px';
        const left = document.createElement('div'); left.style.flex='1'; left.textContent = r.q;
        const btn = document.createElement('button'); btn.type='button'; btn.className='btn'; btn.textContent='Add answer';
        btn.addEventListener('click', ()=>{
          renderFaqRow(r.q,'');
          // scroll to bottom
          document.getElementById('faqs_list').lastElementChild.scrollIntoView({behavior:'smooth'});
        });
        el.appendChild(left); el.appendChild(btn);
        if (recentEl) recentEl.appendChild(el);
      });
    }

    function saveKnowledge(){
      const container = document.getElementById('faqs_list');
      if (!container) return alert('FAQ list not found');
      const rows = Array.from(container.children);
      const faqs = rows.map(r=>{
        const q = r.querySelector('.faq-q')?.value || '';
        const a = r.querySelector('.faq-a')?.value || '';
        return {question: q, answer: a};
      }).filter(x=>x.question.trim());
      localStorage.setItem('knowledge_faqs', JSON.stringify(faqs));
      alert('‚úì FAQ Knowledge saved');
    }

    // Avatar preview handler
    (function(){
      const avatarFile = document.getElementById('avatar_file');
      const avatarPreview = document.getElementById('avatar_preview');
      if (!avatarFile) return;
      avatarFile.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(){ if (avatarPreview) avatarPreview.src = reader.result; };
        reader.readAsDataURL(f);
      });
    })();

    // init knowledge UI after DOM is ready
    (function(){
      // add handler for Add FAQ button
      const addBtn = document.getElementById('knowledge_add');
      if (addBtn) addBtn.addEventListener('click', ()=> renderFaqRow('',''));
      // load knowledge and recent questions
      loadKnowledge();
    })();

    // Section enable/disable helpers
    (function(){
      function setDisabledForForm(formEl, disabled, excludeIds){
        if (!formEl) return;
        const els = formEl.querySelectorAll('input,select,textarea,button');
        els.forEach(el=>{
          // skip excluded ids (like the hidden checkbox)
          if (excludeIds && excludeIds.includes(el.id)) return;
          // never disable visible toggle buttons (they control the section)
          if (el.classList && el.classList.contains('toggle-btn')) return;
          // skip elements used as the visual toggle (data-checkbox) if present
          if (el.dataset && el.dataset.checkbox) return;
          try{ el.disabled = !!disabled; }catch(e){}
        });
        // toggle visual class on the main form or section
        if (disabled) formEl.classList.add('disabled-section'); else formEl.classList.remove('disabled-section');
      }

      function updateSectionState(){
        // Quotes
        const quotesToggle = document.getElementById('quotes_enabled');
        const quotesForm = document.getElementById('quotesForm');
        setDisabledForForm(quotesForm, !quotesToggle?.checked, ['quotes_enabled']);

        // Appointments
        const apptsToggle = document.getElementById('appts_enabled');
        const apptsForm = document.getElementById('appointmentsForm');
        setDisabledForForm(apptsForm, !apptsToggle?.checked, ['appts_enabled']);

        // Reservation
        const resvToggle = document.getElementById('resv_enabled');
        const resvForm = document.getElementById('reservationForm');
        setDisabledForForm(resvForm, !resvToggle?.checked, ['resv_enabled']);

        // Snaps section inside privacy
        const snapsToggle = document.getElementById('snaps_store_enabled');
        const snapsSection = document.getElementById('snaps_section');
        if (snapsSection){
          const inputs = snapsSection.querySelectorAll('input,select,textarea,button');
          inputs.forEach(i=>{ if (i.id !== 'snaps_store_enabled') i.disabled = !snapsToggle?.checked; });
          if (!snapsToggle?.checked) snapsSection.classList.add('disabled-section'); else snapsSection.classList.remove('disabled-section');
        }
      }

      // wire toggles to update state
      ['quotes_enabled','appts_enabled','resv_enabled','snaps_store_enabled'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateSectionState);
      });

      // initialize toggle buttons (sync hidden checkboxes with visible toggles)
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        const cbId = btn.dataset.checkbox;
        const cb = document.getElementById(cbId);
        function updateBtn(){
          const on = !!(cb && cb.checked);
          btn.classList.toggle('on', on);
          btn.setAttribute('aria-checked', on ? 'true' : 'false');
          btn.querySelector('.label').textContent = on ? 'On' : 'Off';
        }
        // click toggles the hidden checkbox and fires change
        btn.addEventListener('click', ()=>{
          if (!cb) return;
          cb.checked = !cb.checked;
          // dispatch change so other handlers run
          cb.dispatchEvent(new Event('change', {bubbles:true}));
          updateBtn();
        });
        // when the checkbox changes (programmatic), update UI
        if (cb) cb.addEventListener('change', updateBtn);
        // initial state
        updateBtn();
      });

      // run at startup
      updateSectionState();
      // expose for debugging
      window.updateSectionState = updateSectionState;
    })();

    // Preset apply handlers
    (function(){
      function setVal(id, val){
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = !!val;
        else el.value = val;
      }

      function applyPreset(name){
        switch(name){
          case 'services':
            setVal('personalityType','friendly');
            setVal('appts_enabled', true);
            setVal('appts_duration',30);
            setVal('primaryLanguage','en');
            break;
          case 'retail':
            setVal('personalityType','concise');
            setVal('quotes_enabled', true);
            setVal('quotes_currency','EUR');
            setVal('quotes_vat',20);
            break;
          case 'restaurant':
            setVal('personalityType','friendly');
            setVal('resv_enabled', true);
            setVal('resv_party_default',2);
            break;
          case 'it':
            setVal('personalityType','technical');
            // enable some troubleshooting capabilities if present
            const cap = document.getElementById('cap_basic_troubleshooting'); if (cap) cap.checked = true;
            break;
          case 'education':
            setVal('personalityType','professional');
            setVal('primaryLanguage','en');
            break;
          case 'healthcare':
            setVal('personalityType','professional');
            setVal('appts_enabled', true);
            break;
          case 'ecommerce':
            setVal('personalityType','concise');
            setVal('quotes_enabled', true);
            break;
          case 'professional':
            setVal('personalityType','professional');
            setVal('quotes_enabled', true);
            break;
        }
        alert('Preset "' + name + '" applied (unsaved)');
      }

      document.querySelectorAll('.preset-apply').forEach(b=> b.addEventListener('click', ()=>{
        const p = b.dataset.preset; if (!p) return;
        applyPreset(p);
      }));
    })();

    // Data & Privacy handlers
    (function(){
      function loadPrivacySettings(){ try{ const raw = localStorage.getItem('privacy_settings'); return raw?JSON.parse(raw):{}; }catch(e){ return {}; } }

      function loadPrivacy(){
        try{
          const pRaw = localStorage.getItem('privacy_settings');
          const sRaw = localStorage.getItem('storage_settings');
          const p = pRaw ? JSON.parse(pRaw) : {};
          const s = sRaw ? JSON.parse(sRaw) : {};
          document.getElementById('privacy_consent_enabled').checked = !!p.consent_enabled;
          document.getElementById('privacy_consent_text').value = p.consent_text || '';
          document.getElementById('privacy_retention_days').value = p.retention_days != null ? p.retention_days : 0;
          document.getElementById('privacy_pii_redact').checked = !!p.pii_redaction;
          document.getElementById('privacy_pii_email').checked = !!p.pii_redact_email;
          document.getElementById('privacy_pii_phone').checked = !!p.pii_redact_phone;
          document.getElementById('privacy_pii_names').checked = !!p.pii_redact_names;
          if (p.data_residency) document.getElementById('privacy_data_residency').value = p.data_residency;
          document.getElementById('privacy_dpa_url').value = p.dpa_url || '';

          document.getElementById('snaps_store_enabled').checked = !!s.store_snaps;
          document.getElementById('snaps_last_n').value = s.snaps_last_n != null ? s.snaps_last_n : 10;
          document.getElementById('snaps_unresolved').checked = !!s.snaps_unresolved;
          document.getElementById('snaps_intents_only').checked = !!s.snaps_intents_only;

          renderSnapsPreview();
        }catch(e){ console.warn('loadPrivacy error', e); }
      }

      function savePrivacy(){
        const p = {
          consent_enabled: !!document.getElementById('privacy_consent_enabled').checked,
          consent_text: document.getElementById('privacy_consent_text').value || '',
          retention_days: Number(document.getElementById('privacy_retention_days').value||0),
          pii_redaction: !!document.getElementById('privacy_pii_redact').checked,
          pii_redact_email: !!document.getElementById('privacy_pii_email')?.checked,
          pii_redact_phone: !!document.getElementById('privacy_pii_phone')?.checked,
          pii_redact_names: !!document.getElementById('privacy_pii_names')?.checked,
          data_residency: document.getElementById('privacy_data_residency').value || 'eu',
          dpa_url: document.getElementById('privacy_dpa_url').value || ''
        };
        localStorage.setItem('privacy_settings', JSON.stringify(p));
        // also save storage settings
        const s = {
          store_snaps: !!document.getElementById('snaps_store_enabled').checked,
          snaps_last_n: Number(document.getElementById('snaps_last_n').value||0),
          snaps_unresolved: !!document.getElementById('snaps_unresolved').checked,
          snaps_intents_only: !!document.getElementById('snaps_intents_only').checked
        };
        localStorage.setItem('storage_settings', JSON.stringify(s));
        alert('‚úì Data & Privacy settings saved');
        renderSnapsPreview();
      }

      function exportUserData(){
        // compile a small export of data stored in localStorage for the demo
        const payload = {};
        try{
          ['privacy_settings','storage_settings','knowledge_faqs','recent_questions'].forEach(k=>{
            const v = localStorage.getItem(k);
            payload[k] = v ? JSON.parse(v) : null;
          });
        }catch(e){ console.warn('exportUserData parse', e); }
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'user-data-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function exportAuditLog(){
        const raw = localStorage.getItem('audit_log') || '[]';
        const blob = new Blob([raw], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'audit-log.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      }

      function simulateConsentBanner(){
        const txt = document.getElementById('privacy_consent_text')?.value || 'We use information to improve service. Do you consent?';
        // show a small modal banner to simulate user consent
        let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML = '';
        const box = document.createElement('div'); box.style.padding='18px'; box.style.background='var(--panel)'; box.style.border='1px solid var(--border)'; box.style.borderRadius='8px'; box.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">Consent Prompt (Simulation)</div><div style="margin-bottom:12px;">${escapeHtml(txt)}</div>`;
        const accept = document.createElement('button'); accept.className='save-btn'; accept.textContent='Accepter'; accept.addEventListener('click', ()=>{ document.getElementById('privacy_consent_enabled').checked = true; const s = loadPrivacySettings(); s.consent_enabled = true; savePrivacy(); panel.remove(); alert('Consentement simul√© accept√©'); });
        const reject = document.createElement('button'); reject.className='btn'; reject.textContent='Refuser'; reject.style.background='#d9534f'; reject.addEventListener('click', ()=>{ document.getElementById('privacy_consent_enabled').checked = false; const s = loadPrivacySettings(); s.consent_enabled = false; savePrivacy(); panel.remove(); alert('Consentement simul√© refus√©'); });
        box.appendChild(accept); box.appendChild(reject); panel.appendChild(box);
      }

      // Privacy helpers: Preview PII redaction on recent conversations and purge old data
      function runPiiRedactionPreview(){
        const recentRaw = localStorage.getItem('conversations');
        let convs = [];
        try{ convs = recentRaw ? JSON.parse(recentRaw) : []; }catch(e){ convs = []; }
        if(!convs || convs.length===0) return alert('Aucune conversation disponible pour l\'aper√ßu');
        const sample = convs[0];
        let text = sample.transcript || sample.text || '';
        // read preferences from privacy settings / checkboxes
        const maskEmail = !!document.getElementById('privacy_pii_email')?.checked;
        const maskPhone = !!document.getElementById('privacy_pii_phone')?.checked;
        const maskNames = !!document.getElementById('privacy_pii_names')?.checked;
        if (maskEmail) text = text.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[REDACTED_EMAIL]');
        if (maskPhone) text = text.replace(/\+?\d[\d\s-]{5,}\d/g, '[REDACTED_PHONE]');
        if (maskNames && sample.customer) text = text.replace(new RegExp(sample.customer,'gi'), '[REDACTED_NAME]');
        // show preview overlay
        let panel = document.getElementById('template_snippets_panel');
        if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'PII Redaction Preview'; title.style.marginTop='0'; panel.appendChild(title);
        const orig = document.createElement('div'); orig.style.marginTop='12px'; orig.innerHTML = '<strong>Original</strong>'; const preOrig = document.createElement('pre'); preOrig.style.whiteSpace='pre-wrap'; preOrig.style.background='rgba(255,255,255,0.02)'; preOrig.style.padding='12px'; preOrig.style.borderRadius='8px'; preOrig.textContent = sample.transcript || sample.text || '(aucun texte)'; orig.appendChild(preOrig); panel.appendChild(orig);
        const red = document.createElement('div'); red.style.marginTop='12px'; red.innerHTML = '<strong>Redacted</strong>'; const preRed = document.createElement('pre'); preRed.style.whiteSpace='pre-wrap'; preRed.style.background='rgba(255,255,255,0.02)'; preRed.style.padding='12px'; preRed.style.borderRadius='8px'; preRed.textContent = text; red.appendChild(preRed); panel.appendChild(red);
      }

      function purgeExpiredData(){
        const days = Number(document.getElementById('privacy_retention_days')?.value || 0);
        if(!days || days<=0) return alert('La dur√©e de conservation est 0 ou non d√©finie ‚Äî rien √† purger.');
        if(!confirm('Purger les conversations datant de plus de ' + days + ' jours ? Cela supprimera ces donn√©es du stockage local de d√©monstration.')) return;
        const raw = localStorage.getItem('conversations'); let convs = [];
        try{ convs = raw ? JSON.parse(raw) : []; }catch(e){ convs = []; }
        const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
        const kept = convs.filter(c=> { const t = c.datetime || c.created_at || c.ts || null; if(!t) return false; const ts = Date.parse(t) || 0; return ts >= cutoff; });
        localStorage.setItem('conversations', JSON.stringify(kept));
        renderConversations();
        alert('Conversations ant√©rieures √† ' + days + ' jours purg√©es. Conserv√©es ' + kept.length + ' conversations.');
      }

      // Gather all settings from forms and localStorage into a single JSON object
      function setPath(obj, path, value){
        const parts = String(path).split('.');
        let cur = obj;
        for (let i=0;i<parts.length;i++){
          const p = parts[i];
          if (i===parts.length-1){ cur[p] = value; }
          else { cur[p] = cur[p] || {}; cur = cur[p]; }
        }
      }

      function gatherConfig(){
        const config = {};
        // helper to process an element
        function process(el){
          if (!el || !el.type) return;
          const name = el.name || el.id;
          if (!name) return;
          let val = null;
          if (el.type === 'checkbox') val = !!el.checked;
          else if (el.type === 'radio') { if (!el.checked) return; val = el.value; }
          else if (el.type === 'number') val = el.value==='' ? null : Number(el.value);
          else if (el.type === 'file') return; // skip files
          else val = el.value;
          setPath(config, name.replace(/\s+/g,'_'), val);
        }

        // gather from each main form
        const formIds = ['personalityForm','capabilitiesForm','quotesForm','knowledgeForm','appointmentsForm','reservationForm','escalationForm'];
        formIds.forEach(fid => {
          const f = document.getElementById(fid);
          if (!f) return;
          const els = f.querySelectorAll('input,select,textarea');
          els.forEach(process);
        });

        // include avatar preview if present
        const avatar = document.getElementById('avatar_preview');
        if (avatar && avatar.src) setPath(config, 'personality.avatar', avatar.src);

        // include localStorage knowledge and privacy items
        try{
          const keys = ['knowledge_faqs','recent_questions','privacy_settings','storage_settings'];
          keys.forEach(k=>{ const v = localStorage.getItem(k); setPath(config, k, v ? JSON.parse(v) : null); });
        }catch(e){ console.warn('gatherConfig parse', e); }

        // small metadata
        setPath(config, 'meta.exported_at', new Date().toISOString());
        return config;
      }

      function exportAllSettings(){
        const cfg = gatherConfig();
        // wrap in canonical top-level object for downstream consumers
        const payload = { ai_agent_config: cfg };
        const fname = `ai-agent-config-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // wire header export button
      document.getElementById('export_config_btn')?.addEventListener('click', exportAllSettings);

      // --- Import Settings (JSON) ---
      (function(){
        const importBtn = document.getElementById('import_config_btn');
        const importFile = document.getElementById('import_config_file');
        const previewPanel = document.getElementById('import_preview');
        const changesEl = document.getElementById('import_changes');
        const applyBtn = document.getElementById('apply_import_btn');
        // schema/validator placeholders
        let configSchema = null;
        let validateFn = null;

        // load JSON Schema and compile Ajv validator (if Ajv loaded)
        async function loadConfigSchema(){
          try{
            const res = await fetch('ai_agent_config.schema.json');
            if (!res.ok) return console.warn('Could not load schema:', res.status);
            configSchema = await res.json();
            if (window.Ajv){
              const ajv = new window.Ajv({allErrors:true, verbose:true});
              validateFn = ajv.compile(configSchema);
              console.log('ai_agent_config schema loaded and validator compiled');
            } else {
              console.warn('Ajv not available for schema validation');
            }
          }catch(e){ console.warn('loadConfigSchema error', e); }
        }
        loadConfigSchema();
        let pendingConfig = null;

        function flatten(obj, prefix=''){
          const out = {};
          if (obj && typeof obj === 'object' && !Array.isArray(obj)){
            for (const k of Object.keys(obj)){
              const p = prefix ? `${prefix}.${k}` : k;
              if (obj[k] && typeof obj[k] === 'object' && !Array.isArray(obj[k])){
                Object.assign(out, flatten(obj[k], p));
              } else {
                out[p] = obj[k];
              }
            }
          } else if (Array.isArray(obj)){
            out[prefix] = obj;
          }
          return out;
        }

        function showPreview(newCfg){
          // If we have a schema validator, validate before showing diffs
          if (validateFn){
            const valid = validateFn(newCfg);
            if (!valid){
              changesEl.innerHTML = '<div style="color:#b00020; font-weight:700; margin-bottom:8px;">Validation errors detected ‚Äî import cannot be applied.</div>';
              const ul = document.createElement('div');
              (validateFn.errors||[]).forEach(err=>{
                const e = document.createElement('div');
                e.style.fontFamily='monospace'; e.style.fontSize='0.95rem';
                e.textContent = `${err.dataPath || err.instancePath || ''} ${err.message}`;
                ul.appendChild(e);
              });
              changesEl.appendChild(ul);
              previewPanel.style.display = 'block';
              if (applyBtn) applyBtn.disabled = true;
              return;
            } else {
              if (applyBtn) applyBtn.disabled = false;
            }
          }
          const current = gatherConfig();
          const flatNew = flatten(newCfg);
          const flatCur = flatten(current);
          const keys = Object.keys(flatNew).sort();
          const lines = [];
          keys.forEach(k=>{
            const nv = flatNew[k];
            const cv = flatCur[k]===undefined ? '<missing>' : flatCur[k];
            if (JSON.stringify(nv) !== JSON.stringify(cv)){
              lines.push({k, cv, nv});
            }
          });
          changesEl.innerHTML = '';
          if (lines.length===0){ changesEl.innerHTML = '<div>No differences detected. The imported file matches current settings.</div>'; }
          else{
            lines.forEach(item=>{
              const row = document.createElement('div');
              row.style.padding = '6px 0';
              row.innerHTML = `<div style="font-weight:600;">${item.k}</div><div style="color:var(--muted);">Current: ${escapeHtml(String(item.cv))}</div><div style="color:var(--fg);">New: ${escapeHtml(String(item.nv))}</div>`;
              changesEl.appendChild(row);
            });
          }
          previewPanel.style.display = 'block';
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function applyConfig(cfg){
          // revalidate at apply time if we have schema
          if (validateFn){
            const ok = validateFn(cfg);
            if (!ok){
              alert('Imported file failed schema validation. See preview for details.');
              return;
            }
          }
          // Flatten cfg and apply to form fields or localStorage
          const flat = flatten(cfg);
          Object.keys(flat).forEach(path=>{
            const val = flat[path];
            // try name selector
            const elByName = document.querySelector(`[name="${path}"]`);
            const elById = document.getElementById(path) || document.getElementById(path.replace(/\./g,'_'));
            if (elByName || elById){
              const el = elByName || elById;
              if (el.type === 'checkbox') { el.checked = !!val; el.dispatchEvent(new Event('change',{bubbles:true})); }
              else if (el.type === 'radio') { if (el.value === String(val)) { el.checked = true; el.dispatchEvent(new Event('change',{bubbles:true})); } }
              else { el.value = (val===null ? '' : val); el.dispatchEvent(new Event('input',{bubbles:true})); }
              return;
            }
            // fallback to localStorage key
            try{
              // If path is a known local key
              const simpleKey = path;
              if (['knowledge_faqs','recent_questions','privacy_settings','storage_settings'].includes(simpleKey)){
                localStorage.setItem(simpleKey, JSON.stringify(val));
              }
              // personality.avatar can be data URL
              if (path === 'personality.avatar' && document.getElementById('avatar_preview')){
                document.getElementById('avatar_preview').src = val;
              }
            }catch(e){ console.warn('applyConfig error', e); }
          });

          // Reinitialize affected UIs
          try{ loadKnowledge(); }catch(e){}
          try{ loadPrivacy(); }catch(e){}
          try{ updateSectionState(); }catch(e){}
          alert('‚úì Imported settings applied to the UI (some items saved to localStorage). Review and click Save where needed.');
        }

        // file selection
        importBtn?.addEventListener('click', ()=> importFile.click());
        importFile?.addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = function(){
            try{
              const json = JSON.parse(reader.result);
              pendingConfig = json;
              showPreview(json);
            }catch(err){
              alert('Could not parse JSON: ' + err.message);
              pendingConfig = null;
            }
          };
          reader.readAsText(f);
        });

        document.getElementById('cancel_import_btn')?.addEventListener('click', ()=>{ previewPanel.style.display='none'; pendingConfig=null; importFile.value=''; });
        document.getElementById('apply_import_btn')?.addEventListener('click', ()=>{
          if (!pendingConfig) return alert('No pending import to apply');
          // basic validation: must be object
          if (typeof pendingConfig !== 'object') return alert('Invalid config file');
          applyConfig(pendingConfig);
          previewPanel.style.display='none'; pendingConfig=null; importFile.value='';
        });
      })();

      function deleteUserData(){
        if (!confirm('Delete locally stored demo data? This removes saved FAQs, recent questions and privacy settings from this browser.')) return;
        ['privacy_settings','storage_settings','knowledge_faqs','recent_questions'].forEach(k=> localStorage.removeItem(k));
        alert('‚úì Local demo data removed');
        loadPrivacy();
        // also refresh FAQ list
        const container = document.getElementById('faqs_list'); if (container) container.innerHTML='';
        const recentEl = document.getElementById('recent_questions'); if (recentEl) recentEl.innerHTML='';
        loadKnowledge();
      }

      function renderSnapsPreview(){
        const previewEl = document.getElementById('snaps_preview');
        if (!previewEl) return;
        previewEl.innerHTML = '';
        try{
          const recentRaw = localStorage.getItem('recent_questions');
          const recent = recentRaw ? JSON.parse(recentRaw) : [];
          const sRaw = localStorage.getItem('storage_settings');
          const s = sRaw ? JSON.parse(sRaw) : {snaps_last_n:10};
          const items = (recent || []).slice(0, s.snaps_last_n || 10);
          if (items.length===0) previewEl.textContent = 'No snaps available.';
          items.forEach(it=>{
            const d = document.createElement('div'); d.style.padding='6px 0'; d.style.borderBottom='1px dashed var(--border)'; d.textContent = it.q || it;
            previewEl.appendChild(d);
          });
        }catch(e){ previewEl.textContent = 'Error rendering snaps preview'; }
      }

      // wire buttons
      document.getElementById('export_my_data')?.addEventListener('click', exportUserData);
      document.getElementById('delete_my_data')?.addEventListener('click', deleteUserData);
      document.getElementById('export_audit_log')?.addEventListener('click', exportAuditLog);
      document.getElementById('simulate_consent')?.addEventListener('click', simulateConsentBanner);
      document.getElementById('snaps_export_btn')?.addEventListener('click', ()=>{
        // lightweight export of snaps: use recent_questions
        const recentRaw = localStorage.getItem('recent_questions');
        const blob = new Blob([recentRaw || '[]'], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'conversation-snaps.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // expose savePrivacy globally for button onclick
      window.savePrivacy = savePrivacy;

      // initialize on load
      loadPrivacy();
    })();

    // Set year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    /* --- Conversation & Transcript Management --- */
    function loadConversations(){
      try{
        const raw = localStorage.getItem('conversations');
        const arr = raw ? JSON.parse(raw) : sampleConversations();
        return arr;
      }catch(e){ console.warn('loadConversations', e); return []; }
    }

    function sampleConversations(){
      // small sample data if none present
      const s = [
        {id: 'c1', customer: 'Alice', datetime: new Date().toISOString(), transcript: 'Hi, I need to change my password. My email is alice@example.com and phone 555-1234.', flagged:false},
        {id: 'c2', customer: 'Bob', datetime: new Date().toISOString(), transcript: 'I want to cancel my service. My account is bob@example.com', flagged:true}
      ];
      localStorage.setItem('conversations', JSON.stringify(s));
      return s;
    }

    function renderConversations(){
      const listEl = document.getElementById('conversations_list');
      if (!listEl) return;
      const q = document.getElementById('transcript_search')?.value?.toLowerCase()||'';
      const convs = loadConversations().filter(c=> !q || (c.customer||'').toLowerCase().includes(q) || (c.transcript||'').toLowerCase().includes(q));
      listEl.innerHTML = '';
      convs.forEach(c=>{
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='12px'; el.style.padding='8px'; el.style.border='1px solid var(--border)'; el.style.borderRadius='8px';
        const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(c.customer||'Unknown')}</strong><div style="color:var(--muted); font-size:0.9rem;">${new Date(c.datetime).toLocaleString()}</div><div style="margin-top:6px;">${escapeHtml((c.transcript||'').slice(0,200))}${(c.transcript||'').length>200?'...':''}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.convId = c.id;
        const btnPreview = document.createElement('button'); btnPreview.className='btn'; btnPreview.textContent='Preview Redaction'; btnPreview.addEventListener('click', ()=> showRedactionPreview(c.id));
        const btnExport = document.createElement('button'); btnExport.className='btn'; btnExport.textContent='Export'; btnExport.addEventListener('click', ()=> exportConversation(c.id));
        const btnPurge = document.createElement('button'); btnPurge.className='btn'; btnPurge.style.background='#d9534f'; btnPurge.textContent='Purge'; btnPurge.addEventListener('click', ()=> purgeConversation(c.id));
        const btnFlag = document.createElement('button'); btnFlag.className='btn'; btnFlag.textContent = c.flagged ? 'Unflag' : 'Flag'; btnFlag.addEventListener('click', ()=> toggleFlag(c.id));
        controls.appendChild(chk); controls.appendChild(btnPreview); controls.appendChild(btnExport); controls.appendChild(btnFlag); controls.appendChild(btnPurge);
        el.appendChild(left); el.appendChild(controls);
        listEl.appendChild(el);
      });
    }

    function getConversationById(id){ return loadConversations().find(c=>c.id===id); }

    function showRedactionPreview(id){
      const conv = getConversationById(id); if (!conv) return alert('Conversation not found');
      const maskEmail = !!document.getElementById('redact_email')?.checked;
      const maskPhone = !!document.getElementById('redact_phone')?.checked;
      const maskNames = !!document.getElementById('redact_names')?.checked;
      let text = conv.transcript || '';
      if (maskEmail) text = text.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[REDACTED_EMAIL]');
      if (maskPhone) text = text.replace(/\+?\d[\d\s-]{5,}\d/g, '[REDACTED_PHONE]');
      if (maskNames) text = text.replace(new RegExp(conv.customer,'gi'), '[REDACTED_NAME]');
      document.getElementById('redaction_preview').textContent = text;
    }

    function exportConversation(id){
      const conv = getConversationById(id); if (!conv) return alert('Conversation not found');
      const blob = new Blob([JSON.stringify(conv, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `conversation-${conv.id}.json`; document.body.appendChild(a); a.click(); a.remove();
    }

    function exportSelectedConversations(){
      const checks = Array.from(document.querySelectorAll('#conversations_list input[type="checkbox"]')).filter(c=>c.checked);
      if (checks.length===0) return alert('Select at least one conversation');
      const ids = checks.map(c=>c.dataset.convId);
      const convs = loadConversations().filter(c=> ids.includes(c.id));
      const blob = new Blob([JSON.stringify(convs, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `conversations-export-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove();
    }

    function purgeConversation(id){
      if (!confirm('Purge this conversation? This cannot be undone (demo: localStorage only).')) return;
      const arr = loadConversations().filter(c=> c.id !== id);
      localStorage.setItem('conversations', JSON.stringify(arr));
      renderConversations();
      alert('Conversation purged (local demo)');
    }

    function purgeAllConversations(){
      if (!confirm('Purge ALL conversations stored locally?')) return;
      localStorage.removeItem('conversations'); renderConversations(); alert('All local conversations removed');
    }

    function toggleFlag(id){
      const arr = loadConversations().map(c=> { if (c.id===id) c.flagged = !c.flagged; return c; }); localStorage.setItem('conversations', JSON.stringify(arr)); renderConversations(); }

    /* --- Payments & Billing Controls (demo) --- */
    function savePaymentSettings(){
      try{
        const p = {
          provider: document.getElementById('payment_provider').value,
          mode: document.getElementById('payment_mode').value,
          api_key: document.getElementById('payment_api_key').value,
          deposit_capture: !!document.getElementById('deposit_capture').checked,
          deposit_default: Number(document.getElementById('deposit_amount_default').value||0),
          refunds_log: document.getElementById('refunds_log_link').value||''
        };
        localStorage.setItem('payments_settings', JSON.stringify(p));
        alert('‚úì Payment settings saved (demo)');
      }catch(e){ console.warn('savePaymentSettings', e); alert('Could not save payments settings'); }
    }

    /* --- Backup / Versioning (demo) --- */
    function listBackups(){
      try{
        const raw = localStorage.getItem('backups');
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }

    function saveBackupsList(arr){ localStorage.setItem('backups', JSON.stringify(arr)); }

    function createBackup(){
      const cfg = gatherConfig();
      const backups = listBackups();
      const id = 'b-' + new Date().toISOString().replace(/[:.]/g,'-');
      backups.unshift({id, created_at: new Date().toISOString(), config: cfg});
      // keep latest 20
      saveBackupsList(backups.slice(0,20));
      renderBackups();
      alert('Backup created: ' + id);
    }

    function renderBackups(){
      const el = document.getElementById('backups_list'); if (!el) return; const items = listBackups(); el.innerHTML = '';
      items.forEach(b=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; row.style.marginBottom='8px';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${b.id}</div><div style="color:var(--muted)">${new Date(b.created_at).toLocaleString()}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(b.config,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = b.id + '.json'; document.body.appendChild(a); a.click(); a.remove(); });
        const restore = document.createElement('button'); restore.className='btn'; restore.textContent='Restore'; restore.addEventListener('click', ()=>{ if (!confirm('Restore this backup? This will update the UI and localStorage (demo).')) return; applyConfig(b.config); });
        const cmp = document.createElement('button'); cmp.className='btn'; cmp.textContent='Compare'; cmp.addEventListener('click', ()=>{ showPreview(b.config); });
        controls.appendChild(dl); controls.appendChild(restore); controls.appendChild(cmp);
        row.appendChild(left); row.appendChild(controls); el.appendChild(row);
      });
    }

    function downloadLatestBackup(){ const b = listBackups()[0]; if (!b) return alert('No backups available'); const blob = new Blob([JSON.stringify(b.config,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = b.id + '.json'; document.body.appendChild(a); a.click(); a.remove(); }

    function scheduleDemoBackup(){
      // demo: schedule a single backup in 5 seconds to demonstrate scheduling
      alert('Scheduling demo backup in 5 seconds (demo only)'); setTimeout(()=>{ createBackup(); }, 5000);
    }

    /* --- Analytics: Intents CSV export --- */
    function loadIntentTrends(){
      try{
        const from = document.getElementById('intents_from').value;
        const to = document.getElementById('intents_to').value;
        // demo: fetch sample trends from localStorage or synthesize
        const raw = localStorage.getItem('intent_trends');
        let arr = raw ? JSON.parse(raw) : [ {date: new Date().toISOString().slice(0,10), intent:'password_reset', count:12}, {date: new Date().toISOString().slice(0,10), intent:'billing', count:5} ];
        const out = arr.filter(r=> { if (!from && !to) return true; const d = r.date; if (from && d<from) return false; if (to && d>to) return false; return true; });
        const el = document.getElementById('intent_trends_preview'); el.innerHTML = '';
        out.forEach(o=>{ const row = document.createElement('div'); row.textContent = `${o.date} ‚Äî ${o.intent} ‚Äî ${o.count}`; el.appendChild(row); });
      }catch(e){ console.warn('loadIntentTrends', e); }
    }

    function exportIntentCSV(){
      try{
        const raw = localStorage.getItem('intent_trends');
        const arr = raw ? JSON.parse(raw) : [];
        if (arr.length===0) return alert('No intent trend data to export');
        const headers = Object.keys(arr[0]);
        const rows = [headers.join(',')].concat(arr.map(r=> headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(',')) ).join('\n');
        const blob = new Blob([rows], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `intent-trends-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ console.warn('exportIntentCSV', e); }
    }

    // initialize new areas
    renderConversations(); renderBackups(); loadIntentTrends();

    /* --- Model / Training Controls --- */
    function loadTrainingQueue(){
      try{ const raw = localStorage.getItem('training_samples'); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveTrainingQueue(arr){ localStorage.setItem('training_samples', JSON.stringify(arr)); }

    function renderTrainingQueue(){
      const container = document.getElementById('training_queue'); if (!container) return;
      const q = loadTrainingQueue();
      if (q.length===0){ container.style.display='block'; container.innerHTML='<div class="helper-text">No samples in the reviewer queue.</div>'; return; }
      container.style.display='block'; container.innerHTML='';
      q.forEach((s, idx)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='12px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; row.style.marginBottom='8px';
        const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<div style="font-weight:700">Sample ${s.id || idx+1} ${s.flagged?'<span style="color:#b00020; font-weight:600; margin-left:8px;">FLAGGED</span>':''}</div><div style="color:var(--muted);">${new Date(s.datetime).toLocaleString()}</div><div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(s.text||'')}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const accept = document.createElement('button'); accept.className='btn'; accept.textContent='Accept'; accept.addEventListener('click', ()=>{ acceptTrainingSample(s.id); });
        const reject = document.createElement('button'); reject.className='btn'; reject.textContent='Reject'; reject.addEventListener('click', ()=>{ rejectTrainingSample(s.id); });
        const del = document.createElement('button'); del.className='btn'; del.style.background='#d9534f'; del.textContent='Remove'; del.addEventListener('click', ()=>{ removeTrainingSample(s.id); });
        controls.appendChild(accept); controls.appendChild(reject); controls.appendChild(del);
        row.appendChild(left); row.appendChild(controls); container.appendChild(row);
      });
    }

    function enqueueSampleFromRecent(){
      // demo: take first recent question and add to training_samples
      const recentRaw = localStorage.getItem('recent_questions'); const recent = recentRaw ? JSON.parse(recentRaw) : [];
      const one = recent && recent.length ? recent[0] : {q:'Sample training text', id: 's-' + Date.now()};
      const samples = loadTrainingQueue(); samples.unshift({id: 't-' + Date.now(), datetime: new Date().toISOString(), text: one.q}); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample enqueued for review');
    }

    function acceptTrainingSample(id){ const samples = loadTrainingQueue(); const idx = samples.findIndex(s=>s.id===id); if (idx===-1) return; // in demo, mark accepted and remove
      samples.splice(idx,1); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample accepted (demo)'); }

    function rejectTrainingSample(id){ const samples = loadTrainingQueue(); const idx = samples.findIndex(s=>s.id===id); if (idx===-1) return; samples.splice(idx,1); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample rejected (demo)'); }

    function removeTrainingSample(id){ const samples = loadTrainingQueue().filter(s=>s.id!==id); saveTrainingQueue(samples); renderTrainingQueue(); }

    // wire the visible training toggle (sync with existing toggle-btn behavior)
    const trainingBtn = document.querySelector('.toggle-btn[data-checkbox="training_enabled"]');
    const trainingCb = document.getElementById('training_enabled');
    if (trainingBtn && trainingCb) {
      trainingBtn.addEventListener('click', ()=>{
        trainingCb.checked = !trainingCb.checked;
        trainingCb.dispatchEvent(new Event('change',{bubbles:true}));
        trainingBtn.classList.toggle('on', trainingCb.checked);
        trainingBtn.querySelector('.label').textContent = trainingCb.checked ? 'On' : 'Off';
      });
      trainingCb.addEventListener('change', ()=>{
        trainingBtn.classList.toggle('on', trainingCb.checked);
        trainingBtn.querySelector('.label').textContent = trainingCb.checked ? 'On' : 'Off';
      });
    }

    /* --- Templates & Snippets --- */
    function loadTemplates(){ try{ const raw = localStorage.getItem('templates'); return raw?JSON.parse(raw):[]; }catch(e){return[];} }
    function saveTemplates(arr){ localStorage.setItem('templates', JSON.stringify(arr)); }

    function renderTemplatesList(){ const list = document.getElementById('templates_list'); const sel = document.getElementById('preview_template'); if(!list||!sel) return; const templates = loadTemplates(); list.innerHTML=''; sel.innerHTML=''; templates.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='6px'; row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(t.name)}</strong><div style="color:var(--muted);">${escapeHtml((t.body||'').slice(0,120))}${(t.body||'').length>120?'...':''}</div></div>`; const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.addEventListener('click', ()=> editTemplate(i)); const rem = document.createElement('button'); rem.className='btn'; rem.textContent='Remove'; rem.style.background='#d9534f'; rem.addEventListener('click', ()=>{ const arr = loadTemplates(); arr.splice(i,1); saveTemplates(arr); renderTemplatesList(); }); row.appendChild(edit); row.appendChild(rem); list.appendChild(row); const opt = document.createElement('option'); opt.value = i; opt.textContent = t.name; sel.appendChild(opt); }); }

    function addTemplateEditor(){ const arr = loadTemplates(); const name = prompt('Template name'); if (!name) return; const body = prompt('Template body (use {{variable}})'); arr.push({name, body}); saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); }

    function editTemplate(index){ const arr = loadTemplates(); const t = arr[index]; const name = prompt('Edit name', t.name); if (!name) return; const body = prompt('Edit body', t.body); arr[index] = {name, body}; saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); }

    function updateTemplatePreview(){ const sel = document.getElementById('preview_template'); const varsEl = document.getElementById('preview_vars'); const preview = document.getElementById('template_preview'); if(!sel||!preview) return; const idx = Number(sel.value); const arr = loadTemplates(); if (!arr[idx]) { preview.textContent=''; return; } let body = arr[idx].body||''; try{ const vars = varsEl && varsEl.value ? JSON.parse(varsEl.value) : {}; Object.keys(vars).forEach(k=>{ const re = new RegExp('{{\\s*'+k+'\\s*}}','g'); body = body.replace(re, vars[k]); }); }catch(e){ /* ignore parse error */ }
      preview.textContent = body;
    }

    // Import templates or text snippets via hidden file input
    function importTemplates(){ const f = document.getElementById('template_import_file'); if(!f) return alert('File input not available'); f.value = ''; f.click(); }

    function handleTemplateFile(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const name = file.name || 'upload';
      const reader = new FileReader();
      reader.onload = function(){
        const txt = String(reader.result || '');
        if(name.toLowerCase().endsWith('.json')){
          try{ const parsed = JSON.parse(txt); if(Array.isArray(parsed)){
            const cur = loadTemplates(); const merged = cur.concat(parsed); saveTemplates(merged); renderTemplatesList(); updateTemplatePreview(); alert('Imported '+parsed.length+' templates');
          } else if(parsed.templates && Array.isArray(parsed.templates)){
            const cur = loadTemplates(); const merged = cur.concat(parsed.templates); saveTemplates(merged); renderTemplatesList(); updateTemplatePreview(); alert('Imported '+parsed.templates.length+' templates');
          } else { alert('JSON file did not contain an array of templates'); }
          }catch(err){ alert('Failed to parse JSON: '+err.message); }
        } else if(name.toLowerCase().endsWith('.txt')){
          // split into paragraphs and show chooser
          const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean);
          if(parts.length===0) return alert('No text found in file');
          showSnippetChooser(parts, name);
        } else {
          alert('Unsupported file type. Use .json or .txt');
        }
      };
      reader.readAsText(file);
    }

    // Document upload helpers (Knowledge tab) - trigger hidden input
    function importDocument(){ const f = document.getElementById('document_import_file'); if(!f) return alert('Document input not available'); f.value=''; f.click(); }

    function handleDocumentFile(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const name = file.name || 'doc'; const reader = new FileReader();
      reader.onload = function(){
        const txt = String(reader.result || ''); if(!txt.trim()) return alert('No text found');
        // save uploaded document to local store
        const id = saveUploadedDocument({name: name, text: txt});
        renderDocumentLibrary();
        // split into paragraphs and show chooser for snippet extraction
        const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean);
        if(parts.length===0) return alert('No text snippets found');
        showSnippetChooser(parts, name + ' (uploaded)');
      };
      reader.readAsText(file);
    }

    // Calendar (.ics) import helpers
    function importCalendar(){ const f = document.getElementById('calendar_import_file'); if(!f) return alert('Calendar input not available'); f.value=''; f.click(); }

    function handleCalendarFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const name = file.name || 'calendar.ics'; const reader = new FileReader(); reader.onload = function(){ const txt = String(reader.result || ''); if(!txt.trim()) return alert('Aucun contenu de calendrier'); const events = parseIcsEvents(txt); const entry = { id: 'c-'+Date.now(), name: name, raw: txt, eventsCount: events.length, created_at: new Date().toISOString() }; const arr = loadUploadedCalendars(); arr.unshift(entry); localStorage.setItem('uploaded_calendars', JSON.stringify(arr)); renderCalendarLibrary(); alert('Calendrier import√© : ' + name + ' (' + events.length + ' √©v√©nements)'); }; reader.readAsText(file); }

    function parseIcsEvents(ics){ try{ const chunks = ics.split(/BEGIN:VEVENT/i); const evs = []; for(let i=1;i<chunks.length;i++){ const section = chunks[i]; const lines = section.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const obj = {}; lines.forEach(l=>{ const idx = l.indexOf(':'); if(idx>0){ const k = l.slice(0, idx).toUpperCase(); const v = l.slice(idx+1); obj[k]= (obj[k] ? obj[k] + '\n' + v : v); } }); evs.push(obj); } return evs; }catch(e){ return []; } }

    function loadUploadedCalendars(){ try{ const raw = localStorage.getItem('uploaded_calendars'); return raw?JSON.parse(raw):[];}catch(e){return[]} }

    function renderCalendarLibrary(){ const container = document.getElementById('uploaded_calendars_list'); if(!container) return; const arr = loadUploadedCalendars(); container.innerHTML=''; if(arr.length===0){ container.innerHTML = '<div class="helper-text">Aucun calendrier t√©l√©vers√©. Utilisez Upload .ics Calendar pour ajouter un calendrier (d√©mo).</div>'; return; } arr.forEach(c=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(c.name)}</strong><div style="color:var(--muted); font-size:0.9rem;">Events: ${c.eventsCount} ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.flexDirection='column'; controls.style.gap='6px'; const view = document.createElement('button'); view.className='btn'; view.textContent='View'; view.addEventListener('click', ()=> viewCalendar(c.id)); const extract = document.createElement('button'); extract.className='btn'; extract.textContent='Extract Events'; extract.addEventListener('click', ()=> { const arr = loadUploadedCalendars(); const found = arr.find(x=>x.id===c.id); if(!found) return alert('Calendar not found'); const events = parseIcsEvents(found.raw); const parts = events.map(e=> (e.DESCRIPTION||e.SUMMARY||'')).filter(Boolean); if(parts.length===0) return alert('No textual event descriptions to extract'); showSnippetChooser(parts, found.name + ' (events)'); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=> removeCalendar(c.id)); controls.appendChild(view); controls.appendChild(extract); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); container.appendChild(row); }); }

    function viewCalendar(id){ const arr = loadUploadedCalendars(); const c = arr.find(x=>x.id===id); if(!c) return alert('Calendar not found'); let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
      panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent = c.name + ' ‚Äî Calendar'; title.style.marginTop='0'; panel.appendChild(title);
      const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginBottom='8px'; meta.textContent = 'Imported: ' + new Date(c.created_at).toLocaleString() + ' ‚Äî Events: ' + c.eventsCount; panel.appendChild(meta);
      const content = document.createElement('pre'); content.style.whiteSpace='pre-wrap'; content.style.background='rgba(255,255,255,0.02)'; content.style.padding='12px'; content.style.borderRadius='8px'; content.textContent = c.raw; panel.appendChild(content);
    }

    function removeCalendar(id){ if(!confirm('Remove this uploaded calendar?')) return; const arr = loadUploadedCalendars().filter(x=>x.id!==id); localStorage.setItem('uploaded_calendars', JSON.stringify(arr)); renderCalendarLibrary(); alert('Calendar removed'); }

    function testCalendarConnection(){ alert('Calendar connection test (demo): this would attempt OAuth/API connection in production.'); }

    // Uploaded documents storage helpers
    function loadUploadedDocuments(){ try{ const raw = localStorage.getItem('uploaded_documents'); return raw?JSON.parse(raw):[];}catch(e){return[]} }
    function saveUploadedDocument(doc){ const arr = loadUploadedDocuments(); const id = 'd-'+Date.now(); const entry = { id, name: doc.name||('doc-'+Date.now()), text: doc.text||'', created_at: new Date().toISOString() }; arr.unshift(entry); localStorage.setItem('uploaded_documents', JSON.stringify(arr)); return entry.id; }

    function renderDocumentLibrary(){ const container = document.getElementById('uploaded_docs_list'); if(!container) return; const docs = loadUploadedDocuments(); container.innerHTML=''; if(docs.length===0){ container.innerHTML = '<div class="helper-text">No documents uploaded yet. Use "Upload Company Doc" to add files.</div>'; return; }
      docs.forEach(d=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px';
        const left = document.createElement('div'); left.style.flex='1'; const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(d.name)}</strong> <div style="color:var(--muted); font-size:0.9rem;">${new Date(d.created_at).toLocaleString()}</div>`; const preview = document.createElement('div'); preview.style.marginTop='6px'; preview.style.color='var(--muted)'; preview.style.whiteSpace='pre-wrap'; preview.textContent = (d.text||'').slice(0,280) + ((d.text||'').length>280 ? '...' : ''); left.appendChild(title); left.appendChild(preview);
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.flexDirection='column'; controls.style.gap='6px'; const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=> viewDocument(d.id)); const extractBtn = document.createElement('button'); extractBtn.className='btn'; extractBtn.textContent='Extract Snippets'; extractBtn.addEventListener('click', ()=> { const parts = (d.text||'').split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean); if(parts.length===0) return alert('No snippets found'); showSnippetChooser(parts, d.name); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=> removeDocument(d.id)); controls.appendChild(viewBtn); controls.appendChild(extractBtn); controls.appendChild(rem);
        row.appendChild(left); row.appendChild(controls); container.appendChild(row);
      }); }

    function viewDocument(id){ const docs = loadUploadedDocuments(); const d = docs.find(x=>x.id===id); if(!d) return alert('Document not found'); // reuse overlay panel if present
      let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
      panel.innerHTML = ''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent = d.name + ' ‚Äî Uploaded Document'; title.style.marginTop='0'; panel.appendChild(title);
      const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginBottom='8px'; meta.textContent = 'Uploaded: ' + new Date(d.created_at).toLocaleString(); panel.appendChild(meta);
      const content = document.createElement('pre'); content.style.whiteSpace='pre-wrap'; content.style.background='rgba(255,255,255,0.02)'; content.style.padding='12px'; content.style.borderRadius='8px'; content.textContent = d.text; panel.appendChild(content);
    }

    function removeDocument(id){ if(!confirm('Remove this uploaded document? This will not affect existing templates/FAQs.')) return; const arr = loadUploadedDocuments().filter(d=> d.id!==id); localStorage.setItem('uploaded_documents', JSON.stringify(arr)); renderDocumentLibrary(); alert('Document removed'); }

    // show a simple chooser panel to accept snippets as templates
    function showSnippetChooser(snippets, filename){
      // create overlay
      let panel = document.getElementById('template_snippets_panel');
      if(!panel){
        panel = document.createElement('div'); panel.id='template_snippets_panel';
        panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff';
        const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Fermer'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'Import snippets from '+filename; title.style.marginTop='0'; panel.appendChild(title);
        const container = document.createElement('div'); container.id='template_snippets_container'; container.style.marginTop='12px'; panel.appendChild(container);
        document.body.appendChild(panel);
      }
      const container = document.getElementById('template_snippets_container'); container.innerHTML='';
      snippets.forEach((s, i)=>{
        const card = document.createElement('div'); card.style.padding='12px'; card.style.border='1px solid rgba(255,255,255,0.06)'; card.style.borderRadius='8px'; card.style.marginBottom='8px'; card.style.background='rgba(255,255,255,0.02)';
        const text = document.createElement('div'); text.style.whiteSpace='pre-wrap'; text.style.color='#fff'; text.textContent = s;
        const controls = document.createElement('div'); controls.style.marginTop='8px'; controls.style.display='flex'; controls.style.gap='8px';
        const tBtn = document.createElement('button'); tBtn.className='btn'; tBtn.textContent='Create Template'; tBtn.addEventListener('click', ()=> createTemplateFromSnippet(s));
        const fBtn = document.createElement('button'); fBtn.className='btn'; fBtn.textContent='Add as FAQ'; fBtn.addEventListener('click', ()=> createFaqFromSnippet(s));
        controls.appendChild(tBtn); controls.appendChild(fBtn);
        card.appendChild(text); card.appendChild(controls); container.appendChild(card);
      });
    }

    function createFaqFromSnippet(text){
      const question = prompt('Entrez une question/titre court pour cette FAQ (suggestion)', (text||'').split('\n')[0].slice(0,60));
      if (!question) return;
      renderFaqRow(question, text);
      alert('Extrait FAQ ajout√© ‚Äî pensez √† enregistrer la base de connaissances pour le conserver');
    }

    function createTemplateFromSnippet(text){
      const name = prompt('Nom du mod√®le (suggestion)', (text||'').slice(0,24).trim() || 'Mod√®le'); if(!name) return;
      const arr = loadTemplates(); arr.push({name: name, body: text}); saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); alert('Mod√®le cr√©√© : '+name);
    }

    function exportTemplates(){ const arr = loadTemplates()||[]; const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='templates.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    /* --- Accessibility & Localization --- */
    function loadTranslations(){ try{ const raw = localStorage.getItem('translations'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function saveTranslations(arr){ localStorage.setItem('translations', JSON.stringify(arr)); }

    function renderTranslations(){ const list = document.getElementById('translations_list'); if(!list) return; const arr = loadTranslations(); list.innerHTML=''; arr.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; const k = document.createElement('input'); k.value = t.key; k.style.width='35%'; const v = document.createElement('input'); v.value = t.value; v.style.flex='1'; const save = document.createElement('button'); save.className='btn'; save.textContent='Enregistrer'; save.addEventListener('click', ()=>{ const data = loadTranslations(); data[i] = {key:k.value, value:v.value}; saveTranslations(data); renderTranslations(); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Supprimer'; rem.addEventListener('click', ()=>{ const data = loadTranslations(); data.splice(i,1); saveTranslations(data); renderTranslations(); }); row.appendChild(k); row.appendChild(v); row.appendChild(save); row.appendChild(rem); list.appendChild(row); }); }

    function addTranslationRow(){ const arr = loadTranslations(); arr.push({key:'new.key', value:'New Value'}); saveTranslations(arr); renderTranslations(); }

    function toggleRTLPreview(){ const el = document.body; if (el.dir === 'rtl'){ el.dir = 'ltr'; alert('Aper√ßu RTL d√©sactiv√©'); } else { el.dir = 'rtl'; alert('Aper√ßu RTL activ√©'); } }

    function previewSSML(){ const ssml = document.getElementById('ssml_snippet')?.value || ''; alert('Aper√ßu SSML (d√©mo)\n\n' + ssml); }

    // wire payment save globally
    window.savePaymentSettings = savePaymentSettings;

    /* --- Developer helpers --- */
    function openImportFile(){ const f = document.getElementById('import_config_file'); if (f) f.click(); }
    function showImportPreviewPanel(){ const p = document.getElementById('import_preview'); if (!p) return; p.classList.remove('dev-only'); p.style.display='block'; document.getElementById('dev_output').textContent = 'Import preview opened (developer view)'; }
    function openBackupsTab(){ const btn = document.querySelector('.tab-btn[data-tab="backups"]'); const content = document.getElementById('backups'); if (btn) btn.classList.remove('dev-only'); if (content) content.classList.remove('dev-only'); if (btn) btn.click(); renderBackups(); document.getElementById('dev_output').textContent = 'Backups tab opened (developer view)'; }
    function openTrainingQueueTab(){ const btn = document.querySelector('.tab-btn[data-tab="model"]'); const content = document.getElementById('model'); if (btn) btn.classList.remove('dev-only'); if (content) content.classList.remove('dev-only'); if (btn) btn.click(); renderTrainingQueue(); document.getElementById('dev_output').textContent = 'Training queue opened (developer view)'; }
    function revealPaymentApiKey(){ const s = localStorage.getItem('payments_settings'); if (!s) return document.getElementById('dev_output').textContent = 'Aucun param√®tre de paiement enregistr√©'; try{ const p = JSON.parse(s); document.getElementById('dev_output').textContent = 'Fournisseur : '+(p.provider||'')+'\nMode : '+(p.mode||'')+'\nCl√© API : '+(p.api_key||'(non d√©finie)'); }catch(e){ document.getElementById('dev_output').textContent = 'Erreur de lecture des param√®tres de paiement'; } }
    function showSSMLRaw(){ const ssml = document.getElementById('ssml_snippet')?.value || ''; document.getElementById('dev_output').textContent = ssml || '(vide)'; }

    // Developer settings storage
    function loadDeveloperSettings(){ try{ const raw = localStorage.getItem('developer_settings'); return raw?JSON.parse(raw):{api_keys:[], webhooks:[], logs:[]}; }catch(e){ return {api_keys:[], webhooks:[], logs:[]}; } }
    function saveDeveloperSettings(obj){ try{ localStorage.setItem('developer_settings', JSON.stringify(obj)); }catch(e){ console.warn('Failed to save developer_settings', e); } }

    // API Keys management (demo only)
    function generateApiKey(){ // random key for demo
      const s = 'sk_' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); return s;
    }
    function createApiKey(){ const name = (document.getElementById('new_api_name')?.value || '').trim(); if(!name) return alert('Fournissez un nom pour la cl√©'); const ds = loadDeveloperSettings(); const k = { id: 'key-'+Date.now(), name, key: generateApiKey(), created_at: new Date().toISOString(), revoked:false }; ds.api_keys = ds.api_keys || []; ds.api_keys.unshift(k); saveDeveloperSettings(ds); renderApiKeys(); document.getElementById('new_api_name').value=''; }
    function renderApiKeys(){ const el = document.getElementById('api_keys_list'); if(!el) return; const ds = loadDeveloperSettings(); const arr = ds.api_keys || []; el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">Aucune cl√© API pour le moment.</div>'; return; } arr.forEach((k,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)'; const leftHtml = `<div style="flex:1"><strong>${escapeHtml(k.name)}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(k.created_at)}${k.revoked ? ' <span style="color:#d9534f; margin-left:8px">(r√©voqu√©e)</span>' : ''}</div></div>`; row.innerHTML = leftHtml; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const show = document.createElement('button'); show.className='btn'; show.textContent='Afficher'; show.addEventListener('click', ()=>{ showModal('Cl√© API '+k.name, '<pre style="white-space:pre-wrap;">'+escapeHtml(k.key)+'</pre>'); }); const rotate = document.createElement('button'); rotate.className='btn'; rotate.textContent='Renouveler'; rotate.addEventListener('click', ()=>{ if(!confirm('Renouveler la cl√© '+k.name+' ? Les consommateurs existants cesseront de fonctionner.')) return; k.key = generateApiKey(); k.created_at = new Date().toISOString(); saveDeveloperSettings(ds); renderApiKeys(); }); const revoke = document.createElement('button'); revoke.className='btn'; revoke.style.background='#d9534f'; revoke.textContent='R√©voquer'; revoke.addEventListener('click', ()=>{ if(!confirm('R√©voquer la cl√© '+k.name+' ?')) return; k.revoked = true; saveDeveloperSettings(ds); renderApiKeys(); }); controls.appendChild(show); controls.appendChild(rotate); controls.appendChild(revoke); row.appendChild(controls); el.appendChild(row); }); }

    // Webhook management (client-side demo)
    function loadWebhooks(){ const ds = loadDeveloperSettings(); return ds.webhooks || []; }
    function saveWebhooks(arr){ const ds = loadDeveloperSettings(); ds.webhooks = arr; saveDeveloperSettings(ds); }
    function addWebhook(){ const url = (document.getElementById('new_webhook_url')?.value||'').trim(); const method = (document.getElementById('new_webhook_method')?.value||'POST'); if(!url) return alert('Fournissez une URL de webhook'); const arr = loadWebhooks(); arr.unshift({ id:'wh-'+Date.now(), url, method, created_at: new Date().toISOString() }); saveWebhooks(arr); document.getElementById('new_webhook_url').value=''; renderWebhooks(); }

    function renderWebhooks(){
      const el = document.getElementById('webhooks_list'); if(!el) return;
      const arr = loadWebhooks(); el.innerHTML='';
      if(arr.length===0){ el.innerHTML='<div class="helper-text">Aucun webhook configur√©.</div>'; return; }
      arr.forEach((w,i)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)';
        row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(w.url)}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(w.method)} ¬∑ ${escapeHtml(w.created_at)}</div></div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
        const test = document.createElement('button'); test.className='btn'; test.textContent='Tester';
        test.addEventListener('click', ()=>{
          const payload = { event: 'ticket.created', id: 't-'+Date.now(), ts: new Date().toISOString() };
          const html = '<div style="padding:12px;"><div style="margin-bottom:8px;"><strong>POST '+escapeHtml(w.url)+'</strong></div><pre style="white-space:pre-wrap; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px;">'+escapeHtml(JSON.stringify(payload, null, 2))+'</pre></div>';
          showModal('Test de webhook', html);
          appendDevLog('Test de webhook pour '+w.url+' (simul√©)');
        });
        const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Supprimer'; rem.addEventListener('click', ()=>{ if(!confirm('Supprimer le webhook ?')) return; const a = loadWebhooks(); a.splice(i,1); saveWebhooks(a); renderWebhooks(); });
        controls.appendChild(test); controls.appendChild(rem); row.appendChild(controls); el.appendChild(row);
      });
    }

    // SDK snippets rendering (safe DOM construction)
    function renderSdkSnippets(){
      const el = document.getElementById('sdk_snippets'); if(!el) return;
      const snippets = [
        {title:'cURL', code:"curl -X POST https://api.example.com/v1/agent/query -H \"Authorization: Bearer YOUR_KEY\" -H \"Content-Type: application/json\" -d '{\"query\":\"Hello\"}'"},
        {title:'Node (fetch)', code:"const res = await fetch('https://api.example.com/v1/agent/query',{method:'POST', headers:{'Authorization':'Bearer YOUR_KEY','Content-Type':'application/json'}, body: JSON.stringify({query:'Hello'})}); const body = await res.json();"},
        {title:'Python (requests)', code:"import requests\nres = requests.post('https://api.example.com/v1/agent/query', headers={'Authorization':'Bearer YOUR_KEY', 'Content-Type':'application/json'}, json={'query':'Hello'})\nprint(res.json())"}
      ];
      el.innerHTML = '';
      snippets.forEach(s=>{
        const b = document.createElement('div'); b.style.marginBottom = '10px';
        const title = document.createElement('div'); title.style.fontWeight = '600'; title.textContent = s.title;
        const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.style.background = 'rgba(255,255,255,0.02)'; pre.style.padding = '8px'; pre.style.borderRadius = '6px'; pre.textContent = s.code;
        const controls = document.createElement('div'); controls.style.display = 'flex'; controls.style.gap = '8px';
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn'; copyBtn.textContent = 'Copier';
        copyBtn.addEventListener('click', ()=>{
          navigator.clipboard.writeText(s.code).then(()=>{ appendDevLog('Extrait SDK copi√© : '+s.title); alert('Extrait copi√© dans le presse-papiers'); }).catch(()=>{ alert('√âchec de la copie'); });
        });
        controls.appendChild(copyBtn);
        b.appendChild(title); b.appendChild(pre); b.appendChild(controls); el.appendChild(b);
      });
    }

    // Developer logs and test endpoint
    function appendDevLog(entry){ try{ const ds = loadDeveloperSettings(); ds.logs = ds.logs||[]; ds.logs.push({ ts: new Date().toISOString(), entry }); if(ds.logs.length>2000) ds.logs = ds.logs.slice(-1000); saveDeveloperSettings(ds); renderDevLogs(); }catch(e){} }
    function renderDevLogs(){ const el = document.getElementById('dev_logs'); if(!el) return; const ds = loadDeveloperSettings(); const arr = ds.logs || []; if(arr.length===0) { el.innerHTML = '<div class="helper-text">Aucun journal d√©veloppeur pour le moment.</div>'; return; } el.innerHTML=''; arr.slice(-200).reverse().forEach(l=>{ const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid var(--border)'; d.innerHTML = `<div style="font-weight:600">${escapeHtml(l.ts)}</div><div style="color:var(--muted);">${escapeHtml(l.entry)}</div>`; el.appendChild(d); }); }
    function clearDevLogs(){ if(!confirm('Effacer les journaux d√©veloppeur ?')) return; const ds = loadDeveloperSettings(); ds.logs = []; saveDeveloperSettings(ds); renderDevLogs(); }
    function downloadDevLogs(){ const ds = loadDeveloperSettings(); const blob = new Blob([JSON.stringify(ds.logs||[], null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'developer-logs.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); }

    function testApiEndpoint(){ // simulate an API call and log response
      appendDevLog('Requ√™te API simul√©e vers /v1/agent/query ‚Äî payload {query: "ping"}'); setTimeout(()=>{ appendDevLog('R√©ponse simul√©e : {reply:"pong"}'); alert('Test d\'API simul√© termin√© ‚Äî voir les journaux d√©veloppeur.'); }, 600); }

    // render developer panels on load
    function renderDeveloperPanels(){ try{ renderApiKeys(); renderWebhooks(); renderSdkSnippets(); renderDevLogs(); }catch(e){} }

    // initialize templates, translations and capabilities UI
    renderTemplatesList(); renderTranslations(); populateActionsWhitelist(); renderCapabilitiesActions(); renderDocumentLibrary(); renderCalendarLibrary(); renderInvoiceTemplatesList();
    // Wire slider display updates for capabilities UI
    const escT = document.getElementById('escalationTimeout'); if (escT) escT.addEventListener('input', ()=> document.getElementById('escalationTimeoutVal').textContent = escT.value);
    const sat = document.getElementById('satisfactionThreshold'); if (sat) sat.addEventListener('input', ()=> document.getElementById('satisfactionThresholdVal').textContent = sat.value);
    const autoE = document.getElementById('auto_escalate'); if (autoE) autoE.addEventListener('input', ()=> document.getElementById('auto_escalate_val').textContent = autoE.value);
  </script>
</body>
</html>
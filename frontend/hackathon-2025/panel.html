<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuration - NovaVoice | Your 24/7 AI Voice Assistant</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ajv@6.12.6/dist/ajv.min.js"></script>
  <style>
    /* Fixed Header */
    .header-fixed {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 50;
      background: linear-gradient(to bottom, var(--bg), rgba(5, 8, 22, 0.9));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(168, 85, 247, 0.1);
    }
    .header-nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 1.25rem;
      color: white;
      text-decoration: none;
      transition: color 0.2s;
    }
    .logo:hover { color: var(--accent); }
    .logo-img {
      width: 45px;
      height: 45px;
      object-fit: contain;
      filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.5)) brightness(1.2) contrast(1.1);
      mix-blend-mode: screen;
    }
    .nav-links {
      display: flex;
      gap: 2rem;
      align-items: center;
    }
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
      font-size: 0.95rem;
    }
    .nav-link:hover { color: var(--brand); }

    .panel-header {
      text-align: left;
      padding: 120px 0 28px;
    }
    .panel-header h1 {
      font-size: 2rem;
      margin: 0 0 8px;
    }
    .panel-header p {
      color: var(--muted);
      margin: 0;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
      padding: 0;
    }
    .tab-debug {
      margin-top:8px;
      font-size:0.85rem;
      color:var(--muted);
    }
    .tab-btn {
      padding: 18px 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(168, 85, 247, 0.2);
      border-radius: 12px;
      color: var(--fg);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--brand), var(--brand-light));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .tab-btn:hover {
      border-color: var(--brand);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
    }
    .tab-btn.active {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(192, 132, 252, 0.1));
      border-color: var(--brand);
      color: var(--accent);
      box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
    }
    .tab-btn.active::before {
      transform: scaleX(1);
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 28px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--fg);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--fg);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color .2s ease;
    }

    /* Ensure checkboxes/radios inside form groups don't stretch to full width */
    .form-group input[type="checkbox"],
    .form-group input[type="radio"] {
      width: auto;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
      height: 18px;
      padding: 0;
      background: transparent;
      border: none;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(91, 140, 255, 0.1);
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
    }

    .checkbox-group {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }
    .slider-group input[type="range"] {
      flex: 1;
      cursor: pointer;
    }
    .slider-value {
      min-width: 50px;
      text-align: right;
      color: var(--brand);
      font-weight: 600;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--fg);
      margin: 24px 0 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .save-btn {
      background: linear-gradient(135deg, var(--brand), #7aa2ff);
      color: #0b0d12;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease;
      box-shadow: 0 10px 24px rgba(91, 140, 255, .25);
    }
    .save-btn:hover {
      transform: translateY(-1px);
    }
    .save-btn:active {
      transform: translateY(0);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .info-box {
      background: rgba(91, 140, 255, 0.1);
      border-left: 3px solid var(--brand);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .section-card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 14px;
      margin-bottom: 24px;
    }
    .section-card .section-header{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin-bottom:10px;
    }
    .section-card .section-header h2{ margin:0; flex:0 0 auto; }
    .helper-text {
      font-style: italic;
      font-size: 0.92rem;
      color: var(--muted);
      margin-top: 6px;
    }
    .disabled-section {
      opacity: 0.6;
      filter: grayscale(40%);
    }
    .toggle-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
      color: var(--fg);
      cursor: pointer;
      font-weight: 600;
      min-width: 48px;
      line-height:1;
    }
    .toggle-btn .dot {
      width: 14px; height: 14px; border-radius: 50%; background: #222; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2);
      transition: transform .18s ease, background .18s ease;
      flex: 0 0 14px;
    }
    .toggle-btn.on { background: linear-gradient(90deg, var(--brand), #7aa2ff); color: #071022; border-color: rgba(122,162,255,0.6); }
    .toggle-btn.on .dot { background: #fff; transform: translateX(6px); }
    .toggle-btn .label { font-size:0.9rem; }
    /* Developer-only controls are hidden for business users by default */
    .dev-only { display: none !important; }
    .dev-warning { background: #fff3cd; border: 1px solid #ffeeba; padding:12px; border-radius:8px; color:#856404; }
    /* Capability categories (accordion) */
    .cap-category-header { text-align:left; color:var(--fg); background:transparent; border:none; padding:0; display:flex; align-items:center; gap:8px; }
    .cap-category-header strong { color:var(--fg); font-size:1rem; font-weight:700; text-align:left; }
    .cap-category-header .muted { color:var(--muted); font-weight:400; font-size:0.95rem; margin-left:8px; }
    .cap-category-header.open { border-color: var(--brand); box-shadow: 0 6px 18px rgba(91,140,255,0.08); }
    .cap-category-content { padding: 8px 0 0 0; }
    .cap-category .cond-area { margin-left: 8px; }
  </style>
</head>
<body>
  <!-- Fixed Header -->
  <header class="header-fixed">
    <nav class="header-nav">
      <a href="index.html" class="logo">
        <img src="logo.jpg" alt="NovaVoice" class="logo-img">
        <span>NovaVoice</span>
      </a>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="record.html" class="nav-link">Try Demo</a>
        <a href="panel.html" class="nav-link" style="color: var(--accent);">Configuration</a>
      </div>
    </nav>
  </header>

  <header class="container panel-header">
    <h1>Configure Your <span class="highlight">AI Assistant</span></h1>
    <p>Customize your 24/7 technical support assistant to match your business needs</p>
      <div style="display:flex; gap:12px; align-items:center; margin-top:16px;">
      <a class="btn" href="index.html">‚Üê Back to Home</a>
      <button id="export_config_btn" class="btn" type="button">Export Settings (JSON)</button>
      <label for="lang_select" style="margin-left:12px; display:inline-flex; align-items:center; gap:8px;">Language
        <select id="lang_select" style="padding:8px; border-radius:8px; margin-left:6px;" onchange="(function(v){ if(v==='fr') window.location.href='panel_fr.html'; else window.location.href='panel.html'; })(this.value)">
          <option value="en" selected>English</option>
          <option value="fr">Fran√ßais</option>
        </select>
      </label>
      <button id="import_config_btn" class="btn dev-only" type="button">Import Settings (JSON)</button>
      <input type="file" id="import_config_file" accept="application/json" class="dev-only" style="display:none" />
      <input type="file" id="template_import_file" accept=".json,.txt" style="display:none" onchange="handleTemplateFile(event)" />
      <input type="file" id="document_import_file" accept=".txt,.md" style="display:none" onchange="handleDocumentFile(event)" />
      <input type="file" id="calendar_import_file" accept=".ics" style="display:none" onchange="handleCalendarFile(event)" />
      <input type="file" id="invoice_template_import_file" accept=".json,.txt,.md" style="display:none" onchange="handleInvoiceTemplateFile(event)" />
    </div>
    <!-- DEVELOPERS / Advanced Controls -->
    <div id="developers" class="tab-content">
      <div class="section-card">
        <div class="dev-warning"><strong>Developer Settings (Advanced)</strong><div style="margin-top:6px;">These controls are intended for developers and technical staff. Business owners should not modify these unless they understand the impact. Back up your configuration before applying changes.</div></div>
        <div style="display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;">
          <button class="btn" type="button" onclick="openImportFile()">Import Settings (JSON)</button>
          <button class="btn" type="button" onclick="showImportPreviewPanel()">Show Import Preview</button>
          <button class="btn" type="button" onclick="openBackupsTab()">Manage Backups</button>
          <button class="btn" type="button" onclick="openTrainingQueueTab()">Open Training Queue</button>
          <button class="btn" type="button" onclick="revealPaymentApiKey()">Reveal Payment API Key</button>
          <button class="btn" type="button" onclick="showSSMLRaw()">Show SSML Raw</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
          <div class="section-card" style="padding:12px;">
            <h3 style="margin-top:0;">API Keys</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input id="new_api_name" placeholder="Key name (e.g., service-app)" style="flex:1; padding:8px;" /><button class="btn" onclick="createApiKey()">Generate Key</button></div>
            <div id="api_keys_list" style="max-height:220px; overflow:auto;"></div>
          </div>

          <div class="section-card" style="padding:12px;">
            <h3 style="margin-top:0;">Webhooks</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input id="new_webhook_url" placeholder="https://example.com/webhook" style="flex:1; padding:8px;" /><select id="new_webhook_method"><option>POST</option><option>PUT</option><option>PATCH</option></select><button class="btn" onclick="addWebhook()">Add</button></div>
            <div id="webhooks_list" style="max-height:220px; overflow:auto;"></div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
          <div class="section-card">
            <h3 style="margin-top:0;">SDK Snippets</h3>
            <div id="sdk_snippets" style="font-family:monospace; font-size:0.95rem; max-height:220px; overflow:auto; padding:8px; background:var(--panel); border-radius:6px;"></div>
          </div>
          <div class="section-card">
            <h3 style="margin-top:0;">Developer Logs & Test</h3>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><button class="btn" onclick="testApiEndpoint()">Test API Endpoint</button><button class="btn" onclick="downloadDevLogs()">Download Logs</button><button class="btn" onclick="clearDevLogs()" style="background:#d9534f;">Clear Logs</button></div>
            <div id="dev_logs" style="max-height:220px; overflow:auto; font-family:monospace; background:var(--panel); padding:8px; border-radius:6px;"></div>
          </div>
        </div>
        <div id="dev_output" style="margin-top:12px; font-family:monospace; white-space:pre-wrap; color:var(--muted);"></div>
      </div>
    </div>
  </header>
  <div class="container" style="margin-top:12px;">
    <div id="import_preview" class="section-card dev-only" style="display:none;">
      <h3 style="margin-top:0;">Import Preview</h3>
      <div id="import_changes" style="max-height:280px; overflow:auto; font-family:monospace; font-size:0.95rem;"></div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button id="apply_import_btn" class="save-btn">Apply Import</button>
        <button id="cancel_import_btn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- MODEL / TRAINING TAB -->
    <div id="model" class="tab-content dev-only">
      <div class="info-box">üß† Control use of interactions for model training, review queue and sample management.</div>
      <div class="section-card">
        <div style="display:flex; align-items:center; gap:12px;">
          <button class="toggle-btn" data-checkbox="training_enabled" role="switch" aria-checked="false"><span class="dot"></span><span class="label">Off</span></button>
          <input type="checkbox" id="training_enabled" name="training.enabled" style="display:none" />
          <div style="flex:1;"><strong>Include anonymized interactions in training</strong><div class="helper-text">When enabled, selected conversations may be sent to your training queue (demo uses localStorage).</div></div>
        </div>
        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <button class="btn" type="button" onclick="enqueueSampleFromRecent()">Add Recent Sample</button>
          <button class="btn" type="button" onclick="renderTrainingQueue()">Open Reviewer Queue</button>
        </div>
        <div id="training_queue" style="margin-top:12px; display:none;"></div>
      </div>
    </div>

    <!-- TEMPLATES & SNIPPETS TAB -->
    <div id="templates" class="tab-content">
      <div class="info-box">‚úâÔ∏è Message templates and reusable snippets with preview and variables.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1;">
            <label><strong>Templates</strong></label>
            <div id="templates_list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
            <div style="margin-top:8px;"><button class="btn" type="button" onclick="addTemplateEditor()">Add Template</button></div>
          </div>
          <div style="flex:1;">
            <label><strong>Live Preview</strong></label>
            <div style="margin-top:8px;">
              <div style="display:flex; gap:8px; align-items:center;"><label style="min-width:80px;">Template</label><select id="preview_template" onchange="updateTemplatePreview()"></select></div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:8px;"><label style="min-width:80px;">Variables (JSON)</label><input id="preview_vars" placeholder='{"customer_name":"Jane"}' style="flex:1; padding:8px;" /></div>
              <div id="template_preview" style="margin-top:12px; white-space:pre-wrap; font-family:monospace; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCESSIBILITY / LOCALIZATION TAB -->
    <div id="accessibility" class="tab-content dev-only">
      <div class="info-box">‚ôø Accessibility and localization: TTS voice selection, SSML, translations and RTL preview.</div>
      <div class="section-card">
        <div class="form-row">
          <div class="form-group"><label for="tts_voice">TTS Voice</label>
            <select id="tts_voice" name="accessibility.tts_voice"><option value="default">Default</option><option value="female_en">Female - en-US</option><option value="male_en">Male - en-US</option><option value="multilang">Multi-lang</option></select></div>
          <div class="form-group"><label for="tts_speed">TTS Speed</label><input id="tts_speed" name="accessibility.tts_speed" type="range" min="0.5" max="2" step="0.1" value="1" /></div>
        </div>
        <div class="form-group"><label for="ssml_snippet">SSML Snippet</label><textarea id="ssml_snippet" name="accessibility.ssml" placeholder="<speak>Hello <break time=\"200ms\"/> world</speak>"></textarea>
          <div style="margin-top:8px;"><button class="btn" type="button" onclick="previewSSML()">Preview SSML (demo)</button></div>
        </div>
        <div class="section-title">Translations</div>
        <div class="helper-text">Manage translation strings for UI messages. Key-value editor below.</div>
        <div id="translations_list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;"><button class="btn" type="button" onclick="addTranslationRow()">Add String</button><button class="btn" type="button" onclick="toggleRTLPreview()">Toggle RTL Preview</button></div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="tabs">
      <button class="tab-btn" data-tab="presets">Presets & Profile</button>
      <button class="tab-btn active" data-tab="personality">Branding & Personality</button>
      <button class="tab-btn" data-tab="capabilities">Capabilities & Safeguards</button>
      <button class="tab-btn" data-tab="telephony">Telephony & CRM</button>
      <button class="tab-btn" data-tab="transcription">Transcription & Transcripts</button>
      <button class="tab-btn" data-tab="diagnostics">Diagnostics & Tools</button>
      <button class="tab-btn" data-tab="playbooks">Playbooks (Runbooks)</button>
      <button class="tab-btn" data-tab="network">Network Status & Outage</button>
      <button class="tab-btn" data-tab="ticketing">Ticketing & SLA</button>
      <button class="tab-btn" data-tab="knowledge">Knowledge & Templates</button>
      <button class="tab-btn" data-tab="appointments">Appointments & Reservations</button>
      <button class="tab-btn" data-tab="quotes">Quotes & Payments</button>
      <button class="tab-btn" data-tab="analytics">Storage, Insights & Analytics</button>
      <button class="tab-btn" data-tab="escalation">Escalation & On-Call</button>
      <button class="tab-btn" data-tab="privacy">Privacy & Compliance</button>
      <button class="tab-btn" data-tab="developers">Developers & Advanced</button>
    </div>

    <!-- PERSONALITY TAB -->
    <!-- PRESETS TAB (UI only) -->
    <div id="presets" class="tab-content">
      <div class="info-box">üéØ Apply industry presets to quickly configure the agent for common business types.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Presets</h2>
        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
          <div class="card">
            <strong>Telecom Frontline</strong>
            <div class="muted">Front-desk/IVR assistant: caller identification, basic troubleshooting, routing to queues, and simple account lookups.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="telecom_frontline">Apply</button></div>
          </div>
          <div class="card">
            <strong>Telecom NOC</strong>
            <div class="muted">NOC-focused: automated diagnostics, outage detection, network-level playbooks, and escalation to field teams.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="telecom_noc">Apply</button></div>
          </div>
          <div class="card">
            <strong>IT Helpdesk / MSP</strong>
            <div class="muted">Managed IT support: device reprovisioning, VPN checks, ticket creation, technician dispatch and SLA workflows.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="it_msp">Apply</button></div>
          </div>
          <div class="card">
            <strong>SaaS Support</strong>
            <div class="muted">Application-first support: account lookup, billing/plan assistance, guided troubleshooting, and escalation to product teams.</div>
            <div style="margin-top:8px;"><button type="button" class="btn preset-apply" data-preset="saas_support">Apply</button></div>
          </div>
        </div>
        <div class="helper-text" style="margin-top:12px;">These buttons are UI-only for now. Applying presets will be implemented later.</div>
        <div class="helper-text">Tip: Apply a preset to get sensible defaults for your industry, then review settings (privacy, quotes, hours) before saving.</div>
      </div>
    </div>
    <div id="personality" class="tab-content active">
      <div class="info-box">
        üí° Define how your AI agent communicates with customers. These settings affect tone, responsiveness, and communication style.
      </div>

      <form id="personalityForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Communication Style</h2>

          <div class="form-group">
            <label>Agent Name</label>
            <input type="text" id="agentName" value="TechBot" placeholder="e.g., TechBot, Alex, Support Agent">
            <div class="helper-text">Use a friendly, recognizable name customers will remember ‚Äî helpful for handoffs to human staff.</div>
          </div>

          <div class="form-group">
            <label>Agent Avatar <small class="muted">(optional)</small></label>
            <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
              <input type="file" id="avatar_file" name="personality.avatar" accept="image/*" />
              <img id="avatar_preview" alt="Avatar preview" src="" style="width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid var(--border); display:inline-block; background:var(--panel);" />
            </div>
            <div class="helper-text">Upload an image to represent the agent (shown to customers).</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Personality Type</label>
              <select id="personalityType">
                <option value="professional">Professional & Formal</option>
                <option value="friendly">Friendly & Approachable</option>
                <option value="technical">Technical & Detailed</option>
                <option value="concise">Concise & Direct</option>
              </select>
              <div class="helper-text">Choose the style that matches your brand ‚Äî friendly for retail, technical for support-heavy businesses.</div>
            </div>
            <div class="form-group">
              <label>Response Speed</label>
              <select id="responseSpeed">
                <option value="instant">Instant (< 1 second)</option>
                <option value="normal">Normal (1-2 seconds)</option>
                <option value="thoughtful">Thoughtful (2-3 seconds)</option>
              </select>
              <div class="helper-text">Faster replies feel more responsive; slower replies allow longer, more accurate answers. Pick based on call type.</div>
            </div>
          </div>

          <div class="form-group">
            <label>Custom Greeting</label>
            <input type="text" id="customGreeting" value="Thank you for calling. How can I assist you today?" placeholder="Your custom greeting message">
            <div class="helper-text">Short greetings reduce friction ‚Äî include business name if helpful for caller recognition.</div>
          </div>

          <div class="form-group">
            <label>Custom Sign-off</label>
            <input type="text" id="customSignOff" value="Thank you for contacting us. Have a great day!" placeholder="Your closing message">
            <div class="helper-text">A warm, consistent sign-off builds trust and signals the conversation end to customers.</div>
          </div>

          <div class="section-title">Language Settings</div>

          <div class="form-group">
            <label>Primary Language</label>
            <select id="primaryLanguage">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="ja">Japanese</option>
              <option value="zh">Chinese</option>
            </select>
          </div>

          <div class="form-group">
            <label>Supported Languages (Multi-language support)</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="lang_en" checked>
                <label for="lang_en">English</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_es">
                <label for="lang_es">Spanish</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_fr">
                <label for="lang_fr">French</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lang_de">
                <label for="lang_de">German</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="savePersonality()">Save Personality Settings</button>
        </div>
      </form>
    </div>

    <!-- CAPABILITIES TAB -->
    <div id="capabilities" class="tab-content">
      <div class="info-box">
        üîß Configure what actions your AI agent can perform automatically. Complex tasks can be escalated to human technicians.
      </div>

      <form id="capabilitiesForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Service Capabilities</h2>

          <div class="helper-text">Set the confirmation level for each action: <strong>No need</strong>, <strong>May require</strong>, or <strong>Required</strong>.</div>

          <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <label style="min-width:120px; font-weight:600;">Quick Set</label>
            <select id="bulkSetLevel" style="max-width:260px;">
              <option value="">-- Set selected --</option>
              <option value="no_need">No confirmation needed</option>
              <option value="may_require">May require confirmation</option>
              <option value="required">Always require confirmation</option>
            </select>
            <button type="button" class="btn" id="bulkApplyBtn">Apply to all</button>
          </div>

          <div class="section-title" style="margin-top:16px;">Actions & Confirmation Levels</div>

          <div class="helper-text" style="margin-top:8px;">
            Each action below can be set to one of three confirmation levels:
            <strong>No confirmation needed</strong> (safe, read-only or low-impact tasks),
            <strong>May require</strong> (agent will suggest but may ask), and
            <strong>Required</strong> (always ask a human first).
          </div>

          <div class="section-card" style="margin-top:12px; padding:10px; background:var(--panel); border:1px solid var(--border);">
            <strong>Conditions Guide</strong>
            <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">
              - <strong>high_priority_account</strong>: customer flagged by your CRM as VIP or covered by a stricter SLA.
              <br>- <strong>outage_detected</strong>: system-wide outage or multiple customers affected.
              <br>- <strong>after_hours</strong>: action requested outside normal business hours.
              <br>- <strong>field_dispatch_required</strong>: issue likely needs an on-site technician.
              <br>- <strong>monetary_impact</strong>: action will change billing, apply credits or refunds.
              <br>- <strong>new_device</strong>: user is registering or using a new/unrecognized device.
              <br>- <strong>unusual_location</strong>: caller appears to be in an unexpected location (possible fraud).
              <br>- <strong>legal_identity_change</strong>: changes involving identity/owner information.
              <br>- <strong>security_incident</strong>: actions related to security breaches or compromised accounts.
                <br>- <strong>staging_passed</strong>: automated tests and staging validation have passed.
                <br>- <strong>backup_taken</strong>: a recent backup or snapshot exists for recovery.
                <br>- <strong>client_approval</strong>: explicit client approval has been recorded for this change.
                <br>- <strong>production_environment</strong>: this action affects production systems (high risk).
                <br>- <strong>domain_verification</strong>: domain ownership/verification step completed.
                <br>- <strong>contract_signed</strong>: client contract or SOW is signed and on file.
                <br>- <strong>payment_verified</strong>: client payment or deposit verified.
                <br>- <strong>production_issue</strong>: current production incident or outage is present.
            </div>
            <div style="margin-top:8px; font-size:0.9rem;" class="helper-text">Tip: use the global "Auto-escalate if unsure" slider to hand off uncertain cases instead of tagging individual actions with confidence rules.</div>
          </div>

          <div id="capabilities_actions_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>

          <div class="section-title">Escalation Triggers</div>

          <div class="form-group">
            <label>Automatically Escalate After (minutes of conversation)</label>
            <div class="slider-group">
              <input type="range" id="escalationTimeout" min="1" max="15" value="5" style="width: 200px;">
              <span class="slider-value"><span id="escalationTimeoutVal">5</span> min</span>
            </div>
            <div class="helper-text">If conversations run this long without resolution, consider escalating to a human (reduce customer frustration).</div>
          </div>

          <div class="form-group">
            <label>Customer Satisfaction Threshold for Escalation</label>
            <div class="slider-group">
              <input type="range" id="satisfactionThreshold" min="1" max="10" value="5" style="width: 200px;">
              <span class="slider-value"><span id="satisfactionThresholdVal">5</span>/10</span>
            </div>
            <div class="helper-text">Set the minimum satisfaction score before the system escalates ‚Äî lower values escalate sooner.</div>
          </div>
          
          <div class="section-title">Global Safeguards</div>
          <div class="form-group">
            <label><input type="checkbox" id="safeguards_enabled" /> Ask before risky actions (master toggle)</label>
            <div class="helper-text">Enable a master safeguard that prompts for confirmation on actions that exceed configured limits.</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="max_monetary_impact">Max monetary impact without approval (‚Ç¨)</label>
              <input id="max_monetary_impact" type="number" min="0" value="0" />
            </div>
            <div class="form-group">
              <label for="actions_whitelist">Actions whitelist (allowed without approval)</label>
              <select id="actions_whitelist" multiple style="height:120px;"></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Auto-escalate if unsure (threshold)</label>
              <div class="slider-group"><input type="range" id="auto_escalate" min="0" max="100" value="60" /><span class="slider-value"><span id="auto_escalate_val">60</span>%</span></div>
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="audit_log_enabled" /> Audit log enabled</label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveCapabilities()">Save Capabilities</button>
        </div>
      </form>
    </div>

    <!-- QUOTES TAB -->
    <div id="quotes" class="tab-content">
      <div class="info-box">
        üí∂ Configure how the AI creates and validates quotes (devis). Templates, VAT, currency and approval rules.
      </div>

      <form id="quotesForm">
        <div class="section-card">
          <div class="section-header">
            <h2 style="margin:0;">Quote Settings</h2>
            <div style="display:flex; align-items:center; gap:12px;">
              <button type="button" class="toggle-btn" data-checkbox="quotes_enabled" role="switch" aria-checked="false">
                <span class="dot"></span>
                <span class="label">Off</span>
              </button>
              <input type="checkbox" id="quotes_enabled" name="quotes.enabled" style="display:none" />
            </div>
          </div>
          <div class="helper-text">Enable if your business provides simple price estimates or formal quotes ‚Äî integrates with email templates below.</div>

          <div class="form-row">
            <div class="form-group">
              <label for="quotes_currency">Default currency</label>
              <select id="quotes_currency" name="quotes.currency">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
            <div class="form-group">
              <label for="quotes_vat">VAT (%)</label>
              <input id="quotes_vat" name="quotes.vat" type="number" min="0" max="100" value="20" />
            </div>
          </div>

          <div class="form-group">
            <label for="quotes_valid_days">Default validity (days)</label>
            <input id="quotes_valid_days" name="quotes.valid_days" type="number" min="0" value="30" />
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="quotes_require_human" name="quotes.require_human" /> Require human approval for quotes above</label>
            <input id="quotes_human_threshold" name="quotes.human_threshold" type="number" min="0" value="1000" style="margin-left:8px; width:140px;" /> <span class="muted">(amount in default currency)</span>
            <div class="helper-text">When enabled, quotes above the threshold will be flagged for human review to prevent large or risky automatic approvals.</div>
          </div>

          <div class="form-group">
            <label for="quotes_template_subject">Email subject template</label>
            <input id="quotes_template_subject" name="quotes.email_subject" placeholder="Quote for {{customer_name}} - {{quote_id}}" />
          </div>
          <div class="form-group">
            <label for="quotes_template_body">Email body template</label>
            <textarea id="quotes_template_body" name="quotes.email_body" placeholder="Hello {{customer_name}},\nPlease find your quote attached. Total: {{total}} {{currency}}"></textarea>
          </div>

          <div class="form-group">
            <label>Invoice Templates</label>
            <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
              <button class="btn" type="button" onclick="importInvoiceTemplate()">Import Invoice Template</button>
              <button class="btn" type="button" onclick="renderInvoiceTemplatesList()">Open Invoice Templates</button>
              <button class="btn" type="button" onclick="exportInvoiceTemplates()">Export Invoice Templates</button>
            </div>
            <div id="invoice_templates_list" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>

          <div class="form-group" style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
            <label><strong>Invoice Platform (Compliance)</strong></label>
            <div class="helper-text">Some jurisdictions require invoices be reported to a certified platform. Choose your platform and register a connection (front-end demo only).</div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <select id="invoice_platform_select" style="min-width:200px">
                <option value="none">None</option>
                <option value="chorus_pro">Chorus Pro</option>
                <option value="sage">Sage</option>
                <option value="dgi">DGI / Local Platform</option>
                <option value="custom">Other (Custom)</option>
              </select>
              <input id="invoice_platform_merchant" placeholder="Merchant / Account ID" style="padding:8px;" />
              <input id="invoice_platform_api" placeholder="API Key / Token" style="padding:8px;" />
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
              <button class="btn" type="button" onclick="connectInvoicePlatform()">Register Invoice Platform (demo)</button>
              <button class="btn" type="button" onclick="disconnectInvoicePlatform()">Disconnect</button>
              <div id="invoice_platform_status" style="color:var(--muted); margin-left:8px;">Not registered</div>
            </div>
          </div>

          <div class="form-group">
            <label for="quotes_validation_rules">Validation rules (JSON)</label>
            <textarea id="quotes_validation_rules" name="quotes.validation_rules" placeholder='[{"field":"price","min":0}]' style="min-height:80px;"></textarea>
            <div class="helper-text">Optional simple JSON rules to validate generated quotes before sending.</div>
          </div>

        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveQuotes()">Save Quote Settings</button>
          <button type="button" class="btn" onclick="previewQuote()">Preview Quote</button>
          <button type="button" class="btn" onclick="exportInvoiceSample()">Export Invoice (JSON)</button>
          <button type="button" class="btn" onclick="openInvoiceHistory()">Invoice History</button>
        </div>
      </form>
    </div>

    <!-- KNOWLEDGE / FAQ TAB -->
    <div id="knowledge" class="tab-content">
      <div class="info-box">‚ùì Manage Frequently Asked Questions (FAQ). See recent user questions and add short answers for the agent to use.</div>

      <form id="knowledgeForm">
        <div class="section-card">
          <h2 style="margin-top:0;">FAQ Knowledge</h2>

            <div class="muted">Existing FAQs (edit answers or add new ones)</div>
            <div class="helper-text">Turn frequent questions into concise FAQs to reduce repetitive calls and speed up resolutions.</div>
            <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Quick Guide: Use FAQs and templates to capture common answers and message snippets. Keep answers short, and use variables like <code>{{customer_name}}</code> to personalise messages. Convert recent questions into FAQs to build your knowledge base quickly.</div>
          <div id="faqs_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
          <div style="margin-top:8px;"><button type="button" id="knowledge_add" class="btn">Add FAQ</button></div>

          <div class="section-title" style="margin-top:18px;">Recent Interesting Questions</div>
          <div id="recent_questions" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
          <div class="helper-text">These are recent user questions detected during use; click "Add answer" to convert them into FAQs. Use the "Add Template" button below to create reusable reply snippets for email/SMS.</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn" type="button" onclick="addTemplateEditor()">Add Template</button>
            <button class="btn" type="button" onclick="importTemplates()">Import Templates</button>
            <button class="btn" type="button" onclick="exportTemplates()">Export Templates</button>
          </div>

          <div style="margin-top:16px; border-top:1px dashed var(--border); padding-top:12px;">
            <h3 style="margin:0 0 6px;">Company Documents</h3>
            <div class="helper-text">Upload plain text or Markdown files describing your company, services, SLAs or product pages. Uploaded documents are stored locally (browser) and can be used to create templates or FAQs. You can remove documents anytime.</div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
              <button class="btn" type="button" onclick="importDocument()">Upload Company Doc</button>
              <button class="btn" type="button" onclick="renderDocumentLibrary()">Open Document Library</button>
            </div>
            <div id="uploaded_docs_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveKnowledge()">Save FAQ Knowledge</button>
        </div>
      </form>
    </div>

        <!-- APPOINTMENTS TAB -->
        <div id="appointments" class="tab-content">
          <div class="info-box">üìÖ Configure appointment booking behavior: calendars, durations and double-book guards.</div>
          <form id="appointmentsForm">
            <div class="section-card">
              <div class="section-header">
                <h2 style="margin:0;">Appointments</h2>
                <div style="display:flex; align-items:center; gap:12px;">
                  <button type="button" class="toggle-btn" data-checkbox="appts_enabled" role="switch" aria-checked="false">
                    <span class="dot"></span>
                    <span class="label">Off</span>
                  </button>
                  <input type="checkbox" id="appts_enabled" name="appointments.enabled" style="display:none" />
                </div>
              </div>
              <div class="helper-text">Turn on to let customers book slots; connect your calendar provider for live availability.</div>
              <div class="form-row">
                <div class="form-group"><label for="appts_provider">Provider</label>
                  <select id="appts_provider" name="appointments.provider"><option value="google">Google Calendar</option><option value="outlook">Outlook</option><option value="none">None</option></select>
                  <div class="helper-text">Choose your calendar provider ‚Äî connecting enables live availability and avoids double bookings.</div>
                </div>
                <div class="form-group"><label for="appts_calendar">Calendar ID</label><input id="appts_calendar" name="appointments.calendar_id" placeholder="primary" /></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label for="appts_duration">Default duration (min)</label><input id="appts_duration" name="appointments.duration_min" type="number" min="5" value="30"/></div>
                <div class="form-group"><label for="appts_buffer">Buffer (min)</label><input id="appts_buffer" name="appointments.buffer_min" type="number" min="0" value="10"/></div>
              </div>
              <div class="form-group"><label for="appts_reminder">Reminder (min before)</label><input id="appts_reminder" name="appointments.reminder_min" type="number" min="0" value="60"/></div>
              <div class="form-group"><label><input type="checkbox" name="appointments.prevent_double_booking" /> Prevent double-booking</label></div>
              <div class="form-group"><label for="appts_confirm">Confirmation message</label><textarea id="appts_confirm" name="appointments.confirm_message" placeholder="Thanks {{customer_name}}, your booking is confirmed for {{date}} at {{time}}."></textarea></div>
            </div>
            <div style="margin-top:16px; border-top:1px dashed var(--border); padding-top:12px;">
              <h3 style="margin:0 0 6px;">Calendar Connections</h3>
              <div class="helper-text">Connect or upload calendars so the agent can check availability and prevent double bookings. For demos you can upload an .ics file which will be stored locally.</div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <button class="btn" type="button" onclick="importCalendar()">Upload .ics Calendar</button>
                <button class="btn" type="button" onclick="renderCalendarLibrary()">Open Calendar Library</button>
                <button class="btn" type="button" onclick="testCalendarConnection()">Test Connection</button>
              </div>
              <div id="uploaded_calendars_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>
            <div class="form-actions"><button type="button" class="save-btn" onclick="saveAppointments()">Save Appointments</button></div>
          </form>
        </div>

        <!-- RESERVATION TAB -->
        <div id="reservation" class="tab-content">
          <div class="info-box">üçΩÔ∏è Reservation-specific settings for restaurants and venues: party sizes, deposits and table prefs.</div>
          <form id="reservationForm">
            <div class="section-card">
              <div class="section-header">
                <h2 style="margin:0;">Reservation Settings</h2>
                <div style="display:flex; align-items:center; gap:12px;">
                  <button type="button" class="toggle-btn" data-checkbox="resv_enabled" role="switch" aria-checked="false">
                    <span class="dot"></span>
                    <span class="label">Off</span>
                  </button>
                  <input type="checkbox" id="resv_enabled" name="reservation.enabled" style="display:none" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group"><label for="resv_party_default">Default party size</label><input id="resv_party_default" name="reservation.party_default" type="number" min="1" value="2"/></div>
                <div class="form-group"><label for="resv_table_pref">Table preference</label><input id="resv_table_pref" name="reservation.table_pref" placeholder="Window / Booth / Any"/></div>
              </div>
              <div class="form-group"><label><input type="checkbox" id="resv_deposit" name="reservation.deposit_required" /> Require deposit</label> <input id="resv_deposit_amount" name="reservation.deposit_amount" type="number" min="0" value="0" style="margin-left:8px; width:120px;"/></div>
              <div class="helper-text">Deposits reduce no-shows and protect revenue ‚Äî keep it modest and communicate the policy clearly to customers.</div>
              <div class="form-group"><label for="resv_booking_url">Online booking URL</label><input id="resv_booking_url" name="reservation.booking_url" type="url" placeholder="https://example.com/book"/></div>
              <div class="form-group"><label for="resv_cancel_policy">Cancellation policy</label><textarea id="resv_cancel_policy" name="reservation.cancellation_policy" placeholder="Cancellation allowed up to 24 hours before..."></textarea></div>
            </div>
            <div class="form-actions"><button type="button" class="save-btn" onclick="saveReservation()">Save Reservation Settings</button></div>
          </form>
        </div>

        <!-- TECHNICAL ASSISTANCE TAB removed temporarily -->
    <!-- DATA & PRIVACY TAB -->
    <div id="privacy" class="tab-content">
      <div class="info-box">üîí Data & Privacy (RGPD/GDPR) ‚Äî controls for consent, retention, PII handling and data exports.</div>

      <form id="privacyForm">
        <div class="section-card">
          <h2 style="margin-top:0;">Privacy Controls</h2>

          <div class="form-group">
            <label><input type="checkbox" id="privacy_consent_enabled" name="privacy.consent.enabled" /> Show consent prompt to users</label>
          </div>

          <div class="form-group">
            <label for="privacy_consent_text">Consent prompt text</label>
            <input id="privacy_consent_text" name="privacy.consent.text" placeholder="We use information to improve service. Do you consent?" />
            <div class="helper-text">Keep consent language short and specific. It's shown to end users.</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="privacy_retention_days">Retention (days)</label>
              <input id="privacy_retention_days" name="privacy.retention_days" type="number" min="0" value="0" />
              <div class="muted">0 = do not keep conversation transcripts</div>
            </div>
            <div class="form-group">
              <label>PII Redaction</label>
              <div><label><input type="checkbox" id="privacy_pii_redact" name="privacy.pii_redaction" /> Enable automated PII redaction for transcripts</label></div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_email" /> Mask emails</label>
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_phone" /> Mask phones</label>
                <label style="display:flex; gap:6px; align-items:center;"> <input type="checkbox" id="privacy_pii_names" /> Mask customer names</label>
              </div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;"><button class="btn" type="button" onclick="runPiiRedactionPreview()">Preview Redaction</button><button class="btn" type="button" onclick="purgeExpiredData()" style="background:#d9534f;">Purge Expired Data</button></div>
              <div class="helper-text">Redaction masks names, emails and phone numbers to reduce privacy risk ‚Äî note it may limit troubleshooting details in transcripts.</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="privacy_data_residency">Data residency</label>
              <select id="privacy_data_residency" name="privacy.data_residency">
                <option value="eu">European Union (EU)</option>
                <option value="us">United States (US)</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="privacy_dpa_url">DPA / Privacy policy URL</label>
              <input id="privacy_dpa_url" name="privacy.dpa_url" placeholder="https://example.com/privacy" />
            </div>
          </div>

          <div class="section-title" style="margin-top:12px;">Account Data Actions</div>
          <div class="form-row" style="align-items:center; gap:12px;">
            <button type="button" id="export_my_data" class="save-btn">Export my data</button>
            <button type="button" id="delete_my_data" class="save-btn" style="background:#d9534f;">Delete my data</button>
            <button type="button" id="export_audit_log" class="btn">Export Audit Log</button>
            <button type="button" id="simulate_consent" class="btn">Simulate Consent Banner</button>
            <div class="muted">Exports produce a ZIP/JSON with stored FAQs, snaps and profile details. Delete will remove locally stored demo data only.</div>
            <div class="helper-text">Tip: For GDPR compliance set retention low and provide data export/delete options to users. Consult your legal advisor for production deployments.</div>
          </div>
        </div>

        <div id="snaps_section" class="section-card" style="margin-top:12px;">
          <div class="section-header">
            <h3 style="margin:0;">Storage & Conversation Snaps</h3>
            <div style="display:flex; align-items:center; gap:12px;">
              <button type="button" class="toggle-btn" data-checkbox="snaps_store_enabled" role="switch" aria-checked="false">
                <span class="dot"></span>
                <span class="label">Off</span>
              </button>
              <input type="checkbox" id="snaps_store_enabled" name="storage.store_snaps" style="display:none" />
            </div>
          </div>
          <div class="helper-text" style="margin-top:6px;">Only store snippets you need. Be mindful of PII and retention rules; consider storing intents only where possible.</div>

          <div class="form-row">
            <div class="form-group">
              <label for="snaps_last_n">Keep last N customer questions</label>
              <input id="snaps_last_n" name="storage.snaps_last_n" type="number" min="0" value="10" />
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="snaps_unresolved" name="storage.snaps_unresolved" /> Keep unresolved questions</label>
            </div>
          </div>

          <div class="form-group">
            <label><input type="checkbox" id="snaps_intents_only" name="storage.snaps_intents_only" /> Store intents only (no full transcripts)</label>
          </div>

          <div style="margin-top:8px; display:flex; gap:12px; align-items:center;">
            <button type="button" id="snaps_export_btn" class="btn">Export conversation snaps</button>
            <div id="snaps_preview" style="flex:1; max-height:120px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
          </div>
        </div>

        <div class="form-actions"><button type="button" class="save-btn" onclick="savePrivacy()">Save Data & Privacy</button></div>
      </form>
    </div>

        <!-- ESCALATION TAB -->
    <div id="escalation" class="tab-content">
      <div class="info-box">
        üë§ Configure how and when calls are escalated to human technicians, and set up your support team.
      </div>

      <form id="escalationForm">
        <div class="section-card">
          <h2 style="margin-top: 0;">Escalation Settings</h2>

          <div class="section-title">Support Team</div>

          <div class="form-group">
            <label>Support Team Email Address</label>
            <input type="email" id="teamEmail" value="support@company.com" placeholder="team@company.com">
          </div>

          <div class="form-group">
            <label>Escalation Queue</label>
            <select id="escalationQueue">
              <option value="priority">Priority Queue (Immediate)</option>
              <option value="standard">Standard Queue (5-10 min)</option>
              <option value="scheduled">Scheduled Callback (Next Available)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="oncall_calendar">On-call Calendar URL</label>
            <input id="oncall_calendar" placeholder="https://calendar.example.com/oncall" />
            <div class="helper-text">Optional: provide an on-call calendar so escalations can route to on-duty technicians.</div>
          </div>

          <div class="form-group">
            <label>Skill Queues</label>
            <div class="helper-text">Comma-separated skills (e.g., Fiber,xDSL,WiFi,VoIP). Routing will match skills to technician profiles.</div>
            <input id="skill_queues" placeholder="Fiber,xDSL,WiFi,VoIP" />
          </div>

          <div class="section-title">SLA Targets</div>
          <div class="form-row">
            <div class="form-group"><label for="sla_p1">P1 Response (min)</label><input id="sla_p1" type="number" min="0" value="15" /></div>
            <div class="form-group"><label for="sla_p1_res">P1 Resolution (hrs)</label><input id="sla_p1_res" type="number" min="0" value="2" /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="sla_p2">P2 Response (min)</label><input id="sla_p2" type="number" min="0" value="60" /></div>
            <div class="form-group"><label for="sla_p2_res">P2 Resolution (hrs)</label><input id="sla_p2_res" type="number" min="0" value="8" /></div>
          </div>

          <div class="section-title">Escalation Reasons</div>

          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="esc_unknown_issue" checked>
              <label for="esc_unknown_issue">Unknown Issue</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_customer_request" checked>
              <label for="esc_customer_request">Customer Request</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_complex_billing" checked>
              <label for="esc_complex_billing">Complex Billing Issue</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_special_case" checked>
              <label for="esc_special_case">Special Case/Exception</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esc_angry_customer">
              <label for="esc_angry_customer">Detect Frustrated Customer</label>
            </div>
          </div>

          <div class="section-title">Business Hours</div>

          <div class="form-row">
            <div class="form-group">
              <label>Support Hours (Start)</label>
              <input type="time" id="supportHourStart" value="09:00">
            </div>
            <div class="form-group">
              <label>Support Hours (End)</label>
              <input type="time" id="supportHourEnd" value="17:00">
            </div>
          </div>

          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="weekend_support">
              <label for="weekend_support">Weekend Support Available</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="holidays_support">
              <label for="holidays_support">Holiday Support Available</label>
            </div>
          </div>

          <div class="form-group">
            <label>After-Hours Auto-Response</label>
            <textarea id="afterHoursMessage" placeholder="We are currently closed. Your call will be queued and handled during business hours...">We are currently closed. Your call will be queued and handled during business hours. Please leave a message.</textarea>
          </div>

          <div class="section-title">On-Call Roster</div>
          <div style="display:flex; gap:12px; align-items:center;">
            <button type="button" class="btn" id="add_oncall_btn">Add On-Call Entry</button>
            <button type="button" class="btn" id="test_escalation_btn">Test Alert</button>
            <div class="helper-text" style="margin-left:8px;">Link uploaded calendars to roster entries, or add contacts manually. Alerts here are simulated client-side.</div>
          </div>
          <div id="oncall_roster_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto;"></div>
        </div>

        <div class="form-actions">
          <button type="button" class="save-btn" onclick="saveEscalation()">Save Escalation Settings</button>
        </div>
      </form>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
      <div class="info-box">
        üìä View analytics and questions asked by customers to improve your AI agent.
      </div>

      <div class="section-card">
        <h2 style="margin-top: 0;">Call Analytics</h2>

        <div class="form-row">
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Total Calls</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">1,247</h3>
          </div>
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Resolved by AI</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">78%</h3>
          </div>
        </div>

        <div class="form-row" style="margin-top: 16px;">
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Escalated to Humans</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">22%</h3>
          </div>
          <div style="background: rgba(91, 140, 255, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid var(--brand);">
            <p style="color: var(--muted); margin: 0 0 8px;">Avg. Resolution Time</p>
            <h3 style="margin: 0; color: var(--brand); font-size: 2rem;">2m 34s</h3>
          </div>
        </div>

        <div class="section-title">Top Customer Questions</div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border);">
              <th style="text-align: left; padding: 12px; color: var(--fg); font-weight: 600;">Question</th>
              <th style="text-align: center; padding: 12px; color: var(--fg); font-weight: 600;">Count</th>
              <th style="text-align: center; padding: 12px; color: var(--fg); font-weight: 600;">Resolution Rate</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">How do I reset my password?</td>
              <td style="text-align: center; color: var(--muted);">245</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">95%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">Why is my service down?</td>
              <td style="text-align: center; color: var(--muted);">189</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">78%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">How do I upgrade my plan?</td>
              <td style="text-align: center; color: var(--muted);">156</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">92%</td>
            </tr>
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 12px; color: var(--fg);">What is my current bill?</td>
              <td style="text-align: center; color: var(--muted);">134</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">98%</td>
            </tr>
            <tr>
              <td style="padding: 12px; color: var(--fg);">How do I cancel my service?</td>
              <td style="text-align: center; color: var(--muted);">98</td>
              <td style="text-align: center; color: var(--brand); font-weight: 600;">35%</td>
            </tr>
          </tbody>
        </table>

        <div class="section-title">Export Data</div>

        <div style="display: flex; gap: 12px; margin-top: 16px;">
          <button type="button" class="save-btn" onclick="exportAnalytics('csv')">Export as CSV</button>
          <button type="button" class="save-btn" onclick="exportAnalytics('pdf')">Export as PDF</button>
        </div>

        <div class="section-title">Intent Trends (Custom Range)</div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
          <label style="min-width:80px;">From</label><input type="date" id="intents_from" />
          <label style="min-width:50px;">To</label><input type="date" id="intents_to" />
          <button class="btn" type="button" onclick="loadIntentTrends()">Load</button>
          <button class="btn" type="button" onclick="exportIntentCSV()">Export Intents CSV</button>
        </div>
        <div id="intent_trends_preview" style="margin-top:12px; max-height:180px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>

        <div class="section-title">Storage & Analytics</div>
        <div class="section-card">
          <h3 style="margin-top:0;">Local Storage & Telemetry</h3>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn" type="button" onclick="renderStorageAnalytics()">Refresh Storage View</button>
            <button class="btn" type="button" onclick="exportAllLocalStorage()">Export All Storage</button>
            <button class="btn" type="button" onclick="document.getElementById('import_storage_file').click()">Import Storage JSON</button>
            <input id="import_storage_file" type="file" accept="application/json" style="display:none" onchange="handleImportLocalStorageFile(event)" />
            <label style="display:flex; align-items:center; gap:8px; margin-left:8px;"><input type="checkbox" id="telemetry_opt_in" /> Enable telemetry (anonymized events)</label>
          </div>
          <div class="helper-text" style="margin-top:8px;">Inspect localStorage keys used by this demo and export/import data. Telemetry collects anonymized event counts for UX testing only.</div>
          <div style="margin-top:12px; display:flex; gap:12px;">
            <div style="flex:1; min-width:260px;">
              <strong>Storage Keys</strong>
              <div id="storage_keys_list" style="margin-top:8px; max-height:240px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
            <div style="flex:1; min-width:260px;">
              <strong>Analytics Events</strong>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;"><button class="btn" onclick="generateSampleEvent()">Generate Sample Event</button><button class="btn" onclick="clearAnalyticsEvents()">Clear Events</button></div>
              <div id="analytics_events_list" style="margin-top:8px; max-height:240px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <label style="min-width:160px;">Data retention (days)</label>
            <input id="storage_retention_days" type="number" min="1" value="90" style="width:80px;" />
            <button class="btn" onclick="purgeStorageOlderThan()">Purge Older Data</button>
            <button class="btn" onclick="clearAllDemoStorage()" style="background:#d9534f;">Clear Demo Storage</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TRANSCRIPTS / CONVERSATIONS TAB -->
    <div id="transcripts" class="tab-content">
      <div class="info-box">üóÇÔ∏è Manage conversation transcripts: search, redact preview, selective export, flagging and purge.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:center;">
          <input id="transcript_search" placeholder="Search transcripts or customer name" style="flex:1; padding:8px;" />
          <button class="btn" type="button" onclick="renderConversations()">Search</button>
          <button class="btn" type="button" onclick="exportSelectedConversations()">Export Selected</button>
          <button class="btn" type="button" onclick="purgeAllConversations()" style="background:#d9534f;">Purge All</button>
        </div>
        <div class="helper-text">Select conversations to preview redaction or export. Purge removes locally stored transcripts (demo only).</div>
        <div id="conversations_list" style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-height:300px; overflow:auto;"></div>
      </div>
      <div class="section-card" style="margin-top:12px;">
        <h3 style="margin-top:0;">Redaction Preview</h3>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="min-width:120px;">Mask emails</label><input type="checkbox" id="redact_email" checked />
          <label style="min-width:120px;">Mask phones</label><input type="checkbox" id="redact_phone" checked />
          <label style="min-width:120px;">Mask names</label><input type="checkbox" id="redact_names" />
        </div>
        <div id="redaction_preview" style="margin-top:12px; white-space:pre-wrap; font-family:monospace; border:1px solid var(--border); padding:8px; border-radius:6px; background:var(--panel);"></div>
      </div>
    </div>

    <!-- TELEPHONY & CRM TAB -->
    <div id="telephony" class="tab-content">
      <div class="info-box">üìû Telephony & CRM integration ‚Äî identify callers automatically and surface account info.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Telephony & CRM</h2>
        <div style="margin-bottom:12px;">
          <div class="helper-text">Quick Guide: Connect a CRM lookup URL (use the <code>{{caller}}</code> placeholder), enable screen-pop fields you want agents to see, and set failover behavior for unknown callers.</div>
          <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">
            <strong>Tip:</strong> Keep your CRM auth token secure. For production, prefer server-side token proxying instead of embedding tokens in client-side UIs.
          </div>
        </div>
        <div class="form-group"><label for="crm_lookup_url">CRM Lookup URL</label>
          <input id="crm_lookup_url" placeholder="https://crm.example.com/lookup?phone={{caller}}" />
          <div class="helper-text">URL to call with caller ID; use {{caller}} placeholder. Add auth token below.</div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="crm_auth_token">CRM Auth Token</label><input id="crm_auth_token" placeholder="Bearer xxxxx" /></div>
          <div class="form-group"><label for="crm_match_strategy">Customer Match Strategy</label>
            <select id="crm_match_strategy"><option value="phone">Phone</option><option value="account">Account ID</option><option value="contract">Contract #</option></select></div>
        </div>
        <div class="form-group"><label>Screen-pop fields</label>
          <div class="checkbox-group" style="margin-top:8px;">
            <label class="checkbox-item"><input type="checkbox" id="crm_show_plan" /> Plan</label>
            <label class="checkbox-item"><input type="checkbox" id="crm_show_device" /> Device</label>
            <label class="checkbox-item"><input type="checkbox" id="crm_show_outage" /> Last outage</label>
          </div>
        </div>
        <div class="form-group"><label>Failover behavior (no match)</label>
          <select id="crm_failover"><option value="ask">Ask caller for account</option><option value="create_lead">Create lead</option><option value="proceed_guest">Proceed as guest</option></select>
        </div>
        <div class="form-row" style="margin-top:12px;">
          <div class="form-group"><label><input type="checkbox" id="tele_auto_open_ticket" /> Auto-open ticket on inbound call</label>
            <div class="helper-text">When enabled, incoming calls will create a draft ticket (can be reviewed before submit).</div>
          </div>
          <div class="form-group"><label for="tele_default_queue">Default support queue</label><input id="tele_default_queue" placeholder="e.g., general-support" /></div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="form-group"><label for="tele_caller_risk">Caller risk threshold (%)</label><input id="tele_caller_risk" type="number" min="0" max="100" value="50" /></div>
          <div class="form-group"><label for="tele_phone_hook">Phone webhook (optional)</label><input id="tele_phone_hook" placeholder="https://hook.example.com/inbound" /></div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveTelephony()">Save Telephony Settings</button></div>
    </div>

    <!-- LIVE TRANSCRIPTION / ASR TAB -->
    <div id="transcription" class="tab-content">
      <div class="info-box">üéôÔ∏è Configure real-time transcription, ASR engine choices and privacy rules.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Live Transcription</h2>
        <div style="margin-bottom:12px;">
          <div class="helper-text">Transcription Quick Guide: Choose an ASR engine (cloud or local), select language for best accuracy, and decide whether you need live streaming or batch transcription. Configure diarization to separate speakers and enable PII redaction if you will store transcripts.</div>
          <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">When testing: start with a small audio sample, adjust <strong>Confidence threshold</strong> to control when the system should flag uncertain text, and use <strong>Store transcripts</strong> carefully to balance troubleshooting needs with privacy.</div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="asr_engine">ASR Engine</label>
            <select id="asr_engine"><option value="openai">OpenAI</option><option value="whisper_local">Whisper (local)</option><option value="google_stream">Google Streaming</option></select>
            <div class="helper-text">Select the speech-to-text provider. Cloud services often give higher accuracy; local options keep audio on-premise for privacy.</div>
          </div>
          <div class="form-group"><label for="asr_language">Language</label><input id="asr_language" placeholder="en-US" />
            <div class="helper-text">Set the primary language/dialect used on calls (e.g., <code>en-US</code>, <code>es-ES</code>) to improve recognition.</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label><input type="checkbox" id="asr_streaming" /> Streaming (low-latency)</label>
            <div class="helper-text">Enable for real-time captions or in-call assistance. Streaming may increase cost and complexity.</div>
          </div>
          <div class="form-group"><label for="asr_confidence">Confidence threshold (%)</label><input id="asr_confidence" type="number" min="0" max="100" value="70" />
            <div class="helper-text">Set the minimum confidence below which the system should flag text as uncertain (useful for auto-escalation rules).</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label><input type="checkbox" id="asr_diarization" /> Diarization (caller/agent)</label>
            <div class="helper-text">When enabled, transcripts label which speaker said each line ‚Äî useful for agent coaching and accurate ticket notes.</div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="asr_profanity_filter" /> Profanity filter</label>
            <div class="helper-text">Mask or remove profanity from stored transcripts and public views.</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="transcript_retention">Store transcripts (days)</label><input id="transcript_retention" type="number" min="0" value="30" />
            <div class="helper-text">Set retention to meet your privacy policy ‚Äî 0 = do not store transcripts.</div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="transcript_pii_redact" /> Redact PII on store</label>
            <div class="helper-text">Remove or mask names, emails, and phone numbers when saving to reduce privacy risk (may remove troubleshooting details).</div>
          </div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveTranscription()">Save Transcription Settings</button></div>
    </div>

    <!-- DIAGNOSTICS & TOOLS TAB -->
    <div id="diagnostics" class="tab-content">
      <div class="info-box">üõ†Ô∏è Configure remote diagnostic tools and safety limits for automatic actions.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Diagnostics & Tools</h2>
        <div class="helper-text">Diagnostics Quick Guide: Add small HTTP/SSH tool definitions that the agent can call to run checks (ping, reboot, gather logs). Keep endpoints secure and set conservative timeouts/limits for automatic runs.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Tip: For remote operations that change device state (reboot, firmware push), set the action confirmation to <strong>Required</strong> in Capabilities and enable audit logging.</div>
        <div id="tools_list" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <div style="flex:1;">
            <button class="btn" type="button" onclick="addToolEditor()">Add Tool</button>
            <button class="btn" type="button" onclick="importTools()">Import Tools (JSON)</button>
          </div>
          <div style="min-width:320px; color:var(--muted); font-size:0.95rem;">Each tool may have a URL, method (GET/POST), timeout and a safety limit. Test tools in a staging environment before enabling production runs.</div>
        </div>
      </div>
      <div class="form-actions"><button type="button" class="save-btn" onclick="saveDiagnostics()">Save Diagnostics Settings</button></div>
    </div>

    <!-- PLAYBOOKS TAB -->
    <div id="playbooks" class="tab-content">
      <div class="info-box">üìö Incident playbooks (runbooks) for common telecom/IT problems.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Playbooks Library</h2>
        <div class="helper-text">Playbooks (runbooks) are step-by-step procedures your agent can run when specific conditions are met ‚Äî for example: "If outage_detected ‚Üí run diagnostics ‚Üí notify NOC ‚Üí open ticket".</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Quick Guide: Keep playbooks short and explicit. Each playbook should include: a clear trigger condition, a defined set of automated steps, and an escalation step to a human or on-call if automated resolution fails.</div>
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <div>
            <button class="btn" onclick="addPlaybook()">Add Playbook</button>
            <button class="btn" onclick="importPlaybooks()">Import Runbooks</button>
          </div>
          <div style="margin-left:12px; color:var(--muted); font-size:0.95rem;">Tip: Test playbooks in staging and add logging steps so actions are auditable. Mark destructive steps (reboots, config changes) to require human confirmation.</div>
        </div>
        <div id="playbooks_list" style="margin-top:12px; max-height:220px; overflow:auto;">
          <div class="card" style="padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--panel);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div>
                <strong>Example: NOC Outage Runbook</strong>
                <div style="color:var(--muted); font-size:0.95rem; margin-top:6px;">Trigger: <code>outage_detected</code></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn" type="button" onclick="(window.clonePlaybook||(()=>alert('Clone not implemented')))('noc_outage')">Clone</button>
                <button class="btn" type="button" onclick="(window.testPlaybook||(()=>alert('Test not implemented')))('noc_outage')">Test</button>
              </div>
            </div>
            <ol style="margin-top:10px; padding-left:20px;">
              <li>Run ping and speed tests to verify connectivity.</li>
              <li>If tests show widespread failure, notify NOC team and open a ticket using the configured ticketing provider.</li>
              <li>Attempt a remote device reboot only if safe; this step is flagged to require human confirmation.</li>
            </ol>
            <div style="margin-top:8px;" class="helper-text">This safe example shows a read-only diagnostic sequence; destructive steps are explicitly marked and should require confirmation before running.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NETWORK STATUS TAB -->
    <div id="network" class="tab-content">
      <div class="info-box">üì° Network status integration and outage mode controls.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Network Status</h2>
        <div class="helper-text">Network Quick Guide: Connect a status API to let the system detect outages automatically. Use the auto-detect toggle to enable automated outage mode and configure a clear broadcast message template for announcements.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Tip: Prefer a read-only status API endpoint and test detection rules in staging before enabling automatic outage mode.</div>
        <div class="form-group" style="margin-top:10px;"><label for="status_api">Status API URL (read-only)</label><input id="status_api" placeholder="https://status.example.com/api" />
          <div class="helper-text">Endpoint that returns system/service health (e.g., JSON with component states). The panel treats this as read-only ‚Äî prefer a server-side proxy in production.</div>
        </div>
        <div class="form-group"><label><input type="checkbox" id="auto_outage_detect" /> Auto-detect widespread outage</label>
          <div class="helper-text">When enabled, the system will enter outage mode based on the status API or configured rules and apply outage-related behavior (e.g., different reply templates, routing to NOC).</div>
        </div>
        <div class="form-group"><label for="outage_broadcast">Outage broadcast script</label><textarea id="outage_broadcast" placeholder="Broadcast message template"></textarea>
          <div class="helper-text">A short message template used for broadcasts (calls, IVR messages, or SMS). Include placeholders like <code>{{service}}</code> and <code>{{eta}}</code> for dynamic content.</div>
        </div>
      </div>
    </div>

    <!-- TICKETING & SLA TAB -->
    <div id="ticketing" class="tab-content">
      <div class="info-box">üé´ Configure ticketing integration, auto-create rules and SLA targets.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Ticketing & SLA</h2>
        <div class="helper-text">Ticketing Quick Guide: Connect your ticketing provider to create and route tickets automatically. Define clear auto-create rules and reasonable SLA targets so the system knows when to escalate to humans.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Tip: Start with conservative auto-create rules (e.g., low confidence OR outage_detected) and tune after observing false positives.</div>
        <div class="form-row" style="margin-top:10px;"><div class="form-group"><label for="ticketing_provider">Provider</label>
            <select id="ticketing_provider"><option value="zendesk">Zendesk</option><option value="jira">JIRA</option><option value="servicenow">ServiceNow</option><option value="none">None</option></select>
            <div class="helper-text">Choose the ticketing system to integrate with. For production, configure API credentials in a secure server-side store.</div>
          </div>
          <div class="form-group" style="flex:1;"><label for="ticket_create_rule">Auto-create rule</label>
            <input id="ticket_create_rule" placeholder="when: confidence &lt; 50% OR outage_detected" />
            <div class="helper-text">A simple rule language: use conditions like <code>confidence &lt; 50%</code> or <code>outage_detected</code> to trigger ticket creation automatically.</div>

            <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <select id="rb_condition" style="min-width:180px;">
                <option value="outage_detected">outage_detected</option>
                <option value="confidence">confidence</option>
                <option value="satisfaction">satisfaction</option>
                <option value="high_priority_account">high_priority_account</option>
                <option value="customer_tier">customer_tier</option>
                <option value="failed_checks">failed_checks</option>
              </select>
              <select id="rb_operator" style="width:80px;">
                <option value="=">=</option>
                <option value=">">&gt;</option>
                <option value="<">&lt;</option>
                <option value="contains">contains</option>
              </select>
              <input id="rb_value" placeholder="value (optional)" style="min-width:120px; padding:8px;" />
              <button class="btn" type="button" onclick="addRuleCondition()">Add Condition</button>
              <button class="btn" type="button" onclick="insertRuleTemplate()">Insert Example Template</button>
            </div>
          </div></div>
        <div class="form-row" style="margin-top:8px;"><div class="form-group"><label for="sla_response">SLA: Response (min)</label><input id="sla_response" type="number" min="0" value="30" />
            <div class="helper-text">Maximum time to first response (in minutes) to meet your SLA commitments.</div>
          </div>
          <div class="form-group"><label for="sla_resolution">SLA: Resolution (hours)</label><input id="sla_resolution" type="number" min="0" value="4" />
            <div class="helper-text">Target time to resolve issues (in hours). Use realistic targets to avoid over-promising.</div>
          </div></div>
      </div>
    </div>

    <!-- STORAGE & INSIGHTS TAB -->
    <div id="storage" class="tab-content">
      <div class="info-box">üíæ Storage and insights: choose what to keep and for how long.</div>
      <div class="section-card">
        <h2 style="margin-top:0;">Storage & Insights</h2>
        <div class="helper-text">Storage Quick Guide: Decide what transcripts, insights and question summaries you need to keep for reporting and training. Keep retention short for privacy-sensitive data and longer for analytics where allowed.</div>
        <div style="margin-top:8px; color:var(--muted); font-size:0.95rem;">Tip: Use short retention for PII-containing items and export summaries for long-term analytics instead of raw transcripts.</div>
        <div class="form-group" style="margin-top:12px;"><label><input type="checkbox" id="store_top_questions" /> Store top questions</label>
          <div class="helper-text">Enable to collect and persist the most common user questions for training and FAQ generation.</div>
        </div>
        <div class="form-group"><label for="insights_retention">Insights retention (days)</label><input id="insights_retention" type="number" min="0" value="30" />
          <div class="helper-text">How many days to keep aggregated insights and trend data. Shorter retention reduces privacy risk and storage cost.</div>
        </div>
        <div style="margin-top:8px; display:flex; gap:12px; align-items:center;"><button class="btn" onclick="exportInsightsCSV()">Export insights (CSV)</button>
          <div style="color:var(--muted); font-size:0.95rem;">Export current analytic summaries for offline review or to import into BI tools.</div>
        </div>
      </div>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="payments" class="tab-content dev-only">
      <div class="info-box">üí≥ Configure payment provider, deposit capture, and view refunds/logs.</div>
      <form id="paymentsForm">
        <div class="section-card">
          <h2 style="margin-top:0;">Payment Provider</h2>
          <div class="form-row">
            <div class="form-group"><label for="payment_provider">Provider</label>
              <select id="payment_provider" name="payments.provider"><option value="stripe">Stripe</option><option value="paypal">PayPal</option><option value="none">None</option></select></div>
            <div class="form-group"><label for="payment_mode">Mode</label>
              <select id="payment_mode" name="payments.mode"><option value="test">Test</option><option value="live">Live</option></select></div>
          </div>
          <div class="form-group"><label for="payment_api_key">API Key / Client ID</label><input id="payment_api_key" name="payments.api_key" placeholder="sk_test_..." /></div>
          <div class="section-title">Payment Manager (PSP)</div>
          <div class="helper-text">Connect to your local Payment Manager or PSP to handle mandates, payouts and jurisdictional compliance. This is a front-end demo; production requires secure server-side integration.</div>
          <div class="form-row">
            <div class="form-group"><label for="payment_manager">Manager</label>
              <select id="payment_manager" name="payments.manager"><option value="none">None</option><option value="stripe">Stripe</option><option value="paypal">PayPal</option><option value="mangopay">MangoPay</option><option value="hipay">HiPay</option></select></div>
            <div class="form-group"><label for="payment_manager_merchant">Merchant / Client ID</label><input id="payment_manager_merchant" name="payments.manager_merchant" placeholder="merchant_..." /></div>
          </div>
          <div class="form-group"><label for="payment_manager_secret">Secret / API Key</label><input id="payment_manager_secret" name="payments.manager_secret" placeholder="(store securely; local demo only)" /></div>
          <div style="display:flex; gap:8px; align-items:center;"><button class="btn" type="button" onclick="connectPaymentManager()">Connect Payment Manager</button><button class="btn" type="button" onclick="disconnectPaymentManager()">Disconnect</button><div id="payment_manager_status" style="color:var(--muted); margin-left:8px;">Not connected</div></div>

          <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
            <h3 style="margin:0 0 6px;">Invoice Platform (Compliance)</h3>
            <div class="helper-text">Optionally register a certified invoice platform here. This front-end demo stores connection details locally; in production this must be done via secure server-side integration and OAuth.</div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <select id="invoice_platform_select_pay" style="min-width:220px">
                <option value="none">None</option>
                <option value="chorus_pro">Chorus Pro</option>
                <option value="sage">Sage</option>
                <option value="dgi">DGI / Local Platform</option>
                <option value="custom">Other (Custom)</option>
              </select>
              <input id="invoice_platform_merchant_pay" placeholder="Merchant / Account ID" style="padding:8px;" />
              <input id="invoice_platform_api_pay" placeholder="API Key / Token" style="padding:8px;" />
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
              <button class="btn" type="button" onclick="connectInvoicePlatform(true)">Register Platform (demo)</button>
              <button class="btn" type="button" onclick="disconnectInvoicePlatform()">Disconnect</button>
              <div id="invoice_platform_status_pay" style="color:var(--muted); margin-left:8px;">Not registered</div>
            </div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="deposit_capture" name="payments.deposit_capture" /> Capture deposit on booking/quote</label></div>
          <div class="form-row"><div class="form-group"><label for="deposit_amount_default">Default deposit amount</label><input id="deposit_amount_default" name="payments.deposit_default" type="number" min="0" value="0"/></div>
            <div class="form-group"><label for="refunds_log_link">Refunds log (demo)</label><input id="refunds_log_link" name="payments.refunds_log" placeholder="(link or notes)" /></div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="save-btn" onclick="savePaymentSettings()">Save Payments</button>
          <button type="button" class="btn" onclick="testPaymentConnector()">Test Payment (Demo)</button>
          <button type="button" class="btn" onclick="exportPaymentConfig()">Export Payments (JSON)</button>
        </div>
      </form>
    </div>

    <!-- BACKUPS / VERSIONING TAB -->
    <div id="backups" class="tab-content dev-only">
      <div class="info-box">üíæ Versioned exports and restores. Create backups, schedule a demo backup, compare and restore versions.</div>
      <div class="section-card">
        <div style="display:flex; gap:12px; align-items:center;">
          <button class="save-btn" type="button" onclick="createBackup()">Create Backup Now</button>
          <button class="btn" type="button" onclick="downloadLatestBackup()">Download Latest</button>
          <button class="btn" type="button" onclick="scheduleDemoBackup()">Schedule Demo Backup</button>
        </div>
        <div class="helper-text">Backups are stored in `localStorage` under `backups` for demo purposes. Use scheduled backups only for local demos.</div>
        <div style="margin-top:12px; max-height:240px; overflow:auto;" id="backups_list"></div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
          <img src="logo.jpg" alt="NovaVoice" style="width: 36px; height: 36px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.4)) brightness(1.2) contrast(1.1); mix-blend-mode: screen;">
          <h4 style="margin: 0;">NovaVoice</h4>
        </div>
        <p>Intelligent conversations. Instant help. Always available.</p>
      </div>
      <div>
        <h4>Product</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="record.html">Try Demo</a></li>
          <li><a href="panel.html">Configuration</a></li>
        </ul>
      </div>
      <div>
        <h4>Contact</h4>
        <ul>
          <li><a href="mailto:contact@novavoice.ai">contact@novavoice.ai</a></li>
          <li><a href="#">Support</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
      </div>
    </div>
    <div class="container footer-bottom">
      <small>¬© <span id="year"></span> NovaVoice. All rights reserved.</small>
    </div>
  </footer>

  <script>
    // Tab switching (defensive) with debug logging
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        console.log('Tab clicked:', tabName);
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const target = document.getElementById(tabName);
        if (!target) {
          console.warn('Tab target not found:', tabName);
          return;
        }
        console.log('Activating target element:', target, 'height=', target.clientHeight);
        target.classList.add('active');
        btn.classList.add('active');
      });
    });

    // hydrate telephony settings into fields
    try {
      const tele = JSON.parse(localStorage.getItem('telephony_settings') || '{}');
      if (tele) {
        if (document.getElementById('crm_lookup_url')) document.getElementById('crm_lookup_url').value = tele.crm_lookup_url || '';
        if (document.getElementById('crm_auth_token')) document.getElementById('crm_auth_token').value = tele.crm_auth_token || '';
    function testPaymentConnector(){
      const prov = document.getElementById('payment_provider')?.value || 'none';
      const mode = document.getElementById('payment_mode')?.value || 'test';
      const key = document.getElementById('payment_api_key')?.value || '';
      if(prov==='none') return alert('No payment provider selected');
      if(!key) return alert('API key / client id is not set ‚Äî add it before testing (demo)');
      // Demo: simulate a small charge attempt
      setTimeout(()=>{
        alert(`‚úì Test ${prov} connection successful (mode=${mode}). Demo charge $1.00 would be authorized.`);
      }, 600);
    }
    function exportPaymentConfig(){
      const obj = { provider: document.getElementById('payment_provider')?.value || '', mode: document.getElementById('payment_mode')?.value || '', api_key: document.getElementById('payment_api_key')?.value || '', deposit_capture: !!document.getElementById('deposit_capture')?.checked, deposit_default: Number(document.getElementById('deposit_amount_default')?.value || 0) };
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payments-config.json'; document.body.appendChild(a); a.click(); a.remove();
    }

    // Payment Manager connect/disconnect (demo-only)
    function connectPaymentManager(){
      const mgr = document.getElementById('payment_manager')?.value || 'none';
      const merchant = document.getElementById('payment_manager_merchant')?.value || '';
      const secret = document.getElementById('payment_manager_secret')?.value || '';
      if(mgr==='none') return alert('Select a payment manager');
      if(!merchant || !secret) return alert('Provide merchant/client id and secret for demo connect');
      // simulate OAuth flow and persist an entry in localStorage
      const token = 'pm-'+Date.now();
      localStorage.setItem('payment_manager_connected', JSON.stringify({manager: mgr, merchant, token, connected_at: new Date().toISOString()}));
      renderPaymentManagerStatus();
      alert('Connected to ' + mgr + ' (demo)');
    }

    function disconnectPaymentManager(){ if(!confirm('Disconnect payment manager?')) return; localStorage.removeItem('payment_manager_connected'); renderPaymentManagerStatus(); alert('Disconnected (demo)'); }

    function renderPaymentManagerStatus(){ const s = localStorage.getItem('payment_manager_connected'); const el = document.getElementById('payment_manager_status'); if(!el) return; if(!s){ el.textContent = 'Not connected'; el.style.color = 'var(--muted)'; } else { try{ const obj = JSON.parse(s); el.textContent = `Connected: ${obj.manager} (${new Date(obj.connected_at).toLocaleString()})`; el.style.color = 'var(--brand)'; }catch(e){ el.textContent = 'Connected'; } } }

    // ensure payment manager status is rendered on load
    renderPaymentManagerStatus();
    
    // Invoice Platform connect/disconnect (front-end demo)
    function connectInvoicePlatform(fromPayments){
      const select = (fromPayments ? document.getElementById('invoice_platform_select_pay') : document.getElementById('invoice_platform_select'));
      const merchant = (fromPayments ? document.getElementById('invoice_platform_merchant_pay') : document.getElementById('invoice_platform_merchant'))?.value || '';
      const api = (fromPayments ? document.getElementById('invoice_platform_api_pay') : document.getElementById('invoice_platform_api'))?.value || '';
      if(!select) return alert('Invoice platform selector not found');
      const platform = select.value || 'none';
      if(platform==='none') return alert('Select an invoice platform to register');
      if(!merchant || !api) return alert('Provide merchant/account id and api token for demo registration');
      const cfg = { platform, merchant, api, registered_at: new Date().toISOString() };
      localStorage.setItem('invoice_platform_config', JSON.stringify(cfg));
      renderInvoicePlatformStatus();
      alert('Invoice platform registered (demo): ' + platform);
    }

    function disconnectInvoicePlatform(){ if(!confirm('Disconnect invoice platform?')) return; localStorage.removeItem('invoice_platform_config'); renderInvoicePlatformStatus(); alert('Invoice platform disconnected'); }

    function renderInvoicePlatformStatus(){ const raw = localStorage.getItem('invoice_platform_config'); const s = raw ? JSON.parse(raw) : null; const el = document.getElementById('invoice_platform_status'); const el2 = document.getElementById('invoice_platform_status_pay'); if(el) el.textContent = s ? `Registered: ${s.platform} (${new Date(s.registered_at).toLocaleString()})` : 'Not registered'; if(el2) el2.textContent = s ? `Registered: ${s.platform} (${new Date(s.registered_at).toLocaleString()})` : 'Not registered'; if(el) el.style.color = s ? 'var(--brand)' : 'var(--muted)'; if(el2) el2.style.color = s ? 'var(--brand)' : 'var(--muted)'; }

    // render invoice platform status at load
    renderInvoicePlatformStatus();
        if (document.getElementById('crm_match_strategy')) document.getElementById('crm_match_strategy').value = tele.crm_match_strategy || 'phone';
        if (document.getElementById('crm_show_plan')) document.getElementById('crm_show_plan').checked = !!tele.crm_show_plan;
        if (document.getElementById('crm_show_device')) document.getElementById('crm_show_device').checked = !!tele.crm_show_device;
        if (document.getElementById('crm_show_outage')) document.getElementById('crm_show_outage').checked = !!tele.crm_show_outage;
        if (document.getElementById('crm_failover')) document.getElementById('crm_failover').value = tele.crm_failover || 'ask';
        if (document.getElementById('tele_auto_open_ticket')) document.getElementById('tele_auto_open_ticket').checked = !!tele.tele_auto_open_ticket;
        if (document.getElementById('tele_default_queue')) document.getElementById('tele_default_queue').value = tele.tele_default_queue || '';
        if (document.getElementById('tele_caller_risk')) document.getElementById('tele_caller_risk').value = tele.tele_caller_risk || 50;
        if (document.getElementById('tele_phone_hook')) document.getElementById('tele_phone_hook').value = tele.tele_phone_hook || '';
      }
    } catch (e) { console.warn('Failed to hydrate telephony_settings', e); }


    // Slider value updates
    document.getElementById('escalationTimeout').addEventListener('input', (e) => {
      document.getElementById('escalationTimeoutVal').textContent = e.target.value;
    });
    document.getElementById('satisfactionThreshold').addEventListener('input', (e) => {
      document.getElementById('satisfactionThresholdVal').textContent = e.target.value;
    });

    // Save functions (demo purposes)
    function savePersonality() {
      alert('‚úì Personality settings saved successfully!');
    }

    // Capabilities: Telecom & IT focused actions list with conservative defaults
    // Notes for business owners:
    //  - Conditions are lightweight tags used to suggest when extra caution is warranted.
    //  - "high_priority_account": accounts flagged by your CRM as VIP/priority (billing or SLA importance).
    //  - Confidence/uncertainty is handled globally by the "Auto-escalate if unsure" slider ‚Äî no need for a separate "low_confidence" tag here.
    const CAPABILITY_ACTIONS = [
      { id: 'account_lookup', label: 'Account Lookup (CRM)', defaultLevel: 'no_need', conditions:[], category:'Accounts & Identity' },
      { id: 'caller_identification', label: 'Caller Identification / Screen-pop', defaultLevel: 'no_need', conditions:[], category:'Accounts & Identity' },
      { id: 'password_reset', label: 'Password / PIN Reset', defaultLevel: 'may_require', conditions:['new_device','unusual_location','high_priority_account'], category:'Accounts & Identity' },
      { id: 'sensitive_info_display', label: 'Show Sensitive Account Info (PII)', defaultLevel: 'may_require', conditions:['high_priority_account'], category:'Accounts & Identity' },

      { id: 'ping_test', label: 'Ping / Connectivity Test', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'speed_test', label: 'Speed Test', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'trace_route', label: 'Traceroute / Route Analysis', defaultLevel: 'no_need', conditions:[], category:'Diagnostics & Network' },
      { id: 'run_noc_playbook', label: 'Run NOC Playbook (automated checks)', defaultLevel: 'may_require', conditions:['outage_detected'], category:'Diagnostics & Network' },

      { id: 'device_reboot', label: 'Remote Device Reboot', defaultLevel: 'may_require', conditions:['after_hours','high_priority_account'], category:'Remote Device Management' },
      { id: 'firmware_update', label: 'Push Firmware Update', defaultLevel: 'required', conditions:['field_dispatch_required','monetary_impact'], category:'Remote Device Management' },
      { id: 'provision_device', label: 'Provision / Reprovision Device', defaultLevel: 'may_require', conditions:['customer_request','high_priority_account'], category:'Provisioning & Orders' },

      { id: 'create_ticket', label: 'Auto-create Support Ticket', defaultLevel: 'no_need', conditions:['outage_detected'], category:'Ticketing & Escalation' },
      { id: 'assign_priority', label: 'Auto-assign Ticket Priority', defaultLevel: 'may_require', conditions:['outage_detected','high_priority_account'], category:'Ticketing & Escalation' },
      { id: 'close_ticket', label: 'Auto-close Ticket (resolved)', defaultLevel: 'may_require', conditions:[], category:'Ticketing & Escalation' },

      { id: 'issue_refund', label: 'Issue Refund / Credit', defaultLevel: 'required', conditions:['monetary_impact','high_priority_account'], category:'Billing & Payments' },
      { id: 'adjust_invoice', label: 'Adjust Billing / Invoice', defaultLevel: 'required', conditions:['monetary_impact','legal_identity_change'], category:'Billing & Payments' },

      { id: 'schedule_field_visit', label: 'Schedule Field Technician', defaultLevel: 'may_require', conditions:['field_dispatch_required','after_hours'], category:'Field Operations & Dispatch' },
      { id: 'dispatch_urgent', label: 'Dispatch Urgent Field Team', defaultLevel: 'required', conditions:['outage_detected','high_priority_account'], category:'Field Operations & Dispatch' },

      { id: 'change_service_plan', label: 'Change Service Plan / Upgrade', defaultLevel: 'required', conditions:['monetary_impact','customer_request'], category:'Configuration & Service Control' },
      { id: 'enable_feature', label: 'Enable/Disable Service Feature', defaultLevel: 'may_require', conditions:['customer_request'], category:'Configuration & Service Control' },

      { id: 'add_user', label: 'Create / Add User Account', defaultLevel: 'may_require', conditions:['new_device','legal_identity_change'], category:'Admin & Security' },
      { id: 'revoke_access', label: 'Revoke Access / Disable Account', defaultLevel: 'required', conditions:['security_incident'], category:'Admin & Security' },

      { id: 'outbound_sms', label: 'Send Outbound SMS / Notifications', defaultLevel: 'no_need', conditions:['after_hours'], category:'Customer Communications' },
      { id: 'send_confirmation_email', label: 'Send Confirmation Email', defaultLevel: 'no_need', conditions:[], category:'Customer Communications' }
      ,
      // Freelancer / Web Developer focused actions (organized)
      // Category: Deployment & Release
      { id: 'deploy_production', label: 'Deploy to Production', defaultLevel: 'required', conditions:['staging_passed','client_approval','production_environment'], category:'Deployment & Release' },
      { id: 'run_db_migration', label: 'Run Database Migration', defaultLevel: 'required', conditions:['staging_passed','backup_taken','client_approval'], category:'Deployment & Release' },
      { id: 'rollback_deploy', label: 'Rollback Production Deploy', defaultLevel: 'required', conditions:['production_issue','high_priority_client'], category:'Deployment & Release' },
      { id: 'restart_server', label: 'Restart Application / Server', defaultLevel: 'may_require', conditions:['after_hours','production_environment'], category:'Deployment & Release' },
      { id: 'run_tests_and_deploy', label: 'Run Tests & Deploy (CI)', defaultLevel: 'may_require', conditions:['staging_passed'], category:'Deployment & Release' },

      // Category: DNS & Domains
      { id: 'modify_dns', label: 'Modify DNS Records', defaultLevel: 'required', conditions:['domain_verification','client_approval'], category:'DNS & Domains' },
      { id: 'install_ssl', label: 'Install / Renew SSL Certificate', defaultLevel: 'may_require', conditions:['domain_verification'], category:'DNS & Domains' },

      // Category: Access & Security
      { id: 'grant_repo_access', label: 'Grant Repo / SSH Access', defaultLevel: 'required', conditions:['identity_verification','client_approval'], category:'Access & Security' },
      { id: 'revoke_repo_access', label: 'Revoke Repo / SSH Access', defaultLevel: 'required', conditions:['security_incident'], category:'Access & Security' },
      { id: 'share_remote_link', label: 'Share Remote Access Link', defaultLevel: 'may_require', conditions:['client_approval','security_incident'], category:'Access & Security' },

      // Category: Provisioning & Hosting
      { id: 'provision_instance', label: 'Provision Hosting / VM', defaultLevel: 'may_require', conditions:['payment_verified','client_approval'], category:'Provisioning & Hosting' },
      { id: 'decommission_instance', label: 'Decommission Hosting / VM', defaultLevel: 'required', conditions:['client_approval','backup_taken'], category:'Provisioning & Hosting' },

      // Category: Backups & Data
      { id: 'take_backup', label: 'Take Backup / Snapshot', defaultLevel: 'no_need', conditions:['production_environment'], category:'Backups & Data' },
      { id: 'run_data_export', label: 'Run Data Export', defaultLevel: 'may_require', conditions:['contract_signed','payment_verified'], category:'Backups & Data' },

      // Category: Billing & Contracts (freelancer-focused)
      { id: 'create_invoice', label: 'Create / Send Invoice', defaultLevel: 'may_require', conditions:['payment_verified'], category:'Billing & Contracts' },
      { id: 'issue_refund_freelancer', label: 'Issue Refund (Freelancer)', defaultLevel: 'required', conditions:['monetary_impact','client_approval'], category:'Billing & Contracts' },
      { id: 'update_contract', label: 'Create / Update Client Contract', defaultLevel: 'required', conditions:['client_approval','legal_identity_change'], category:'Billing & Contracts' },

      // Category: Client Communication & Scheduling
      { id: 'schedule_meeting', label: 'Schedule Client Meeting', defaultLevel: 'no_need', conditions:[], category:'Client Communication' },
      { id: 'send_progress_report', label: 'Send Progress Report / Status', defaultLevel: 'no_need', conditions:[], category:'Client Communication' }
    ];

    // Small initializer: populate whitelist options, hydrate saved per-action levels, and trigger renderer
    function initCapabilitiesHelpers() {
      const whitelist = document.getElementById('actions_whitelist');
      if (whitelist) {
        whitelist.innerHTML = '';
        CAPABILITY_ACTIONS.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.label;
          whitelist.appendChild(opt);
        });
      }

      // hydrate previously saved per-action levels from localStorage
      try {
        const saved = JSON.parse(localStorage.getItem('capabilities_settings') || '{}');
        if (saved && saved.actions) {
          CAPABILITY_ACTIONS.forEach(a => {
            if (saved.actions[a.id] && saved.actions[a.id].level) {
              a.defaultLevel = saved.actions[a.id].level;
            }
          });
        }
      } catch (e) {
        console.warn('Failed to parse capabilities_settings', e);
      }

      if (typeof renderCapabilitiesActions === 'function') {
        try { renderCapabilitiesActions(); } catch (e) { console.warn('renderCapabilitiesActions failed', e); }
      }
    }

    document.addEventListener('DOMContentLoaded', initCapabilitiesHelpers);

    document.addEventListener('DOMContentLoaded', function(){
      // initialize storage analytics UI
      try{ renderStorageAnalytics(); }catch(e){}
      const tb = document.getElementById('telemetry_opt_in'); if(tb){ tb.addEventListener('change', function(){ const s = loadStorageAnalyticsSettings(); s.telemetry_opt_in = !!tb.checked; saveStorageAnalyticsSettings(s); }); }
      try{ renderOncallRoster(); }catch(e){}
      // wire buttons in Escalation tab
      const addBtn = document.getElementById('add_oncall_btn'); if(addBtn) addBtn.addEventListener('click', addOncallEntry);
      const testBtn = document.getElementById('test_escalation_btn'); if(testBtn) testBtn.addEventListener('click', testEscalationAlert);
      try{ loadEscalationSettings(); }catch(e){}
    });

    function renderCapabilitiesActions() {
      const container = document.getElementById('capabilities_actions_list');
      if (!container) return;
      const saved = loadCapabilities();
      container.innerHTML = '';

      // group actions by category
      const categories = {};
      CAPABILITY_ACTIONS.forEach(a => {
        const cat = a.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(a);
      });

      // helper to create a category accordion
      Object.keys(categories).forEach(catName => {
        const catWrap = document.createElement('div');
        catWrap.className = 'cap-category';
        catWrap.style.marginBottom = '12px';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'cap-category-header';
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.style.width = '100%';
        header.style.padding = '10px 12px';
        header.style.border = '1px solid var(--border)';
        header.style.borderRadius = '8px';
        header.style.background = 'var(--card)';
        header.style.cursor = 'pointer';
        header.innerHTML = `<strong style="text-align:left">${catName}</strong><span class="muted">${categories[catName].length} items</span>`;

        const content = document.createElement('div');
        content.className = 'cap-category-content';
        content.style.display = 'none';
        content.style.marginTop = '8px';

        header.addEventListener('click', () => {
          const open = content.style.display === 'block';
          content.style.display = open ? 'none' : 'block';
          header.classList.toggle('open', !open);
        });

        // render actions inside this category
        categories[catName].forEach(act => {
          const rowWrap = document.createElement('div');
          rowWrap.style.display = 'flex';
          rowWrap.style.flexDirection = 'column';
          rowWrap.style.gap = '8px';
          rowWrap.style.padding = '8px 0';
          rowWrap.style.borderBottom = '1px dashed rgba(0,0,0,0.03)';

          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '12px';

          const label = document.createElement('div');
          label.style.flex = '1';
          label.textContent = act.label;

          const select = document.createElement('select');
          select.style.minWidth = '220px';
          select.dataset.actionId = act.id;
          select.id = `cap_${act.id}`;
          const opts = [
            {v:'no_need', t:'No confirmation needed'},
            {v:'may_require', t:'May require confirmation'},
            {v:'required', t:'Always require confirmation'}
          ];
          opts.forEach(o=>{ const option=document.createElement('option'); option.value=o.v; option.textContent=o.t; select.appendChild(option); });
          let sv = 'no_need';
          if (saved && saved.actions && saved.actions[act.id]) {
            const asv = saved.actions[act.id];
            if (typeof asv === 'string') sv = asv;
            else if (asv && typeof asv === 'object' && asv.level) sv = asv.level;
            else sv = asv;
          } else {
            sv = act.defaultLevel || 'no_need';
          }
          select.value = sv;

          row.appendChild(label);
          row.appendChild(select);

          // condition area (hidden by default) - keep data attrs used by save
          const condArea = document.createElement('div');
          condArea.className = 'cond-area';
          condArea.dataset.actionId = act.id;
          condArea.style.display = (select.value === 'may_require') ? 'block' : 'none';
          condArea.style.padding = '8px 12px';
          condArea.style.border = '1px dashed var(--border)';
          condArea.style.borderRadius = '8px';
          condArea.style.background = 'rgba(0,0,0,0.01)';

          function renderConditions() {
            condArea.innerHTML = '';
            const savedForAction = (saved && saved.conditions && saved.conditions[act.id]) ? saved.conditions[act.id] : {};
            act.conditions && act.conditions.forEach(cond => {
              const ctrl = renderConditionControl(cond, savedForAction[cond], act.id);
              if (ctrl) condArea.appendChild(ctrl);
            });
          }
          renderConditions();

          // show/hide conditions when selection changes; also open category when may_require
          select.addEventListener('change', ()=>{
            condArea.style.display = (select.value === 'may_require') ? 'block' : 'none';
            if (select.value === 'may_require') {
              content.style.display = 'block';
              header.classList.add('open');
            }
          });

          rowWrap.appendChild(row);
          rowWrap.appendChild(condArea);
          content.appendChild(rowWrap);
        });

        catWrap.appendChild(header);
        catWrap.appendChild(content);
        container.appendChild(catWrap);
      });

      // wire bulk apply to set values and also open/close categories as needed
      const bulkBtn = document.getElementById('bulkApplyBtn');
      const bulkSel = document.getElementById('bulkSetLevel');
      if (bulkBtn && bulkSel) {
        bulkBtn.onclick = () => {
          const v = bulkSel.value;
          if (!v) return alert('Select a level to apply');
          // set all selects and dispatch change so condition areas update
          container.querySelectorAll('select').forEach(s => {
            s.value = v;
            s.dispatchEvent(new Event('change', { bubbles: true }));
          });

          // open categories that contain any 'may_require' selections, close others
          container.querySelectorAll('.cap-category').forEach(cat => {
            const content = cat.querySelector('.cap-category-content');
            const hasMay = Array.from(cat.querySelectorAll('select')).some(s => s.value === 'may_require');
            if (hasMay) { content.style.display = 'block'; cat.querySelector('.cap-category-header').classList.add('open'); }
            else { content.style.display = 'none'; cat.querySelector('.cap-category-header').classList.remove('open'); }
          });
        };
      }

      // hydrate escalation sliders if present
      if (saved && saved.escalation) {
        const t = document.getElementById('escalationTimeout');
        const s = document.getElementById('satisfactionThreshold');
        if (t) { t.value = saved.escalation.timeout || t.value; document.getElementById('escalationTimeoutVal').textContent = t.value; }
        if (s) { s.value = saved.escalation.satisfaction || s.value; document.getElementById('satisfactionThresholdVal').textContent = s.value; }
        // load new escalation fields: on-call calendar, skill queues, SLA targets
        const oncall = document.getElementById('oncall_calendar');
        if (oncall && saved.escalation.oncall_calendar) oncall.value = saved.escalation.oncall_calendar;
        const skills = document.getElementById('skill_queues');
        if (skills && Array.isArray(saved.escalation.skill_queues)) skills.value = saved.escalation.skill_queues.join(',');
        // SLA targets
        if (saved.escalation.sla) {
          const s1 = document.getElementById('sla_p1'); if (s1 && saved.escalation.sla.p1) s1.value = saved.escalation.sla.p1.response_min || s1.value;
          const s1r = document.getElementById('sla_p1_res'); if (s1r && saved.escalation.sla.p1) s1r.value = saved.escalation.sla.p1.resolution_hours || s1r.value;
          const s2 = document.getElementById('sla_p2'); if (s2 && saved.escalation.sla.p2) s2.value = saved.escalation.sla.p2.response_min || s2.value;
          const s2r = document.getElementById('sla_p2_res'); if (s2r && saved.escalation.sla.p2) s2r.value = saved.escalation.sla.p2.resolution_hours || s2r.value;
        }
      }
      // hydrate global safeguards
      if (saved && saved.safeguards) {
        document.getElementById('safeguards_enabled').checked = !!saved.safeguards.enabled;
        document.getElementById('max_monetary_impact').value = saved.safeguards.max_monetary_impact || 0;
        document.getElementById('auto_escalate').value = saved.safeguards.auto_escalate || 60;
        document.getElementById('auto_escalate_val').textContent = document.getElementById('auto_escalate').value;
        document.getElementById('audit_log_enabled').checked = !!saved.safeguards.audit_log_enabled;
        // whitelist selections
        const wl = saved.safeguards.actions_whitelist || [];
        const sel = document.getElementById('actions_whitelist');
        if (sel) { Array.from(sel.options).forEach(o=> o.selected = wl.includes(o.value)); }
      }
    }

    // Populate actions whitelist options
    function populateActionsWhitelist() {
      const sel = document.getElementById('actions_whitelist');
      if (!sel) return;
      sel.innerHTML = '';
      CAPABILITY_ACTIONS.forEach(a=>{
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.label; sel.appendChild(opt);
      });
    }

    // Render control for a single condition knob
    function renderConditionControl(condKey, savedValue, actionId) {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '8px';
      row.style.marginBottom = '8px';

      const label = document.createElement('label');
      label.style.minWidth = '220px'; label.style.fontWeight = '600';
      // map condKey to friendly label and input type
      switch(condKey) {
        case 'new_device': label.textContent = 'Condition: New Device?'; break;
        case 'unusual_location': label.textContent = 'Condition: Unusual Location?'; break;
        case 'daily_limit': label.textContent = 'Condition: Daily Reset Limit (count)'; break;
        case 'customer_tier': label.textContent = 'Condition: Customer Tier (min)'; break;
        case 'send_otp': label.textContent = 'Send OTP on change'; break;
        case 'billing_impact': label.textContent = 'Affects billing/shipping?'; break;
        case 'block_po_box': label.textContent = 'Block P.O. boxes?'; break;
        case 'identity_verification': label.textContent = 'Require identity verification'; break;
        case 'human_approval': label.textContent = 'Require human approval'; break;
        case 'flag_low_rating': label.textContent = 'Flag ratings ‚â§'; break;
        case 'low_sentiment': label.textContent = 'Trigger on low sentiment'; break;
        case 'policy_conflict': label.textContent = 'Trigger on policy conflicts'; break;
        case 'misunderstandings': label.textContent = 'Trigger on repeated misunderstandings'; break;
        case 'price_limit': label.textContent = '‚Ç¨ Limit'; break;
        case 'discount_limit': label.textContent = '% Limit'; break;
        case 'unlisted_items': label.textContent = 'Unlisted items present'; break;
        case 'new_customer': label.textContent = 'New customer?'; break;
        case 'custom_terms': label.textContent = 'Custom terms present'; break;
        case 'tax_edits': label.textContent = 'Tax edits present'; break;
        case 'percent_limit': label.textContent = '% Limit'; break;
        case 'value_limit': label.textContent = 'Value (‚Ç¨) Limit'; break;
        case 'campaign_dates': label.textContent = 'Outside campaign dates'; break;
        case 'require_3ds': label.textContent = 'Require 3DS/OTP'; break;
        case 'cap_limit': label.textContent = 'Capture cap (‚Ç¨)'; break;
        case 'approved_quote': label.textContent = 'Only for approved quotes/invoices'; break;
        case 'paid_orders_only': label.textContent = 'Only for paid orders'; break;
        case 'double_book': label.textContent = 'Avoid double-book'; break;
        case 'buffers': label.textContent = 'Enforce buffers (min)'; break;
        case 'outside_hours_hold': label.textContent = 'Outside hours ‚Üí hold for approval'; break;
        case 'lock_window': label.textContent = 'Inside lock window (minutes)'; break;
        case 'vip_customer': label.textContent = 'VIP customer?'; break;
        case 'explicit_consent': label.textContent = 'Require explicit consent'; break;
        case 'business_hours': label.textContent = 'Business hours only'; break;
        case 'skill_match': label.textContent = 'Skill match required'; break;
        case 'overtime': label.textContent = 'Overtime hours'; break;
        case 'travel_time': label.textContent = 'Travel time (min)'; break;
        case 'price_change_limit': label.textContent = 'Price change > (‚Ç¨)'; break;
        case 'commitment_change': label.textContent = 'Commitment term change'; break;
        case 'confirmation_shown': label.textContent = 'Show confirmation + retention'; break;
        case 'retention_script': label.textContent = 'Run retention script'; break;
        case 'amount_limit': label.textContent = 'Amount > (‚Ç¨)'; break;
        case 'refunds_count_window': label.textContent = 'Refunds > N in 30 days'; break;
        case 'payment_age': label.textContent = 'Payment older than (days)'; break;
        case 'order_value_limit': label.textContent = 'Order value > (‚Ç¨)'; break;
        case 'stock_substitution': label.textContent = 'Out-of-stock substitutions'; break;
        case 'prepayment_required': label.textContent = 'Pre-payment required'; break;
        case 'fulfillment_cutoff': label.textContent = 'After fulfillment cutoff'; break;
        case 'change_value_limit': label.textContent = 'Change > (‚Ç¨) Limit'; break;
        case 'after_prep_start': label.textContent = 'After prep/ship start'; break;
        case 'cancellation_fee': label.textContent = 'Restocking / cancellation fee present'; break;
        case 'address_risk': label.textContent = 'Address risk score'; break;
        case 'calendar_rules': label.textContent = 'Slot must pass calendar rules'; break;
        case 'opt_in_required': label.textContent = 'Customer opt-in required'; break;
        case 'fee_limit': label.textContent = 'Fee > (‚Ç¨) Limit'; break;
        case 'vip_exempt': label.textContent = 'VIP exempt'; break;
        case 'double_opt_in': label.textContent = 'Require double opt-in'; break;
        case 'log_consent': label.textContent = 'Log consent text'; break;
        case 'template_approved': label.textContent = 'Template approved?'; break;
        case 'send_window': label.textContent = 'Allowed send window'; break;
        case 'confidence_threshold': label.textContent = 'Confidence threshold (%)'; break;
        case 'user_consent': label.textContent = 'User consent required'; break;
        case 'redact_pii': label.textContent = 'Redact PII?'; break;
        case 'retention_limit': label.textContent = 'Retention ‚â§ (days)'; break;
        case 'staging_passed': label.textContent = 'Staging tests passed'; break;
        case 'backup_taken': label.textContent = 'Backup / Snapshot taken'; break;
        case 'client_approval': label.textContent = 'Client approval recorded'; break;
        case 'production_environment': label.textContent = 'Affects production environment'; break;
        case 'domain_verification': label.textContent = 'Domain verified'; break;
        case 'contract_signed': label.textContent = 'Contract / SOW signed'; break;
        case 'payment_verified': label.textContent = 'Payment verified'; break;
        case 'production_issue': label.textContent = 'Production incident present'; break;
        default: label.textContent = condKey; break;
      }

      // decide input type
      const key = `${actionId}::${condKey}`;
      if (/(limit|amount|value|price|cap|fee|percent|threshold|minutes|days|time|travel_time)$/i.test(condKey) || condKey==='retention_limit') {
        const inp = document.createElement('input'); inp.type='number'; inp.value = (savedValue!==undefined?savedValue:''); inp.style.min='0'; inp.style.width='160px'; inp.dataset.condKey = condKey; inp.dataset.actionId = actionId;
        row.appendChild(label); row.appendChild(inp); return row;
      }
      if (/^(business_hours|require_3ds|send_otp|block_po_box|identity_verification|human_approval|new_customer|vip_customer|paid_orders_only|unlisted_items|stock_substitution|template_approved|redact_pii|staging_passed|backup_taken|client_approval|production_environment|domain_verification|contract_signed|payment_verified|production_issue)$/i.test(condKey)) {
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!savedValue; cb.dataset.condKey = condKey; cb.dataset.actionId = actionId; row.appendChild(label); row.appendChild(cb); return row;
      }
      if (condKey==='customer_tier' || condKey==='address_risk') {
        const sel = document.createElement('select'); sel.dataset.condKey = condKey; sel.dataset.actionId = actionId; ['any','low','medium','high','vip'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); if (savedValue) sel.value = savedValue; row.appendChild(label); row.appendChild(sel); return row;
      }
      if (condKey==='send_window') {
        const inp = document.createElement('input'); inp.type='text'; inp.placeholder='09:00-20:00'; inp.value = savedValue||''; inp.dataset.condKey = condKey; inp.dataset.actionId = actionId; row.appendChild(label); row.appendChild(inp); return row;
      }
      // default: checkbox
      const cbDefault = document.createElement('input'); cbDefault.type='checkbox'; cbDefault.checked = !!savedValue; cbDefault.dataset.condKey = condKey; cbDefault.dataset.actionId = actionId; row.appendChild(label); row.appendChild(cbDefault); return row;
    }

    function loadCapabilities() {
      try { const raw = localStorage.getItem('capabilities_settings'); return raw ? JSON.parse(raw) : null; } catch(e) { return null; }
    }

    function saveCapabilities() {
      try {
        const container = document.getElementById('capabilities_actions_list');
        if (!container) return alert('Capabilities UI not ready');
        const actions = {};
        container.querySelectorAll('select').forEach(s => { actions[s.dataset.actionId] = { level: s.value }; });
        // collect per-action condition knobs
        const conditions = {};
        container.querySelectorAll('[data-action-id]').forEach(el => {
          const aid = el.dataset.actionId;
          const ckey = el.dataset.condKey;
          if (!ckey || !aid) return;
          conditions[aid] = conditions[aid] || {};
          if (el.type === 'checkbox') conditions[aid][ckey] = !!el.checked;
          else if (el.tagName === 'SELECT') conditions[aid][ckey] = el.value;
          else conditions[aid][ckey] = el.value;
        });
        // keep escalation settings
        const escalation = { timeout: Number(document.getElementById('escalationTimeout')?.value || 5), satisfaction: Number(document.getElementById('satisfactionThreshold')?.value || 5) };
        // global safeguards
        const safeguards = {
          enabled: !!document.getElementById('safeguards_enabled')?.checked,
          max_monetary_impact: Number(document.getElementById('max_monetary_impact')?.value || 0),
          actions_whitelist: Array.from(document.getElementById('actions_whitelist')?.selectedOptions || []).map(o=>o.value),
          auto_escalate: Number(document.getElementById('auto_escalate')?.value || 60),
          audit_log_enabled: !!document.getElementById('audit_log_enabled')?.checked
        };

        const obj = { actions, conditions, escalation, safeguards, updated: new Date().toISOString() };
        localStorage.setItem('capabilities_settings', JSON.stringify(obj));
        document.getElementById('dev_output').textContent = 'Capabilities saved to localStorage';
        alert('‚úì Capabilities saved successfully!');
      } catch (e) { console.error(e); alert('Error saving capabilities'); }
    }

    // Save Telephony & CRM settings
    function saveTelephony() {
      try {
        const obj = {
          crm_lookup_url: (document.getElementById('crm_lookup_url')?.value || '').trim(),
          crm_auth_token: (document.getElementById('crm_auth_token')?.value || '').trim(),
          crm_match_strategy: (document.getElementById('crm_match_strategy')?.value || 'phone'),
          crm_show_plan: !!document.getElementById('crm_show_plan')?.checked,
          crm_show_device: !!document.getElementById('crm_show_device')?.checked,
          crm_show_outage: !!document.getElementById('crm_show_outage')?.checked,
          crm_failover: (document.getElementById('crm_failover')?.value || 'ask'),
          tele_auto_open_ticket: !!document.getElementById('tele_auto_open_ticket')?.checked,
          tele_default_queue: (document.getElementById('tele_default_queue')?.value || '').trim(),
          tele_caller_risk: Number(document.getElementById('tele_caller_risk')?.value || 50),
          tele_phone_hook: (document.getElementById('tele_phone_hook')?.value || '').trim(),
          updated: new Date().toISOString()
        };
        localStorage.setItem('telephony_settings', JSON.stringify(obj));
        document.getElementById('dev_output').textContent = 'Telephony settings saved to localStorage';
        alert('‚úì Telephony settings saved successfully!');
      } catch (e) { console.error(e); alert('Error saving telephony settings'); }
    }

    function saveEscalation() {
      const caps = loadCapabilities() || { actions: {} };
      const timeout = Number(document.getElementById('escalationTimeout')?.value || 5);
      const satisfaction = Number(document.getElementById('satisfactionThreshold')?.value || 5);
      const oncall_calendar = (document.getElementById('oncall_calendar')?.value || '').trim();
      const skillQueuesRaw = (document.getElementById('skill_queues')?.value || '').trim();
      const skill_queues = skillQueuesRaw ? skillQueuesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      const sla = {
        p1: { response_min: Number(document.getElementById('sla_p1')?.value || 15), resolution_hours: Number(document.getElementById('sla_p1_res')?.value || 2) },
        p2: { response_min: Number(document.getElementById('sla_p2')?.value || 60), resolution_hours: Number(document.getElementById('sla_p2_res')?.value || 8) }
      };

      caps.escalation = { timeout, satisfaction, oncall_calendar, skill_queues, sla };
      localStorage.setItem('capabilities_settings', JSON.stringify(caps));

      // Also save richer escalation settings for the Escalation tab
      try{
        const esc = {
          team_email: (document.getElementById('teamEmail')?.value || '').trim(),
          escalation_queue: (document.getElementById('escalationQueue')?.value || '').trim(),
          oncall_calendar: oncall_calendar,
          skill_queues: skill_queues,
          sla: sla,
          support_hours: { start: document.getElementById('supportHourStart')?.value || '', end: document.getElementById('supportHourEnd')?.value || '' },
          weekend_support: !!document.getElementById('weekend_support')?.checked,
          holidays_support: !!document.getElementById('holidays_support')?.checked,
          after_hours_message: document.getElementById('afterHoursMessage')?.value || '' ,
          escalation_reasons: {
            unknown_issue: !!document.getElementById('esc_unknown_issue')?.checked,
            customer_request: !!document.getElementById('esc_customer_request')?.checked,
            complex_billing: !!document.getElementById('esc_complex_billing')?.checked,
            special_case: !!document.getElementById('esc_special_case')?.checked,
            frustrated: !!document.getElementById('esc_angry_customer')?.checked
          },
          updated: new Date().toISOString()
        };
        // store roster separately if present
        try{ const rosterRaw = localStorage.getItem('escalation_roster'); if(rosterRaw) esc.roster = JSON.parse(rosterRaw); }catch(e){}
        localStorage.setItem('escalation_settings', JSON.stringify(esc));
      }catch(e){ console.warn('Failed to save escalation_settings', e); }

      document.getElementById('dev_output').textContent = 'Escalation settings saved to localStorage';
      alert('‚úì Escalation settings saved successfully!');
    }

    // Escalation Roster helpers
    function loadEscalationRoster(){ try{ const raw = localStorage.getItem('escalation_roster'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function saveEscalationRoster(arr){ try{ localStorage.setItem('escalation_roster', JSON.stringify(arr)); }catch(e){ console.warn('save roster failed', e); } }

    function renderOncallRoster(){ const el = document.getElementById('oncall_roster_list'); if(!el) return; const arr = loadEscalationRoster(); el.innerHTML=''; if(arr.length===0){ el.innerHTML = '<div class="helper-text">No on-call entries. Add technicians or link calendars to route escalations.</div>'; return; }
      arr.forEach((r,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(r.name||'Unnamed')}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(r.method||'')} ¬∑ ${escapeHtml(r.contact||'')}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.addEventListener('click', ()=> openOncallEditor(r,i)); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ if(!confirm('Remove on-call entry for '+r.name+'?')) return; const a = loadEscalationRoster(); a.splice(i,1); saveEscalationRoster(a); renderOncallRoster(); }); controls.appendChild(edit); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); el.appendChild(row); }); }

    function openOncallEditor(existing, index){ // small modal editor
      return new Promise((resolve,reject)=>{
        let modal = document.getElementById('oncall_editor'); if(!modal){ modal = document.createElement('div'); modal.id='oncall_editor'; modal.style.position='fixed'; modal.style.left='20%'; modal.style.right='20%'; modal.style.top='12%'; modal.style.bottom='12%'; modal.style.background='var(--card)'; modal.style.zIndex=10001; modal.style.overflow='auto'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.color='var(--fg)'; modal.style.border='1px solid var(--border)'; document.body.appendChild(modal); }
        modal.innerHTML=''; const title = document.createElement('h3'); title.textContent = existing ? 'Edit On-Call Entry' : 'Add On-Call Entry'; modal.appendChild(title);
        const form = document.createElement('div'); form.style.display='grid'; form.style.gridTemplateColumns='1fr 1fr'; form.style.gap='8px';
        const name = document.createElement('input'); name.placeholder='Name'; name.value = existing?.name||''; const contact = document.createElement('input'); contact.placeholder='Contact (email or phone)'; contact.value = existing?.contact||'';
        const method = document.createElement('select'); method.innerHTML = '<option value="email">Email</option><option value="phone">Phone</option><option value="pager">Pager/SMS</option>'; method.value = existing?.method||'email'; const calendarSel = document.createElement('select'); calendarSel.innerHTML = '<option value="">-- no calendar --</option>';
        // populate with uploaded calendars if available
        try{ const calRaw = localStorage.getItem('uploaded_calendars'); const cals = calRaw?JSON.parse(calRaw):[]; (cals||[]).forEach(c=>{ const o = document.createElement('option'); o.value = c.id || c.name; o.textContent = c.name || c.id; calendarSel.appendChild(o); }); }catch(e){}
        calendarSel.value = existing?.calendar||'';
        const start = document.createElement('input'); start.type='date'; start.value = existing?.start||''; const end = document.createElement('input'); end.type='date'; end.value = existing?.end||'';
        form.appendChild(name); form.appendChild(contact); form.appendChild(method); form.appendChild(calendarSel); form.appendChild(start); form.appendChild(end);
        modal.appendChild(form);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='12px'; const save = document.createElement('button'); save.className='save-btn'; save.textContent='Save'; save.addEventListener('click', ()=>{
          const obj = { name: name.value.trim(), contact: contact.value.trim(), method: method.value, calendar: calendarSel.value, start: start.value||null, end: end.value||null };
          let arr = loadEscalationRoster(); if(Number.isInteger(index) && index>=0) arr[index] = obj; else arr.push(obj); saveEscalationRoster(arr); modal.remove(); renderOncallRoster(); resolve(obj);
        }); const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.addEventListener('click', ()=>{ modal.remove(); reject(new Error('cancel')); }); actions.appendChild(save); actions.appendChild(cancel); modal.appendChild(actions);
      });
    }

    function addOncallEntry(){ openOncallEditor(null).catch(()=>{}); }

    // Test paging/alert (simulated)
    function testEscalationAlert(){ const roster = loadEscalationRoster(); if(!roster || roster.length===0) return alert('No on-call entries to test. Add at least one technician.'); const idx = 0; const target = roster[idx]; // choose first for demo
      const msg = `Test alert to ${target.name} (${target.contact}) via ${target.method}`;
      showModal('Test Alert', `<div style="padding:12px;"><p>${escapeHtml(msg)}</p><p style="color:var(--muted)">This is a simulated alert (demo only).</p><button class=\"btn\" onclick=\"document.getElementById('template_snippets_panel').remove()\">Close</button></div>`);
    }

    function loadEscalationSettings(){
      try{
        const raw = localStorage.getItem('escalation_settings'); if(!raw) return;
        const esc = JSON.parse(raw);
        if(esc.team_email) document.getElementById('teamEmail').value = esc.team_email;
        if(esc.escalation_queue) document.getElementById('escalationQueue').value = esc.escalation_queue;
        if(esc.oncall_calendar) document.getElementById('oncall_calendar').value = esc.oncall_calendar;
        if(esc.skill_queues) document.getElementById('skill_queues').value = (esc.skill_queues || []).join(',');
        if(esc.sla){ document.getElementById('sla_p1').value = esc.sla.p1?.response_min || 15; document.getElementById('sla_p1_res').value = esc.sla.p1?.resolution_hours || 2; document.getElementById('sla_p2').value = esc.sla.p2?.response_min || 60; document.getElementById('sla_p2_res').value = esc.sla.p2?.resolution_hours || 8; }
        if(esc.support_hours){ document.getElementById('supportHourStart').value = esc.support_hours.start || '09:00'; document.getElementById('supportHourEnd').value = esc.support_hours.end || '17:00'; }
        document.getElementById('weekend_support').checked = !!esc.weekend_support; document.getElementById('holidays_support').checked = !!esc.holidays_support;
        if(esc.after_hours_message) document.getElementById('afterHoursMessage').value = esc.after_hours_message;
        if(esc.escalation_reasons){ document.getElementById('esc_unknown_issue').checked = !!esc.escalation_reasons.unknown_issue; document.getElementById('esc_customer_request').checked = !!esc.escalation_reasons.customer_request; document.getElementById('esc_complex_billing').checked = !!esc.escalation_reasons.complex_billing; document.getElementById('esc_special_case').checked = !!esc.escalation_reasons.special_case; document.getElementById('esc_angry_customer').checked = !!esc.escalation_reasons.frustrated; }
        // if roster included, ensure it's saved to escalation_roster
        if(esc.roster && Array.isArray(esc.roster)){
          saveEscalationRoster(esc.roster);
        }
      }catch(e){ console.warn('Failed to load escalation_settings', e); }
    }
    function exportAnalytics(format) {
      alert(`‚úì Analytics exported as ${format.toUpperCase()}!`);
    }

    /* --- Storage & Analytics helpers --- */
    function loadStorageAnalyticsSettings(){ try{ const raw = localStorage.getItem('storage_analytics_settings'); return raw?JSON.parse(raw):{telemetry_opt_in:false, retention_days:90}; }catch(e){return {telemetry_opt_in:false, retention_days:90};} }
    function saveStorageAnalyticsSettings(s){ localStorage.setItem('storage_analytics_settings', JSON.stringify(s)); }

    function renderStorageAnalytics(){
      const out = document.getElementById('storage_keys_list'); if(!out) return;
      out.innerHTML = '';
      // list keys and approximate sizes
      const rows = [];
      for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); try{ const v = localStorage.getItem(k)||''; rows.push({key:k, size: new Blob([v]).size}); }catch(e){} }
      rows.sort((a,b)=>b.size-a.size);
      if(rows.length===0) { out.innerHTML = '<div class="helper-text">No storage keys found.</div>'; } else {
        rows.forEach(r=>{
          const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='8px'; el.style.padding='6px'; el.style.borderBottom='1px solid var(--border)';
          const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(r.key)}</strong><div style="color:var(--muted); font-size:0.9rem;">${r.size} bytes</div>`;
          const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
          const view = document.createElement('button'); view.className='btn'; view.textContent='View'; view.addEventListener('click', ()=>{ const val = localStorage.getItem(r.key)||''; showModal('Key: '+r.key, '<pre style="white-space:pre-wrap; max-height:320px; overflow:auto;">'+escapeHtml(val)+'</pre>'); });
          const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Export'; dl.addEventListener('click', ()=>{ const v = localStorage.getItem(r.key)||''; const blob = new Blob([v], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `${r.key}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); });
          const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ if(!confirm('Remove localStorage key '+r.key+'?')) return; localStorage.removeItem(r.key); renderStorageAnalytics(); });
          controls.appendChild(view); controls.appendChild(dl); controls.appendChild(rem);
          el.appendChild(left); el.appendChild(controls); out.appendChild(el);
        });
      }
      renderAnalyticsEventsList();
      // telemetry checkbox
      const s = loadStorageAnalyticsSettings(); const tb = document.getElementById('telemetry_opt_in'); if(tb) tb.checked = !!s.telemetry_opt_in; const rd = document.getElementById('storage_retention_days'); if(rd) rd.value = s.retention_days||90;
    }

    function exportAllLocalStorage(){
      const obj = {};
      for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); try{ obj[k]=JSON.parse(localStorage.getItem(k)); }catch(e){ obj[k]=localStorage.getItem(k); } }
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'localstorage-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }

    function handleImportLocalStorageFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(){ try{ const parsed = JSON.parse(String(reader.result||'')); if(typeof parsed !== 'object'){ return alert('Imported JSON should be an object of key:value pairs'); } Object.keys(parsed).forEach(k=>{ try{ localStorage.setItem(k, typeof parsed[k] === 'string' ? parsed[k] : JSON.stringify(parsed[k])); }catch(err){} }); alert('Imported '+Object.keys(parsed).length+' keys into localStorage (demo only)'); renderStorageAnalytics(); }catch(err){ alert('Import error: '+err.message); } }; reader.readAsText(file);
    }

    function purgeStorageOlderThan(){ const days = Number(document.getElementById('storage_retention_days')?.value || 90); if(!confirm('Purge demo data older than '+days+' days? This affects demo keys that include a timestamp.')) return; const cutoff = Date.now() - (days*24*60*60*1000);
      // heuristic: many demo keys store objects with created_at or timestamps; try to parse and remove those older than cutoff
      let removed = 0; for(let i=localStorage.length-1;i>=0;i--){ const k=localStorage.key(i); try{ const v = localStorage.getItem(k); if(!v) continue; let parsed; try{ parsed = JSON.parse(v); }catch(e){ parsed = null; }
        let t = null; if(parsed && parsed.created_at) t = Date.parse(parsed.created_at); else if(parsed && parsed.updated) t = Date.parse(parsed.updated); else {
          // try numeric timestamp inside string
          const m = v.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/); if(m) t = Date.parse(m[0]);
        }
        if(t && !isNaN(t) && t < cutoff){ localStorage.removeItem(k); removed++; }
      }catch(e){} }
      alert('Purge complete. Removed '+removed+' keys (heuristic)'); renderStorageAnalytics();
    }

    function showModal(title, html){ let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); } panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn); const t = document.createElement('h3'); t.textContent = title; t.style.marginTop='0'; panel.appendChild(t); const wrapper = document.createElement('div'); wrapper.style.marginTop='8px'; wrapper.innerHTML = html; panel.appendChild(wrapper); }

    function generateSampleEvent(){ const s = loadStorageAnalyticsSettings(); if(!s.telemetry_opt_in){ if(!confirm('Telemetry is currently disabled. Enable it to generate anonymized events?')) return; s.telemetry_opt_in = true; saveStorageAnalyticsSettings(s); }
      const arrRaw = localStorage.getItem('analytics_events'); let arr = []; try{ arr = arrRaw?JSON.parse(arrRaw):[]; }catch(e){ arr = []; }
      arr.push({ id: 'evt-'+Date.now(), type:'sample.event', created_at: new Date().toISOString(), meta:{demo:true} }); localStorage.setItem('analytics_events', JSON.stringify(arr)); renderAnalyticsEventsList(); }

    function renderAnalyticsEventsList(){ const el = document.getElementById('analytics_events_list'); if(!el) return; const raw = localStorage.getItem('analytics_events'); let arr = []; try{ arr = raw?JSON.parse(raw):[]; }catch(e){ arr = []; }
      el.innerHTML = ''; if(arr.length===0){ el.innerHTML = '<div class="helper-text">No analytics events recorded yet.</div>'; return; }
      arr.slice(-100).reverse().forEach(a=>{ const row = document.createElement('div'); row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)'; row.innerHTML = `<div style="font-weight:600">${escapeHtml(a.type||'event')}</div><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(a.created_at||'')}</div><div style="margin-top:6px;">${escapeHtml(JSON.stringify(a.meta||{}))}</div>`; el.appendChild(row); });
    }

    function clearAnalyticsEvents(){ if(!confirm('Clear stored analytics events?')) return; localStorage.removeItem('analytics_events'); renderAnalyticsEventsList(); }

    function clearAllDemoStorage(){ if(!confirm('Clear all localStorage used by this demo? This cannot be undone.')) return; // remove keys that look demo-related
      const preserve = []; const removed = []; for(let i=localStorage.length-1;i>=0;i--){ const k = localStorage.key(i); if(k && (k.startsWith('capabilities')||k.startsWith('telephony')||k.startsWith('templates')||k.startsWith('knowledge')||k.startsWith('invoices')||k.startsWith('analytics')||k.startsWith('uploaded_')||k==='storage_analytics_settings')){ localStorage.removeItem(k); removed.push(k); } }
      alert('Removed '+removed.length+' demo keys.'); renderStorageAnalytics(); }

    function saveQuotes() {
      // simple demo save handler for quotes settings
      const form = document.getElementById('quotesForm');
      if (!form) return alert('Quotes form not found');
      // for now just notify ‚Äî could serialize like others
      alert('‚úì Quote settings saved successfully!');
    }

    function previewQuote(){
      // Use modal item editor instead of prompt for better UX
      const cur = {};
      cur.currency = document.getElementById('quotes_currency')?.value || 'USD';
      cur.vat = Number(document.getElementById('quotes_vat')?.value || 0);
      cur.valid_days = Number(document.getElementById('quotes_valid_days')?.value || 30);
      cur.subject = document.getElementById('quotes_template_subject')?.value || 'Quote';
      cur.body = document.getElementById('quotes_template_body')?.value || '';
      // get items from modal editor
      openLineItemEditor([]).then(items=>{
        if(!items || items.length===0) items = [{desc:'Service (demo)', amount:100}];
        const subtotal = items.reduce((s,i)=>s + (i.amount||0), 0);
        const vatAmount = Math.round((subtotal * (cur.vat/100))*100)/100;
        const total = Math.round((subtotal + vatAmount)*100)/100;
        // render overlay preview
        let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'Quote Preview'; title.style.marginTop='0'; panel.appendChild(title);
        const subj = document.createElement('div'); subj.innerHTML = '<strong>Subject:</strong> ' + escapeHtml(cur.subject); subj.style.marginTop='8px'; panel.appendChild(subj);
        const bodyEl = document.createElement('div'); bodyEl.style.marginTop='8px'; bodyEl.innerHTML = '<strong>Message:</strong><div style="white-space:pre-wrap; border:1px solid var(--border); padding:8px; border-radius:6px; margin-top:6px; background:var(--panel);">' + escapeHtml(cur.body) + '</div>'; panel.appendChild(bodyEl);
        const list = document.createElement('div'); list.style.marginTop='12px'; list.innerHTML = '<strong>Items</strong>';
        const ul = document.createElement('div'); ul.style.marginTop='6px'; items.forEach(it=>{ const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.padding='6px 0'; r.innerHTML = '<div>'+escapeHtml(it.desc)+'</div><div>'+escapeHtml((it.amount||0).toFixed(2))+' '+escapeHtml(cur.currency)+'</div>'; ul.appendChild(r); }); list.appendChild(ul); panel.appendChild(list);
        const sums = document.createElement('div'); sums.style.marginTop='12px'; sums.innerHTML = `<div style="display:flex; justify-content:space-between"><div>Subtotal</div><div>${subtotal.toFixed(2)} ${escapeHtml(cur.currency)}</div></div><div style="display:flex; justify-content:space-between"><div>VAT (${cur.vat}%)</div><div>${vatAmount.toFixed(2)} ${escapeHtml(cur.currency)}</div></div><div style="display:flex; justify-content:space-between; font-weight:700; margin-top:6px"><div>Total</div><div>${total.toFixed(2)} ${escapeHtml(cur.currency)}</div></div>`;
        panel.appendChild(sums);
      }).catch(()=>{ /* user cancelled */ });
    }

    function exportInvoiceSample(){
      // Use modal editor to build items; then save invoice to history and download
      openLineItemEditor([]).then(items=>{
        const subtotal = items.reduce((s,i)=>s + (i.amount||0), 0);
        const invoice = { id: 'inv-'+Date.now(), created_at: new Date().toISOString(), currency: document.getElementById('quotes_currency')?.value || 'USD', vat: Number(document.getElementById('quotes_vat')?.value || 0), valid_days: Number(document.getElementById('quotes_valid_days')?.value || 30), subject: document.getElementById('quotes_template_subject')?.value || '', body: document.getElementById('quotes_template_body')?.value || '', items: items.length?items:[{desc:'Demo service', amount:100}], subtotal };
        invoice.vat_amount = Math.round((invoice.subtotal * (invoice.vat/100))*100)/100; invoice.total = Math.round((invoice.subtotal + invoice.vat_amount)*100)/100;
        // save to history
        try{ const histRaw = localStorage.getItem('invoices'); const hist = histRaw?JSON.parse(histRaw):[]; hist.unshift(invoice); localStorage.setItem('invoices', JSON.stringify(hist)); }catch(e){}
        // download
        const blob = new Blob([JSON.stringify(invoice, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoice-${invoice.id}.json`; document.body.appendChild(a); a.click(); a.remove();
        // refresh history UI if open
        renderInvoiceHistoryList();
      }).catch(()=>{});
    }

    /* --- Invoice Templates management (simple client-side) --- */
    function loadInvoiceTemplates(){ try{ const raw = localStorage.getItem('invoice_templates'); return raw?JSON.parse(raw):[]; }catch(e){return[];} }
    function saveInvoiceTemplates(arr){ localStorage.setItem('invoice_templates', JSON.stringify(arr)); }

    function importInvoiceTemplate(){ const f = document.getElementById('invoice_template_import_file'); if(!f) return alert('Invoice import input not available'); f.value=''; f.click(); }

    function handleInvoiceTemplateFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const name = file.name || 'invoice-template'; const reader = new FileReader(); reader.onload = function(){ const txt = String(reader.result||''); if(!txt.trim()) return alert('Empty file'); if(name.toLowerCase().endsWith('.json')){ try{ const parsed = JSON.parse(txt); if(Array.isArray(parsed)){ const cur = loadInvoiceTemplates(); saveInvoiceTemplates(cur.concat(parsed)); renderInvoiceTemplatesList(); alert('Imported '+parsed.length+' invoice templates'); } else { // try to accept object
            const cur = loadInvoiceTemplates(); cur.push(parsed); saveInvoiceTemplates(cur); renderInvoiceTemplatesList(); alert('Imported invoice template'); }
          }catch(err){ alert('JSON parse error: '+err.message); } }
        else { // treat as text/markdown: split paragraphs as potential templates
          const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean); if(parts.length===0) return alert('No template text found'); const cur = loadInvoiceTemplates(); parts.forEach((p,i)=> cur.push({name: name + (parts.length>1? ' - part '+(i+1):''), body: p})); saveInvoiceTemplates(cur); renderInvoiceTemplatesList(); alert('Imported '+parts.length+' invoice snippets'); }
    }; reader.readAsText(file); }

    function renderInvoiceTemplatesList(){ const el = document.getElementById('invoice_templates_list'); if(!el) return; const arr = loadInvoiceTemplates(); el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">No invoice templates available.</div>'; return; } arr.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='6px'; row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(t.name||('Template '+(i+1)))}</strong><div style="color:var(--muted)">${escapeHtml(((t.body||'').slice(0,140))) + ((t.body||'').length>140?'...':'')}</div></div>`; const view = document.createElement('button'); view.className='btn'; view.textContent='View'; view.addEventListener('click', ()=>{ let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); } panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn); const title = document.createElement('h3'); title.textContent = t.name || 'Invoice Template'; title.style.marginTop='0'; panel.appendChild(title); const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.background='rgba(255,255,255,0.02)'; pre.style.padding='12px'; pre.style.borderRadius='8px'; pre.textContent = t.body || ''; panel.appendChild(pre); }); const rem = document.createElement('button'); rem.className='btn'; rem.textContent='Remove'; rem.style.background='#d9534f'; rem.addEventListener('click', ()=>{ const arr2 = loadInvoiceTemplates(); arr2.splice(i,1); saveInvoiceTemplates(arr2); renderInvoiceTemplatesList(); }); row.appendChild(view); row.appendChild(rem); el.appendChild(row); }); }

    function exportInvoiceTemplates(){ const arr = loadInvoiceTemplates(); const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoice-templates.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); }

    // --- Line Item Editor Modal ---
    function openLineItemEditor(initialItems){
      return new Promise((resolve, reject)=>{
        let modal = document.getElementById('line_item_editor');
        if(!modal){ modal = document.createElement('div'); modal.id='line_item_editor'; modal.style.position='fixed'; modal.style.left='20%'; modal.style.right='20%'; modal.style.top='10%'; modal.style.bottom='10%'; modal.style.background='var(--card)'; modal.style.zIndex=10000; modal.style.overflow='auto'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.color='var(--fg)'; modal.style.border='1px solid var(--border)'; document.body.appendChild(modal); }
        modal.innerHTML='';
        const title = document.createElement('h3'); title.textContent='Line Items'; modal.appendChild(title);
        const list = document.createElement('div'); list.id='line_items_container'; list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px'; list.style.marginTop='8px'; modal.appendChild(list);
        const addRow = (it)=>{
          const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; const desc = document.createElement('input'); desc.type='text'; desc.placeholder='Description'; desc.value = it.desc || ''; desc.style.flex='1'; const amt = document.createElement('input'); amt.type='number'; amt.step='0.01'; amt.min='0'; amt.value = (it.amount!=null?it.amount:''); amt.style.width='120px'; const del = document.createElement('button'); del.className='btn'; del.textContent='Remove'; del.style.background='#d9534f'; del.addEventListener('click', ()=>{ row.remove(); }); row.appendChild(desc); row.appendChild(amt); row.appendChild(del); list.appendChild(row); };
        (initialItems||[]).forEach(i=> addRow(i));
        const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add Line Item'; addBtn.addEventListener('click', ()=> addRow({desc:'', amount:0})); modal.appendChild(addBtn);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='12px'; const save = document.createElement('button'); save.className='save-btn'; save.textContent='Save Items'; save.addEventListener('click', ()=>{
          const rows = Array.from(list.children); const items = rows.map(r=>{ const d = r.querySelector('input[type="text"]')?.value||''; const a = Number(r.querySelector('input[type="number"]')?.value||0); return {desc:d.trim(), amount: Math.round(a*100)/100}; }).filter(x=>x.desc);
          modal.remove(); resolve(items);
        }); const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.addEventListener('click', ()=>{ modal.remove(); reject(new Error('cancel')); }); actions.appendChild(save); actions.appendChild(cancel); modal.appendChild(actions);
      });
    }

    // --- Invoice History (local-only) ---
    function loadInvoiceHistory(){ try{ const raw = localStorage.getItem('invoices'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function renderInvoiceHistoryList(){ const el = document.getElementById('invoice_history_list'); if(!el) return; const arr = loadInvoiceHistory(); el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">No invoices yet. Export one to populate history.</div>'; return; } arr.forEach((inv,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(inv.id)}</strong><div style="color:var(--muted); font-size:0.9rem;">${new Date(inv.created_at).toLocaleString()} ‚Äî ${escapeHtml((inv.total||0).toFixed?inv.total.toFixed(2):String(inv.total))} ${escapeHtml(inv.currency||'')}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(inv, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${inv.id}.json`; document.body.appendChild(a); a.click(); a.remove(); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ if(!confirm('Remove invoice '+inv.id+' from history?')) return; const a2 = loadInvoiceHistory(); a2.splice(i,1); localStorage.setItem('invoices', JSON.stringify(a2)); renderInvoiceHistoryList(); }); controls.appendChild(dl); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); el.appendChild(row); }); }
    function openInvoiceHistory(){ // show modal with invoice history
      let panel = document.getElementById('invoice_history_panel');
      if(!panel){ panel = document.createElement('div'); panel.id='invoice_history_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
      panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent='Invoice History'; title.style.marginTop='0'; panel.appendChild(title);
      const container = document.createElement('div'); container.id='invoice_history_list'; container.style.marginTop='12px'; panel.appendChild(container);
      renderInvoiceHistoryList();
    }

    function saveAppointments() {
      const f = document.getElementById('appointmentsForm');
      if (!f) return alert('Appointments form not found');
      alert('‚úì Appointment settings saved successfully!');
    }

    function saveReservation() {
      const f = document.getElementById('reservationForm');
      if (!f) return alert('Reservation form not found');
      alert('‚úì Reservation settings saved successfully!');
    }

    // Rule builder helpers for Ticketing auto-create rules
    function insertRuleTemplate(){
      const el = document.getElementById('ticket_create_rule');
      if(!el) return alert('Rule input not found');
      el.value = 'when: confidence < 50% OR outage_detected';
      el.focus();
    }

    function addRuleCondition(){
      const cond = document.getElementById('rb_condition')?.value;
      const op = document.getElementById('rb_operator')?.value;
      const val = (document.getElementById('rb_value')?.value || '').trim();
      const input = document.getElementById('ticket_create_rule');
      if(!cond || !input) return alert('Builder or rule input not found');

      let fragment = '';
      // boolean conditions don't need operator/value
      const booleanConds = ['outage_detected','high_priority_account','failed_checks'];
      if(booleanConds.includes(cond)){
        fragment = cond;
      } else {
        // require value for numeric/qualitative conditions
        if(!val){ return alert('Please provide a value for this condition'); }
        fragment = `${cond} ${op} ${val}`;
      }

      // build into rule input
      let cur = (input.value || '').trim();
      if(!cur){
        input.value = `when: ${fragment}`;
      } else {
        // if cur already starts with "when:", append with AND
        if(/^when:/i.test(cur)) input.value = cur + ' AND ' + fragment;
        else input.value = cur + ' AND ' + fragment;
      }
      input.focus();
      // clear value field for convenience
      const rv = document.getElementById('rb_value'); if(rv) rv.value = '';
    }

    // Knowledge (FAQ) handlers
    function renderFaqRow(q='', a=''){
      const container = document.getElementById('faqs_list');
      if (!container) return;
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 1fr auto';
      row.style.gap = '8px';
      row.innerHTML = `
        <input class="faq-q" placeholder="Question" value="${escapeHtml(q)}" />
        <textarea class="faq-a" placeholder="Short answer">${escapeHtml(a)}</textarea>
        <div style="display:flex; flex-direction:column; gap:8px;"><button type="button" class="btn remove-faq">Remove</button></div>
      `;
      container.appendChild(row);
      row.querySelector('.remove-faq').addEventListener('click', ()=>row.remove());
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function loadKnowledge(){
      // Load saved FAQs and recent questions (demo: from localStorage)
      const faqsRaw = localStorage.getItem('knowledge_faqs');
      const recentRaw = localStorage.getItem('recent_questions');
      const container = document.getElementById('faqs_list');
      if (container) container.innerHTML='';
      try{
        const faqs = faqsRaw ? JSON.parse(faqsRaw) : [];
        (faqs||[]).forEach(item=> renderFaqRow(item.question || '', item.answer || ''));
      }catch(e){ console.warn('Could not parse saved faqs', e); }

      // Sample recent questions if none are present
      let recent = [];
      try{ recent = recentRaw ? JSON.parse(recentRaw) : []; }catch(e){ recent = []; }
      if (!recent || recent.length===0){
        recent = [
          {q:'How can I change my password?', id:1},
          {q:'What are your opening hours on weekends?', id:2},
          {q:'Do you offer maintenance contracts?', id:3}
        ];
      }
      const recentEl = document.getElementById('recent_questions');
      if (recentEl) recentEl.innerHTML = '';
      recent.forEach(r=>{
        const el = document.createElement('div');
        el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='12px';
        const left = document.createElement('div'); left.style.flex='1'; left.textContent = r.q;
        const btn = document.createElement('button'); btn.type='button'; btn.className='btn'; btn.textContent='Add answer';
        btn.addEventListener('click', ()=>{
          renderFaqRow(r.q,'');
          // scroll to bottom
          document.getElementById('faqs_list').lastElementChild.scrollIntoView({behavior:'smooth'});
        });
        el.appendChild(left); el.appendChild(btn);
        if (recentEl) recentEl.appendChild(el);
      });
    }

    function saveKnowledge(){
      const container = document.getElementById('faqs_list');
      if (!container) return alert('FAQ list not found');
      const rows = Array.from(container.children);
      const faqs = rows.map(r=>{
        const q = r.querySelector('.faq-q')?.value || '';
        const a = r.querySelector('.faq-a')?.value || '';
        return {question: q, answer: a};
      }).filter(x=>x.question.trim());
      localStorage.setItem('knowledge_faqs', JSON.stringify(faqs));
      alert('‚úì FAQ Knowledge saved');
    }

    // Avatar preview handler
    (function(){
      const avatarFile = document.getElementById('avatar_file');
      const avatarPreview = document.getElementById('avatar_preview');
      if (!avatarFile) return;
      avatarFile.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(){ if (avatarPreview) avatarPreview.src = reader.result; };
        reader.readAsDataURL(f);
      });
    })();

    // init knowledge UI after DOM is ready
    (function(){
      // add handler for Add FAQ button
      const addBtn = document.getElementById('knowledge_add');
      if (addBtn) addBtn.addEventListener('click', ()=> renderFaqRow('',''));
      // load knowledge and recent questions
      loadKnowledge();
    })();

    // Section enable/disable helpers
    (function(){
      function setDisabledForForm(formEl, disabled, excludeIds){
        if (!formEl) return;
        const els = formEl.querySelectorAll('input,select,textarea,button');
        els.forEach(el=>{
          // skip excluded ids (like the hidden checkbox)
          if (excludeIds && excludeIds.includes(el.id)) return;
          // never disable visible toggle buttons (they control the section)
          if (el.classList && el.classList.contains('toggle-btn')) return;
          // skip elements used as the visual toggle (data-checkbox) if present
          if (el.dataset && el.dataset.checkbox) return;
          try{ el.disabled = !!disabled; }catch(e){}
        });
        // toggle visual class on the main form or section
        if (disabled) formEl.classList.add('disabled-section'); else formEl.classList.remove('disabled-section');
      }

      function updateSectionState(){
        // Quotes
        const quotesToggle = document.getElementById('quotes_enabled');
        const quotesForm = document.getElementById('quotesForm');
        setDisabledForForm(quotesForm, !quotesToggle?.checked, ['quotes_enabled']);

        // Appointments
        const apptsToggle = document.getElementById('appts_enabled');
        const apptsForm = document.getElementById('appointmentsForm');
        setDisabledForForm(apptsForm, !apptsToggle?.checked, ['appts_enabled']);

        // Reservation
        const resvToggle = document.getElementById('resv_enabled');
        const resvForm = document.getElementById('reservationForm');
        setDisabledForForm(resvForm, !resvToggle?.checked, ['resv_enabled']);

        // Snaps section inside privacy
        const snapsToggle = document.getElementById('snaps_store_enabled');
        const snapsSection = document.getElementById('snaps_section');
        if (snapsSection){
          const inputs = snapsSection.querySelectorAll('input,select,textarea,button');
          inputs.forEach(i=>{ if (i.id !== 'snaps_store_enabled') i.disabled = !snapsToggle?.checked; });
          if (!snapsToggle?.checked) snapsSection.classList.add('disabled-section'); else snapsSection.classList.remove('disabled-section');
        }
      }

      // wire toggles to update state
      ['quotes_enabled','appts_enabled','resv_enabled','snaps_store_enabled'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateSectionState);
      });

      // initialize toggle buttons (sync hidden checkboxes with visible toggles)
      document.querySelectorAll('.toggle-btn').forEach(btn=>{
        const cbId = btn.dataset.checkbox;
        const cb = document.getElementById(cbId);
        function updateBtn(){
          const on = !!(cb && cb.checked);
          btn.classList.toggle('on', on);
          btn.setAttribute('aria-checked', on ? 'true' : 'false');
          btn.querySelector('.label').textContent = on ? 'On' : 'Off';
        }
        // click toggles the hidden checkbox and fires change
        btn.addEventListener('click', ()=>{
          if (!cb) return;
          cb.checked = !cb.checked;
          // dispatch change so other handlers run
          cb.dispatchEvent(new Event('change', {bubbles:true}));
          updateBtn();
        });
        // when the checkbox changes (programmatic), update UI
        if (cb) cb.addEventListener('change', updateBtn);
        // initial state
        updateBtn();
      });

      // run at startup
      updateSectionState();
      // expose for debugging
      window.updateSectionState = updateSectionState;
    })();

    // Preset apply handlers
    (function(){
      function setVal(id, val){
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = !!val;
        else el.value = val;
      }

      function applyPreset(name){
        switch(name){
          case 'services':
            setVal('personalityType','friendly');
            setVal('appts_enabled', true);
            setVal('appts_duration',30);
            setVal('primaryLanguage','en');
            break;
          case 'retail':
            setVal('personalityType','concise');
            setVal('quotes_enabled', true);
            setVal('quotes_currency','EUR');
            setVal('quotes_vat',20);
            break;
          case 'restaurant':
            setVal('personalityType','friendly');
            setVal('resv_enabled', true);
            setVal('resv_party_default',2);
            break;
          case 'it':
            setVal('personalityType','technical');
            // enable some troubleshooting capabilities if present
            const cap = document.getElementById('cap_basic_troubleshooting'); if (cap) cap.checked = true;
            break;
          case 'education':
            setVal('personalityType','professional');
            setVal('primaryLanguage','en');
            break;
          case 'healthcare':
            setVal('personalityType','professional');
            setVal('appts_enabled', true);
            break;
          case 'ecommerce':
            setVal('personalityType','concise');
            setVal('quotes_enabled', true);
            break;
          case 'professional':
            setVal('personalityType','professional');
            setVal('quotes_enabled', true);
            break;
        }
        alert('Preset "' + name + '" applied (unsaved)');
      }

      document.querySelectorAll('.preset-apply').forEach(b=> b.addEventListener('click', ()=>{
        const p = b.dataset.preset; if (!p) return;
        applyPreset(p);
      }));
    })();

    // Data & Privacy handlers
    (function(){
      function loadPrivacySettings(){ try{ const raw = localStorage.getItem('privacy_settings'); return raw?JSON.parse(raw):{}; }catch(e){ return {}; } }

      function loadPrivacy(){
        try{
          const pRaw = localStorage.getItem('privacy_settings');
          const sRaw = localStorage.getItem('storage_settings');
          const p = pRaw ? JSON.parse(pRaw) : {};
          const s = sRaw ? JSON.parse(sRaw) : {};
          document.getElementById('privacy_consent_enabled').checked = !!p.consent_enabled;
          document.getElementById('privacy_consent_text').value = p.consent_text || '';
          document.getElementById('privacy_retention_days').value = p.retention_days != null ? p.retention_days : 0;
          document.getElementById('privacy_pii_redact').checked = !!p.pii_redaction;
          document.getElementById('privacy_pii_email').checked = !!p.pii_redact_email;
          document.getElementById('privacy_pii_phone').checked = !!p.pii_redact_phone;
          document.getElementById('privacy_pii_names').checked = !!p.pii_redact_names;
          if (p.data_residency) document.getElementById('privacy_data_residency').value = p.data_residency;
          document.getElementById('privacy_dpa_url').value = p.dpa_url || '';

          document.getElementById('snaps_store_enabled').checked = !!s.store_snaps;
          document.getElementById('snaps_last_n').value = s.snaps_last_n != null ? s.snaps_last_n : 10;
          document.getElementById('snaps_unresolved').checked = !!s.snaps_unresolved;
          document.getElementById('snaps_intents_only').checked = !!s.snaps_intents_only;

          renderSnapsPreview();
        }catch(e){ console.warn('loadPrivacy error', e); }
      }

      function savePrivacy(){
        const p = {
          consent_enabled: !!document.getElementById('privacy_consent_enabled').checked,
          consent_text: document.getElementById('privacy_consent_text').value || '',
          retention_days: Number(document.getElementById('privacy_retention_days').value||0),
          pii_redaction: !!document.getElementById('privacy_pii_redact').checked,
          pii_redact_email: !!document.getElementById('privacy_pii_email')?.checked,
          pii_redact_phone: !!document.getElementById('privacy_pii_phone')?.checked,
          pii_redact_names: !!document.getElementById('privacy_pii_names')?.checked,
          data_residency: document.getElementById('privacy_data_residency').value || 'eu',
          dpa_url: document.getElementById('privacy_dpa_url').value || ''
        };
        localStorage.setItem('privacy_settings', JSON.stringify(p));
        // also save storage settings
        const s = {
          store_snaps: !!document.getElementById('snaps_store_enabled').checked,
          snaps_last_n: Number(document.getElementById('snaps_last_n').value||0),
          snaps_unresolved: !!document.getElementById('snaps_unresolved').checked,
          snaps_intents_only: !!document.getElementById('snaps_intents_only').checked
        };
        localStorage.setItem('storage_settings', JSON.stringify(s));
        alert('‚úì Data & Privacy settings saved');
        renderSnapsPreview();
      }

      function exportUserData(){
        // compile a small export of data stored in localStorage for the demo
        const payload = {};
        try{
          ['privacy_settings','storage_settings','knowledge_faqs','recent_questions'].forEach(k=>{
            const v = localStorage.getItem(k);
            payload[k] = v ? JSON.parse(v) : null;
          });
        }catch(e){ console.warn('exportUserData parse', e); }
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'user-data-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function exportAuditLog(){
        const raw = localStorage.getItem('audit_log') || '[]';
        const blob = new Blob([raw], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'audit-log.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      }

      function simulateConsentBanner(){
        const txt = document.getElementById('privacy_consent_text')?.value || 'We use information to improve service. Do you consent?';
        // show a small modal banner to simulate user consent
        let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML = '';
        const box = document.createElement('div'); box.style.padding='18px'; box.style.background='var(--panel)'; box.style.border='1px solid var(--border)'; box.style.borderRadius='8px'; box.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">Consent Prompt (Simulation)</div><div style="margin-bottom:12px;">${escapeHtml(txt)}</div>`;
        const accept = document.createElement('button'); accept.className='save-btn'; accept.textContent='Accept'; accept.addEventListener('click', ()=>{ document.getElementById('privacy_consent_enabled').checked = true; const s = loadPrivacySettings(); s.consent_enabled = true; savePrivacy(); panel.remove(); alert('Simulated consent accepted'); });
        const reject = document.createElement('button'); reject.className='btn'; reject.textContent='Reject'; reject.style.background='#d9534f'; reject.addEventListener('click', ()=>{ document.getElementById('privacy_consent_enabled').checked = false; const s = loadPrivacySettings(); s.consent_enabled = false; savePrivacy(); panel.remove(); alert('Simulated consent rejected'); });
        box.appendChild(accept); box.appendChild(reject); panel.appendChild(box);
      }

      // Privacy helpers: Preview PII redaction on recent conversations and purge old data
      function runPiiRedactionPreview(){
        const recentRaw = localStorage.getItem('conversations');
        let convs = [];
        try{ convs = recentRaw ? JSON.parse(recentRaw) : []; }catch(e){ convs = []; }
        if(!convs || convs.length===0) return alert('No conversations available for preview');
        const sample = convs[0];
        let text = sample.transcript || sample.text || '';
        // read preferences from privacy settings / checkboxes
        const maskEmail = !!document.getElementById('privacy_pii_email')?.checked;
        const maskPhone = !!document.getElementById('privacy_pii_phone')?.checked;
        const maskNames = !!document.getElementById('privacy_pii_names')?.checked;
        if (maskEmail) text = text.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[REDACTED_EMAIL]');
        if (maskPhone) text = text.replace(/\+?\d[\d\s-]{5,}\d/g, '[REDACTED_PHONE]');
        if (maskNames && sample.customer) text = text.replace(new RegExp(sample.customer,'gi'), '[REDACTED_NAME]');
        // show preview overlay
        let panel = document.getElementById('template_snippets_panel');
        if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
        panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'PII Redaction Preview'; title.style.marginTop='0'; panel.appendChild(title);
        const orig = document.createElement('div'); orig.style.marginTop='12px'; orig.innerHTML = '<strong>Original</strong>'; const preOrig = document.createElement('pre'); preOrig.style.whiteSpace='pre-wrap'; preOrig.style.background='rgba(255,255,255,0.02)'; preOrig.style.padding='12px'; preOrig.style.borderRadius='8px'; preOrig.textContent = sample.transcript || sample.text || '(no text)'; orig.appendChild(preOrig); panel.appendChild(orig);
        const red = document.createElement('div'); red.style.marginTop='12px'; red.innerHTML = '<strong>Redacted</strong>'; const preRed = document.createElement('pre'); preRed.style.whiteSpace='pre-wrap'; preRed.style.background='rgba(255,255,255,0.02)'; preRed.style.padding='12px'; preRed.style.borderRadius='8px'; preRed.textContent = text; red.appendChild(preRed); panel.appendChild(red);
      }

      function purgeExpiredData(){
        const days = Number(document.getElementById('privacy_retention_days')?.value || 0);
        if(!days || days<=0) return alert('Retention days is 0 or not set ‚Äî nothing to purge.');
        if(!confirm('Purge conversations older than ' + days + ' days? This will remove them from local demo storage.')) return;
        const raw = localStorage.getItem('conversations'); let convs = [];
        try{ convs = raw ? JSON.parse(raw) : []; }catch(e){ convs = []; }
        const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
        const kept = convs.filter(c=> { const t = c.datetime || c.created_at || c.ts || null; if(!t) return false; const ts = Date.parse(t) || 0; return ts >= cutoff; });
        localStorage.setItem('conversations', JSON.stringify(kept));
        renderConversations();
        alert('Purged conversations older than ' + days + ' days. Kept ' + kept.length + ' conversations.');
      }

      // Gather all settings from forms and localStorage into a single JSON object
      function setPath(obj, path, value){
        const parts = String(path).split('.');
        let cur = obj;
        for (let i=0;i<parts.length;i++){
          const p = parts[i];
          if (i===parts.length-1){ cur[p] = value; }
          else { cur[p] = cur[p] || {}; cur = cur[p]; }
        }
      }

      function gatherConfig(){
        const config = {};
        // helper to process an element
        function process(el){
          if (!el || !el.type) return;
          const name = el.name || el.id;
          if (!name) return;
          let val = null;
          if (el.type === 'checkbox') val = !!el.checked;
          else if (el.type === 'radio') { if (!el.checked) return; val = el.value; }
          else if (el.type === 'number') val = el.value==='' ? null : Number(el.value);
          else if (el.type === 'file') return; // skip files
          else val = el.value;
          setPath(config, name.replace(/\s+/g,'_'), val);
        }

        // gather from each main form
        const formIds = ['personalityForm','capabilitiesForm','quotesForm','knowledgeForm','appointmentsForm','reservationForm','escalationForm'];
        formIds.forEach(fid => {
          const f = document.getElementById(fid);
          if (!f) return;
          const els = f.querySelectorAll('input,select,textarea');
          els.forEach(process);
        });

        // include avatar preview if present
        const avatar = document.getElementById('avatar_preview');
        if (avatar && avatar.src) setPath(config, 'personality.avatar', avatar.src);

        // include localStorage knowledge and privacy items
        try{
          const keys = ['knowledge_faqs','recent_questions','privacy_settings','storage_settings'];
          keys.forEach(k=>{ const v = localStorage.getItem(k); setPath(config, k, v ? JSON.parse(v) : null); });
        }catch(e){ console.warn('gatherConfig parse', e); }

        // small metadata
        setPath(config, 'meta.exported_at', new Date().toISOString());
        return config;
      }

      function exportAllSettings(){
        const cfg = gatherConfig();
        // wrap in canonical top-level object for downstream consumers
        const payload = { ai_agent_config: cfg };
        const fname = `ai-agent-config-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // wire header export button
      document.getElementById('export_config_btn')?.addEventListener('click', exportAllSettings);

      // --- Import Settings (JSON) ---
      (function(){
        const importBtn = document.getElementById('import_config_btn');
        const importFile = document.getElementById('import_config_file');
        const previewPanel = document.getElementById('import_preview');
        const changesEl = document.getElementById('import_changes');
        const applyBtn = document.getElementById('apply_import_btn');
        // schema/validator placeholders
        let configSchema = null;
        let validateFn = null;

        // load JSON Schema and compile Ajv validator (if Ajv loaded)
        async function loadConfigSchema(){
          try{
            const res = await fetch('ai_agent_config.schema.json');
            if (!res.ok) return console.warn('Could not load schema:', res.status);
            configSchema = await res.json();
            if (window.Ajv){
              const ajv = new window.Ajv({allErrors:true, verbose:true});
              validateFn = ajv.compile(configSchema);
              console.log('ai_agent_config schema loaded and validator compiled');
            } else {
              console.warn('Ajv not available for schema validation');
            }
          }catch(e){ console.warn('loadConfigSchema error', e); }
        }
        loadConfigSchema();
        let pendingConfig = null;

        function flatten(obj, prefix=''){
          const out = {};
          if (obj && typeof obj === 'object' && !Array.isArray(obj)){
            for (const k of Object.keys(obj)){
              const p = prefix ? `${prefix}.${k}` : k;
              if (obj[k] && typeof obj[k] === 'object' && !Array.isArray(obj[k])){
                Object.assign(out, flatten(obj[k], p));
              } else {
                out[p] = obj[k];
              }
            }
          } else if (Array.isArray(obj)){
            out[prefix] = obj;
          }
          return out;
        }

        function showPreview(newCfg){
          // If we have a schema validator, validate before showing diffs
          if (validateFn){
            const valid = validateFn(newCfg);
            if (!valid){
              changesEl.innerHTML = '<div style="color:#b00020; font-weight:700; margin-bottom:8px;">Validation errors detected ‚Äî import cannot be applied.</div>';
              const ul = document.createElement('div');
              (validateFn.errors||[]).forEach(err=>{
                const e = document.createElement('div');
                e.style.fontFamily='monospace'; e.style.fontSize='0.95rem';
                e.textContent = `${err.dataPath || err.instancePath || ''} ${err.message}`;
                ul.appendChild(e);
              });
              changesEl.appendChild(ul);
              previewPanel.style.display = 'block';
              if (applyBtn) applyBtn.disabled = true;
              return;
            } else {
              if (applyBtn) applyBtn.disabled = false;
            }
          }
          const current = gatherConfig();
          const flatNew = flatten(newCfg);
          const flatCur = flatten(current);
          const keys = Object.keys(flatNew).sort();
          const lines = [];
          keys.forEach(k=>{
            const nv = flatNew[k];
            const cv = flatCur[k]===undefined ? '<missing>' : flatCur[k];
            if (JSON.stringify(nv) !== JSON.stringify(cv)){
              lines.push({k, cv, nv});
            }
          });
          changesEl.innerHTML = '';
          if (lines.length===0){ changesEl.innerHTML = '<div>No differences detected. The imported file matches current settings.</div>'; }
          else{
            lines.forEach(item=>{
              const row = document.createElement('div');
              row.style.padding = '6px 0';
              row.innerHTML = `<div style="font-weight:600;">${item.k}</div><div style="color:var(--muted);">Current: ${escapeHtml(String(item.cv))}</div><div style="color:var(--fg);">New: ${escapeHtml(String(item.nv))}</div>`;
              changesEl.appendChild(row);
            });
          }
          previewPanel.style.display = 'block';
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function applyConfig(cfg){
          // revalidate at apply time if we have schema
          if (validateFn){
            const ok = validateFn(cfg);
            if (!ok){
              alert('Imported file failed schema validation. See preview for details.');
              return;
            }
          }
          // Flatten cfg and apply to form fields or localStorage
          const flat = flatten(cfg);
          Object.keys(flat).forEach(path=>{
            const val = flat[path];
            // try name selector
            const elByName = document.querySelector(`[name="${path}"]`);
            const elById = document.getElementById(path) || document.getElementById(path.replace(/\./g,'_'));
            if (elByName || elById){
              const el = elByName || elById;
              if (el.type === 'checkbox') { el.checked = !!val; el.dispatchEvent(new Event('change',{bubbles:true})); }
              else if (el.type === 'radio') { if (el.value === String(val)) { el.checked = true; el.dispatchEvent(new Event('change',{bubbles:true})); } }
              else { el.value = (val===null ? '' : val); el.dispatchEvent(new Event('input',{bubbles:true})); }
              return;
            }
            // fallback to localStorage key
            try{
              // If path is a known local key
              const simpleKey = path;
              if (['knowledge_faqs','recent_questions','privacy_settings','storage_settings'].includes(simpleKey)){
                localStorage.setItem(simpleKey, JSON.stringify(val));
              }
              // personality.avatar can be data URL
              if (path === 'personality.avatar' && document.getElementById('avatar_preview')){
                document.getElementById('avatar_preview').src = val;
              }
            }catch(e){ console.warn('applyConfig error', e); }
          });

          // Reinitialize affected UIs
          try{ loadKnowledge(); }catch(e){}
          try{ loadPrivacy(); }catch(e){}
          try{ updateSectionState(); }catch(e){}
          alert('‚úì Imported settings applied to the UI (some items saved to localStorage). Review and click Save where needed.');
        }

        // file selection
        importBtn?.addEventListener('click', ()=> importFile.click());
        importFile?.addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = function(){
            try{
              const json = JSON.parse(reader.result);
              pendingConfig = json;
              showPreview(json);
            }catch(err){
              alert('Could not parse JSON: ' + err.message);
              pendingConfig = null;
            }
          };
          reader.readAsText(f);
        });

        document.getElementById('cancel_import_btn')?.addEventListener('click', ()=>{ previewPanel.style.display='none'; pendingConfig=null; importFile.value=''; });
        document.getElementById('apply_import_btn')?.addEventListener('click', ()=>{
          if (!pendingConfig) return alert('No pending import to apply');
          // basic validation: must be object
          if (typeof pendingConfig !== 'object') return alert('Invalid config file');
          applyConfig(pendingConfig);
          previewPanel.style.display='none'; pendingConfig=null; importFile.value='';
        });
      })();

      function deleteUserData(){
        if (!confirm('Delete locally stored demo data? This removes saved FAQs, recent questions and privacy settings from this browser.')) return;
        ['privacy_settings','storage_settings','knowledge_faqs','recent_questions'].forEach(k=> localStorage.removeItem(k));
        alert('‚úì Local demo data removed');
        loadPrivacy();
        // also refresh FAQ list
        const container = document.getElementById('faqs_list'); if (container) container.innerHTML='';
        const recentEl = document.getElementById('recent_questions'); if (recentEl) recentEl.innerHTML='';
        loadKnowledge();
      }

      function renderSnapsPreview(){
        const previewEl = document.getElementById('snaps_preview');
        if (!previewEl) return;
        previewEl.innerHTML = '';
        try{
          const recentRaw = localStorage.getItem('recent_questions');
          const recent = recentRaw ? JSON.parse(recentRaw) : [];
          const sRaw = localStorage.getItem('storage_settings');
          const s = sRaw ? JSON.parse(sRaw) : {snaps_last_n:10};
          const items = (recent || []).slice(0, s.snaps_last_n || 10);
          if (items.length===0) previewEl.textContent = 'No snaps available.';
          items.forEach(it=>{
            const d = document.createElement('div'); d.style.padding='6px 0'; d.style.borderBottom='1px dashed var(--border)'; d.textContent = it.q || it;
            previewEl.appendChild(d);
          });
        }catch(e){ previewEl.textContent = 'Error rendering snaps preview'; }
      }

      // wire buttons
      document.getElementById('export_my_data')?.addEventListener('click', exportUserData);
      document.getElementById('delete_my_data')?.addEventListener('click', deleteUserData);
      document.getElementById('export_audit_log')?.addEventListener('click', exportAuditLog);
      document.getElementById('simulate_consent')?.addEventListener('click', simulateConsentBanner);
      document.getElementById('snaps_export_btn')?.addEventListener('click', ()=>{
        // lightweight export of snaps: use recent_questions
        const recentRaw = localStorage.getItem('recent_questions');
        const blob = new Blob([recentRaw || '[]'], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'conversation-snaps.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // expose savePrivacy globally for button onclick
      window.savePrivacy = savePrivacy;

      // initialize on load
      loadPrivacy();
    })();

    // Set year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    /* --- Conversation & Transcript Management --- */
    function loadConversations(){
      try{
        const raw = localStorage.getItem('conversations');
        const arr = raw ? JSON.parse(raw) : sampleConversations();
        return arr;
      }catch(e){ console.warn('loadConversations', e); return []; }
    }

    function sampleConversations(){
      // small sample data if none present
      const s = [
        {id: 'c1', customer: 'Alice', datetime: new Date().toISOString(), transcript: 'Hi, I need to change my password. My email is alice@example.com and phone 555-1234.', flagged:false},
        {id: 'c2', customer: 'Bob', datetime: new Date().toISOString(), transcript: 'I want to cancel my service. My account is bob@example.com', flagged:true}
      ];
      localStorage.setItem('conversations', JSON.stringify(s));
      return s;
    }

    function renderConversations(){
      const listEl = document.getElementById('conversations_list');
      if (!listEl) return;
      const q = document.getElementById('transcript_search')?.value?.toLowerCase()||'';
      const convs = loadConversations().filter(c=> !q || (c.customer||'').toLowerCase().includes(q) || (c.transcript||'').toLowerCase().includes(q));
      listEl.innerHTML = '';
      convs.forEach(c=>{
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='12px'; el.style.padding='8px'; el.style.border='1px solid var(--border)'; el.style.borderRadius='8px';
        const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(c.customer||'Unknown')}</strong><div style="color:var(--muted); font-size:0.9rem;">${new Date(c.datetime).toLocaleString()}</div><div style="margin-top:6px;">${escapeHtml((c.transcript||'').slice(0,200))}${(c.transcript||'').length>200?'...':''}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.convId = c.id;
        const btnPreview = document.createElement('button'); btnPreview.className='btn'; btnPreview.textContent='Preview Redaction'; btnPreview.addEventListener('click', ()=> showRedactionPreview(c.id));
        const btnExport = document.createElement('button'); btnExport.className='btn'; btnExport.textContent='Export'; btnExport.addEventListener('click', ()=> exportConversation(c.id));
        const btnPurge = document.createElement('button'); btnPurge.className='btn'; btnPurge.style.background='#d9534f'; btnPurge.textContent='Purge'; btnPurge.addEventListener('click', ()=> purgeConversation(c.id));
        const btnFlag = document.createElement('button'); btnFlag.className='btn'; btnFlag.textContent = c.flagged ? 'Unflag' : 'Flag'; btnFlag.addEventListener('click', ()=> toggleFlag(c.id));
        controls.appendChild(chk); controls.appendChild(btnPreview); controls.appendChild(btnExport); controls.appendChild(btnFlag); controls.appendChild(btnPurge);
        el.appendChild(left); el.appendChild(controls);
        listEl.appendChild(el);
      });
    }

    function getConversationById(id){ return loadConversations().find(c=>c.id===id); }

    function showRedactionPreview(id){
      const conv = getConversationById(id); if (!conv) return alert('Conversation not found');
      const maskEmail = !!document.getElementById('redact_email')?.checked;
      const maskPhone = !!document.getElementById('redact_phone')?.checked;
      const maskNames = !!document.getElementById('redact_names')?.checked;
      let text = conv.transcript || '';
      if (maskEmail) text = text.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[REDACTED_EMAIL]');
      if (maskPhone) text = text.replace(/\+?\d[\d\s-]{5,}\d/g, '[REDACTED_PHONE]');
      if (maskNames) text = text.replace(new RegExp(conv.customer,'gi'), '[REDACTED_NAME]');
      document.getElementById('redaction_preview').textContent = text;
    }

    function exportConversation(id){
      const conv = getConversationById(id); if (!conv) return alert('Conversation not found');
      const blob = new Blob([JSON.stringify(conv, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `conversation-${conv.id}.json`; document.body.appendChild(a); a.click(); a.remove();
    }

    function exportSelectedConversations(){
      const checks = Array.from(document.querySelectorAll('#conversations_list input[type="checkbox"]')).filter(c=>c.checked);
      if (checks.length===0) return alert('Select at least one conversation');
      const ids = checks.map(c=>c.dataset.convId);
      const convs = loadConversations().filter(c=> ids.includes(c.id));
      const blob = new Blob([JSON.stringify(convs, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `conversations-export-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove();
    }

    function purgeConversation(id){
      if (!confirm('Purge this conversation? This cannot be undone (demo: localStorage only).')) return;
      const arr = loadConversations().filter(c=> c.id !== id);
      localStorage.setItem('conversations', JSON.stringify(arr));
      renderConversations();
      alert('Conversation purged (local demo)');
    }

    function purgeAllConversations(){
      if (!confirm('Purge ALL conversations stored locally?')) return;
      localStorage.removeItem('conversations'); renderConversations(); alert('All local conversations removed');
    }

    function toggleFlag(id){
      const arr = loadConversations().map(c=> { if (c.id===id) c.flagged = !c.flagged; return c; }); localStorage.setItem('conversations', JSON.stringify(arr)); renderConversations(); }

    /* --- Payments & Billing Controls (demo) --- */
    function savePaymentSettings(){
      try{
        const p = {
          provider: document.getElementById('payment_provider').value,
          mode: document.getElementById('payment_mode').value,
          api_key: document.getElementById('payment_api_key').value,
          deposit_capture: !!document.getElementById('deposit_capture').checked,
          deposit_default: Number(document.getElementById('deposit_amount_default').value||0),
          refunds_log: document.getElementById('refunds_log_link').value||''
        };
        localStorage.setItem('payments_settings', JSON.stringify(p));
        alert('‚úì Payment settings saved (demo)');
      }catch(e){ console.warn('savePaymentSettings', e); alert('Could not save payments settings'); }
    }

    /* --- Backup / Versioning (demo) --- */
    function listBackups(){
      try{
        const raw = localStorage.getItem('backups');
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }

    function saveBackupsList(arr){ localStorage.setItem('backups', JSON.stringify(arr)); }

    function createBackup(){
      const cfg = gatherConfig();
      const backups = listBackups();
      const id = 'b-' + new Date().toISOString().replace(/[:.]/g,'-');
      backups.unshift({id, created_at: new Date().toISOString(), config: cfg});
      // keep latest 20
      saveBackupsList(backups.slice(0,20));
      renderBackups();
      alert('Backup created: ' + id);
    }

    function renderBackups(){
      const el = document.getElementById('backups_list'); if (!el) return; const items = listBackups(); el.innerHTML = '';
      items.forEach(b=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; row.style.marginBottom='8px';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${b.id}</div><div style="color:var(--muted)">${new Date(b.created_at).toLocaleString()}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Download'; dl.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(b.config,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = b.id + '.json'; document.body.appendChild(a); a.click(); a.remove(); });
        const restore = document.createElement('button'); restore.className='btn'; restore.textContent='Restore'; restore.addEventListener('click', ()=>{ if (!confirm('Restore this backup? This will update the UI and localStorage (demo).')) return; applyConfig(b.config); });
        const cmp = document.createElement('button'); cmp.className='btn'; cmp.textContent='Compare'; cmp.addEventListener('click', ()=>{ showPreview(b.config); });
        controls.appendChild(dl); controls.appendChild(restore); controls.appendChild(cmp);
        row.appendChild(left); row.appendChild(controls); el.appendChild(row);
      });
    }

    function downloadLatestBackup(){ const b = listBackups()[0]; if (!b) return alert('No backups available'); const blob = new Blob([JSON.stringify(b.config,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = b.id + '.json'; document.body.appendChild(a); a.click(); a.remove(); }

    function scheduleDemoBackup(){
      // demo: schedule a single backup in 5 seconds to demonstrate scheduling
      alert('Scheduling demo backup in 5 seconds (demo only)'); setTimeout(()=>{ createBackup(); }, 5000);
    }

    /* --- Analytics: Intents CSV export --- */
    function loadIntentTrends(){
      try{
        const from = document.getElementById('intents_from').value;
        const to = document.getElementById('intents_to').value;
        // demo: fetch sample trends from localStorage or synthesize
        const raw = localStorage.getItem('intent_trends');
        let arr = raw ? JSON.parse(raw) : [ {date: new Date().toISOString().slice(0,10), intent:'password_reset', count:12}, {date: new Date().toISOString().slice(0,10), intent:'billing', count:5} ];
        const out = arr.filter(r=> { if (!from && !to) return true; const d = r.date; if (from && d<from) return false; if (to && d>to) return false; return true; });
        const el = document.getElementById('intent_trends_preview'); el.innerHTML = '';
        out.forEach(o=>{ const row = document.createElement('div'); row.textContent = `${o.date} ‚Äî ${o.intent} ‚Äî ${o.count}`; el.appendChild(row); });
      }catch(e){ console.warn('loadIntentTrends', e); }
    }

    function exportIntentCSV(){
      try{
        const raw = localStorage.getItem('intent_trends');
        const arr = raw ? JSON.parse(raw) : [];
        if (arr.length===0) return alert('No intent trend data to export');
        const headers = Object.keys(arr[0]);
        const rows = [headers.join(',')].concat(arr.map(r=> headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(',')) ).join('\n');
        const blob = new Blob([rows], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `intent-trends-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ console.warn('exportIntentCSV', e); }
    }

    // initialize new areas
    renderConversations(); renderBackups(); loadIntentTrends();

    /* --- Model / Training Controls --- */
    function loadTrainingQueue(){
      try{ const raw = localStorage.getItem('training_samples'); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveTrainingQueue(arr){ localStorage.setItem('training_samples', JSON.stringify(arr)); }

    function renderTrainingQueue(){
      const container = document.getElementById('training_queue'); if (!container) return;
      const q = loadTrainingQueue();
      if (q.length===0){ container.style.display='block'; container.innerHTML='<div class="helper-text">No samples in the reviewer queue.</div>'; return; }
      container.style.display='block'; container.innerHTML='';
      q.forEach((s, idx)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='12px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; row.style.marginBottom='8px';
        const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<div style="font-weight:700">Sample ${s.id || idx+1} ${s.flagged?'<span style="color:#b00020; font-weight:600; margin-left:8px;">FLAGGED</span>':''}</div><div style="color:var(--muted);">${new Date(s.datetime).toLocaleString()}</div><div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(s.text||'')}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const accept = document.createElement('button'); accept.className='btn'; accept.textContent='Accept'; accept.addEventListener('click', ()=>{ acceptTrainingSample(s.id); });
        const reject = document.createElement('button'); reject.className='btn'; reject.textContent='Reject'; reject.addEventListener('click', ()=>{ rejectTrainingSample(s.id); });
        const del = document.createElement('button'); del.className='btn'; del.style.background='#d9534f'; del.textContent='Remove'; del.addEventListener('click', ()=>{ removeTrainingSample(s.id); });
        controls.appendChild(accept); controls.appendChild(reject); controls.appendChild(del);
        row.appendChild(left); row.appendChild(controls); container.appendChild(row);
      });
    }

    function enqueueSampleFromRecent(){
      // demo: take first recent question and add to training_samples
      const recentRaw = localStorage.getItem('recent_questions'); const recent = recentRaw ? JSON.parse(recentRaw) : [];
      const one = recent && recent.length ? recent[0] : {q:'Sample training text', id: 's-' + Date.now()};
      const samples = loadTrainingQueue(); samples.unshift({id: 't-' + Date.now(), datetime: new Date().toISOString(), text: one.q}); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample enqueued for review');
    }

    function acceptTrainingSample(id){ const samples = loadTrainingQueue(); const idx = samples.findIndex(s=>s.id===id); if (idx===-1) return; // in demo, mark accepted and remove
      samples.splice(idx,1); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample accepted (demo)'); }

    function rejectTrainingSample(id){ const samples = loadTrainingQueue(); const idx = samples.findIndex(s=>s.id===id); if (idx===-1) return; samples.splice(idx,1); saveTrainingQueue(samples); renderTrainingQueue(); alert('Sample rejected (demo)'); }

    function removeTrainingSample(id){ const samples = loadTrainingQueue().filter(s=>s.id!==id); saveTrainingQueue(samples); renderTrainingQueue(); }

    // wire the visible training toggle (sync with existing toggle-btn behavior)
    const trainingBtn = document.querySelector('.toggle-btn[data-checkbox="training_enabled"]');
    const trainingCb = document.getElementById('training_enabled');
    if (trainingBtn && trainingCb) {
      trainingBtn.addEventListener('click', ()=>{
        trainingCb.checked = !trainingCb.checked;
        trainingCb.dispatchEvent(new Event('change',{bubbles:true}));
        trainingBtn.classList.toggle('on', trainingCb.checked);
        trainingBtn.querySelector('.label').textContent = trainingCb.checked ? 'On' : 'Off';
      });
      trainingCb.addEventListener('change', ()=>{
        trainingBtn.classList.toggle('on', trainingCb.checked);
        trainingBtn.querySelector('.label').textContent = trainingCb.checked ? 'On' : 'Off';
      });
    }

    /* --- Templates & Snippets --- */
    function loadTemplates(){ try{ const raw = localStorage.getItem('templates'); return raw?JSON.parse(raw):[]; }catch(e){return[];} }
    function saveTemplates(arr){ localStorage.setItem('templates', JSON.stringify(arr)); }

    function renderTemplatesList(){ const list = document.getElementById('templates_list'); const sel = document.getElementById('preview_template'); if(!list||!sel) return; const templates = loadTemplates(); list.innerHTML=''; sel.innerHTML=''; templates.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='6px'; row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(t.name)}</strong><div style="color:var(--muted);">${escapeHtml((t.body||'').slice(0,120))}${(t.body||'').length>120?'...':''}</div></div>`; const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.addEventListener('click', ()=> editTemplate(i)); const rem = document.createElement('button'); rem.className='btn'; rem.textContent='Remove'; rem.style.background='#d9534f'; rem.addEventListener('click', ()=>{ const arr = loadTemplates(); arr.splice(i,1); saveTemplates(arr); renderTemplatesList(); }); row.appendChild(edit); row.appendChild(rem); list.appendChild(row); const opt = document.createElement('option'); opt.value = i; opt.textContent = t.name; sel.appendChild(opt); }); }

    function addTemplateEditor(){ const arr = loadTemplates(); const name = prompt('Template name'); if (!name) return; const body = prompt('Template body (use {{variable}})'); arr.push({name, body}); saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); }

    function editTemplate(index){ const arr = loadTemplates(); const t = arr[index]; const name = prompt('Edit name', t.name); if (!name) return; const body = prompt('Edit body', t.body); arr[index] = {name, body}; saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); }

    function updateTemplatePreview(){ const sel = document.getElementById('preview_template'); const varsEl = document.getElementById('preview_vars'); const preview = document.getElementById('template_preview'); if(!sel||!preview) return; const idx = Number(sel.value); const arr = loadTemplates(); if (!arr[idx]) { preview.textContent=''; return; } let body = arr[idx].body||''; try{ const vars = varsEl && varsEl.value ? JSON.parse(varsEl.value) : {}; Object.keys(vars).forEach(k=>{ const re = new RegExp('{{\\s*'+k+'\\s*}}','g'); body = body.replace(re, vars[k]); }); }catch(e){ /* ignore parse error */ }
      preview.textContent = body;
    }

    // Import templates or text snippets via hidden file input
    function importTemplates(){ const f = document.getElementById('template_import_file'); if(!f) return alert('File input not available'); f.value = ''; f.click(); }

    function handleTemplateFile(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const name = file.name || 'upload';
      const reader = new FileReader();
      reader.onload = function(){
        const txt = String(reader.result || '');
        if(name.toLowerCase().endsWith('.json')){
          try{ const parsed = JSON.parse(txt); if(Array.isArray(parsed)){
            const cur = loadTemplates(); const merged = cur.concat(parsed); saveTemplates(merged); renderTemplatesList(); updateTemplatePreview(); alert('Imported '+parsed.length+' templates');
          } else if(parsed.templates && Array.isArray(parsed.templates)){
            const cur = loadTemplates(); const merged = cur.concat(parsed.templates); saveTemplates(merged); renderTemplatesList(); updateTemplatePreview(); alert('Imported '+parsed.templates.length+' templates');
          } else { alert('JSON file did not contain an array of templates'); }
          }catch(err){ alert('Failed to parse JSON: '+err.message); }
        } else if(name.toLowerCase().endsWith('.txt')){
          // split into paragraphs and show chooser
          const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean);
          if(parts.length===0) return alert('No text found in file');
          showSnippetChooser(parts, name);
        } else {
          alert('Unsupported file type. Use .json or .txt');
        }
      };
      reader.readAsText(file);
    }

    // Document upload helpers (Knowledge tab) - trigger hidden input
    function importDocument(){ const f = document.getElementById('document_import_file'); if(!f) return alert('Document input not available'); f.value=''; f.click(); }

    function handleDocumentFile(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const name = file.name || 'doc'; const reader = new FileReader();
      reader.onload = function(){
        const txt = String(reader.result || ''); if(!txt.trim()) return alert('No text found');
        // save uploaded document to local store
        const id = saveUploadedDocument({name: name, text: txt});
        renderDocumentLibrary();
        // split into paragraphs and show chooser for snippet extraction
        const parts = txt.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean);
        if(parts.length===0) return alert('No text snippets found');
        showSnippetChooser(parts, name + ' (uploaded)');
      };
      reader.readAsText(file);
    }

    // Calendar (.ics) import helpers
    function importCalendar(){ const f = document.getElementById('calendar_import_file'); if(!f) return alert('Calendar input not available'); f.value=''; f.click(); }

    function handleCalendarFile(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const name = file.name || 'calendar.ics'; const reader = new FileReader(); reader.onload = function(){ const txt = String(reader.result || ''); if(!txt.trim()) return alert('No calendar content'); const events = parseIcsEvents(txt); const entry = { id: 'c-'+Date.now(), name: name, raw: txt, eventsCount: events.length, created_at: new Date().toISOString() }; const arr = loadUploadedCalendars(); arr.unshift(entry); localStorage.setItem('uploaded_calendars', JSON.stringify(arr)); renderCalendarLibrary(); alert('Imported calendar: ' + name + ' (' + events.length + ' events)'); }; reader.readAsText(file); }

    function parseIcsEvents(ics){ try{ const chunks = ics.split(/BEGIN:VEVENT/i); const evs = []; for(let i=1;i<chunks.length;i++){ const section = chunks[i]; const lines = section.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const obj = {}; lines.forEach(l=>{ const idx = l.indexOf(':'); if(idx>0){ const k = l.slice(0, idx).toUpperCase(); const v = l.slice(idx+1); obj[k]= (obj[k] ? obj[k] + '\n' + v : v); } }); evs.push(obj); } return evs; }catch(e){ return []; } }

    function loadUploadedCalendars(){ try{ const raw = localStorage.getItem('uploaded_calendars'); return raw?JSON.parse(raw):[];}catch(e){return[]} }

    function renderCalendarLibrary(){ const container = document.getElementById('uploaded_calendars_list'); if(!container) return; const arr = loadUploadedCalendars(); container.innerHTML=''; if(arr.length===0){ container.innerHTML = '<div class="helper-text">No calendars uploaded. Use Upload .ics Calendar to add a calendar for demo/testing.</div>'; return; } arr.forEach(c=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px'; const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<strong>${escapeHtml(c.name)}</strong><div style="color:var(--muted); font-size:0.9rem;">Events: ${c.eventsCount} ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>`; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.flexDirection='column'; controls.style.gap='6px'; const view = document.createElement('button'); view.className='btn'; view.textContent='View'; view.addEventListener('click', ()=> viewCalendar(c.id)); const extract = document.createElement('button'); extract.className='btn'; extract.textContent='Extract Events'; extract.addEventListener('click', ()=> { const arr = loadUploadedCalendars(); const found = arr.find(x=>x.id===c.id); if(!found) return alert('Calendar not found'); const events = parseIcsEvents(found.raw); const parts = events.map(e=> (e.DESCRIPTION||e.SUMMARY||'')).filter(Boolean); if(parts.length===0) return alert('No textual event descriptions to extract'); showSnippetChooser(parts, found.name + ' (events)'); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=> removeCalendar(c.id)); controls.appendChild(view); controls.appendChild(extract); controls.appendChild(rem); row.appendChild(left); row.appendChild(controls); container.appendChild(row); }); }

    function viewCalendar(id){ const arr = loadUploadedCalendars(); const c = arr.find(x=>x.id===id); if(!c) return alert('Calendar not found'); let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
      panel.innerHTML=''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent = c.name + ' ‚Äî Calendar'; title.style.marginTop='0'; panel.appendChild(title);
      const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginBottom='8px'; meta.textContent = 'Imported: ' + new Date(c.created_at).toLocaleString() + ' ‚Äî Events: ' + c.eventsCount; panel.appendChild(meta);
      const content = document.createElement('pre'); content.style.whiteSpace='pre-wrap'; content.style.background='rgba(255,255,255,0.02)'; content.style.padding='12px'; content.style.borderRadius='8px'; content.textContent = c.raw; panel.appendChild(content);
    }

    function removeCalendar(id){ if(!confirm('Remove this uploaded calendar?')) return; const arr = loadUploadedCalendars().filter(x=>x.id!==id); localStorage.setItem('uploaded_calendars', JSON.stringify(arr)); renderCalendarLibrary(); alert('Calendar removed'); }

    function testCalendarConnection(){ alert('Calendar connection test (demo): this would attempt OAuth/API connection in production.'); }

    // Uploaded documents storage helpers
    function loadUploadedDocuments(){ try{ const raw = localStorage.getItem('uploaded_documents'); return raw?JSON.parse(raw):[];}catch(e){return[]} }
    function saveUploadedDocument(doc){ const arr = loadUploadedDocuments(); const id = 'd-'+Date.now(); const entry = { id, name: doc.name||('doc-'+Date.now()), text: doc.text||'', created_at: new Date().toISOString() }; arr.unshift(entry); localStorage.setItem('uploaded_documents', JSON.stringify(arr)); return entry.id; }

    function renderDocumentLibrary(){ const container = document.getElementById('uploaded_docs_list'); if(!container) return; const docs = loadUploadedDocuments(); container.innerHTML=''; if(docs.length===0){ container.innerHTML = '<div class="helper-text">No documents uploaded yet. Use "Upload Company Doc" to add files.</div>'; return; }
      docs.forEach(d=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.border='1px solid var(--border)'; row.style.borderRadius='8px';
        const left = document.createElement('div'); left.style.flex='1'; const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(d.name)}</strong> <div style="color:var(--muted); font-size:0.9rem;">${new Date(d.created_at).toLocaleString()}</div>`; const preview = document.createElement('div'); preview.style.marginTop='6px'; preview.style.color='var(--muted)'; preview.style.whiteSpace='pre-wrap'; preview.textContent = (d.text||'').slice(0,280) + ((d.text||'').length>280 ? '...' : ''); left.appendChild(title); left.appendChild(preview);
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.flexDirection='column'; controls.style.gap='6px'; const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=> viewDocument(d.id)); const extractBtn = document.createElement('button'); extractBtn.className='btn'; extractBtn.textContent='Extract Snippets'; extractBtn.addEventListener('click', ()=> { const parts = (d.text||'').split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean); if(parts.length===0) return alert('No snippets found'); showSnippetChooser(parts, d.name); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=> removeDocument(d.id)); controls.appendChild(viewBtn); controls.appendChild(extractBtn); controls.appendChild(rem);
        row.appendChild(left); row.appendChild(controls); container.appendChild(row);
      }); }

    function viewDocument(id){ const docs = loadUploadedDocuments(); const d = docs.find(x=>x.id===id); if(!d) return alert('Document not found'); // reuse overlay panel if present
      let panel = document.getElementById('template_snippets_panel'); if(!panel){ panel = document.createElement('div'); panel.id='template_snippets_panel'; panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff'; document.body.appendChild(panel); }
      panel.innerHTML = ''; const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
      const title = document.createElement('h3'); title.textContent = d.name + ' ‚Äî Uploaded Document'; title.style.marginTop='0'; panel.appendChild(title);
      const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginBottom='8px'; meta.textContent = 'Uploaded: ' + new Date(d.created_at).toLocaleString(); panel.appendChild(meta);
      const content = document.createElement('pre'); content.style.whiteSpace='pre-wrap'; content.style.background='rgba(255,255,255,0.02)'; content.style.padding='12px'; content.style.borderRadius='8px'; content.textContent = d.text; panel.appendChild(content);
    }

    function removeDocument(id){ if(!confirm('Remove this uploaded document? This will not affect existing templates/FAQs.')) return; const arr = loadUploadedDocuments().filter(d=> d.id!==id); localStorage.setItem('uploaded_documents', JSON.stringify(arr)); renderDocumentLibrary(); alert('Document removed'); }

    // show a simple chooser panel to accept snippets as templates
    function showSnippetChooser(snippets, filename){
      // create overlay
      let panel = document.getElementById('template_snippets_panel');
      if(!panel){
        panel = document.createElement('div'); panel.id='template_snippets_panel';
        panel.style.position='fixed'; panel.style.left='12px'; panel.style.right='12px'; panel.style.top='12px'; panel.style.bottom='12px'; panel.style.background='rgba(11,13,18,0.95)'; panel.style.zIndex=9999; panel.style.overflow='auto'; panel.style.padding='18px'; panel.style.borderRadius='12px'; panel.style.color='#fff';
        const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.style.float='right'; closeBtn.addEventListener('click', ()=> panel.remove()); panel.appendChild(closeBtn);
        const title = document.createElement('h3'); title.textContent = 'Import snippets from '+filename; title.style.marginTop='0'; panel.appendChild(title);
        const container = document.createElement('div'); container.id='template_snippets_container'; container.style.marginTop='12px'; panel.appendChild(container);
        document.body.appendChild(panel);
      }
      const container = document.getElementById('template_snippets_container'); container.innerHTML='';
      snippets.forEach((s, i)=>{
        const card = document.createElement('div'); card.style.padding='12px'; card.style.border='1px solid rgba(255,255,255,0.06)'; card.style.borderRadius='8px'; card.style.marginBottom='8px'; card.style.background='rgba(255,255,255,0.02)';
        const text = document.createElement('div'); text.style.whiteSpace='pre-wrap'; text.style.color='#fff'; text.textContent = s;
        const controls = document.createElement('div'); controls.style.marginTop='8px'; controls.style.display='flex'; controls.style.gap='8px';
        const tBtn = document.createElement('button'); tBtn.className='btn'; tBtn.textContent='Create Template'; tBtn.addEventListener('click', ()=> createTemplateFromSnippet(s));
        const fBtn = document.createElement('button'); fBtn.className='btn'; fBtn.textContent='Add as FAQ'; fBtn.addEventListener('click', ()=> createFaqFromSnippet(s));
        controls.appendChild(tBtn); controls.appendChild(fBtn);
        card.appendChild(text); card.appendChild(controls); container.appendChild(card);
      });
    }

    function createFaqFromSnippet(text){
      const question = prompt('Enter a short question/title for this FAQ (suggested)', (text||'').split('\n')[0].slice(0,60));
      if (!question) return;
      renderFaqRow(question, text);
      alert('FAQ snippet added ‚Äî remember to Save FAQ Knowledge to persist');
    }

    function createTemplateFromSnippet(text){
      const name = prompt('Template name (suggested)', (text||'').slice(0,24).trim() || 'Template'); if(!name) return;
      const arr = loadTemplates(); arr.push({name: name, body: text}); saveTemplates(arr); renderTemplatesList(); updateTemplatePreview(); alert('Template created: '+name);
    }

    function exportTemplates(){ const arr = loadTemplates()||[]; const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='templates.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    /* --- Accessibility & Localization --- */
    function loadTranslations(){ try{ const raw = localStorage.getItem('translations'); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function saveTranslations(arr){ localStorage.setItem('translations', JSON.stringify(arr)); }

    function renderTranslations(){ const list = document.getElementById('translations_list'); if(!list) return; const arr = loadTranslations(); list.innerHTML=''; arr.forEach((t,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; const k = document.createElement('input'); k.value = t.key; k.style.width='35%'; const v = document.createElement('input'); v.value = t.value; v.style.flex='1'; const save = document.createElement('button'); save.className='btn'; save.textContent='Save'; save.addEventListener('click', ()=>{ const data = loadTranslations(); data[i] = {key:k.value, value:v.value}; saveTranslations(data); renderTranslations(); }); const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ const data = loadTranslations(); data.splice(i,1); saveTranslations(data); renderTranslations(); }); row.appendChild(k); row.appendChild(v); row.appendChild(save); row.appendChild(rem); list.appendChild(row); }); }

    function addTranslationRow(){ const arr = loadTranslations(); arr.push({key:'new.key', value:'New Value'}); saveTranslations(arr); renderTranslations(); }

    function toggleRTLPreview(){ const el = document.body; if (el.dir === 'rtl'){ el.dir = 'ltr'; alert('RTL preview disabled'); } else { el.dir = 'rtl'; alert('RTL preview enabled'); } }

    function previewSSML(){ const ssml = document.getElementById('ssml_snippet')?.value || ''; alert('SSML preview (demo)\n\n' + ssml); }

    // wire payment save globally
    window.savePaymentSettings = savePaymentSettings;

    /* --- Developer helpers --- */
    function openImportFile(){ const f = document.getElementById('import_config_file'); if (f) f.click(); }
    function showImportPreviewPanel(){ const p = document.getElementById('import_preview'); if (!p) return; p.classList.remove('dev-only'); p.style.display='block'; document.getElementById('dev_output').textContent = 'Import preview opened (developer view)'; }
    function openBackupsTab(){ const btn = document.querySelector('.tab-btn[data-tab="backups"]'); const content = document.getElementById('backups'); if (btn) btn.classList.remove('dev-only'); if (content) content.classList.remove('dev-only'); if (btn) btn.click(); renderBackups(); document.getElementById('dev_output').textContent = 'Backups tab opened (developer view)'; }
    function openTrainingQueueTab(){ const btn = document.querySelector('.tab-btn[data-tab="model"]'); const content = document.getElementById('model'); if (btn) btn.classList.remove('dev-only'); if (content) content.classList.remove('dev-only'); if (btn) btn.click(); renderTrainingQueue(); document.getElementById('dev_output').textContent = 'Training queue opened (developer view)'; }
    function revealPaymentApiKey(){ const s = localStorage.getItem('payments_settings'); if (!s) return document.getElementById('dev_output').textContent = 'No payment settings saved'; try{ const p = JSON.parse(s); document.getElementById('dev_output').textContent = 'Provider: '+(p.provider||'')+'\nMode: '+(p.mode||'')+'\nAPI Key: '+(p.api_key||'(not set)'); }catch(e){ document.getElementById('dev_output').textContent = 'Error reading payment settings'; } }
    function showSSMLRaw(){ const ssml = document.getElementById('ssml_snippet')?.value || ''; document.getElementById('dev_output').textContent = ssml || '(empty)'; }

    // Developer settings storage
    function loadDeveloperSettings(){ try{ const raw = localStorage.getItem('developer_settings'); return raw?JSON.parse(raw):{api_keys:[], webhooks:[], logs:[]}; }catch(e){ return {api_keys:[], webhooks:[], logs:[]}; } }
    function saveDeveloperSettings(obj){ try{ localStorage.setItem('developer_settings', JSON.stringify(obj)); }catch(e){ console.warn('Failed to save developer_settings', e); } }

    // API Keys management (demo only)
    function generateApiKey(){ // random key for demo
      const s = 'sk_' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); return s;
    }
    function createApiKey(){ const name = (document.getElementById('new_api_name')?.value || '').trim(); if(!name) return alert('Provide a name for the key'); const ds = loadDeveloperSettings(); const k = { id: 'key-'+Date.now(), name, key: generateApiKey(), created_at: new Date().toISOString(), revoked:false }; ds.api_keys = ds.api_keys || []; ds.api_keys.unshift(k); saveDeveloperSettings(ds); renderApiKeys(); document.getElementById('new_api_name').value=''; }
    function renderApiKeys(){ const el = document.getElementById('api_keys_list'); if(!el) return; const ds = loadDeveloperSettings(); const arr = ds.api_keys || []; el.innerHTML=''; if(arr.length===0){ el.innerHTML='<div class="helper-text">No API keys yet.</div>'; return; } arr.forEach((k,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)'; const leftHtml = `<div style="flex:1"><strong>${escapeHtml(k.name)}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(k.created_at)}${k.revoked ? ' <span style="color:#d9534f; margin-left:8px">(revoked)</span>' : ''}</div></div>`; row.innerHTML = leftHtml; const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; const show = document.createElement('button'); show.className='btn'; show.textContent='Reveal'; show.addEventListener('click', ()=>{ showModal('API Key '+k.name, '<pre style="white-space:pre-wrap;">'+escapeHtml(k.key)+'</pre>'); }); const rotate = document.createElement('button'); rotate.className='btn'; rotate.textContent='Rotate'; rotate.addEventListener('click', ()=>{ if(!confirm('Rotate key '+k.name+'? Existing consumers will stop working.')) return; k.key = generateApiKey(); k.created_at = new Date().toISOString(); saveDeveloperSettings(ds); renderApiKeys(); }); const revoke = document.createElement('button'); revoke.className='btn'; revoke.style.background='#d9534f'; revoke.textContent='Revoke'; revoke.addEventListener('click', ()=>{ if(!confirm('Revoke key '+k.name+'?')) return; k.revoked = true; saveDeveloperSettings(ds); renderApiKeys(); }); controls.appendChild(show); controls.appendChild(rotate); controls.appendChild(revoke); row.appendChild(controls); el.appendChild(row); }); }

    // Webhook management (client-side demo)
    function loadWebhooks(){ const ds = loadDeveloperSettings(); return ds.webhooks || []; }
    function saveWebhooks(arr){ const ds = loadDeveloperSettings(); ds.webhooks = arr; saveDeveloperSettings(ds); }
    function addWebhook(){ const url = (document.getElementById('new_webhook_url')?.value||'').trim(); const method = (document.getElementById('new_webhook_method')?.value||'POST'); if(!url) return alert('Provide a webhook URL'); const arr = loadWebhooks(); arr.unshift({ id:'wh-'+Date.now(), url, method, created_at: new Date().toISOString() }); saveWebhooks(arr); document.getElementById('new_webhook_url').value=''; renderWebhooks(); }

    function renderWebhooks(){
      const el = document.getElementById('webhooks_list'); if(!el) return;
      const arr = loadWebhooks(); el.innerHTML='';
      if(arr.length===0){ el.innerHTML='<div class="helper-text">No webhooks configured.</div>'; return; }
      arr.forEach((w,i)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--border)';
        row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(w.url)}</strong><div style="color:var(--muted); font-size:0.9rem;">${escapeHtml(w.method)} ¬∑ ${escapeHtml(w.created_at)}</div></div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
        const test = document.createElement('button'); test.className='btn'; test.textContent='Test';
        test.addEventListener('click', ()=>{
          const payload = { event: 'ticket.created', id: 't-'+Date.now(), ts: new Date().toISOString() };
          const html = '<div style="padding:12px;"><div style="margin-bottom:8px;"><strong>POST '+escapeHtml(w.url)+'</strong></div><pre style="white-space:pre-wrap; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px;">'+escapeHtml(JSON.stringify(payload, null, 2))+'</pre></div>';
          showModal('Webhook Test', html);
          appendDevLog('Webhook test for '+w.url+' (simulated)');
        });
        const rem = document.createElement('button'); rem.className='btn'; rem.style.background='#d9534f'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ if(!confirm('Remove webhook?')) return; const a = loadWebhooks(); a.splice(i,1); saveWebhooks(a); renderWebhooks(); });
        controls.appendChild(test); controls.appendChild(rem); row.appendChild(controls); el.appendChild(row);
      });
    }

    // SDK snippets rendering (safe DOM construction)
    function renderSdkSnippets(){
      const el = document.getElementById('sdk_snippets'); if(!el) return;
      const snippets = [
        {title:'cURL', code:"curl -X POST https://api.example.com/v1/agent/query -H \"Authorization: Bearer YOUR_KEY\" -H \"Content-Type: application/json\" -d '{\"query\":\"Hello\"}'"},
        {title:'Node (fetch)', code:"const res = await fetch('https://api.example.com/v1/agent/query',{method:'POST', headers:{'Authorization':'Bearer YOUR_KEY','Content-Type':'application/json'}, body: JSON.stringify({query:'Hello'})}); const body = await res.json();"},
        {title:'Python (requests)', code:"import requests\nres = requests.post('https://api.example.com/v1/agent/query', headers={'Authorization':'Bearer YOUR_KEY', 'Content-Type':'application/json'}, json={'query':'Hello'})\nprint(res.json())"}
      ];
      el.innerHTML = '';
      snippets.forEach(s=>{
        const b = document.createElement('div'); b.style.marginBottom = '10px';
        const title = document.createElement('div'); title.style.fontWeight = '600'; title.textContent = s.title;
        const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.style.background = 'rgba(255,255,255,0.02)'; pre.style.padding = '8px'; pre.style.borderRadius = '6px'; pre.textContent = s.code;
        const controls = document.createElement('div'); controls.style.display = 'flex'; controls.style.gap = '8px';
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn'; copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', ()=>{
          navigator.clipboard.writeText(s.code).then(()=>{ appendDevLog('Copied SDK snippet: '+s.title); alert('Copied snippet to clipboard'); }).catch(()=>{ alert('Copy failed'); });
        });
        controls.appendChild(copyBtn);
        b.appendChild(title); b.appendChild(pre); b.appendChild(controls); el.appendChild(b);
      });
    }

    // Developer logs and test endpoint
    function appendDevLog(entry){ try{ const ds = loadDeveloperSettings(); ds.logs = ds.logs||[]; ds.logs.push({ ts: new Date().toISOString(), entry }); if(ds.logs.length>2000) ds.logs = ds.logs.slice(-1000); saveDeveloperSettings(ds); renderDevLogs(); }catch(e){} }
    function renderDevLogs(){ const el = document.getElementById('dev_logs'); if(!el) return; const ds = loadDeveloperSettings(); const arr = ds.logs || []; if(arr.length===0) { el.innerHTML = '<div class="helper-text">No dev logs yet.</div>'; return; } el.innerHTML=''; arr.slice(-200).reverse().forEach(l=>{ const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid var(--border)'; d.innerHTML = `<div style="font-weight:600">${escapeHtml(l.ts)}</div><div style="color:var(--muted);">${escapeHtml(l.entry)}</div>`; el.appendChild(d); }); }
    function clearDevLogs(){ if(!confirm('Clear developer logs?')) return; const ds = loadDeveloperSettings(); ds.logs = []; saveDeveloperSettings(ds); renderDevLogs(); }
    function downloadDevLogs(){ const ds = loadDeveloperSettings(); const blob = new Blob([JSON.stringify(ds.logs||[], null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'developer-logs.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); }

    function testApiEndpoint(){ // simulate an API call and log response
      appendDevLog('Simulated API request to /v1/agent/query ‚Äî payload {query: "ping"}'); setTimeout(()=>{ appendDevLog('Simulated response: {reply:"pong"}'); alert('Simulated API test complete ‚Äî see developer logs.'); }, 600); }

    // render developer panels on load
    function renderDeveloperPanels(){ try{ renderApiKeys(); renderWebhooks(); renderSdkSnippets(); renderDevLogs(); }catch(e){} }

    // initialize templates, translations and capabilities UI
    renderTemplatesList(); renderTranslations(); populateActionsWhitelist(); renderCapabilitiesActions(); renderDocumentLibrary(); renderCalendarLibrary(); renderInvoiceTemplatesList();
    // Wire slider display updates for capabilities UI
    const escT = document.getElementById('escalationTimeout'); if (escT) escT.addEventListener('input', ()=> document.getElementById('escalationTimeoutVal').textContent = escT.value);
    const sat = document.getElementById('satisfactionThreshold'); if (sat) sat.addEventListener('input', ()=> document.getElementById('satisfactionThresholdVal').textContent = sat.value);
    const autoE = document.getElementById('auto_escalate'); if (autoE) autoE.addEventListener('input', ()=> document.getElementById('auto_escalate_val').textContent = autoE.value);
  </script>
</body>
</html>